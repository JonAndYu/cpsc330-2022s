
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CPSC 330 Lecture 18 &#8212; CPSC 330 Applied Machine Learning</title>
    
  <link href="../_static/css/theme.css" rel="stylesheet" />
  <link href="../_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/sphinx-book-theme.e8e5499552300ddf5d7adccae7cc3b70.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.1c5a1a01449ed65a7b51.js">

    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["\\(", "\\)"]], "displayMath": [["\\[", "\\]"]], "processRefs": false, "processEnvironments": false}})</script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
      <img src="../_static/UBC-CS-logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">CPSC 330 Applied Machine Learning</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
    <div class="bd-toc-item active">
        <p class="caption">
 <span class="caption-text">
  Things you should know
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../docs/README.html">
   CPSC 330 Documents
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Lectures
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="01_intro.html">
   Lecture 1: Course Introduction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="02_decision-trees.html">
   Lecture 2: Terminology, Baselines, Decision Trees
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="03_ml-fundamentals.html">
   Lecture 3: Machine Learning Fundamentals
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="04_kNNs-SVM-RBF.html">
   Lecture 4:
   <span class="math notranslate nohighlight">
    \(k\)
   </span>
   -Nearest Neighbours and SVM RBFs
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="05_preprocessing-pipelines.html">
   Lecture 5: Preprocessing and
   <code class="docutils literal notranslate">
    <span class="pre">
     sklearn
    </span>
   </code>
   pipelines
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="06_column-transformer-text-feats.html">
   Lecture 6:
   <code class="docutils literal notranslate">
    <span class="pre">
     sklearn
    </span>
   </code>
   <code class="docutils literal notranslate">
    <span class="pre">
     ColumnTransformer
    </span>
   </code>
   and Text Features
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="07_linear-models.html">
   Lecture 7: Linear Models
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="08_hyperparameter-optimization.html">
   Lecture 8: Hyperparameter Optimization and Optimization Bias
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="09_classification-metrics.html">
   Lecture 9: Classification Metrics
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="10_regression-metrics.html">
   Lecture 10: Regression Evaluation Metrics
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="11_ensembles.html">
   Lecture 11: Ensembles
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="13_feature-engineering-selection.html">
   Lecture 13: Feature engineering and feature selection
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="14_k-means-clustering.html">
   Lecture 14: Clustering
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="15_recommender-systems.html">
   Lecture 15: DBSCAN and Recommender Systems
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="16_natural-language-processing.html">
   Lecture 16: Introduction to natural language processing
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="17_intro_to_computer-vision.html">
   Lecture 17: Multi-class classification and introduction to computer vision
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Attribution
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../attribution.html">
   Attributions
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../LICENSE.html">
   LICENSE
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Varada Kolhatkar, CPSC 330 2021-22<br>Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/lectures/19_survival-analysis.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/UBC-CS/cpsc330/master?urlpath=tree/lectures/19_survival-analysis.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#">
   CPSC 330 Lecture 18
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#learning-objectives">
     Learning objectives
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#announcements">
     Announcements
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#customer-churn-our-standard-approach-10-min">
     Customer churn: our standard approach (10 min)
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#censoring-and-survival-analysis-15-min">
     Censoring and survival analysis (15 min)
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#time-to-event-and-censoring">
       Time to event and censoring
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#approach-1">
       Approach 1
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#approach-2">
       Approach 2
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#approach-3">
       Approach 3
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#types-of-questions-we-might-want-to-answer">
       Types of questions we might want to answer:
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#break-5-min">
     Break (5 min)
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#kaplan-meier-survival-curve-10-min">
     Kaplan-Meier survival curve (10 min)
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#cox-proportional-hazards-model-10-min">
     Cox proportional hazards model (10 min)
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#prediction-10-min">
     Prediction (10 min)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#todo">
   TODO
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#other-approaches-what-did-we-not-cover-5-min">
     Other approaches / what did we not cover? (5 min)
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#measures-of-model-accuracy">
       Measures of model accuracy
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#other-approaches">
       Other approaches
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#types-of-censoring">
       Types of censoring
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#summary">
     Summary
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#time-permitting">
     Time-permitting
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#true-false-questions">
     True/False questions
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#references">
     References
    </a>
   </li>
  </ul>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="cpsc-330-lecture-18">
<h1>CPSC 330 Lecture 18<a class="headerlink" href="#cpsc-330-lecture-18" title="Permalink to this headline">¶</a></h1>
<p>Lecture plan:</p>
<ul class="simple">
<li><p>👋</p></li>
<li><p><strong>Turn on recording</strong></p></li>
<li><p>Announcements</p></li>
<li><p>Our standard approach (15 min)</p></li>
<li><p>Censoring and survival analysis (20 min)</p></li>
<li><p>Break (5 min)</p></li>
<li><p>Kaplan-Meier curve (10 min)</p></li>
<li><p>Cox proportional hazards model (15 min)</p></li>
<li><p>Prediction (10 min)</p></li>
<li><p>Other approaches / what did we not cover? (5 min)</p></li>
</ul>
<p>Piazza:</p>
<ul class="simple">
<li><p>True/False</p></li>
</ul>
<div class="section" id="learning-objectives">
<h2>Learning objectives<a class="headerlink" href="#learning-objectives" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Explain the problem with treating right-censored data the same as “regular” data.</p></li>
<li><p>Determine whether survival analysis is an appropriate tool for a given problem.</p></li>
<li><p>Apply survival analysis in Python using the <code class="docutils literal notranslate"><span class="pre">lifelines</span></code> package.</p></li>
<li><p>Interpret a survival curve, such as the Kaplan-Meier curve.</p></li>
<li><p>Interpret the coefficients of a fitted Cox proportional hazards model.</p></li>
<li><p>Make predictions for existing individuals and interpret these predictions.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="kn">from</span> <span class="nn">sklearn.dummy</span> <span class="kn">import</span> <span class="n">DummyClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegression</span><span class="p">,</span> <span class="n">Ridge</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestClassifier</span><span class="p">,</span> <span class="n">RandomForestRegressor</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span><span class="p">,</span> <span class="n">cross_val_score</span><span class="p">,</span> <span class="n">cross_validate</span><span class="p">,</span> <span class="n">cross_val_predict</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">plot_confusion_matrix</span><span class="p">,</span> <span class="n">confusion_matrix</span>
<span class="kn">from</span> <span class="nn">sklearn.impute</span> <span class="kn">import</span> <span class="n">SimpleImputer</span>
<span class="kn">from</span> <span class="nn">sklearn.compose</span> <span class="kn">import</span> <span class="n">ColumnTransformer</span><span class="p">,</span> <span class="n">make_column_transformer</span>
<span class="kn">from</span> <span class="nn">sklearn.pipeline</span> <span class="kn">import</span> <span class="n">Pipeline</span><span class="p">,</span> <span class="n">make_pipeline</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span><span class="p">,</span> <span class="n">OrdinalEncoder</span><span class="p">,</span> <span class="n">OneHotEncoder</span><span class="p">,</span> <span class="n">FunctionTransformer</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;font.size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">16</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">lifelines</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># does lifelines try to mess with this?</span>
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">max_rows</span> <span class="o">=</span> <span class="mi">10</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="announcements">
<h2>Announcements<a class="headerlink" href="#announcements" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>hw7 released, due next Monday 11:59pm</p></li>
<li><p>hw8 will be a free-form ML task, hw9 will be a blog post</p></li>
<li><p>See Piazza for final exam details</p></li>
</ul>
</div>
<div class="section" id="customer-churn-our-standard-approach-10-min">
<h2>Customer churn: our standard approach (10 min)<a class="headerlink" href="#customer-churn-our-standard-approach-10-min" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>In hw4 you looked at a dataset about <a class="reference external" href="https://en.wikipedia.org/wiki/Customer_attrition">customer churn</a>.</p></li>
<li><p>In hw4, the dataset was interesting because it’s unbalanced (most customers stay).</p></li>
<li><p>Today we’ll look at a different customer churn <a class="reference external" href="https://www.kaggle.com/blastchar/telco-customer-churn">dataset</a>, because it has a feature we need - time!</p></li>
<li><p>We’ll explore the time aspect of the dataset today.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;data/WA_Fn-UseC_-Telco-Customer-Churn.csv&quot;</span><span class="p">)</span>
<span class="n">df_train</span><span class="p">,</span> <span class="n">df_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">123</span><span class="p">)</span>
<span class="n">df_train</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">FileNotFoundError</span><span class="g g-Whitespace">                         </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">80</span><span class="o">/</span><span class="n">kr9rkqfj4w78h49djkz8yy9r0000gp</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_17020</span><span class="o">/</span><span class="mf">3147564248.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;data/WA_Fn-UseC_-Telco-Customer-Churn.csv&quot;</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="n">df_train</span><span class="p">,</span> <span class="n">df_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">123</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="n">df_train</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>

<span class="nn">~/opt/miniconda3/envs/cpsc330/lib/python3.9/site-packages/pandas/util/_decorators.py</span> in <span class="ni">wrapper</span><span class="nt">(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">309</span>                     <span class="n">stacklevel</span><span class="o">=</span><span class="n">stacklevel</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">310</span>                 <span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">311</span>             <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">312</span> 
<span class="g g-Whitespace">    </span><span class="mi">313</span>         <span class="k">return</span> <span class="n">wrapper</span>

<span class="nn">~/opt/miniconda3/envs/cpsc330/lib/python3.9/site-packages/pandas/io/parsers/readers.py</span> in <span class="ni">read_csv</span><span class="nt">(filepath_or_buffer, sep, delimiter, header, names, index_col, usecols, squeeze, prefix, mangle_dupe_cols, dtype, engine, converters, true_values, false_values, skipinitialspace, skiprows, skipfooter, nrows, na_values, keep_default_na, na_filter, verbose, skip_blank_lines, parse_dates, infer_datetime_format, keep_date_col, date_parser, dayfirst, cache_dates, iterator, chunksize, compression, thousands, decimal, lineterminator, quotechar, quoting, doublequote, escapechar, comment, encoding, encoding_errors, dialect, error_bad_lines, warn_bad_lines, on_bad_lines, delim_whitespace, low_memory, memory_map, float_precision, storage_options)</span>
<span class="g g-Whitespace">    </span><span class="mi">584</span>     <span class="n">kwds</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwds_defaults</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">585</span> 
<span class="ne">--&gt; </span><span class="mi">586</span>     <span class="k">return</span> <span class="n">_read</span><span class="p">(</span><span class="n">filepath_or_buffer</span><span class="p">,</span> <span class="n">kwds</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">587</span> 
<span class="g g-Whitespace">    </span><span class="mi">588</span> 

<span class="nn">~/opt/miniconda3/envs/cpsc330/lib/python3.9/site-packages/pandas/io/parsers/readers.py</span> in <span class="ni">_read</span><span class="nt">(filepath_or_buffer, kwds)</span>
<span class="g g-Whitespace">    </span><span class="mi">480</span> 
<span class="g g-Whitespace">    </span><span class="mi">481</span>     <span class="c1"># Create the parser.</span>
<span class="ne">--&gt; </span><span class="mi">482</span>     <span class="n">parser</span> <span class="o">=</span> <span class="n">TextFileReader</span><span class="p">(</span><span class="n">filepath_or_buffer</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">483</span> 
<span class="g g-Whitespace">    </span><span class="mi">484</span>     <span class="k">if</span> <span class="n">chunksize</span> <span class="ow">or</span> <span class="n">iterator</span><span class="p">:</span>

<span class="nn">~/opt/miniconda3/envs/cpsc330/lib/python3.9/site-packages/pandas/io/parsers/readers.py</span> in <span class="ni">__init__</span><span class="nt">(self, f, engine, **kwds)</span>
<span class="g g-Whitespace">    </span><span class="mi">809</span>             <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;has_index_names&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwds</span><span class="p">[</span><span class="s2">&quot;has_index_names&quot;</span><span class="p">]</span>
<span class="g g-Whitespace">    </span><span class="mi">810</span> 
<span class="ne">--&gt; </span><span class="mi">811</span>         <span class="bp">self</span><span class="o">.</span><span class="n">_engine</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_engine</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">812</span> 
<span class="g g-Whitespace">    </span><span class="mi">813</span>     <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

<span class="nn">~/opt/miniconda3/envs/cpsc330/lib/python3.9/site-packages/pandas/io/parsers/readers.py</span> in <span class="ni">_make_engine</span><span class="nt">(self, engine)</span>
<span class="g g-Whitespace">   </span><span class="mi">1038</span>             <span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1039</span>         <span class="c1"># error: Too many arguments for &quot;ParserBase&quot;</span>
<span class="ne">-&gt; </span><span class="mi">1040</span>         <span class="k">return</span> <span class="n">mapping</span><span class="p">[</span><span class="n">engine</span><span class="p">](</span><span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">)</span>  <span class="c1"># type: ignore[call-arg]</span>
<span class="g g-Whitespace">   </span><span class="mi">1041</span> 
<span class="g g-Whitespace">   </span><span class="mi">1042</span>     <span class="k">def</span> <span class="nf">_failover_to_python</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

<span class="nn">~/opt/miniconda3/envs/cpsc330/lib/python3.9/site-packages/pandas/io/parsers/c_parser_wrapper.py</span> in <span class="ni">__init__</span><span class="nt">(self, src, **kwds)</span>
<span class="g g-Whitespace">     </span><span class="mi">49</span> 
<span class="g g-Whitespace">     </span><span class="mi">50</span>         <span class="c1"># open handles</span>
<span class="ne">---&gt; </span><span class="mi">51</span>         <span class="bp">self</span><span class="o">.</span><span class="n">_open_handles</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">kwds</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">52</span>         <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">handles</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<span class="g g-Whitespace">     </span><span class="mi">53</span> 

<span class="nn">~/opt/miniconda3/envs/cpsc330/lib/python3.9/site-packages/pandas/io/parsers/base_parser.py</span> in <span class="ni">_open_handles</span><span class="nt">(self, src, kwds)</span>
<span class="g g-Whitespace">    </span><span class="mi">220</span>         <span class="n">Let</span> <span class="n">the</span> <span class="n">readers</span> <span class="nb">open</span> <span class="n">IOHandles</span> <span class="n">after</span> <span class="n">they</span> <span class="n">are</span> <span class="n">done</span> <span class="k">with</span> <span class="n">their</span> <span class="n">potential</span> <span class="n">raises</span><span class="o">.</span>
<span class="g g-Whitespace">    </span><span class="mi">221</span>         <span class="s2">&quot;&quot;&quot;</span>
<span class="ne">--&gt; </span><span class="mi">222</span><span class="s2">         self.handles = get_handle(</span>
<span class="g g-Whitespace">    </span><span class="mi">223</span><span class="s2">             src,</span>
<span class="g g-Whitespace">    </span><span class="mi">224</span><span class="s2">             &quot;r&quot;,</span>

<span class="nn">~/opt/miniconda3/envs/cpsc330/lib/python3.9/site-packages/pandas/io/common.py</span> in <span class="ni">get_handle</span><span class="nt">(path_or_buf, mode, encoding, compression, memory_map, is_text, errors, storage_options)</span>
<span class="g g-Whitespace">    </span><span class="mi">699</span><span class="s2">         if ioargs.encoding and &quot;b&quot; not in ioargs.mode:</span>
<span class="g g-Whitespace">    </span><span class="mi">700</span><span class="s2">             # Encoding</span>
<span class="ne">--&gt; </span><span class="mi">701</span><span class="s2">             handle = open(</span>
<span class="g g-Whitespace">    </span><span class="mi">702</span><span class="s2">                 handle,</span>
<span class="g g-Whitespace">    </span><span class="mi">703</span><span class="s2">                 ioargs.mode,</span>

<span class="ne">FileNotFoundError</span>: [Errno 2] No such file or directory: &#39;data/WA_Fn-UseC_-Telco-Customer-Churn.csv&#39;
</pre></div>
</div>
</div>
</div>
<p>We are trying to predict <code class="docutils literal notranslate"><span class="pre">Churn</span></code> (yes/no) from these other columns.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_train</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(5282, 21)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_train</span><span class="p">[</span><span class="s2">&quot;Churn&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>No     3912
Yes    1370
Name: Churn, dtype: int64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_train</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
Int64Index: 5282 entries, 6464 to 3582
Data columns (total 21 columns):
 #   Column            Non-Null Count  Dtype  
---  ------            --------------  -----  
 0   customerID        5282 non-null   object 
 1   gender            5282 non-null   object 
 2   SeniorCitizen     5282 non-null   int64  
 3   Partner           5282 non-null   object 
 4   Dependents        5282 non-null   object 
 5   tenure            5282 non-null   int64  
 6   PhoneService      5282 non-null   object 
 7   MultipleLines     5282 non-null   object 
 8   InternetService   5282 non-null   object 
 9   OnlineSecurity    5282 non-null   object 
 10  OnlineBackup      5282 non-null   object 
 11  DeviceProtection  5282 non-null   object 
 12  TechSupport       5282 non-null   object 
 13  StreamingTV       5282 non-null   object 
 14  StreamingMovies   5282 non-null   object 
 15  Contract          5282 non-null   object 
 16  PaperlessBilling  5282 non-null   object 
 17  PaymentMethod     5282 non-null   object 
 18  MonthlyCharges    5282 non-null   float64
 19  TotalCharges      5282 non-null   object 
 20  Churn             5282 non-null   object 
dtypes: float64(1), int64(2), object(18)
memory usage: 907.8+ KB
</pre></div>
</div>
</div>
</div>
<p>Question: Does this mean there is no missing data?</p>
<p>Ok, let’s try our usual approach:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">numeric_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;tenure&#39;</span><span class="p">,</span> <span class="s1">&#39;MonthlyCharges&#39;</span><span class="p">,</span> <span class="s1">&#39;TotalCharges&#39;</span><span class="p">]</span>
<span class="n">drop_features</span>    <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;customerID&#39;</span><span class="p">]</span>
<span class="n">target_column</span>    <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Churn&#39;</span><span class="p">]</span>
<span class="c1"># the rest are categorical</span>
<span class="n">categorical_features</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">df_train</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="o">-</span><span class="nb">set</span><span class="p">(</span><span class="n">numeric_features</span><span class="p">)</span><span class="o">-</span><span class="nb">set</span><span class="p">(</span><span class="n">drop_features</span><span class="p">)</span><span class="o">-</span><span class="nb">set</span><span class="p">(</span><span class="n">target_column</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">preprocessing</span> <span class="o">=</span> <span class="n">ColumnTransformer</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;scale&#39;</span><span class="p">,</span>  <span class="n">StandardScaler</span><span class="p">(),</span> <span class="n">numeric_features</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ohe&#39;</span><span class="p">,</span>    <span class="n">OneHotEncoder</span><span class="p">(),</span> <span class="n">categorical_features</span><span class="p">)</span> 
<span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_raises-exception docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">preprocessing</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df_train</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">ValueError</span><span class="g g-Whitespace">                                </span>Traceback (most recent call last)
<span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="n">a3e10b6cacc4</span><span class="o">&gt;</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">preprocessing</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df_train</span><span class="p">);</span>

<span class="nn">/opt/miniconda3/envs/cpsc330env/lib/python3.8/site-packages/sklearn/compose/_column_transformer.py</span> in <span class="ni">fit</span><span class="nt">(self, X, y)</span>
<span class="g g-Whitespace">    </span><span class="mi">492</span>         <span class="c1"># we use fit_transform to make sure to set sparse_output_ (for which we</span>
<span class="g g-Whitespace">    </span><span class="mi">493</span>         <span class="c1"># need the transformed data) to have consistent output type in predict</span>
<span class="ne">--&gt; </span><span class="mi">494</span>         <span class="bp">self</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">495</span>         <span class="k">return</span> <span class="bp">self</span>
<span class="g g-Whitespace">    </span><span class="mi">496</span> 

<span class="nn">/opt/miniconda3/envs/cpsc330env/lib/python3.8/site-packages/sklearn/compose/_column_transformer.py</span> in <span class="ni">fit_transform</span><span class="nt">(self, X, y)</span>
<span class="g g-Whitespace">    </span><span class="mi">529</span>         <span class="bp">self</span><span class="o">.</span><span class="n">_validate_remainder</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">530</span> 
<span class="ne">--&gt; </span><span class="mi">531</span>         <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">_fit_transform_one</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">532</span> 
<span class="g g-Whitespace">    </span><span class="mi">533</span>         <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">:</span>

<span class="nn">/opt/miniconda3/envs/cpsc330env/lib/python3.8/site-packages/sklearn/compose/_column_transformer.py</span> in <span class="ni">_fit_transform</span><span class="nt">(self, X, y, func, fitted)</span>
<span class="g g-Whitespace">    </span><span class="mi">456</span>             <span class="bp">self</span><span class="o">.</span><span class="n">_iter</span><span class="p">(</span><span class="n">fitted</span><span class="o">=</span><span class="n">fitted</span><span class="p">,</span> <span class="n">replace_strings</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
<span class="g g-Whitespace">    </span><span class="mi">457</span>         <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">458</span>             <span class="k">return</span> <span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_jobs</span><span class="p">)(</span>
<span class="g g-Whitespace">    </span><span class="mi">459</span>                 <span class="n">delayed</span><span class="p">(</span><span class="n">func</span><span class="p">)(</span>
<span class="g g-Whitespace">    </span><span class="mi">460</span>                     <span class="n">transformer</span><span class="o">=</span><span class="n">clone</span><span class="p">(</span><span class="n">trans</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">fitted</span> <span class="k">else</span> <span class="n">trans</span><span class="p">,</span>

<span class="nn">/opt/miniconda3/envs/cpsc330env/lib/python3.8/site-packages/joblib/parallel.py</span> in <span class="ni">__call__</span><span class="nt">(self, iterable)</span>
<span class="g g-Whitespace">   </span><span class="mi">1027</span>             <span class="c1"># remaining jobs.</span>
<span class="g g-Whitespace">   </span><span class="mi">1028</span>             <span class="bp">self</span><span class="o">.</span><span class="n">_iterating</span> <span class="o">=</span> <span class="kc">False</span>
<span class="ne">-&gt; </span><span class="mi">1029</span>             <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispatch_one_batch</span><span class="p">(</span><span class="n">iterator</span><span class="p">):</span>
<span class="g g-Whitespace">   </span><span class="mi">1030</span>                 <span class="bp">self</span><span class="o">.</span><span class="n">_iterating</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_original_iterator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<span class="g g-Whitespace">   </span><span class="mi">1031</span> 

<span class="nn">/opt/miniconda3/envs/cpsc330env/lib/python3.8/site-packages/joblib/parallel.py</span> in <span class="ni">dispatch_one_batch</span><span class="nt">(self, iterator)</span>
<span class="g g-Whitespace">    </span><span class="mi">845</span>                 <span class="k">return</span> <span class="kc">False</span>
<span class="g g-Whitespace">    </span><span class="mi">846</span>             <span class="k">else</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">847</span>                 <span class="bp">self</span><span class="o">.</span><span class="n">_dispatch</span><span class="p">(</span><span class="n">tasks</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">848</span>                 <span class="k">return</span> <span class="kc">True</span>
<span class="g g-Whitespace">    </span><span class="mi">849</span> 

<span class="nn">/opt/miniconda3/envs/cpsc330env/lib/python3.8/site-packages/joblib/parallel.py</span> in <span class="ni">_dispatch</span><span class="nt">(self, batch)</span>
<span class="g g-Whitespace">    </span><span class="mi">763</span>         <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">764</span>             <span class="n">job_idx</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_jobs</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">765</span>             <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_backend</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">cb</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">766</span>             <span class="c1"># A job can complete so quickly than its callback is</span>
<span class="g g-Whitespace">    </span><span class="mi">767</span>             <span class="c1"># called before we get here, causing self._jobs to</span>

<span class="nn">/opt/miniconda3/envs/cpsc330env/lib/python3.8/site-packages/joblib/_parallel_backends.py</span> in <span class="ni">apply_async</span><span class="nt">(self, func, callback)</span>
<span class="g g-Whitespace">    </span><span class="mi">206</span>     <span class="k">def</span> <span class="nf">apply_async</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">207</span>         <span class="sd">&quot;&quot;&quot;Schedule a func to be run&quot;&quot;&quot;</span>
<span class="ne">--&gt; </span><span class="mi">208</span>         <span class="n">result</span> <span class="o">=</span> <span class="n">ImmediateResult</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">209</span>         <span class="k">if</span> <span class="n">callback</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">210</span>             <span class="n">callback</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

<span class="nn">/opt/miniconda3/envs/cpsc330env/lib/python3.8/site-packages/joblib/_parallel_backends.py</span> in <span class="ni">__init__</span><span class="nt">(self, batch)</span>
<span class="g g-Whitespace">    </span><span class="mi">570</span>         <span class="c1"># Don&#39;t delay the application, to avoid keeping the input</span>
<span class="g g-Whitespace">    </span><span class="mi">571</span>         <span class="c1"># arguments in memory</span>
<span class="ne">--&gt; </span><span class="mi">572</span>         <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="n">batch</span><span class="p">()</span>
<span class="g g-Whitespace">    </span><span class="mi">573</span> 
<span class="g g-Whitespace">    </span><span class="mi">574</span>     <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

<span class="nn">/opt/miniconda3/envs/cpsc330env/lib/python3.8/site-packages/joblib/parallel.py</span> in <span class="ni">__call__</span><span class="nt">(self)</span>
<span class="g g-Whitespace">    </span><span class="mi">250</span>         <span class="c1"># change the default number of processes to -1</span>
<span class="g g-Whitespace">    </span><span class="mi">251</span>         <span class="k">with</span> <span class="n">parallel_backend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_backend</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_jobs</span><span class="p">):</span>
<span class="ne">--&gt; </span><span class="mi">252</span>             <span class="k">return</span> <span class="p">[</span><span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">253</span>                     <span class="k">for</span> <span class="n">func</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">]</span>
<span class="g g-Whitespace">    </span><span class="mi">254</span> 

<span class="nn">/opt/miniconda3/envs/cpsc330env/lib/python3.8/site-packages/joblib/parallel.py</span> in <span class="ni">&lt;listcomp&gt;</span><span class="nt">(.0)</span>
<span class="g g-Whitespace">    </span><span class="mi">250</span>         <span class="c1"># change the default number of processes to -1</span>
<span class="g g-Whitespace">    </span><span class="mi">251</span>         <span class="k">with</span> <span class="n">parallel_backend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_backend</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_jobs</span><span class="p">):</span>
<span class="ne">--&gt; </span><span class="mi">252</span>             <span class="k">return</span> <span class="p">[</span><span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">253</span>                     <span class="k">for</span> <span class="n">func</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">]</span>
<span class="g g-Whitespace">    </span><span class="mi">254</span> 

<span class="nn">/opt/miniconda3/envs/cpsc330env/lib/python3.8/site-packages/sklearn/pipeline.py</span> in <span class="ni">_fit_transform_one</span><span class="nt">(transformer, X, y, weight, message_clsname, message, **fit_params)</span>
<span class="g g-Whitespace">    </span><span class="mi">738</span>     <span class="k">with</span> <span class="n">_print_elapsed_time</span><span class="p">(</span><span class="n">message_clsname</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">739</span>         <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">transformer</span><span class="p">,</span> <span class="s1">&#39;fit_transform&#39;</span><span class="p">):</span>
<span class="ne">--&gt; </span><span class="mi">740</span>             <span class="n">res</span> <span class="o">=</span> <span class="n">transformer</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="o">**</span><span class="n">fit_params</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">741</span>         <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">742</span>             <span class="n">res</span> <span class="o">=</span> <span class="n">transformer</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="o">**</span><span class="n">fit_params</span><span class="p">)</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

<span class="nn">/opt/miniconda3/envs/cpsc330env/lib/python3.8/site-packages/sklearn/base.py</span> in <span class="ni">fit_transform</span><span class="nt">(self, X, y, **fit_params)</span>
<span class="g g-Whitespace">    </span><span class="mi">688</span>         <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">689</span>             <span class="c1"># fit method of arity 1 (unsupervised transformation)</span>
<span class="ne">--&gt; </span><span class="mi">690</span>             <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="o">**</span><span class="n">fit_params</span><span class="p">)</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">691</span>         <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">692</span>             <span class="c1"># fit method of arity 2 (supervised transformation)</span>

<span class="nn">/opt/miniconda3/envs/cpsc330env/lib/python3.8/site-packages/sklearn/preprocessing/_data.py</span> in <span class="ni">fit</span><span class="nt">(self, X, y)</span>
<span class="g g-Whitespace">    </span><span class="mi">665</span>         <span class="c1"># Reset internal state before fitting</span>
<span class="g g-Whitespace">    </span><span class="mi">666</span>         <span class="bp">self</span><span class="o">.</span><span class="n">_reset</span><span class="p">()</span>
<span class="ne">--&gt; </span><span class="mi">667</span>         <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">partial_fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">668</span> 
<span class="g g-Whitespace">    </span><span class="mi">669</span>     <span class="k">def</span> <span class="nf">partial_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

<span class="nn">/opt/miniconda3/envs/cpsc330env/lib/python3.8/site-packages/sklearn/preprocessing/_data.py</span> in <span class="ni">partial_fit</span><span class="nt">(self, X, y)</span>
<span class="g g-Whitespace">    </span><span class="mi">694</span>             <span class="n">Transformer</span> <span class="n">instance</span><span class="o">.</span>
<span class="g g-Whitespace">    </span><span class="mi">695</span>         <span class="sd">&quot;&quot;&quot;</span>
<span class="ne">--&gt; </span><span class="mi">696</span><span class="sd">         X = self._validate_data(X, accept_sparse=(&#39;csr&#39;, &#39;csc&#39;),</span>
<span class="g g-Whitespace">    </span><span class="mi">697</span><span class="sd">                                 estimator=self, dtype=FLOAT_DTYPES,</span>
<span class="g g-Whitespace">    </span><span class="mi">698</span><span class="sd">                                 force_all_finite=&#39;allow-nan&#39;)</span>

<span class="nn">/opt/miniconda3/envs/cpsc330env/lib/python3.8/site-packages/sklearn/base.py</span> in <span class="ni">_validate_data</span><span class="nt">(self, X, y, reset, validate_separately, **check_params)</span>
<span class="g g-Whitespace">    </span><span class="mi">418</span><span class="sd">                     f&quot;requires y to be passed, but the target y is None.&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">419</span><span class="sd">                 )</span>
<span class="ne">--&gt; </span><span class="mi">420</span><span class="sd">             X = check_array(X, **check_params)</span>
<span class="g g-Whitespace">    </span><span class="mi">421</span><span class="sd">             out = X</span>
<span class="g g-Whitespace">    </span><span class="mi">422</span><span class="sd">         else:</span>

<span class="nn">/opt/miniconda3/envs/cpsc330env/lib/python3.8/site-packages/sklearn/utils/validation.py</span> in <span class="ni">inner_f</span><span class="nt">(*args, **kwargs)</span>
<span class="g g-Whitespace">     </span><span class="mi">71</span><span class="sd">                           FutureWarning)</span>
<span class="nn">     72         kwargs.update({k: arg for k, arg</span> in <span class="ni">zip</span><span class="nt">(sig.parameters, args)})</span>
<span class="ne">---&gt; </span><span class="mi">73</span><span class="sd">         return f(**kwargs)</span>
<span class="g g-Whitespace">     </span><span class="mi">74</span><span class="sd">     return inner_f</span>
<span class="g g-Whitespace">     </span><span class="mi">75</span><span class="sd"> </span>

<span class="nn">/opt/miniconda3/envs/cpsc330env/lib/python3.8/site-packages/sklearn/utils/validation.py</span> in <span class="ni">check_array</span><span class="nt">(array, accept_sparse, accept_large_sparse, dtype, order, copy, force_all_finite, ensure_2d, allow_nd, ensure_min_samples, ensure_min_features, estimator)</span>
<span class="g g-Whitespace">    </span><span class="mi">597</span><span class="sd">                     array = array.astype(dtype, casting=&quot;unsafe&quot;, copy=False)</span>
<span class="g g-Whitespace">    </span><span class="mi">598</span><span class="sd">                 else:</span>
<span class="ne">--&gt; </span><span class="mi">599</span><span class="sd">                     array = np.asarray(array, order=order, dtype=dtype)</span>
<span class="g g-Whitespace">    </span><span class="mi">600</span><span class="sd">             except ComplexWarning:</span>
<span class="g g-Whitespace">    </span><span class="mi">601</span><span class="sd">                 raise ValueError(&quot;Complex data not supported\n&quot;</span>

<span class="nn">/opt/miniconda3/envs/cpsc330env/lib/python3.8/site-packages/numpy/core/_asarray.py</span> in <span class="ni">asarray</span><span class="nt">(a, dtype, order)</span>
<span class="g g-Whitespace">     </span><span class="mi">81</span><span class="sd"> </span>
<span class="g g-Whitespace">     </span><span class="mi">82</span><span class="sd">     &quot;&quot;&quot;</span>
<span class="ne">---&gt; </span><span class="mi">83</span>     <span class="k">return</span> <span class="n">array</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">84</span> 
<span class="g g-Whitespace">     </span><span class="mi">85</span> 

<span class="ne">ValueError</span>: could not convert string to float: &#39;&#39;
</pre></div>
</div>
</div>
</div>
<p>Hmmm, one of the numeric features is causing problems?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
RangeIndex: 7043 entries, 0 to 7042
Data columns (total 21 columns):
 #   Column            Non-Null Count  Dtype  
---  ------            --------------  -----  
 0   customerID        7043 non-null   object 
 1   gender            7043 non-null   object 
 2   SeniorCitizen     7043 non-null   int64  
 3   Partner           7043 non-null   object 
 4   Dependents        7043 non-null   object 
 5   tenure            7043 non-null   int64  
 6   PhoneService      7043 non-null   object 
 7   MultipleLines     7043 non-null   object 
 8   InternetService   7043 non-null   object 
 9   OnlineSecurity    7043 non-null   object 
 10  OnlineBackup      7043 non-null   object 
 11  DeviceProtection  7043 non-null   object 
 12  TechSupport       7043 non-null   object 
 13  StreamingTV       7043 non-null   object 
 14  StreamingMovies   7043 non-null   object 
 15  Contract          7043 non-null   object 
 16  PaperlessBilling  7043 non-null   object 
 17  PaymentMethod     7043 non-null   object 
 18  MonthlyCharges    7043 non-null   float64
 19  TotalCharges      7043 non-null   object 
 20  Churn             7043 non-null   object 
dtypes: float64(1), int64(2), object(18)
memory usage: 1.1+ MB
</pre></div>
</div>
</div>
</div>
<p>Oh, looks like <code class="docutils literal notranslate"><span class="pre">TotalCharges</span></code> is not a numeric type.</p>
<div class="cell tag_raises-exception docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_train</span><span class="p">[</span><span class="s1">&#39;TotalCharges&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_train</span><span class="p">[</span><span class="s1">&#39;TotalCharges&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">ValueError</span><span class="g g-Whitespace">                                </span>Traceback (most recent call last)
<span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">13</span><span class="o">-</span><span class="mi">3</span><span class="n">ec7075e6215</span><span class="o">&gt;</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">df_train</span><span class="p">[</span><span class="s1">&#39;TotalCharges&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_train</span><span class="p">[</span><span class="s1">&#39;TotalCharges&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

<span class="nn">/opt/miniconda3/envs/cpsc330env/lib/python3.8/site-packages/pandas/core/generic.py</span> in <span class="ni">astype</span><span class="nt">(self, dtype, copy, errors)</span>
<span class="g g-Whitespace">   </span><span class="mi">5696</span>         <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">5697</span>             <span class="c1"># else, only a single dtype is given</span>
<span class="ne">-&gt; </span><span class="mi">5698</span>             <span class="n">new_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="n">copy</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="n">errors</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">5699</span>             <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constructor</span><span class="p">(</span><span class="n">new_data</span><span class="p">)</span><span class="o">.</span><span class="n">__finalize__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">5700</span> 

<span class="nn">/opt/miniconda3/envs/cpsc330env/lib/python3.8/site-packages/pandas/core/internals/managers.py</span> in <span class="ni">astype</span><span class="nt">(self, dtype, copy, errors)</span>
<span class="g g-Whitespace">    </span><span class="mi">580</span> 
<span class="g g-Whitespace">    </span><span class="mi">581</span>     <span class="k">def</span> <span class="nf">astype</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">copy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">errors</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;raise&quot;</span><span class="p">):</span>
<span class="ne">--&gt; </span><span class="mi">582</span>         <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="s2">&quot;astype&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="n">copy</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="n">errors</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">583</span> 
<span class="g g-Whitespace">    </span><span class="mi">584</span>     <span class="k">def</span> <span class="nf">convert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

<span class="nn">/opt/miniconda3/envs/cpsc330env/lib/python3.8/site-packages/pandas/core/internals/managers.py</span> in <span class="ni">apply</span><span class="nt">(self, f, filter, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">440</span>                 <span class="n">applied</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">441</span>             <span class="k">else</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">442</span>                 <span class="n">applied</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">f</span><span class="p">)(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">443</span>             <span class="n">result_blocks</span> <span class="o">=</span> <span class="n">_extend_blocks</span><span class="p">(</span><span class="n">applied</span><span class="p">,</span> <span class="n">result_blocks</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">444</span> 

<span class="nn">/opt/miniconda3/envs/cpsc330env/lib/python3.8/site-packages/pandas/core/internals/blocks.py</span> in <span class="ni">astype</span><span class="nt">(self, dtype, copy, errors)</span>
<span class="g g-Whitespace">    </span><span class="mi">623</span>             <span class="n">vals1d</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="g g-Whitespace">    </span><span class="mi">624</span>             <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">625</span>                 <span class="n">values</span> <span class="o">=</span> <span class="n">astype_nansafe</span><span class="p">(</span><span class="n">vals1d</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">626</span>             <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">627</span>                 <span class="c1"># e.g. astype_nansafe can fail on object-dtype of strings</span>

<span class="nn">/opt/miniconda3/envs/cpsc330env/lib/python3.8/site-packages/pandas/core/dtypes/cast.py</span> in <span class="ni">astype_nansafe</span><span class="nt">(arr, dtype, copy, skipna)</span>
<span class="g g-Whitespace">    </span><span class="mi">895</span>     <span class="k">if</span> <span class="n">copy</span> <span class="ow">or</span> <span class="n">is_object_dtype</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span> <span class="ow">or</span> <span class="n">is_object_dtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">896</span>         <span class="c1"># Explicit copy, or required since NumPy can&#39;t view from / to object.</span>
<span class="ne">--&gt; </span><span class="mi">897</span>         <span class="k">return</span> <span class="n">arr</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">898</span> 
<span class="g g-Whitespace">    </span><span class="mi">899</span>     <span class="k">return</span> <span class="n">arr</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>

<span class="ne">ValueError</span>: could not convert string to float: &#39;&#39;
</pre></div>
</div>
</div>
</div>
<p>Argh!!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">df_train</span><span class="p">[</span><span class="s1">&#39;TotalCharges&#39;</span><span class="p">]:</span>
    <span class="k">try</span><span class="p">:</span> 
        <span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 
 
 
 
 
 
 
 
</pre></div>
</div>
</div>
</div>
<p>Any ideas?</p>
<p><br><br><br><br><br><br></p>
<p>Well, it turns out we can’t see those problematic values because they are whitespace!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">df_train</span><span class="p">[</span><span class="s1">&#39;TotalCharges&#39;</span><span class="p">]:</span>
    <span class="k">try</span><span class="p">:</span> 
        <span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="n">val</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&quot; &quot;
&quot; &quot;
&quot; &quot;
&quot; &quot;
&quot; &quot;
&quot; &quot;
&quot; &quot;
&quot; &quot;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_train</span> <span class="o">=</span> <span class="n">df_train</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">TotalCharges</span><span class="o">=</span><span class="n">df_train</span><span class="p">[</span><span class="s1">&#39;TotalCharges&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">))</span>
<span class="n">df_test</span> <span class="o">=</span> <span class="n">df_test</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">TotalCharges</span><span class="o">=</span><span class="n">df_test</span><span class="p">[</span><span class="s1">&#39;TotalCharges&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_train</span> <span class="o">=</span> <span class="n">df_train</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Churn&quot;</span><span class="p">])</span>
<span class="n">X_test</span> <span class="o">=</span> <span class="n">df_test</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Churn&quot;</span><span class="p">])</span>

<span class="n">y_train</span> <span class="o">=</span> <span class="n">df_train</span><span class="p">[</span><span class="s2">&quot;Churn&quot;</span><span class="p">]</span>
<span class="n">y_test</span> <span class="o">=</span> <span class="n">df_test</span><span class="p">[</span><span class="s2">&quot;Churn&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>Now that worked. But now we need to do imputation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">preprocessing</span> <span class="o">=</span> <span class="n">ColumnTransformer</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;scale&#39;</span><span class="p">,</span>  <span class="n">make_pipeline</span><span class="p">(</span><span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">),</span> <span class="n">StandardScaler</span><span class="p">()),</span> <span class="n">numeric_features</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ohe&#39;</span><span class="p">,</span>    <span class="n">OneHotEncoder</span><span class="p">(),</span> <span class="n">categorical_features</span><span class="p">)</span> 
<span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p>Now let’s try that again…</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">preprocessing</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df_train</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">new_columns</span> <span class="o">=</span> <span class="n">numeric_features</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">preprocessing</span><span class="o">.</span><span class="n">named_transformers_</span><span class="p">[</span><span class="s1">&#39;ohe&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_feature_names</span><span class="p">(</span><span class="n">categorical_features</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_train_enc</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">preprocessing</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">df_train</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">df_train</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">new_columns</span><span class="p">)</span>
<span class="n">X_test_enc</span>  <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">preprocessing</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">df_test</span><span class="p">),</span>  <span class="n">index</span><span class="o">=</span><span class="n">df_test</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>  <span class="n">columns</span><span class="o">=</span><span class="n">new_columns</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_train_enc</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>tenure</th>
      <th>MonthlyCharges</th>
      <th>TotalCharges</th>
      <th>InternetService_DSL</th>
      <th>InternetService_Fiber optic</th>
      <th>InternetService_No</th>
      <th>OnlineSecurity_No</th>
      <th>OnlineSecurity_No internet service</th>
      <th>OnlineSecurity_Yes</th>
      <th>PaymentMethod_Bank transfer (automatic)</th>
      <th>...</th>
      <th>OnlineBackup_No internet service</th>
      <th>OnlineBackup_Yes</th>
      <th>PaperlessBilling_No</th>
      <th>PaperlessBilling_Yes</th>
      <th>Contract_Month-to-month</th>
      <th>Contract_One year</th>
      <th>Contract_Two year</th>
      <th>TechSupport_No</th>
      <th>TechSupport_No internet service</th>
      <th>TechSupport_Yes</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>6464</th>
      <td>0.707712</td>
      <td>0.185175</td>
      <td>0.513678</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>5707</th>
      <td>-1.248999</td>
      <td>-0.641538</td>
      <td>-0.979562</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>3442</th>
      <td>-0.148349</td>
      <td>1.133562</td>
      <td>0.226789</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>3932</th>
      <td>-1.248999</td>
      <td>0.458524</td>
      <td>-0.950696</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>6124</th>
      <td>0.993065</td>
      <td>-0.183179</td>
      <td>0.433814</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 46 columns</p>
</div></div></div>
</div>
<p>Ok, let’s get some scores…</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dc</span> <span class="o">=</span> <span class="n">DummyClassifier</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;prior&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">cross_validate</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">return_train_score</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>fit_time       0.003828
score_time     0.001830
test_score     0.740628
train_score    0.740629
dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lr</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span><span class="n">preprocessing</span><span class="p">,</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">cross_validate</span><span class="p">(</span><span class="n">lr</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">return_train_score</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>fit_time       0.116107
score_time     0.015310
test_score     0.804429
train_score    0.808690
dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">cross_val_predict</span><span class="p">(</span><span class="n">lr</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[3516,  396],
       [ 637,  733]])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rf</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span><span class="n">preprocessing</span><span class="p">,</span> <span class="n">RandomForestClassifier</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">cross_validate</span><span class="p">(</span><span class="n">rf</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">return_train_score</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>fit_time       0.448337
score_time     0.034781
test_score     0.791368
train_score    0.997965
dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">cross_val_predict</span><span class="p">(</span><span class="n">rf</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[3512,  400],
       [ 739,  631]])
</pre></div>
</div>
</div>
</div>
<p>And now the rest of the class is about what is wrong with what we just did!</p>
</div>
<div class="section" id="censoring-and-survival-analysis-15-min">
<h2>Censoring and survival analysis (15 min)<a class="headerlink" href="#censoring-and-survival-analysis-15-min" title="Permalink to this headline">¶</a></h2>
<div class="section" id="time-to-event-and-censoring">
<h3>Time to event and censoring<a class="headerlink" href="#time-to-event-and-censoring" title="Permalink to this headline">¶</a></h3>
<p>Imagine that you want to analyze <em>the time until an event occurs</em>. For example,</p>
<ul class="simple">
<li><p>the time until a disease kills its host.</p></li>
<li><p>the time until a piece of equipment breaks.</p></li>
<li><p>the time that someone unemployed will take to land a new job.</p></li>
<li><p>the time until a customer leaves a subscription service (this dataset).</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_train</span><span class="p">[[</span><span class="s2">&quot;tenure&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>tenure</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>6464</th>
      <td>50</td>
    </tr>
    <tr>
      <th>5707</th>
      <td>2</td>
    </tr>
    <tr>
      <th>3442</th>
      <td>29</td>
    </tr>
    <tr>
      <th>3932</th>
      <td>2</td>
    </tr>
    <tr>
      <th>6124</th>
      <td>57</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>This column is the number of months the customer has stayed with the company.</p>
<p>Although this branch of statistics is usually referred to as <strong>Survival Analysis</strong>, the event in question does not need to be related to actual “survival”. The important thing is to understand that we are interested in <strong>the time until something happens</strong>, or whether or not something will happen in a certain time frame.</p>
<p><strong>Question:</strong> But why is this different? Can’t you just use the techniques you learned so far (e.g., regression models) to predict the time? Take a minute to think about this.</p>
<p><br><br><br><br><br><br></p>
<p>The answer would be yes if you could observe the actual time in all occurrences, but you usually cannot. Frequently, there will be some kind of <strong>censoring</strong> which will not allow you to observe the exact time that the event happened for all units/individuals that are being studied.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_train</span><span class="p">[[</span><span class="s2">&quot;tenure&quot;</span><span class="p">,</span> <span class="s2">&quot;Churn&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>tenure</th>
      <th>Churn</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>6464</th>
      <td>50</td>
      <td>No</td>
    </tr>
    <tr>
      <th>5707</th>
      <td>2</td>
      <td>No</td>
    </tr>
    <tr>
      <th>3442</th>
      <td>29</td>
      <td>No</td>
    </tr>
    <tr>
      <th>3932</th>
      <td>2</td>
      <td>Yes</td>
    </tr>
    <tr>
      <th>6124</th>
      <td>57</td>
      <td>No</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<ul class="simple">
<li><p>What this means is that we <strong>don’t have correct target values</strong> to train or test our model.</p></li>
<li><p>This is a problem!</p></li>
</ul>
<p>Let’s consider some approaches to deal with this censoring issue.</p>
</div>
<div class="section" id="approach-1">
<h3>Approach 1<a class="headerlink" href="#approach-1" title="Permalink to this headline">¶</a></h3>
<p>Let’s just consider the cases <em>for which we have the time</em>, to obtain the average subscription length.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_train_churn</span> <span class="o">=</span> <span class="n">df_train</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Churn == &#39;Yes&#39;&quot;</span><span class="p">)</span>
<span class="n">df_test_churn</span> <span class="o">=</span> <span class="n">df_test</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Churn == &#39;Yes&#39;&quot;</span><span class="p">)</span>
<span class="n">df_train_churn</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>customerID</th>
      <th>gender</th>
      <th>SeniorCitizen</th>
      <th>Partner</th>
      <th>Dependents</th>
      <th>tenure</th>
      <th>PhoneService</th>
      <th>MultipleLines</th>
      <th>InternetService</th>
      <th>OnlineSecurity</th>
      <th>...</th>
      <th>DeviceProtection</th>
      <th>TechSupport</th>
      <th>StreamingTV</th>
      <th>StreamingMovies</th>
      <th>Contract</th>
      <th>PaperlessBilling</th>
      <th>PaymentMethod</th>
      <th>MonthlyCharges</th>
      <th>TotalCharges</th>
      <th>Churn</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>3932</th>
      <td>1304-NECVQ</td>
      <td>Female</td>
      <td>1</td>
      <td>No</td>
      <td>No</td>
      <td>2</td>
      <td>Yes</td>
      <td>Yes</td>
      <td>Fiber optic</td>
      <td>No</td>
      <td>...</td>
      <td>Yes</td>
      <td>No</td>
      <td>No</td>
      <td>No</td>
      <td>Month-to-month</td>
      <td>Yes</td>
      <td>Electronic check</td>
      <td>78.55</td>
      <td>149.55</td>
      <td>Yes</td>
    </tr>
    <tr>
      <th>301</th>
      <td>8098-LLAZX</td>
      <td>Female</td>
      <td>1</td>
      <td>No</td>
      <td>No</td>
      <td>4</td>
      <td>Yes</td>
      <td>Yes</td>
      <td>Fiber optic</td>
      <td>No</td>
      <td>...</td>
      <td>No</td>
      <td>No</td>
      <td>Yes</td>
      <td>Yes</td>
      <td>Month-to-month</td>
      <td>Yes</td>
      <td>Electronic check</td>
      <td>95.45</td>
      <td>396.10</td>
      <td>Yes</td>
    </tr>
    <tr>
      <th>5540</th>
      <td>3803-KMQFW</td>
      <td>Female</td>
      <td>0</td>
      <td>Yes</td>
      <td>Yes</td>
      <td>1</td>
      <td>Yes</td>
      <td>No</td>
      <td>No</td>
      <td>No internet service</td>
      <td>...</td>
      <td>No internet service</td>
      <td>No internet service</td>
      <td>No internet service</td>
      <td>No internet service</td>
      <td>Month-to-month</td>
      <td>No</td>
      <td>Mailed check</td>
      <td>20.55</td>
      <td>20.55</td>
      <td>Yes</td>
    </tr>
    <tr>
      <th>4084</th>
      <td>2777-PHDEI</td>
      <td>Female</td>
      <td>0</td>
      <td>No</td>
      <td>No</td>
      <td>1</td>
      <td>Yes</td>
      <td>No</td>
      <td>Fiber optic</td>
      <td>No</td>
      <td>...</td>
      <td>No</td>
      <td>No</td>
      <td>Yes</td>
      <td>No</td>
      <td>Month-to-month</td>
      <td>No</td>
      <td>Electronic check</td>
      <td>78.05</td>
      <td>78.05</td>
      <td>Yes</td>
    </tr>
    <tr>
      <th>3272</th>
      <td>6772-KSATR</td>
      <td>Male</td>
      <td>0</td>
      <td>No</td>
      <td>No</td>
      <td>1</td>
      <td>Yes</td>
      <td>Yes</td>
      <td>Fiber optic</td>
      <td>Yes</td>
      <td>...</td>
      <td>No</td>
      <td>No</td>
      <td>No</td>
      <td>No</td>
      <td>Month-to-month</td>
      <td>Yes</td>
      <td>Electronic check</td>
      <td>81.70</td>
      <td>81.70</td>
      <td>Yes</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 21 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_train</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(5282, 21)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_train_churn</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(1370, 21)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">preprocessing_notenure</span> <span class="o">=</span> <span class="n">ColumnTransformer</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;scale&#39;</span><span class="p">,</span>  <span class="n">make_pipeline</span><span class="p">(</span><span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">),</span> <span class="n">StandardScaler</span><span class="p">()),</span> <span class="n">numeric_features</span><span class="p">[</span><span class="mi">1</span><span class="p">:]),</span>
    <span class="p">(</span><span class="s1">&#39;ohe&#39;</span><span class="p">,</span>    <span class="n">OneHotEncoder</span><span class="p">(),</span> <span class="n">categorical_features</span><span class="p">)</span> 
<span class="p">])</span>

<span class="n">tenure_lm</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span><span class="n">preprocessing_notenure</span><span class="p">,</span> <span class="n">Ridge</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tenure_lm</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df_train_churn</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;tenure&quot;</span><span class="p">]),</span> <span class="n">df_train_churn</span><span class="p">[</span><span class="s2">&quot;tenure&quot;</span><span class="p">]);</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tenure_lm</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">df_test_churn</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;tenure&quot;</span><span class="p">]))[:</span><span class="mi">10</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([ 5.06220341, 13.19842594, 11.86000915,  5.86549339, 58.15531207,
        3.75777597, 18.93218848,  7.72057413, 36.81845697,  7.26344075])
</pre></div>
</div>
</div>
</div>
<p>What will be wrong with our estimated survival times? Will they be too low or too high?
<br><br><br><br><br><br><br></p>
<p>On average they will be <strong>underestimates</strong> (too small), because we are ignoring the currently subscribed (un-churned) customers. Our dataset is a biased sample of those who churned within the time window of the data collection. Long-time subscribers were more likely to be removed from the dataset! This is a common mistake - see the Calling Bullshit video I posted on the README!</p>
</div>
<div class="section" id="approach-2">
<h3>Approach 2<a class="headerlink" href="#approach-2" title="Permalink to this headline">¶</a></h3>
<p>Assume everyone churns right now - in other words, use the original dataset.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tenure_lm</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df_train</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;tenure&quot;</span><span class="p">]),</span> <span class="n">df_train</span><span class="p">[</span><span class="s2">&quot;tenure&quot;</span><span class="p">]);</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tenure_lm</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">df_test</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;tenure&quot;</span><span class="p">]))[:</span><span class="mi">10</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([20.56929697, 40.65520509, 31.52902413, 36.16312437, 41.8706012 ,
       37.98663577, 17.47753169, 54.68983917, 48.1412576 , 71.23988875])
</pre></div>
</div>
</div>
</div>
<p>What will be wrong with our estimated survival time?
<br><br><br><br><br><br></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_train</span><span class="p">[[</span><span class="s2">&quot;tenure&quot;</span><span class="p">,</span> <span class="s2">&quot;Churn&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>tenure</th>
      <th>Churn</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>6464</th>
      <td>50</td>
      <td>No</td>
    </tr>
    <tr>
      <th>5707</th>
      <td>2</td>
      <td>No</td>
    </tr>
    <tr>
      <th>3442</th>
      <td>29</td>
      <td>No</td>
    </tr>
    <tr>
      <th>3932</th>
      <td>2</td>
      <td>Yes</td>
    </tr>
    <tr>
      <th>6124</th>
      <td>57</td>
      <td>No</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>It will be an <strong>underestimate</strong> again. For those still subscribed, while we did not remove them, we recorded a total tenure shorter than in reality, because they will keep going for some amount of time. because we have a bunch of churns “now” that did not actually happen.</p>
</div>
<div class="section" id="approach-3">
<h3>Approach 3<a class="headerlink" href="#approach-3" title="Permalink to this headline">¶</a></h3>
<p>Deal with this properly using <a class="reference external" href="https://en.wikipedia.org/wiki/Survival_analysis">survival analysis</a>.</p>
<ul class="simple">
<li><p>You may learn about this in a statistics course.</p></li>
<li><p>We will use the <code class="docutils literal notranslate"><span class="pre">lifelines</span></code> package in Python and will not go into the math/stats of how it works.</p></li>
</ul>
</div>
<div class="section" id="types-of-questions-we-might-want-to-answer">
<h3>Types of questions we might want to answer:<a class="headerlink" href="#types-of-questions-we-might-want-to-answer" title="Permalink to this headline">¶</a></h3>
<ol class="simple">
<li><p>How long do customers stay with the service?</p></li>
<li><p>What factors influence a customer’s churn time?</p></li>
<li><p>For a particular customer, can we predict how long they might stay with the service?</p></li>
</ol>
</div>
</div>
<div class="section" id="break-5-min">
<h2>Break (5 min)<a class="headerlink" href="#break-5-min" title="Permalink to this headline">¶</a></h2>
<p>REMINDER TO TURN ON RECORDING</p>
</div>
<div class="section" id="kaplan-meier-survival-curve-10-min">
<h2>Kaplan-Meier survival curve (10 min)<a class="headerlink" href="#kaplan-meier-survival-curve-10-min" title="Permalink to this headline">¶</a></h2>
<p>Before we do anything further, I want to modify our dataset slightly:</p>
<ol class="simple">
<li><p>I’m going to drop the <code class="docutils literal notranslate"><span class="pre">TotalCharges</span></code> (yes, after all that work fixing it) because it’s a bit of a strange feature.</p></li>
</ol>
<ul class="simple">
<li><p>Its value actually changes over time, but we only have the value at the end.</p></li>
<li><p>We still have <code class="docutils literal notranslate"><span class="pre">MonthlyCharges</span></code>.</p></li>
</ul>
<ol class="simple">
<li><p>I’m going to not scale the <code class="docutils literal notranslate"><span class="pre">tenure</span></code> column, since it will be convenient to keep it in its original units of months.</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">numeric_features</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;tenure&#39;, &#39;MonthlyCharges&#39;, &#39;TotalCharges&#39;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">preprocessing_final</span> <span class="o">=</span> <span class="n">make_column_transformer</span><span class="p">(</span>
    <span class="p">(</span><span class="s1">&#39;passthrough&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;tenure&#39;</span><span class="p">]),</span> 
    <span class="p">(</span><span class="n">FunctionTransformer</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">==</span> <span class="s2">&quot;Yes&quot;</span><span class="p">),</span> <span class="p">[</span><span class="s1">&#39;Churn&#39;</span><span class="p">]),</span>
    <span class="p">(</span><span class="s1">&#39;drop&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;TotalCharges&#39;</span><span class="p">]),</span>
    <span class="p">(</span><span class="n">StandardScaler</span><span class="p">(),</span> <span class="p">[</span><span class="s1">&#39;MonthlyCharges&#39;</span><span class="p">]),</span>
    <span class="p">(</span><span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="s1">&#39;if_binary&#39;</span><span class="p">),</span> <span class="n">categorical_features</span><span class="p">)</span> 
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">preprocessing_final</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df_train</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">new_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;tenure&#39;</span><span class="p">,</span> <span class="s1">&#39;Churn&#39;</span><span class="p">,</span> <span class="s1">&#39;MonthlyCharges&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">preprocessing_final</span><span class="o">.</span><span class="n">named_transformers_</span><span class="p">[</span><span class="s1">&#39;onehotencoder&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_feature_names</span><span class="p">(</span><span class="n">categorical_features</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_train_surv</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">preprocessing_final</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">df_train</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">df_train</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">new_columns</span><span class="p">)</span>
<span class="n">df_test_surv</span>  <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">preprocessing_final</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">df_test</span><span class="p">),</span>  <span class="n">index</span><span class="o">=</span><span class="n">df_test</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>  <span class="n">columns</span><span class="o">=</span><span class="n">new_columns</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_train_surv</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>tenure</th>
      <th>Churn</th>
      <th>MonthlyCharges</th>
      <th>InternetService_DSL</th>
      <th>InternetService_Fiber optic</th>
      <th>InternetService_No</th>
      <th>OnlineSecurity_No</th>
      <th>OnlineSecurity_No internet service</th>
      <th>OnlineSecurity_Yes</th>
      <th>PaymentMethod_Bank transfer (automatic)</th>
      <th>...</th>
      <th>OnlineBackup_No</th>
      <th>OnlineBackup_No internet service</th>
      <th>OnlineBackup_Yes</th>
      <th>PaperlessBilling_Yes</th>
      <th>Contract_Month-to-month</th>
      <th>Contract_One year</th>
      <th>Contract_Two year</th>
      <th>TechSupport_No</th>
      <th>TechSupport_No internet service</th>
      <th>TechSupport_Yes</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>6464</th>
      <td>50.0</td>
      <td>0.0</td>
      <td>0.185175</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>5707</th>
      <td>2.0</td>
      <td>0.0</td>
      <td>-0.641538</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>3442</th>
      <td>29.0</td>
      <td>0.0</td>
      <td>1.133562</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>3932</th>
      <td>2.0</td>
      <td>1.0</td>
      <td>0.458524</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>6124</th>
      <td>57.0</td>
      <td>0.0</td>
      <td>-0.183179</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 40 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">kmf</span> <span class="o">=</span> <span class="n">lifelines</span><span class="o">.</span><span class="n">KaplanMeierFitter</span><span class="p">()</span>
<span class="n">kmf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df_train_surv</span><span class="p">[</span><span class="s2">&quot;tenure&quot;</span><span class="p">],</span> <span class="n">df_train_surv</span><span class="p">[</span><span class="s2">&quot;Churn&quot;</span><span class="p">]);</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">kmf</span><span class="o">.</span><span class="n">survival_function_</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Survival function of customer churn&#39;</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Time with service (months)&#39;</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Survival probability&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/19_survival-analysis_93_0.png" src="../_images/19_survival-analysis_93_0.png" />
</div>
</div>
<ul class="simple">
<li><p>What is this plot telling us?</p></li>
<li><p>It is the probability of survival over time.</p></li>
<li><p>This is around 0.6 at the end, but…</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y_train</span> <span class="o">==</span> <span class="s1">&#39;No&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.7406285497917455
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">df_train_surv</span><span class="p">[</span><span class="s2">&quot;tenure&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>32.6391518364256
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">df_train_surv</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Churn == &#39;1&#39;&quot;</span><span class="p">)[</span><span class="s2">&quot;tenure&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>17.854744525547446
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">df_train_surv</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Churn == &#39;0&#39;&quot;</span><span class="p">)[</span><span class="s2">&quot;tenure&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>37.816717791411044
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>…but 73% of customers “survived” (did not churn) in our dataset. So, shouldn’t our plot go down to 73%.</p></li>
<li><p>It goes lower, to ~60%, because some customers churned in less than 70 months.</p></li>
<li><p>Thus, the <em>probability</em> of churning in 70 months is larger than our fraction who churned.</p>
<ul>
<li><p>Or, conversely, the probability of survival after 70 months is lower than the fraction of stayed.</p></li>
</ul>
</li>
</ul>
<p>The key point here is that people <em>joined at different times</em>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_train</span><span class="p">[</span><span class="n">y_train</span> <span class="o">==</span> <span class="s1">&#39;No&#39;</span><span class="p">][</span><span class="s2">&quot;tenure&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">grid</span><span class="o">=</span><span class="kc">False</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;months&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/19_survival-analysis_101_0.png" src="../_images/19_survival-analysis_101_0.png" />
</div>
</div>
<ul class="simple">
<li><p>Since the data was collected at a fixed time and these are the people who hadn’t yet churned, those with larger <code class="docutils literal notranslate"><span class="pre">tenure</span></code> values here must have joined earlier.</p></li>
<li><p>This is a bit subtle but an important point - questions?</p></li>
</ul>
<p>Lifelines can also give us some “error bars”:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">kmf</span><span class="o">.</span><span class="n">plot</span><span class="p">();</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Survival function of customer churn&#39;</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Time with service (months)&#39;</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Survival probability&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/19_survival-analysis_104_0.png" src="../_images/19_survival-analysis_104_0.png" />
</div>
</div>
<ul class="simple">
<li><p>We already have some actionable information here.</p></li>
<li><p>BTW, the <a class="reference external" href="https://web.stanford.edu/~lutian/coursepdf/KMpaper.pdf">original paper by Kaplan and Meier</a> has been cited over 57000 times!</p></li>
</ul>
<p>We can also create the K-M curve for different subgroups:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">T</span> <span class="o">=</span> <span class="n">df_train_surv</span><span class="p">[</span><span class="s2">&quot;tenure&quot;</span><span class="p">]</span>
<span class="n">E</span> <span class="o">=</span> <span class="n">df_train_surv</span><span class="p">[</span><span class="s2">&quot;Churn&quot;</span><span class="p">]</span>
<span class="n">senior</span> <span class="o">=</span> <span class="n">df_train_surv</span><span class="p">[</span><span class="s2">&quot;SeniorCitizen_1&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>

<span class="n">kmf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">T</span><span class="p">[</span><span class="n">senior</span><span class="p">],</span> <span class="n">event_observed</span><span class="o">=</span><span class="n">E</span><span class="p">[</span><span class="n">senior</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Senior Citizens&quot;</span><span class="p">)</span>
<span class="n">kmf</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

<span class="n">kmf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">T</span><span class="p">[</span><span class="o">~</span><span class="n">senior</span><span class="p">],</span> <span class="n">event_observed</span><span class="o">=</span><span class="n">E</span><span class="p">[</span><span class="o">~</span><span class="n">senior</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Non-Senior Citizens&quot;</span><span class="p">)</span>
<span class="n">kmf</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Time with service (months)&#39;</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Survival probability&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/19_survival-analysis_108_0.png" src="../_images/19_survival-analysis_108_0.png" />
</div>
</div>
<ul class="simple">
<li><p>It looks like senior citizens churn more quickly than others.</p></li>
<li><p>This is quite useful!</p></li>
</ul>
</div>
<div class="section" id="cox-proportional-hazards-model-10-min">
<h2>Cox proportional hazards model (10 min)<a class="headerlink" href="#cox-proportional-hazards-model-10-min" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>The Cox proportional hazards model is a commonly used model that allows us to interpret how features influence a censored tenure/duration.</p></li>
<li><p>You can think of it like linear regression for survival analysis: we will get a coefficient for each feature that tells us how it influences survival.</p></li>
<li><p>It makes some strong assumptions (the proportional hazards assumption) that may not be true, but we won’t go into this here.</p></li>
<li><p>The proportional hazard model works multiplicatively, like linear regression with log-transformed targets.</p></li>
</ul>
<div class="cell tag_raises-exception docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cph</span> <span class="o">=</span> <span class="n">lifelines</span><span class="o">.</span><span class="n">CoxPHFitter</span><span class="p">()</span>
<span class="n">cph</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df_train_surv</span><span class="p">,</span> <span class="n">duration_col</span><span class="o">=</span><span class="s1">&#39;tenure&#39;</span><span class="p">,</span> <span class="n">event_col</span><span class="o">=</span><span class="s1">&#39;Churn&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">LinAlgError</span><span class="g g-Whitespace">                               </span>Traceback (most recent call last)
<span class="nn">/opt/miniconda3/envs/cpsc330env/lib/python3.8/site-packages/lifelines/fitters/coxph_fitter.py</span> in <span class="ni">_newton_rhapson_for_efron_model</span><span class="nt">(self, X, T, E, weights, entries, initial_point, step_size, precision, show_progress, max_steps)</span>
<span class="g g-Whitespace">   </span><span class="mi">1184</span>             <span class="k">try</span><span class="p">:</span>
<span class="ne">-&gt; </span><span class="mi">1185</span>                 <span class="n">inv_h_dot_g_T</span> <span class="o">=</span> <span class="n">spsolve</span><span class="p">(</span><span class="o">-</span><span class="n">h</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">assume_a</span><span class="o">=</span><span class="s2">&quot;pos&quot;</span><span class="p">,</span> <span class="n">check_finite</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1186</span>             <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">LinAlgError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>

<span class="nn">/opt/miniconda3/envs/cpsc330env/lib/python3.8/site-packages/scipy/linalg/basic.py</span> in <span class="ni">solve</span><span class="nt">(a, b, sym_pos, lower, overwrite_a, overwrite_b, debug, check_finite, assume_a, transposed)</span>
<span class="g g-Whitespace">    </span><span class="mi">247</span>                            <span class="n">overwrite_b</span><span class="o">=</span><span class="n">overwrite_b</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">248</span>         <span class="n">_solve_check</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">249</span>         <span class="n">rcond</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">pocon</span><span class="p">(</span><span class="n">lu</span><span class="p">,</span> <span class="n">anorm</span><span class="p">)</span>

<span class="nn">/opt/miniconda3/envs/cpsc330env/lib/python3.8/site-packages/scipy/linalg/basic.py</span> in <span class="ni">_solve_check</span><span class="nt">(n, info, lamch, rcond)</span>
<span class="g g-Whitespace">     </span><span class="mi">28</span>     <span class="k">elif</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">info</span><span class="p">:</span>
<span class="ne">---&gt; </span><span class="mi">29</span>         <span class="k">raise</span> <span class="n">LinAlgError</span><span class="p">(</span><span class="s1">&#39;Matrix is singular.&#39;</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">30</span> 

<span class="ne">LinAlgError</span>: Matrix is singular.

<span class="n">During</span> <span class="n">handling</span> <span class="n">of</span> <span class="n">the</span> <span class="n">above</span> <span class="n">exception</span><span class="p">,</span> <span class="n">another</span> <span class="n">exception</span> <span class="n">occurred</span><span class="p">:</span>

<span class="ne">ConvergenceError</span><span class="g g-Whitespace">                          </span>Traceback (most recent call last)
<span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">77</span><span class="o">-</span><span class="n">ae0c946a049b</span><span class="o">&gt;</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="n">cph</span> <span class="o">=</span> <span class="n">lifelines</span><span class="o">.</span><span class="n">CoxPHFitter</span><span class="p">()</span>
<span class="ne">----&gt; </span><span class="mi">2</span> <span class="n">cph</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df_train_surv</span><span class="p">,</span> <span class="n">duration_col</span><span class="o">=</span><span class="s1">&#39;tenure&#39;</span><span class="p">,</span> <span class="n">event_col</span><span class="o">=</span><span class="s1">&#39;Churn&#39;</span><span class="p">);</span>

<span class="nn">/opt/miniconda3/envs/cpsc330env/lib/python3.8/site-packages/lifelines/utils/__init__.py</span> in <span class="ni">f</span><span class="nt">(model, *args, **kwargs)</span>
<span class="g g-Whitespace">     </span><span class="mi">52</span>         <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="g g-Whitespace">     </span><span class="mi">53</span>             <span class="bp">cls</span><span class="o">.</span><span class="n">set_censoring_type</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">RIGHT</span><span class="p">)</span>
<span class="ne">---&gt; </span><span class="mi">54</span>             <span class="k">return</span> <span class="n">function</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">55</span> 
<span class="g g-Whitespace">     </span><span class="mi">56</span>         <span class="k">return</span> <span class="n">f</span>

<span class="nn">/opt/miniconda3/envs/cpsc330env/lib/python3.8/site-packages/lifelines/fitters/coxph_fitter.py</span> in <span class="ni">fit</span><span class="nt">(self, df, duration_col, event_col, show_progress, initial_point, strata, step_size, weights_col, cluster_col, robust, batch_mode, timeline, formula, entry_col)</span>
<span class="g g-Whitespace">    </span><span class="mi">274</span>         <span class="sd">&quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">275</span><span class="sd">         self.strata = utils.coalesce(strata, self.strata)</span>
<span class="ne">--&gt; </span><span class="mi">276</span><span class="sd">         self._model = self._fit_model(</span>
<span class="g g-Whitespace">    </span><span class="mi">277</span><span class="sd">             df,</span>
<span class="g g-Whitespace">    </span><span class="mi">278</span><span class="sd">             duration_col,</span>

<span class="nn">/opt/miniconda3/envs/cpsc330env/lib/python3.8/site-packages/lifelines/fitters/coxph_fitter.py</span> in <span class="ni">_fit_model</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">307</span><span class="sd">     def _fit_model(self, *args, **kwargs):</span>
<span class="g g-Whitespace">    </span><span class="mi">308</span><span class="sd">         if self.baseline_estimation_method == &quot;breslow&quot;:</span>
<span class="ne">--&gt; </span><span class="mi">309</span><span class="sd">             return self._fit_model_breslow(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">310</span><span class="sd">         elif self.baseline_estimation_method == &quot;spline&quot;:</span>
<span class="g g-Whitespace">    </span><span class="mi">311</span><span class="sd">             return self._fit_model_spline(*args, **kwargs)</span>

<span class="nn">/opt/miniconda3/envs/cpsc330env/lib/python3.8/site-packages/lifelines/fitters/coxph_fitter.py</span> in <span class="ni">_fit_model_breslow</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">319</span><span class="sd">             penalizer=self.penalizer, l1_ratio=self.l1_ratio, strata=self.strata, alpha=self.alpha, label=self._label</span>
<span class="g g-Whitespace">    </span><span class="mi">320</span><span class="sd">         )</span>
<span class="ne">--&gt; </span><span class="mi">321</span><span class="sd">         model.fit(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">322</span><span class="sd">         return model</span>
<span class="g g-Whitespace">    </span><span class="mi">323</span><span class="sd"> </span>

<span class="nn">/opt/miniconda3/envs/cpsc330env/lib/python3.8/site-packages/lifelines/utils/__init__.py</span> in <span class="ni">f</span><span class="nt">(model, *args, **kwargs)</span>
<span class="g g-Whitespace">     </span><span class="mi">52</span><span class="sd">         def f(model, *args, **kwargs):</span>
<span class="g g-Whitespace">     </span><span class="mi">53</span><span class="sd">             cls.set_censoring_type(model, cls.RIGHT)</span>
<span class="ne">---&gt; </span><span class="mi">54</span><span class="sd">             return function(model, *args, **kwargs)</span>
<span class="g g-Whitespace">     </span><span class="mi">55</span><span class="sd"> </span>
<span class="g g-Whitespace">     </span><span class="mi">56</span><span class="sd">         return f</span>

<span class="nn">/opt/miniconda3/envs/cpsc330env/lib/python3.8/site-packages/lifelines/fitters/coxph_fitter.py</span> in <span class="ni">fit</span><span class="nt">(self, df, duration_col, event_col, show_progress, initial_point, strata, step_size, weights_col, cluster_col, robust, batch_mode, timeline, formula, entry_col)</span>
<span class="g g-Whitespace">    </span><span class="mi">915</span><span class="sd">         )</span>
<span class="g g-Whitespace">    </span><span class="mi">916</span><span class="sd"> </span>
<span class="ne">--&gt; </span><span class="mi">917</span><span class="sd">         params_, ll_, variance_matrix_, baseline_hazard_, baseline_cumulative_hazard_, model = self._fit_model(</span>
<span class="g g-Whitespace">    </span><span class="mi">918</span><span class="sd">             X_norm,</span>
<span class="g g-Whitespace">    </span><span class="mi">919</span><span class="sd">             T,</span>

<span class="nn">/opt/miniconda3/envs/cpsc330env/lib/python3.8/site-packages/lifelines/fitters/coxph_fitter.py</span> in <span class="ni">_fit_model</span><span class="nt">(self, X, T, E, weights, entries, initial_point, step_size, show_progress)</span>
<span class="g g-Whitespace">   </span><span class="mi">1040</span><span class="sd">         show_progress: bool = True,</span>
<span class="g g-Whitespace">   </span><span class="mi">1041</span><span class="sd">     ):</span>
<span class="ne">-&gt; </span><span class="mi">1042</span><span class="sd">         beta_, ll_, hessian_ = self._newton_rhapson_for_efron_model(</span>
<span class="g g-Whitespace">   </span><span class="mi">1043</span><span class="sd">             X, T, E, weights, entries, initial_point=initial_point, step_size=step_size, show_progress=show_progress</span>
<span class="g g-Whitespace">   </span><span class="mi">1044</span><span class="sd">         )</span>

<span class="nn">/opt/miniconda3/envs/cpsc330env/lib/python3.8/site-packages/lifelines/fitters/coxph_fitter.py</span> in <span class="ni">_newton_rhapson_for_efron_model</span><span class="nt">(self, X, T, E, weights, entries, initial_point, step_size, precision, show_progress, max_steps)</span>
<span class="g g-Whitespace">   </span><span class="mi">1192</span><span class="sd">                     )</span>
<span class="g g-Whitespace">   </span><span class="mi">1193</span><span class="sd">                 elif isinstance(e, LinAlgError):</span>
<span class="ne">-&gt; </span><span class="mi">1194</span><span class="sd">                     raise exceptions.ConvergenceError(</span>
<span class="g g-Whitespace">   </span><span class="mi">1195</span><span class="sd">                         &quot;&quot;&quot;</span><span class="n">Convergence</span> <span class="n">halted</span> <span class="n">due</span> <span class="n">to</span> <span class="n">matrix</span> <span class="n">inversion</span> <span class="n">problems</span><span class="o">.</span> <span class="n">Suspicion</span> <span class="ow">is</span> <span class="n">high</span> <span class="n">collinearity</span><span class="o">.</span> <span class="p">{</span><span class="mi">0</span><span class="p">}</span><span class="s2">&quot;&quot;&quot;.format(</span>
<span class="g g-Whitespace">   </span><span class="mi">1196</span><span class="s2">                             CONVERGENCE_DOCS</span>

<span class="ne">ConvergenceError</span>: Convergence halted due to matrix inversion problems. Suspicion is high collinearity. Please see the following tips in the lifelines documentation: https://lifelines.readthedocs.io/en/latest/Examples.html#problems-with-convergence-in-the-cox-proportional-hazard-modelMatrix is singular.
</pre></div>
</div>
</div>
</div>
<p><img alt="" src="../_images/mike_funtimes.png" /></p>
<ul class="simple">
<li><p>Ok, going that <a class="reference external" href="https://lifelines.readthedocs.io/en/latest/Examples.html#problems-with-convergence-in-the-cox-proportional-hazard-model">that URL</a>, it seems the easiest solution is to add a penalizer.</p>
<ul>
<li><p>FYI this is related to switching from <code class="docutils literal notranslate"><span class="pre">LinearRegression</span></code> to <code class="docutils literal notranslate"><span class="pre">Ridge</span></code>.</p></li>
<li><p>Adding <code class="docutils literal notranslate"><span class="pre">drop='first'</span></code> on our OHE might have helped with this.</p></li>
<li><p>(For 340 folks: we’re adding regularization; <code class="docutils literal notranslate"><span class="pre">lifelines</span></code> adds both L1 and L2 regularization, aka elastic net)</p></li>
</ul>
</li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cph</span> <span class="o">=</span> <span class="n">lifelines</span><span class="o">.</span><span class="n">CoxPHFitter</span><span class="p">(</span><span class="n">penalizer</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">cph</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df_train_surv</span><span class="p">,</span> <span class="n">duration_col</span><span class="o">=</span><span class="s1">&#39;tenure&#39;</span><span class="p">,</span> <span class="n">event_col</span><span class="o">=</span><span class="s1">&#39;Churn&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cph_params</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">cph</span><span class="o">.</span><span class="n">params_</span><span class="p">)</span>
<span class="n">cph_params</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;coef&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>coef</th>
    </tr>
    <tr>
      <th>covariate</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Contract_Month-to-month</th>
      <td>0.817158</td>
    </tr>
    <tr>
      <th>OnlineSecurity_No</th>
      <td>0.313812</td>
    </tr>
    <tr>
      <th>OnlineBackup_No</th>
      <td>0.300171</td>
    </tr>
    <tr>
      <th>PaymentMethod_Electronic check</th>
      <td>0.281481</td>
    </tr>
    <tr>
      <th>TechSupport_No</th>
      <td>0.212638</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
    </tr>
    <tr>
      <th>PaymentMethod_Credit card (automatic)</th>
      <td>-0.301786</td>
    </tr>
    <tr>
      <th>OnlineSecurity_Yes</th>
      <td>-0.332959</td>
    </tr>
    <tr>
      <th>Contract_One year</th>
      <td>-0.353184</td>
    </tr>
    <tr>
      <th>Partner_Yes</th>
      <td>-0.413941</td>
    </tr>
    <tr>
      <th>Contract_Two year</th>
      <td>-0.780959</td>
    </tr>
  </tbody>
</table>
<p>38 rows × 1 columns</p>
</div></div></div>
</div>
<ul class="simple">
<li><p>We can start to interpret these!</p></li>
<li><p>Looks like month-to-month leads to more churn, two-year contract leads to less churn; this makes sense!!!</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># cph.baseline_hazard_ # baseline hazard</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cph</span><span class="o">.</span><span class="n">summary</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>coef</th>
      <th>exp(coef)</th>
      <th>se(coef)</th>
      <th>coef lower 95%</th>
      <th>coef upper 95%</th>
      <th>exp(coef) lower 95%</th>
      <th>exp(coef) upper 95%</th>
      <th>z</th>
      <th>p</th>
      <th>-log2(p)</th>
    </tr>
    <tr>
      <th>covariate</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>MonthlyCharges</th>
      <td>-0.003597</td>
      <td>0.996409</td>
      <td>0.040010</td>
      <td>-0.082015</td>
      <td>0.074820</td>
      <td>0.921258</td>
      <td>1.077691</td>
      <td>-0.089912</td>
      <td>9.283573e-01</td>
      <td>0.107248</td>
    </tr>
    <tr>
      <th>InternetService_DSL</th>
      <td>-0.160578</td>
      <td>0.851651</td>
      <td>0.072205</td>
      <td>-0.302097</td>
      <td>-0.019060</td>
      <td>0.739267</td>
      <td>0.981121</td>
      <td>-2.223935</td>
      <td>2.615284e-02</td>
      <td>5.256889</td>
    </tr>
    <tr>
      <th>InternetService_Fiber optic</th>
      <td>0.186995</td>
      <td>1.205622</td>
      <td>0.071461</td>
      <td>0.046934</td>
      <td>0.327057</td>
      <td>1.048053</td>
      <td>1.386880</td>
      <td>2.616742</td>
      <td>8.877350e-03</td>
      <td>6.815655</td>
    </tr>
    <tr>
      <th>InternetService_No</th>
      <td>-0.058015</td>
      <td>0.943636</td>
      <td>0.100965</td>
      <td>-0.255901</td>
      <td>0.139872</td>
      <td>0.774218</td>
      <td>1.150127</td>
      <td>-0.574603</td>
      <td>5.655596e-01</td>
      <td>0.822249</td>
    </tr>
    <tr>
      <th>OnlineSecurity_No</th>
      <td>0.313812</td>
      <td>1.368632</td>
      <td>0.069632</td>
      <td>0.177335</td>
      <td>0.450288</td>
      <td>1.194032</td>
      <td>1.568764</td>
      <td>4.506713</td>
      <td>6.583963e-06</td>
      <td>17.212612</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>Contract_One year</th>
      <td>-0.353184</td>
      <td>0.702448</td>
      <td>0.077743</td>
      <td>-0.505558</td>
      <td>-0.200809</td>
      <td>0.603169</td>
      <td>0.818068</td>
      <td>-4.542944</td>
      <td>5.547410e-06</td>
      <td>17.459754</td>
    </tr>
    <tr>
      <th>Contract_Two year</th>
      <td>-0.780959</td>
      <td>0.457967</td>
      <td>0.081116</td>
      <td>-0.939943</td>
      <td>-0.621974</td>
      <td>0.390650</td>
      <td>0.536884</td>
      <td>-9.627673</td>
      <td>6.109722e-22</td>
      <td>70.471311</td>
    </tr>
    <tr>
      <th>TechSupport_No</th>
      <td>0.212638</td>
      <td>1.236937</td>
      <td>0.069651</td>
      <td>0.076125</td>
      <td>0.349152</td>
      <td>1.079097</td>
      <td>1.417865</td>
      <td>3.052913</td>
      <td>2.266315e-03</td>
      <td>8.785436</td>
    </tr>
    <tr>
      <th>TechSupport_No internet service</th>
      <td>-0.058015</td>
      <td>0.943636</td>
      <td>0.100965</td>
      <td>-0.255901</td>
      <td>0.139872</td>
      <td>0.774218</td>
      <td>1.150127</td>
      <td>-0.574603</td>
      <td>5.655596e-01</td>
      <td>0.822249</td>
    </tr>
    <tr>
      <th>TechSupport_Yes</th>
      <td>-0.211924</td>
      <td>0.809026</td>
      <td>0.072953</td>
      <td>-0.354909</td>
      <td>-0.068940</td>
      <td>0.701238</td>
      <td>0.933383</td>
      <td>-2.904958</td>
      <td>3.673021e-03</td>
      <td>8.088817</td>
    </tr>
  </tbody>
</table>
<p>38 rows × 10 columns</p>
</div></div></div>
</div>
<ul class="simple">
<li><p>Interpretation of the coefficients: changing a feature by 1 unit causes a multiplicative “change in hazard” by exp(coef).</p>
<ul>
<li><p>We’re sweeping some details under the rug here.</p></li>
</ul>
</li>
<li><p>Note that, as discussed in Lecture 9, if <span class="math notranslate nohighlight">\(\textrm{coef}&gt;0\)</span> then <span class="math notranslate nohighlight">\(\exp(\textrm{coef})&gt;1\)</span>.</p></li>
</ul>
<p>Could we have gotten this type of information out of sklearn?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y_train</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>6464     No
5707     No
3442     No
3932    Yes
6124     No
Name: Churn, dtype: object
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lr</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">lr_coefs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">lr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">coef_</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">X_train_enc</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Coefficient&quot;</span><span class="p">])</span>
<span class="n">lr_coefs</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;Coefficient&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Coefficient</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Contract_Month-to-month</th>
      <td>0.629461</td>
    </tr>
    <tr>
      <th>TotalCharges</th>
      <td>0.609612</td>
    </tr>
    <tr>
      <th>InternetService_Fiber optic</th>
      <td>0.566841</td>
    </tr>
    <tr>
      <th>OnlineSecurity_No</th>
      <td>0.290896</td>
    </tr>
    <tr>
      <th>PaymentMethod_Electronic check</th>
      <td>0.255360</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
    </tr>
    <tr>
      <th>MultipleLines_No</th>
      <td>-0.205720</td>
    </tr>
    <tr>
      <th>MonthlyCharges</th>
      <td>-0.278976</td>
    </tr>
    <tr>
      <th>InternetService_DSL</th>
      <td>-0.434388</td>
    </tr>
    <tr>
      <th>Contract_Two year</th>
      <td>-0.622706</td>
    </tr>
    <tr>
      <th>tenure</th>
      <td>-1.393448</td>
    </tr>
  </tbody>
</table>
<p>46 rows × 1 columns</p>
</div></div></div>
</div>
<ul class="simple">
<li><p>There is some agreement, which is good.</p></li>
<li><p>The coefficient for <code class="docutils literal notranslate"><span class="pre">tenure</span></code> - ha! Well that is definitely cheating!!!</p></li>
<li><p>But our survival model is much more useful.</p>
<ul>
<li><p>Not to mention more correct.</p></li>
</ul>
</li>
<li><p>One thing we get with <code class="docutils literal notranslate"><span class="pre">lifelines</span></code> is confidence intervals on the coefficients:</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plt.figure(figsize=(8,8))</span>
<span class="c1"># cph.plot();</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>(We could probably get the same for logistic regression if using <code class="docutils literal notranslate"><span class="pre">statsmodels</span></code> instead of sklearn.)</p></li>
<li><p>However, in general, I would be careful with all of this.</p></li>
<li><p>Ideally we would have more statistical training when using <code class="docutils literal notranslate"><span class="pre">lifelines</span></code> - there is a lot that can go wrong.</p>
<ul>
<li><p>It comes with various diagnostics as well.</p></li>
</ul>
</li>
<li><p>But I think it’s very useful to know about survival analysis and the availability of software to deal with it.</p></li>
<li><p>Oh, and there are lots of other nice plots.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cph</span><span class="o">.</span><span class="n">plot_partial_effects_on_outcome</span><span class="p">(</span><span class="s1">&#39;Contract_Two year&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/19_survival-analysis_128_0.png" src="../_images/19_survival-analysis_128_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cph</span><span class="o">.</span><span class="n">plot_partial_effects_on_outcome</span><span class="p">(</span><span class="s1">&#39;MonthlyCharges&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">10_000</span><span class="p">]);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/19_survival-analysis_129_0.png" src="../_images/19_survival-analysis_129_0.png" />
</div>
</div>
<ul class="simple">
<li><p>That’s the thing with linear models, they can’t stop the growth.</p></li>
<li><p>We have a negative coefficient associated with <code class="docutils literal notranslate"><span class="pre">MonthlyCharges</span></code></p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cph_params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;MonthlyCharges&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>coef   -0.003597
Name: MonthlyCharges, dtype: float64
</pre></div>
</div>
</div>
</div>
<p>If your monthly charges are huge, it takes this to the extreme and thinks you’ll basically never churn.</p>
</div>
<div class="section" id="prediction-10-min">
<h2>Prediction (10 min)<a class="headerlink" href="#prediction-10-min" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>We can use survival analysis to make predictions as well.</p></li>
<li><p>Here is the expected number of months to churn for the first 5 customers in the test set:</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_test_surv</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;tenure&#39;</span><span class="p">,</span> <span class="s1">&#39;Churn&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>MonthlyCharges</th>
      <th>InternetService_DSL</th>
      <th>InternetService_Fiber optic</th>
      <th>InternetService_No</th>
      <th>OnlineSecurity_No</th>
      <th>OnlineSecurity_No internet service</th>
      <th>OnlineSecurity_Yes</th>
      <th>PaymentMethod_Bank transfer (automatic)</th>
      <th>PaymentMethod_Credit card (automatic)</th>
      <th>PaymentMethod_Electronic check</th>
      <th>...</th>
      <th>OnlineBackup_No</th>
      <th>OnlineBackup_No internet service</th>
      <th>OnlineBackup_Yes</th>
      <th>PaperlessBilling_Yes</th>
      <th>Contract_Month-to-month</th>
      <th>Contract_One year</th>
      <th>Contract_Two year</th>
      <th>TechSupport_No</th>
      <th>TechSupport_No internet service</th>
      <th>TechSupport_Yes</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>941</th>
      <td>-1.154900</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>1404</th>
      <td>-1.383246</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>5515</th>
      <td>-1.514920</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>3684</th>
      <td>0.351852</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>7017</th>
      <td>-1.471584</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 38 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_test_surv</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>tenure</th>
      <th>Churn</th>
      <th>MonthlyCharges</th>
      <th>InternetService_DSL</th>
      <th>InternetService_Fiber optic</th>
      <th>InternetService_No</th>
      <th>OnlineSecurity_No</th>
      <th>OnlineSecurity_No internet service</th>
      <th>OnlineSecurity_Yes</th>
      <th>PaymentMethod_Bank transfer (automatic)</th>
      <th>...</th>
      <th>OnlineBackup_No</th>
      <th>OnlineBackup_No internet service</th>
      <th>OnlineBackup_Yes</th>
      <th>PaperlessBilling_Yes</th>
      <th>Contract_Month-to-month</th>
      <th>Contract_One year</th>
      <th>Contract_Two year</th>
      <th>TechSupport_No</th>
      <th>TechSupport_No internet service</th>
      <th>TechSupport_Yes</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>941</th>
      <td>13.0</td>
      <td>0.0</td>
      <td>-1.154900</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>1404</th>
      <td>35.0</td>
      <td>0.0</td>
      <td>-1.383246</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>5515</th>
      <td>18.0</td>
      <td>0.0</td>
      <td>-1.514920</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>3684</th>
      <td>43.0</td>
      <td>0.0</td>
      <td>0.351852</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>7017</th>
      <td>51.0</td>
      <td>0.0</td>
      <td>-1.471584</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 40 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cph</span><span class="o">.</span><span class="n">predict_expectation</span><span class="p">(</span><span class="n">df_test_surv</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">()</span> <span class="c1"># assumes they just joined right now</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>941     35.399514
1404    69.120668
5515    68.453006
3684    28.166816
7017    68.022376
dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cph</span><span class="o">.</span><span class="n">predict_expectation</span><span class="p">(</span><span class="n">df_test_surv</span><span class="p">,</span> <span class="n">conditional_after</span><span class="o">=</span><span class="n">df_test_surv</span><span class="p">[</span><span class="s2">&quot;tenure&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>941     35.034987
1404    66.845293
5515    67.185179
3684    16.569810
7017    64.261491
dtype: float64
</pre></div>
</div>
</div>
</div>
<p>Survival curves for first 5 customers in the test set:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cph</span><span class="o">.</span><span class="n">predict_survival_function</span><span class="p">(</span><span class="n">df_test_surv</span><span class="p">[:</span><span class="mi">5</span><span class="p">])</span><span class="o">.</span><span class="n">plot</span><span class="p">();</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Time with service (months)&#39;</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Survival probability&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/19_survival-analysis_142_0.png" src="../_images/19_survival-analysis_142_0.png" />
</div>
</div>
<p>From <code class="docutils literal notranslate"><span class="pre">predict_survival_function</span></code> documentation:</p>
<blockquote>
<div><p>Predict the survival function for individuals, given their covariates. This assumes that the individual just entered the study (that is, we do not condition on how long they have already lived for.)</p>
</div></blockquote>
<p>So these curves are “starting now”.</p>
<ul class="simple">
<li><p>There’s no probability prerequisite for this course, so this is optional material.</p></li>
<li><p>But you can do some interesting stuff here with conditional probabilities.</p></li>
<li><p>“Given that a customer has been here 5 months, what’s the outlook?”</p>
<ul>
<li><p>It will be different than for a new customer.</p></li>
<li><p>Thus, we might still want to predict for the non-churned customers in the training set!</p></li>
<li><p>Not something we really thought about with our traditional supervised learning.</p></li>
</ul>
</li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_train_surv_not_churned</span> <span class="o">=</span> <span class="n">df_train_surv</span><span class="p">[</span><span class="n">df_train_surv</span><span class="p">[</span><span class="s2">&quot;Churn&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_train_surv_not_churned</span><span class="p">[:</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;tenure&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>6464    50.0
Name: tenure, dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cph</span><span class="o">.</span><span class="n">predict_survival_function</span><span class="p">(</span><span class="n">df_train_surv_not_churned</span><span class="p">[:</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">plot</span><span class="p">();</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Time with service (months)&#39;</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Survival probability&#39;</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/19_survival-analysis_147_0.png" src="../_images/19_survival-analysis_147_0.png" />
</div>
</div>
<p>We can <em>condition</em> on the person having been around for 50 months.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cph</span><span class="o">.</span><span class="n">predict_survival_function</span><span class="p">(</span><span class="n">df_train_surv_not_churned</span><span class="p">[:</span><span class="mi">1</span><span class="p">],</span> <span class="n">conditional_after</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>6464</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0.0</th>
      <td>1.000000</td>
    </tr>
    <tr>
      <th>1.0</th>
      <td>0.996929</td>
    </tr>
    <tr>
      <th>2.0</th>
      <td>0.992320</td>
    </tr>
    <tr>
      <th>3.0</th>
      <td>0.989908</td>
    </tr>
    <tr>
      <th>4.0</th>
      <td>0.983341</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
    </tr>
    <tr>
      <th>68.0</th>
      <td>0.450575</td>
    </tr>
    <tr>
      <th>69.0</th>
      <td>0.450575</td>
    </tr>
    <tr>
      <th>70.0</th>
      <td>0.450575</td>
    </tr>
    <tr>
      <th>71.0</th>
      <td>0.450575</td>
    </tr>
    <tr>
      <th>72.0</th>
      <td>0.450575</td>
    </tr>
  </tbody>
</table>
<p>73 rows × 1 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">cph</span><span class="o">.</span><span class="n">predict_survival_function</span><span class="p">(</span><span class="n">df_train_surv_not_churned</span><span class="p">[:</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">());</span>
<span class="n">preds</span> <span class="o">=</span> <span class="n">cph</span><span class="o">.</span><span class="n">predict_survival_function</span><span class="p">(</span><span class="n">df_train_surv_not_churned</span><span class="p">[:</span><span class="mi">1</span><span class="p">],</span> <span class="n">conditional_after</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">preds</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">20</span><span class="p">:],</span> <span class="n">preds</span><span class="o">.</span><span class="n">values</span><span class="p">[:</span><span class="o">-</span><span class="mi">20</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Time with service (months)&#39;</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Survival probability&#39;</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s2">&quot;Starting now&quot;</span><span class="p">,</span> <span class="s2">&quot;Given 20 more months of service&quot;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">50</span><span class="p">]);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/19_survival-analysis_150_0.png" src="../_images/19_survival-analysis_150_0.png" />
</div>
</div>
<ul class="simple">
<li><p>Look at how the survival function (and expected lifetime) is much longer <em>given</em> that the customer has already lasted 20 months.</p></li>
</ul>
<p>So, we can set this to their actual tenure so far to get a prediciton of what will happen going forward:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cph</span><span class="o">.</span><span class="n">predict_survival_function</span><span class="p">(</span><span class="n">df_train_surv_not_churned</span><span class="p">[:</span><span class="mi">1</span><span class="p">],</span> <span class="n">conditional_after</span><span class="o">=</span><span class="n">df_train_surv_not_churned</span><span class="p">[:</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;tenure&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">plot</span><span class="p">();</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Time into the future (months)&#39;</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Survival probability&#39;</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">20</span><span class="p">]);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/19_survival-analysis_153_0.png" src="../_images/19_survival-analysis_153_0.png" />
</div>
</div>
<ul class="simple">
<li><p>Another useful application: you could ask what is the <a class="reference external" href="https://en.wikipedia.org/wiki/Customer_lifetime_value">customer lifetime value</a>.</p>
<ul>
<li><p>Basically, how much money do you expect to make off this customer between now and when they churn?</p></li>
</ul>
</li>
<li><p>With regular supervised learning, tenure was a feature and we could only predict whether or not they had churned by then.</p></li>
</ul>
</div>
</div>
<div class="section" id="todo">
<h1>TODO<a class="headerlink" href="#todo" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li><p>clarify the above section, talk more about why it matters that they’ve been here for X months</p></li>
</ul>
<div class="section" id="other-approaches-what-did-we-not-cover-5-min">
<h2>Other approaches / what did we not cover? (5 min)<a class="headerlink" href="#other-approaches-what-did-we-not-cover-5-min" title="Permalink to this headline">¶</a></h2>
<div class="section" id="measures-of-model-accuracy">
<h3>Measures of model accuracy<a class="headerlink" href="#measures-of-model-accuracy" title="Permalink to this headline">¶</a></h3>
<p>By default score returns “partial log likelihood”:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cph</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">df_train_surv</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-1.8646212793677286
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cph</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">df_test_surv</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-1.727691684168186
</pre></div>
</div>
</div>
</div>
<p>We can look at the “concordance index”:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cph</span><span class="o">.</span><span class="n">concordance_index_</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cph</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">df_train_surv</span><span class="p">,</span> <span class="n">scoring_method</span><span class="o">=</span><span class="s2">&quot;concordance_index&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.8626990298786501
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cph</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">df_test_surv</span><span class="p">,</span> <span class="n">scoring_method</span><span class="o">=</span><span class="s2">&quot;concordance_index&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.8545229998086725
</pre></div>
</div>
</div>
</div>
<p>From the documentation <a class="reference external" href="https://lifelines.readthedocs.io/en/latest/Survival%20Regression.html#model-selection-and-calibration-in-survival-regression">here</a>:</p>
<blockquote>
<div><p>Another censoring-sensitive measure is the concordance-index, also known as the c-index. This measure evaluates the accuracy of the ranking of predicted time. It is in fact a generalization of AUC, another common loss function, and is interpreted similarly:</p>
<ul class="simple">
<li><p>0.5 is the expected result from random predictions,</p></li>
<li><p>1.0 is perfect concordance and,</p></li>
<li><p>0.0 is perfect anti-concordance (multiply predictions with -1 to get 1.0)</p></li>
</ul>
<p><a class="reference external" href="https://stats.stackexchange.com/a/478305/11867">Here</a> is an excellent introduction &amp; description of the c-index for new users.</p>
</div></blockquote>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># cph.log_likelihood_ratio_test()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># cph.check_assumptions(df_train_surv)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="other-approaches">
<h3>Other approaches<a class="headerlink" href="#other-approaches" title="Permalink to this headline">¶</a></h3>
<p>There are many other approaches to modelling in survival analysis:</p>
<ul class="simple">
<li><p>Time-varying proportional hazards.</p>
<ul>
<li><p>What if some of the features change over time, e.g. plan type, number of lines, etc.</p></li>
</ul>
</li>
<li><p>Approaches based on deep learning, e.g. the <a class="reference external" href="https://square.github.io/pysurvival/">pysurvival</a> package.</p></li>
<li><p>Random survival forests.</p></li>
<li><p>And more…</p></li>
</ul>
</div>
<div class="section" id="types-of-censoring">
<h3>Types of censoring<a class="headerlink" href="#types-of-censoring" title="Permalink to this headline">¶</a></h3>
<p>There are also various types and sub-types of censoring we didn’t cover:</p>
<ul class="simple">
<li><p>What we did today is called “right censoring”</p></li>
<li><p>Sub-types within right censoring</p>
<ul>
<li><p>Did everyone join at the same time?</p></li>
<li><p>Other there other reasons the data might be censored at random times, e.g. the person died?</p></li>
</ul>
</li>
<li><p>Left censoring</p></li>
<li><p>Interval censoring</p></li>
</ul>
</div>
</div>
<div class="section" id="summary">
<h2>Summary<a class="headerlink" href="#summary" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Censoring and incorrect approaches to handling it</p>
<ul>
<li><p>Throw away people who haven’t churned</p></li>
<li><p>Assume everyone churns today</p></li>
</ul>
</li>
<li><p>Predicting tenure vs. churned</p></li>
<li><p>Survival analysis encompasses both of these, and deals with censoring</p></li>
<li><p>And it can make rich and interesting predictions!</p></li>
<li><p>KM model -&gt; doesn’t look at features</p></li>
<li><p>CPH model -&gt; like linear regression, does look at the features</p></li>
</ul>
</div>
<div class="section" id="time-permitting">
<h2>Time-permitting<a class="headerlink" href="#time-permitting" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Outliers T/F: https://piazza.com/class/kb2e6nwu3uj23?cid=466</p></li>
<li><p>Time series T/F: https://piazza.com/class/kb2e6nwu3uj23?cid=512</p></li>
<li><p>Survival analysis T/F: https://piazza.com/class/kb2e6nwu3uj23?cid=513</p></li>
</ul>
</div>
<div class="section" id="true-false-questions">
<h2>True/False questions<a class="headerlink" href="#true-false-questions" title="Permalink to this headline">¶</a></h2>
<ol class="simple">
<li><p>If all customers joined a service at the same time (hypothetically), then censoring would not be an issue.</p></li>
<li><p>The Cox proportional hazards model (<code class="docutils literal notranslate"><span class="pre">cph</span></code> above) assumes the effect of a feature is the same for all customers and over all time.</p></li>
<li><p>Survival analysis can be useful even without a “deployment” stage.</p></li>
</ol>
</div>
<div class="section" id="references">
<h2>References<a class="headerlink" href="#references" title="Permalink to this headline">¶</a></h2>
<p>Some people working with this same dataset:</p>
<ul class="simple">
<li><p>https://medium.com/&#64;zachary.james.angell/applying-survival-analysis-to-customer-churn-40b5a809b05a</p></li>
<li><p>https://towardsdatascience.com/churn-prediction-and-prevention-in-python-2d454e5fd9a5 (Cox)</p></li>
<li><p>https://towardsdatascience.com/survival-analysis-in-python-a-model-for-customer-churn-e737c5242822</p></li>
<li><p>https://towardsdatascience.com/survival-analysis-intuition-implementation-in-python-504fde4fcf8e</p></li>
</ul>
<p>lifelines documentation:</p>
<ul class="simple">
<li><p>https://lifelines.readthedocs.io/en/latest/Survival%20analysis%20with%20lifelines.html</p></li>
<li><p>https://lifelines.readthedocs.io/en/latest/Survival%20Analysis%20intro.html#introduction-to-survival-analysis</p></li>
</ul>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./lectures"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
        <div class='prev-next-bottom'>
            

        </div>
        
        </div>
    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By Varada Kolhatkar<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="../_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  
  </body>
</html>