
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lecture 15: DBSCAN and Recommender Systems &#8212; CPSC 330 Applied Machine Learning</title>
    
  <link href="../_static/css/theme.css" rel="stylesheet" />
  <link href="../_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/sphinx-book-theme.e8e5499552300ddf5d7adccae7cc3b70.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.1c5a1a01449ed65a7b51.js">

    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["\\(", "\\)"]], "displayMath": [["\\[", "\\]"]], "processRefs": false, "processEnvironments": false}})</script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Attributions" href="../attribution.html" />
    <link rel="prev" title="Lecture 14: Clustering" href="14_k-means-clustering.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
      <img src="../_static/UBC-CS-logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">CPSC 330 Applied Machine Learning</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
    <div class="bd-toc-item active">
        <p class="caption">
 <span class="caption-text">
  Things you should know
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../docs/README.html">
   CPSC 330 Documents
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Lectures
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="01_intro.html">
   Lecture 1: Course Introduction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="02_decision-trees.html">
   Lecture 2: Terminology, Baselines, Decision Trees
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="03_ml-fundamentals.html">
   Lecture 3: Machine Learning Fundamentals
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="04_kNNs-SVM-RBF.html">
   Lecture 4:
   <span class="math notranslate nohighlight">
    \(k\)
   </span>
   -Nearest Neighbours and SVM RBFs
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="05_preprocessing-pipelines.html">
   Lecture 5: Preprocessing and
   <code class="docutils literal notranslate">
    <span class="pre">
     sklearn
    </span>
   </code>
   pipelines
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="06_column-transformer-text-feats.html">
   Lecture 6:
   <code class="docutils literal notranslate">
    <span class="pre">
     sklearn
    </span>
   </code>
   <code class="docutils literal notranslate">
    <span class="pre">
     ColumnTransformer
    </span>
   </code>
   and Text Features
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="07_linear-models.html">
   Lecture 7: Linear Models
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="08_hyperparameter-optimization.html">
   Lecture 8: Hyperparameter Optimization and Optimization Bias
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="09_classification-metrics.html">
   Lecture 9: Classification Metrics
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="10_regression-metrics.html">
   Lecture 10: Regression Evaluation Metrics
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="11_ensembles.html">
   Lecture 11: Ensembles
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="14_k-means-clustering.html">
   Lecture 14: Clustering
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Lecture 15: DBSCAN and Recommender Systems
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Attribution
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../attribution.html">
   Attributions
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../LICENSE.html">
   LICENSE
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Varada Kolhatkar, CPSC 330 2021-22<br>Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/lectures/15_recommender-systems.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/UBC-CS/cpsc330/master?urlpath=tree/lectures/15_recommender-systems.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#imports">
   Imports
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#lecture-plan-for-today">
   Lecture plan for today
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#learning-outcomes-a-name-lo-a">
   Learning outcomes
   <a name="lo">
   </a>
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#announcements">
   Announcements
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#another-useful-clustering-algorithm-dbscan">
   Another useful clustering algorithm: DBSCAN
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#k-means-recap">
     K-Means recap
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#k-means-limitations">
     K-Means limitations
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#k-means-limitations-shape-of-k-means-clusters">
     K-Means limitations: Shape of K-Means clusters
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#k-means-failure-case-1">
     K-Means: failure case 1
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#k-means-failure-case-2">
     K-Means: failure case 2
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#k-means-failure-case-3">
     K-Means: failure case 3
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#dbscan">
     DBSCAN
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#how-does-it-work">
     How does it work?
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#two-main-hyperparameters">
     Two main hyperparameters
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#effect-of-eps-hyperparameter">
     Effect of
     <code class="docutils literal notranslate">
      <span class="pre">
       eps
      </span>
     </code>
     hyperparameter
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#effect-of-min-samples-hyperparameter">
     Effect of
     <code class="docutils literal notranslate">
      <span class="pre">
       min_samples
      </span>
     </code>
     hyperparameter
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#k-means-vs-dbscan">
     K-Means vs. DBSCAN
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#more-details-on-dbscan">
     More details on DBSCAN
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#illustration-of-hyperparameters-eps-and-min-samples">
     Illustration of hyperparameters
     <code class="docutils literal notranslate">
      <span class="pre">
       eps
      </span>
     </code>
     and
     <code class="docutils literal notranslate">
      <span class="pre">
       min_samples
      </span>
     </code>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#evaluating-dbscan-clusters">
     Evaluating DBSCAN clusters
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#observations">
     Observations
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#summary-pros-and-cons">
     Summary: Pros and cons
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#dbscan-failure-cases">
     DBSCAN: failure cases
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#recommender-systems-motivation-a-name-1-a">
   Recommender systems motivation
   <a name="1">
   </a>
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#what-is-a-recommender-system">
     What is a recommender system?
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#example-recommender-systems">
     Example: Recommender Systems
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#why-should-we-care-about-recommendation-systems">
     Why should we care about recommendation systems?
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#an-example-capstone-project-qxmd">
     An example Capstone project: QxMD
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#what-kind-of-data-we-need-to-build-recommendation-systems">
     What kind of data we need to build recommendation systems?
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#main-approaches">
     Main approaches
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#the-netflix-prize">
     The Netflix prize
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id1">
     The Netflix prize
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#break-5-min">
   Break (5 min)
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#recommender-systems-problem">
   Recommender systems problem
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#problem-formulation">
     Problem formulation
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#utility-matrix">
     Utility matrix
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id2">
     Utility matrix
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#sparsity-of-utility-matrix">
     Sparsity of utility matrix
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#what-do-we-predict">
     What do we predict?
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#example-dataset-jester-1-7m-jokes-ratings-dataset">
     Example dataset: Jester 1.7M jokes ratings dataset
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#dataset-stats">
     Dataset stats
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#creating-utility-matrix">
     Creating utility matrix
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#utility-matrix-for-the-example-problem">
     Utility matrix for the example problem
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#baseline-approaches">
   Baseline Approaches
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#evaluation">
     Evaluation
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#data-splitting">
     Data splitting
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#questions-for-you">
     Questions for you
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id3">
     Evaluation
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#baselines">
     Baselines
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#global-average-baseline">
     Global average baseline
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#k-nearest-neighbours-imputation">
     <span class="math notranslate nohighlight">
      \(k\)
     </span>
     -nearest neighbours imputation
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#finding-nearest-neighbors">
     Finding nearest neighbors
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#k-nearest-neighbours-on-a-query-joke">
     <span class="math notranslate nohighlight">
      \(k\)
     </span>
     -nearest neighbours on a query joke
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#what-to-do-with-predictions">
     What to do with predictions?
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#collaborative-filtering">
   Collaborative filtering
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id4">
     Collaborative filtering
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#problem">
     Problem
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#classification-or-regression">
     Classification or regression
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#rating-prediction">
     Rating prediction
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#rating-prediction-using-the-surprise-package">
     Rating prediction using the surprise package
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#cross-validation-for-recommender-systems">
     Cross-validation for recommender systems
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#what-is-content-based-filtering">
     What is content-based filtering?
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#hybrid-filtering">
     Hybrid filtering
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#final-comments-and-summary-a-name-1-a">
   Final comments and summary
   <a name="1">
   </a>
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#formulating-the-problem-of-recommender-systems">
     Formulating the problem of recommender systems
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id5">
     Collaborative filtering
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id6">
     Evaluation
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#precision-at-n">
     Precision at N
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#some-thoughts-on-recommendation-systems">
     Some thoughts on recommendation systems
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id7">
     Some thoughts on recommendation systems
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#my-advice">
     My advice
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#resources">
     Resources
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#questions-for-class-discussion-a-name-questions-a">
     Questions for class discussion
     <a name="questions">
     </a>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#true-false-questions">
     True/False questions
    </a>
   </li>
  </ul>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <p><img alt="" src="../_images/330-banner.png" /></p>
<div class="section" id="lecture-15-dbscan-and-recommender-systems">
<h1>Lecture 15: DBSCAN and Recommender Systems<a class="headerlink" href="#lecture-15-dbscan-and-recommender-systems" title="Permalink to this headline">¶</a></h1>
<p>UBC 2020-21</p>
<p>Instructor: Varada Kolhatkar</p>
<div class="section" id="imports">
<h2>Imports<a class="headerlink" href="#imports" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;code/.&quot;</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">plotting_functions_unsup</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">plotting_functions</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">sklearn.decomposition</span> <span class="kn">import</span> <span class="n">PCA</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">cross_validate</span><span class="p">,</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span>

<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;font.size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">16</span>
<span class="kn">import</span> <span class="nn">matplotlib.cm</span> <span class="k">as</span> <span class="nn">cm</span>

<span class="c1"># plt.style.use(&quot;seaborn&quot;)</span>
<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s2">&quot;display.max_colwidth&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="lecture-plan-for-today">
<h2>Lecture plan for today<a class="headerlink" href="#lecture-plan-for-today" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>DBSCAN (~20 mins)</p></li>
<li><p>Recommender systems motivation (~5 mins)</p></li>
<li><p>Utility matrix (~10 mins)</p></li>
<li><p>Break (~5 mins)</p></li>
<li><p>Recommender systems dataset and baselines (~15 mins)</p></li>
<li><p>Collaborative filtering with <code class="docutils literal notranslate"><span class="pre">surprise</span></code> package (~15 mins)</p></li>
<li><p>Summary and final comments (~5 mins)</p></li>
</ul>
</div>
<div class="section" id="learning-outcomes-a-name-lo-a">
<h2>Learning outcomes <a name="lo"></a><a class="headerlink" href="#learning-outcomes-a-name-lo-a" title="Permalink to this headline">¶</a></h2>
<p>From this lecture, students are expected to be able to:</p>
<ul class="simple">
<li><p>Identify limitations of K-Means.</p></li>
<li><p>Explain how DBSCAN works at a high level.</p></li>
<li><p>Use <code class="docutils literal notranslate"><span class="pre">sklearn</span></code> to apply DBSCAN.</p></li>
<li><p>Explain the effect of epsilon and minimum samples hyperparameters in DBSCAN.</p></li>
<li><p>Identify DBSCAN limitations.</p></li>
<li><p>State the problem of recommender systems.</p></li>
<li><p>Describe components of a utility matrix.</p></li>
<li><p>Create a utility matrix given ratings data.</p></li>
<li><p>Describe a common approach to evaluate recommender systems.</p></li>
<li><p>Implement some baseline approaches to complete the utility matrix.</p></li>
<li><p>Explain the idea of collaborative filtering.</p></li>
<li><p>Explain some serious consequences of recommendation systems.</p></li>
</ul>
</div>
<div class="section" id="announcements">
<h2>Announcements<a class="headerlink" href="#announcements" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Homework 7 will be released later today (A short and sweet one)</p></li>
<li><p>Midterms grades have been released. Most of you did very well! Congrats!</p></li>
<li><p>No class on Thursday and no tutorials on Friday.</p></li>
<li><p>Extra OH tomorrow and I’ll be scheduling more. (Check the <a class="reference external" href="https://htmlpreview.github.io/?https://github.com/UBC-CS/cpsc330/blob/master/docs/calendar.html">Calender</a>.)</p></li>
</ul>
</div>
<div class="section" id="another-useful-clustering-algorithm-dbscan">
<h2>Another useful clustering algorithm: DBSCAN<a class="headerlink" href="#another-useful-clustering-algorithm-dbscan" title="Permalink to this headline">¶</a></h2>
<div class="section" id="k-means-recap">
<h3>K-Means recap<a class="headerlink" href="#k-means-recap" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>We discussed K-Means clustering in the previous lecture.</p></li>
<li><p>Each cluster is represented by a center.</p></li>
<li><p>Given a new point, you can assign it to a cluster by computing the distances to all cluster centers and picking the cluster with the smallest distance.</p></li>
<li><p>It’s a popular algorithm because</p>
<ul>
<li><p>It’s easy to understand and implement.</p></li>
<li><p>Runs relatively quickly and scales well to large datasets.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sklearn</span></code> has a more scalable variant called <a class="reference external" href="https://scikit-learn.org/stable/modules/generated/sklearn.cluster.MiniBatchKMeans.html"><code class="docutils literal notranslate"><span class="pre">MiniBatchKMeans</span></code></a> which can handle very large datasets.</p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="k-means-limitations">
<h3>K-Means limitations<a class="headerlink" href="#k-means-limitations" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Relies on random initialization and so the outcome may change depending upon this initialization.</p></li>
<li><p>K-Means clustering requires to specify the number of clusters in advance.</p></li>
<li><p>Very often you do not know the centers in advance. The elbow method or the silhouette method to find the optimal number of clusters are not always easy to interpret.</p></li>
<li><p>Each point has to have a cluster assignment.</p></li>
</ul>
</div>
<div class="section" id="k-means-limitations-shape-of-k-means-clusters">
<h3>K-Means limitations: Shape of K-Means clusters<a class="headerlink" href="#k-means-limitations-shape-of-k-means-clusters" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>K-Means partitions the space based on the closest mean.</p></li>
<li><p>Each cluster is defined solely by its center and so it can only capture relatively simple shapes.</p></li>
<li><p>So the boundaries between clusters are linear; It fails to identify clusters with complex shapes.</p></li>
</ul>
<a class="reference internal image-reference" href="../_images/kmeans_boundaries.png"><img alt="" src="../_images/kmeans_boundaries.png" style="width: 500px; height: 500px;" /></a>
<p><a class="reference external" href="https://scikit-learn.org/stable/auto_examples/cluster/plot_kmeans_digits.html">Source</a></p>
</div>
<div class="section" id="k-means-failure-case-1">
<h3>K-Means: failure case 1<a class="headerlink" href="#k-means-failure-case-1" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>K-Means performs poorly if the clusters have more complex shapes (e.g., two moons data below).</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.datasets</span> <span class="kn">import</span> <span class="n">make_moons</span>

<span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">make_moons</span><span class="p">(</span><span class="n">n_samples</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">noise</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="n">plot_X_k_means</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/15_recommender-systems_12_0.png" src="../_images/15_recommender-systems_12_0.png" />
</div>
</div>
</div>
<div class="section" id="k-means-failure-case-2">
<h3>K-Means: failure case 2<a class="headerlink" href="#k-means-failure-case-2" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>It assumes that all directions are equally important for each cluster and fails to identify non-spherical clusters.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># generate some random cluster data</span>
<span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">make_blobs</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">170</span><span class="p">,</span> <span class="n">n_samples</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
<span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="mi">74</span><span class="p">)</span>
<span class="n">transformation</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">transformation</span><span class="p">)</span>
<span class="n">plot_X_k_means</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/15_recommender-systems_14_0.png" src="../_images/15_recommender-systems_14_0.png" />
</div>
</div>
</div>
<div class="section" id="k-means-failure-case-3">
<h3>K-Means: failure case 3<a class="headerlink" href="#k-means-failure-case-3" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Again, K-Means is unable to capture complex cluster shapes.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">make_circles</span><span class="p">(</span><span class="n">n_samples</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">noise</span><span class="o">=</span><span class="mf">0.06</span><span class="p">,</span> <span class="n">factor</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">plot_X_k_means</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/15_recommender-systems_16_0.png" src="../_images/15_recommender-systems_16_0.png" />
</div>
</div>
<ul class="simple">
<li><p>Can we do better than this?</p></li>
<li><p>Another clustering algorithm called DBSCAN is able to tackle some of these cases.</p></li>
</ul>
</div>
<div class="section" id="dbscan">
<h3>DBSCAN<a class="headerlink" href="#dbscan" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p><strong>D</strong>ensity-<strong>B</strong>ased <strong>S</strong>patial <strong>C</strong>lustering of <strong>A</strong>pplications with <strong>N</strong>oise</p></li>
<li><p>Intuitively, it’s based on the idea that clusters form dense regions in the data and so it works by identifying “crowded” regions in the feature space.</p></li>
<li><p>It can address some of the limitations of K-Means we saw above.</p>
<ul>
<li><p>It does not require the user to specify the number of clusters in advance.</p></li>
<li><p>It can identify points that are not part of any clusters.</p></li>
<li><p>It can capture clusters of complex shapes.</p></li>
</ul>
</li>
</ul>
<p>Let’s try <code class="docutils literal notranslate"><span class="pre">sklearn</span></code>’s DBSCAN.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.cluster</span> <span class="kn">import</span> <span class="n">DBSCAN</span>
<span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">make_moons</span><span class="p">(</span><span class="n">n_samples</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">noise</span><span class="o">=</span><span class="mf">0.08</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="n">dbscan</span> <span class="o">=</span> <span class="n">DBSCAN</span><span class="p">(</span><span class="n">eps</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
<span class="n">dbscan</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
<span class="n">plot_X_dbscan</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">dbscan</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/15_recommender-systems_20_0.png" src="../_images/15_recommender-systems_20_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dbscan</span><span class="o">.</span><span class="n">labels_</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([ 0,  0,  0,  1,  1,  1,  0,  1,  1,  0,  0,  1,  1,  0,  1,  1,  0,
        1,  0,  0,  1,  0,  1,  0,  0,  0,  0,  0,  1,  1,  0,  0,  0,  0,
        1,  1,  1,  1,  1,  0,  0,  1,  0,  0,  1,  1,  0,  0,  1,  0,  1,
        1,  0,  1,  1,  0,  1,  0,  1,  0,  1,  0,  0,  0,  0,  1,  0,  1,
        0,  1,  0,  1,  1,  0,  1,  1,  0,  1, -1,  1,  0,  0,  0,  1,  1,
        0,  1,  0,  1,  0,  0,  1,  1,  0,  0,  1,  1,  0,  0,  1,  0,  0,
        1,  1,  1,  1,  0,  0,  1,  1,  1,  0,  1,  1,  0,  1,  0,  0,  1,
        0,  0,  1,  1,  1,  0,  0,  1,  1,  0,  0,  1,  0,  0,  1,  0,  1,
        0,  1,  0,  1,  1,  1,  1,  0,  0,  0,  0,  1,  0,  0,  1,  1,  0,
        0,  0,  0,  1,  1,  0,  0,  1,  1,  1,  1,  0,  0,  1,  0,  1,  0,
        0,  0,  0,  0,  1,  1,  1,  0,  1,  1,  0,  0,  1,  1,  1,  1,  0,
        1,  0,  0,  1,  1,  0,  1,  0,  1,  0, -1,  1,  1])
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>DBSCAN is able to capture half moons shape</p></li>
<li><p>We don’t not have to specify the number of clusters.</p>
<ul>
<li><p>That said, it has two other non-trivial hyperparameters to tune.</p></li>
</ul>
</li>
<li><p>There are two examples which have not been assigned any label (noise examples).</p></li>
</ul>
<p>One more example of DBSCAN clusters capturing complex cluster shapes.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">make_circles</span><span class="p">(</span><span class="n">n_samples</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">noise</span><span class="o">=</span><span class="mf">0.06</span><span class="p">,</span> <span class="n">factor</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">dbscan</span> <span class="o">=</span> <span class="n">DBSCAN</span><span class="p">(</span><span class="n">eps</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">min_samples</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">dbscan</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
<span class="n">plot_X_dbscan</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">dbscan</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/15_recommender-systems_24_0.png" src="../_images/15_recommender-systems_24_0.png" />
</div>
</div>
</div>
<div class="section" id="how-does-it-work">
<h3>How does it work?<a class="headerlink" href="#how-does-it-work" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Iterative algorithm. (We won’t go into the details.)</p></li>
<li><p>Based on the idea that clusters form dense regions in the data.</p></li>
</ul>
<a class="reference internal image-reference" href="../_images/DBSCAN_search.gif"><img alt="" src="../_images/DBSCAN_search.gif" style="width: 900px; height: 900px;" /></a>
<p><a class="reference external" href="https://dashee87.github.io/data%20science/general/Clustering-with-Scikit-with-GIFs/">Source</a></p>
</div>
<div class="section" id="two-main-hyperparameters">
<h3>Two main hyperparameters<a class="headerlink" href="#two-main-hyperparameters" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">eps</span></code>: determines what it means for points to be “close”</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">min_samples</span></code>: determines the number of <strong>neighboring points</strong> we require to consider in order for a point to be part of a cluster</p></li>
</ul>
</div>
<div class="section" id="effect-of-eps-hyperparameter">
<h3>Effect of <code class="docutils literal notranslate"><span class="pre">eps</span></code> hyperparameter<a class="headerlink" href="#effect-of-eps-hyperparameter" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">ipywidgets</span> <span class="kn">import</span> <span class="n">interactive</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">make_blobs</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">centers</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">n_samples</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
<span class="n">interactive</span><span class="p">(</span><span class="k">lambda</span> <span class="n">eps</span><span class="o">=</span><span class="mi">1</span><span class="p">:</span> <span class="n">plot_dbscan_with_labels</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">eps</span><span class="p">),</span> <span class="n">eps</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">
{"version_major": 2, "version_minor": 0, "model_id": "5a05b19c89ce43c0b36c9a7957427157"}
</script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">euclidean_distances</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">X</span><span class="p">))</span><span class="o">.</span><span class="n">round</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>0</th>
      <th>1</th>
      <th>2</th>
      <th>3</th>
      <th>4</th>
      <th>5</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.0</td>
      <td>3.0</td>
      <td>9.0</td>
      <td>7.0</td>
      <td>2.0</td>
      <td>8.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>3.0</td>
      <td>0.0</td>
      <td>12.0</td>
      <td>10.0</td>
      <td>4.0</td>
      <td>11.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>9.0</td>
      <td>12.0</td>
      <td>0.0</td>
      <td>2.0</td>
      <td>8.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>7.0</td>
      <td>10.0</td>
      <td>2.0</td>
      <td>0.0</td>
      <td>6.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2.0</td>
      <td>4.0</td>
      <td>8.0</td>
      <td>6.0</td>
      <td>0.0</td>
      <td>7.0</td>
    </tr>
    <tr>
      <th>5</th>
      <td>8.0</td>
      <td>11.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>7.0</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="effect-of-min-samples-hyperparameter">
<h3>Effect of <code class="docutils literal notranslate"><span class="pre">min_samples</span></code> hyperparameter<a class="headerlink" href="#effect-of-min-samples-hyperparameter" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">interactive</span><span class="p">(</span>
    <span class="k">lambda</span> <span class="n">min_samples</span><span class="o">=</span><span class="mi">1</span><span class="p">:</span> <span class="n">plot_dbscan_with_labels</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">min_samples</span><span class="o">=</span><span class="n">min_samples</span><span class="p">),</span>
    <span class="n">min_samples</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">
{"version_major": 2, "version_minor": 0, "model_id": "a2bf25509164436281aff95721e4a7c0"}
</script></div>
</div>
</div>
<div class="section" id="k-means-vs-dbscan">
<h3>K-Means vs. DBSCAN<a class="headerlink" href="#k-means-vs-dbscan" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>In DBSCAN, you do not have to specify the number of clusters!</p>
<ul>
<li><p>Instead, you have to tune <code class="docutils literal notranslate"><span class="pre">eps</span></code> and <code class="docutils literal notranslate"><span class="pre">min_samples</span></code>.</p></li>
</ul>
</li>
<li><p>Unlike K-Means, DBSCAN doesn’t have to assign all points to clusters.</p>
<ul>
<li><p>The label is -1 if a point is unassigned.</p></li>
</ul>
</li>
<li><p>Unlike K-Means, there is no <code class="docutils literal notranslate"><span class="pre">predict</span></code> method.</p>
<ul>
<li><p>DBSCAN only really clusters the points you have, not “new” or “test” points.</p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="more-details-on-dbscan">
<h3>More details on DBSCAN<a class="headerlink" href="#more-details-on-dbscan" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>You’ll find more details in the lecture notebook.</p></li>
</ul>
<p>There are three kinds of points.</p>
<ul class="simple">
<li><p><strong>Core points</strong> are the points that have at least <code class="docutils literal notranslate"><span class="pre">min_samples</span></code> points in the neighborhood.</p></li>
<li><p><strong>Border points</strong> are the points with fewer than <code class="docutils literal notranslate"><span class="pre">min_samples</span></code> points in the neighborhood, but are connected to a core point.</p></li>
<li><p><strong>Noise points</strong> are the points which do not belong to any cluster. In other words, the points which have less that <code class="docutils literal notranslate"><span class="pre">min_samples</span></code> point within distance <code class="docutils literal notranslate"><span class="pre">eps</span></code> of the starting point are noise points.</p></li>
</ul>
<ul class="simple">
<li><p>Default values for hyperparameters don’t work well on toy datasets.</p></li>
<li><p>All points have been marked as noise with the default values for <code class="docutils literal notranslate"><span class="pre">eps</span></code> and <code class="docutils literal notranslate"><span class="pre">min_samples</span></code></p></li>
<li><p>Let’s examine the effect of changing these hyperparameters.</p>
<ul>
<li><p>noise points: shown in white</p></li>
<li><p>core points: bigger</p></li>
<li><p>border points: smaller</p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="illustration-of-hyperparameters-eps-and-min-samples">
<h3>Illustration of hyperparameters <code class="docutils literal notranslate"><span class="pre">eps</span></code> and <code class="docutils literal notranslate"><span class="pre">min_samples</span></code><a class="headerlink" href="#illustration-of-hyperparameters-eps-and-min-samples" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mglearn</span><span class="o">.</span><span class="n">plots</span><span class="o">.</span><span class="n">plot_dbscan</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>min_samples: 2 eps: 1.000000  cluster: [-1  0  0 -1  0 -1  1  1  0  1 -1 -1]
min_samples: 2 eps: 1.500000  cluster: [0 1 1 1 1 0 2 2 1 2 2 0]
min_samples: 2 eps: 2.000000  cluster: [0 1 1 1 1 0 0 0 1 0 0 0]
min_samples: 2 eps: 3.000000  cluster: [0 0 0 0 0 0 0 0 0 0 0 0]
min_samples: 3 eps: 1.000000  cluster: [-1  0  0 -1  0 -1  1  1  0  1 -1 -1]
min_samples: 3 eps: 1.500000  cluster: [0 1 1 1 1 0 2 2 1 2 2 0]
min_samples: 3 eps: 2.000000  cluster: [0 1 1 1 1 0 0 0 1 0 0 0]
min_samples: 3 eps: 3.000000  cluster: [0 0 0 0 0 0 0 0 0 0 0 0]
min_samples: 5 eps: 1.000000  cluster: [-1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1]
min_samples: 5 eps: 1.500000  cluster: [-1  0  0  0  0 -1 -1 -1  0 -1 -1 -1]
min_samples: 5 eps: 2.000000  cluster: [-1  0  0  0  0 -1 -1 -1  0 -1 -1 -1]
min_samples: 5 eps: 3.000000  cluster: [0 0 0 0 0 0 0 0 0 0 0 0]
</pre></div>
</div>
<img alt="../_images/15_recommender-systems_38_1.png" src="../_images/15_recommender-systems_38_1.png" />
</div>
</div>
</div>
<div class="section" id="evaluating-dbscan-clusters">
<h3>Evaluating DBSCAN clusters<a class="headerlink" href="#evaluating-dbscan-clusters" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>We cannot use the elbow method to examine the goodness of clusters created with DBSCAN.</p></li>
<li><p>But we can use the silhouette method because it’s not dependent on the idea of cluster centers.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">make_blobs</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">centers</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">n_samples</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
<span class="n">dbscan</span> <span class="o">=</span> <span class="n">DBSCAN</span><span class="p">(</span><span class="n">eps</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">min_samples</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">dbscan</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
<span class="n">plot_X_dbscan</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">dbscan</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/15_recommender-systems_40_0.png" src="../_images/15_recommender-systems_40_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Yellowbrick is designed to work with K-Means and not with DBSCAN.</span>
<span class="c1"># So it needs the number of clusters stored in n_clusters</span>
<span class="c1"># It also needs `predict` method to be implemented.</span>
<span class="c1"># So I&#39;m implementing it here so that we can use Yellowbrick to show Silhouette plots.</span>
<span class="n">n_clusters</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">dbscan</span><span class="o">.</span><span class="n">labels_</span><span class="p">))</span>
<span class="n">dbscan</span><span class="o">.</span><span class="n">n_clusters</span> <span class="o">=</span> <span class="n">n_clusters</span>
<span class="n">dbscan</span><span class="o">.</span><span class="n">predict</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">dbscan</span><span class="o">.</span><span class="n">labels_</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">yellowbrick.cluster</span> <span class="kn">import</span> <span class="n">SilhouetteVisualizer</span>
<span class="n">visualizer</span> <span class="o">=</span> <span class="n">SilhouetteVisualizer</span><span class="p">(</span><span class="n">dbscan</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s2">&quot;yellowbrick&quot;</span><span class="p">)</span>
<span class="n">visualizer</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>  <span class="c1"># Fit the data to the visualizer</span>
<span class="n">visualizer</span><span class="o">.</span><span class="n">show</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/15_recommender-systems_42_0.png" src="../_images/15_recommender-systems_42_0.png" />
</div>
</div>
</div>
<div class="section" id="observations">
<h3>Observations<a class="headerlink" href="#observations" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Increasing <code class="docutils literal notranslate"><span class="pre">eps</span></code> (<span class="math notranslate nohighlight">\(\uparrow\)</span>) (left to right in the plot above) means more points will be included in a cluster.</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">eps</span></code> = 1.0 either creates more clusters or more noise points, whereas eps=3.0 puts all points in one cluster with no noise points.</p></li>
</ul>
</li>
<li><p>Increasing <code class="docutils literal notranslate"><span class="pre">min_samples</span></code> (<span class="math notranslate nohighlight">\(\uparrow\)</span>) (top to bottom in the plot above) means points in less dense regions will either be labeled as their own cluster or noise.</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">min_samples=2</span></code>, for instance, has none or only a fewer noise points whereas <code class="docutils literal notranslate"><span class="pre">min_samples=5</span></code> has several noise points.</p></li>
</ul>
</li>
<li><p>Here <code class="docutils literal notranslate"><span class="pre">min_samples</span></code> = 2.0 or 3.0 and <code class="docutils literal notranslate"><span class="pre">eps</span></code> = 1.5 is giving us the best results.</p></li>
<li><p>In general, it’s not trivial to tune these hyperparameters.</p></li>
</ul>
</div>
<div class="section" id="summary-pros-and-cons">
<h3>Summary: Pros and cons<a class="headerlink" href="#summary-pros-and-cons" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Pros</p>
<ul>
<li><p>Can learn arbitrary cluster shapes</p></li>
<li><p>Can detect outliers</p></li>
</ul>
</li>
<li><p>Cons</p>
<ul>
<li><p>Cannot <code class="docutils literal notranslate"><span class="pre">predict</span></code> on new examples.</p></li>
<li><p>Needs tuning of two non-obvious hyperparameters</p></li>
</ul>
</li>
</ul>
<p>There is an improved version of DBSCAN called <a class="reference external" href="https://github.com/scikit-learn-contrib/hdbscan"><code class="docutils literal notranslate"><span class="pre">HDBSCAN</span></code> (hierarchical DBSCAN)</a>.</p>
</div>
<div class="section" id="dbscan-failure-cases">
<h3>DBSCAN: failure cases<a class="headerlink" href="#dbscan-failure-cases" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>DBSCAN is able to capture complex clusters. But this doesn’t mean that <code class="docutils literal notranslate"><span class="pre">DBSCAN</span></code> always works better. It has its own problems!</p></li>
<li><p>DBSCAN doesn’t do well when we have clusters with different densities.</p>
<ul>
<li><p>You can play with the hyperparameters but it’s not likely to help much.</p></li>
</ul>
</li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_varied</span><span class="p">,</span> <span class="n">y_varied</span> <span class="o">=</span> <span class="n">make_blobs</span><span class="p">(</span>
    <span class="n">n_samples</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">cluster_std</span><span class="o">=</span><span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">10</span>
<span class="p">)</span>
<span class="n">plot_k_means_dbscan_comparison</span><span class="p">(</span><span class="n">X_varied</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/15_recommender-systems_46_0.png" src="../_images/15_recommender-systems_46_0.png" />
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>There is also “hierarchical” clustering. We don’t have time to talk about it. But if you want to know more about it, check out the notes from last year <a class="reference external" href="https://github.com/UBC-CS/cpsc330/blob/v2.0/lectures/19_clustering.ipynb">here</a>.</p>
</div>
<p><br><br><br><br></p>
</div>
</div>
<div class="section" id="recommender-systems-motivation-a-name-1-a">
<h2>Recommender systems motivation <a name="1"></a><a class="headerlink" href="#recommender-systems-motivation-a-name-1-a" title="Permalink to this headline">¶</a></h2>
<div class="section" id="what-is-a-recommender-system">
<h3>What is a recommender system?<a class="headerlink" href="#what-is-a-recommender-system" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>A recommender or a recommendation system <strong>recommends</strong> a particular product or service to users they are likely to consume.</p></li>
</ul>
<a class="reference internal image-reference" href="../_images/recommendation_system.png"><img alt="" src="../_images/recommendation_system.png" style="width: 900px; height: 900px;" /></a>
</div>
<div class="section" id="example-recommender-systems">
<h3>Example: Recommender Systems<a class="headerlink" href="#example-recommender-systems" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>A client goes to Amazon to buy products.</p></li>
<li><p>Amazon has some information about the client. They also have information about other clients buying similar products.</p></li>
<li><p>What should they recommend to the client, so that they buy more products?</p></li>
<li><p>There’s no “right” answer (no label).</p></li>
<li><p>The whole idea is to understand user behavior in order to recommend them products they are likely to consume.</p></li>
</ul>
</div>
<div class="section" id="why-should-we-care-about-recommendation-systems">
<h3>Why should we care about recommendation systems?<a class="headerlink" href="#why-should-we-care-about-recommendation-systems" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Almost everything we buy or consume today is in some way or the other influenced by recommendation systems.</p>
<ul>
<li><p>Music (Spotify), videos (YouTube), news, books and products (Amazon), movies (Netflix), jokes, restaurants, dating , friends (Facebook), professional connections (Linkedin)</p></li>
</ul>
</li>
<li><p>Recommendation systems are at the core of the success of many companies.</p>
<ul>
<li><p>Amazon</p></li>
<li><p><a class="reference external" href="https://help.netflix.com/en/node/100639">Netflix</a></p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="an-example-capstone-project-qxmd">
<h3>An example Capstone project: <a class="reference external" href="https://qxmd.com/">QxMD</a><a class="headerlink" href="#an-example-capstone-project-qxmd" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Present personalized journal article recommendations to health care professionals.</p></li>
</ul>
</div>
<div class="section" id="what-kind-of-data-we-need-to-build-recommendation-systems">
<h3>What kind of data we need to build recommendation systems?<a class="headerlink" href="#what-kind-of-data-we-need-to-build-recommendation-systems" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p><strong>User ratings data</strong> (most common)</p></li>
<li><p><strong>Features related to items or users</strong></p></li>
<li><p>Customer purchase history data</p></li>
</ul>
</div>
<div class="section" id="main-approaches">
<h3>Main approaches<a class="headerlink" href="#main-approaches" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Collaborative filtering</p>
<ul>
<li><p>“Unsupervised” learning</p></li>
<li><p>We only have labels <span class="math notranslate nohighlight">\(y_{ij}\)</span> (rating of user <span class="math notranslate nohighlight">\(i\)</span> for item <span class="math notranslate nohighlight">\(j\)</span>).</p></li>
<li><p>We learn features.</p></li>
</ul>
</li>
<li><p>Content-based recommenders</p>
<ul>
<li><p>Supervised learning</p></li>
<li><p>Extract features <span class="math notranslate nohighlight">\(x_i\)</span> of users and/or items and building a model to predict rating <span class="math notranslate nohighlight">\(y_i\)</span> given <span class="math notranslate nohighlight">\(x_i\)</span>.</p></li>
<li><p>Apply model to predict for new users/items.</p></li>
</ul>
</li>
<li><p>Hybrid</p>
<ul>
<li><p>Combining collaborative filtering with content-based filtering</p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="the-netflix-prize">
<h3>The Netflix prize<a class="headerlink" href="#the-netflix-prize" title="Permalink to this headline">¶</a></h3>
<p><img alt="image.png" src="lectures/attachment:image.png" /></p>
<p><a class="reference external" href="https://netflixtechblog.com/netflix-recommendations-beyond-the-5-stars-part-1-55838468f429">Source</a></p>
</div>
<div class="section" id="id1">
<h3>The Netflix prize<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>100M ratings from 0.5M users on 18k movies.</p></li>
<li><p>Grand prize was $1M for first team to reduce squared error at least by 10%.</p></li>
<li><p>Winning entry (and most entries) used collaborative filtering:</p>
<ul>
<li><p>Methods that only looks at ratings, not features of movies/users.</p></li>
</ul>
</li>
<li><p>A simple collaborative filtering method that does really well:</p>
<ul>
<li><p>Now adopted by many companies.</p></li>
</ul>
</li>
</ul>
</div>
</div>
<div class="section" id="break-5-min">
<h2>Break (5 min)<a class="headerlink" href="#break-5-min" title="Permalink to this headline">¶</a></h2>
<p><img alt="" src="../_images/eva-coffee.png" /></p>
</div>
<div class="section" id="recommender-systems-problem">
<h2>Recommender systems problem<a class="headerlink" href="#recommender-systems-problem" title="Permalink to this headline">¶</a></h2>
<div class="section" id="problem-formulation">
<h3>Problem formulation<a class="headerlink" href="#problem-formulation" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Most often the data for recommender systems come in as <strong>ratings</strong> for a set of items from a set of users.</p></li>
<li><p>We have two entities: <span class="math notranslate nohighlight">\(N\)</span> <strong>users</strong> and <span class="math notranslate nohighlight">\(M\)</span> <strong>items</strong>.</p></li>
<li><p><strong>Users</strong> are consumers.</p></li>
<li><p><strong>Items</strong> are the products or services offered.</p>
<ul>
<li><p>E.g., movies (Netflix), books (Amazon), songs (spotify), people (tinder)</p></li>
</ul>
</li>
</ul>
<a class="reference internal image-reference" href="../_images/utility_matrix.png"><img alt="" src="../_images/utility_matrix.png" style="width: 900px; height: 900px;" /></a>
</div>
<div class="section" id="utility-matrix">
<h3>Utility matrix<a class="headerlink" href="#utility-matrix" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>A <strong>utility matrix</strong> is the matrix that captures <strong>interactions</strong> between <span class="math notranslate nohighlight">\(N\)</span> <strong>users</strong> and <span class="math notranslate nohighlight">\(M\)</span> <strong>items</strong>.</p></li>
<li><p>The interaction may come in different forms:</p>
<ul>
<li><p>ratings, clicks, purchases</p></li>
</ul>
</li>
</ul>
<a class="reference internal image-reference" href="../_images/utility_mat.png"><img alt="" src="../_images/utility_mat.png" style="width: 900px; height: 900px;" /></a>
</div>
<div class="section" id="id2">
<h3>Utility matrix<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Below is a toy utility matrix. Here <span class="math notranslate nohighlight">\(N\)</span> = 6 and <span class="math notranslate nohighlight">\(M\)</span> = 5.</p></li>
<li><p>Each entry <span class="math notranslate nohighlight">\(y_{ij}\)</span> (<span class="math notranslate nohighlight">\(i^{th}\)</span> row and <span class="math notranslate nohighlight">\(j^{th}\)</span> column) denotes the rating given by the user <span class="math notranslate nohighlight">\(i\)</span> to item <span class="math notranslate nohighlight">\(j\)</span>.</p></li>
<li><p>We represent users in terms of items and items in terms of users.</p></li>
</ul>
<a class="reference internal image-reference" href="../_images/utility_matrix.png"><img alt="" src="../_images/utility_matrix.png" style="width: 900px; height: 900px;" /></a>
</div>
<div class="section" id="sparsity-of-utility-matrix">
<h3>Sparsity of utility matrix<a class="headerlink" href="#sparsity-of-utility-matrix" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>The utility matrix is very sparse because usually users only interact with a few items.</p></li>
<li><p>For example:</p>
<ul>
<li><p>all Netflix users will have rated only a small percentage of content available on Netflix</p></li>
<li><p>all amazon clients will have rated only a small fraction of items among all items available on Amazon</p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="what-do-we-predict">
<h3>What do we predict?<a class="headerlink" href="#what-do-we-predict" title="Permalink to this headline">¶</a></h3>
<p>Given a utility matrix of <span class="math notranslate nohighlight">\(N\)</span> users and <span class="math notranslate nohighlight">\(M\)</span> items, <strong>complete the utility matrix</strong>. In other words, <strong>predict missing values in the matrix</strong>.</p>
<a class="reference internal image-reference" href="../_images/utility_matrix.png"><img alt="" src="../_images/utility_matrix.png" style="width: 900px; height: 900px;" /></a>
<ul class="simple">
<li><p>Once we have predicted ratings, we can recommend items to users they are likely to rate higher.</p></li>
</ul>
</div>
<div class="section" id="example-dataset-jester-1-7m-jokes-ratings-dataset">
<h3>Example dataset: <a class="reference external" href="https://www.kaggle.com/vikashrajluhaniwal/jester-17m-jokes-ratings-dataset?select=jester_ratings.csv">Jester 1.7M jokes ratings dataset</a><a class="headerlink" href="#example-dataset-jester-1-7m-jokes-ratings-dataset" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>We’ll use a sample of <a class="reference external" href="https://www.kaggle.com/vikashrajluhaniwal/jester-17m-jokes-ratings-dataset">Jester 1.7M jokes ratings dataset</a> to demonstrate different recommendation systems.</p></li>
</ul>
<p>The dataset comes with two CSVs</p>
<ul class="simple">
<li><p>A CSV containing ratings (-10.0 to +10.0) of 150 jokes from 59,132 users.</p></li>
<li><p>A CSV containing joke IDs and the actual text of jokes.</p></li>
</ul>
<blockquote>
<div><p>Some jokes might be offensive. Please do not look too much into the actual text data if you are sensitive to such language.</p>
</div></blockquote>
<ul class="simple">
<li><p>Recommendation systems are most effective when you have a large amount of data.</p></li>
<li><p>But we are only taking a sample here for speed.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;data/jester_ratings.csv&quot;</span>
<span class="n">ratings_full</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
<span class="n">ratings</span> <span class="o">=</span> <span class="n">ratings_full</span><span class="p">[</span><span class="n">ratings_full</span><span class="p">[</span><span class="s2">&quot;userId&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">4000</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ratings</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>userId</th>
      <th>jokeId</th>
      <th>rating</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>5</td>
      <td>0.219</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>7</td>
      <td>-9.281</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>8</td>
      <td>-9.281</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>13</td>
      <td>-6.781</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1</td>
      <td>15</td>
      <td>0.875</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">user_key</span> <span class="o">=</span> <span class="s2">&quot;userId&quot;</span>
<span class="n">item_key</span> <span class="o">=</span> <span class="s2">&quot;jokeId&quot;</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="dataset-stats">
<h3>Dataset stats<a class="headerlink" href="#dataset-stats" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ratings</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
Int64Index: 141362 entries, 0 to 141361
Data columns (total 3 columns):
 #   Column  Non-Null Count   Dtype  
---  ------  --------------   -----  
 0   userId  141362 non-null  int64  
 1   jokeId  141362 non-null  int64  
 2   rating  141362 non-null  float64
dtypes: float64(1), int64(2)
memory usage: 4.3 MB
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_stats</span><span class="p">(</span><span class="n">ratings</span><span class="p">,</span> <span class="n">item_key</span><span class="o">=</span><span class="s2">&quot;jokeId&quot;</span><span class="p">,</span> <span class="n">user_key</span><span class="o">=</span><span class="s2">&quot;userId&quot;</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of ratings:&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ratings</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Average rating:  </span><span class="si">%0.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ratings</span><span class="p">[</span><span class="s2">&quot;rating&quot;</span><span class="p">])))</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">ratings</span><span class="p">[</span><span class="n">user_key</span><span class="p">]))</span>
    <span class="n">M</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">ratings</span><span class="p">[</span><span class="n">item_key</span><span class="p">]))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of users (N): </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">N</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of items (M): </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">M</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Fraction non-nan ratings: </span><span class="si">%0.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ratings</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">N</span> <span class="o">*</span> <span class="n">M</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">N</span><span class="p">,</span> <span class="n">M</span>


<span class="n">N</span><span class="p">,</span> <span class="n">M</span> <span class="o">=</span> <span class="n">get_stats</span><span class="p">(</span><span class="n">ratings</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Number of ratings: 141362
Average rating:  1.200
Number of users (N): 3635
Number of items (M): 140
Fraction non-nan ratings: 0.278
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="creating-utility-matrix">
<h3>Creating utility matrix<a class="headerlink" href="#creating-utility-matrix" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Let’s construct utility matrix with <code class="docutils literal notranslate"><span class="pre">number</span> <span class="pre">of</span> <span class="pre">users</span></code> rows and <code class="docutils literal notranslate"><span class="pre">number</span> <span class="pre">of</span> <span class="pre">items</span></code> columns from the ratings data.</p></li>
</ul>
<blockquote>
<div><p>Note we are constructing a non-sparse matrix for demonstration purpose here. In real life it’s recommended that you work with sparse matrices.</p>
</div></blockquote>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">user_mapper</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">ratings</span><span class="p">[</span><span class="n">user_key</span><span class="p">]),</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">))))</span>
<span class="n">item_mapper</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">ratings</span><span class="p">[</span><span class="n">item_key</span><span class="p">]),</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">M</span><span class="p">))))</span>
<span class="n">user_inverse_mapper</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">ratings</span><span class="p">[</span><span class="n">user_key</span><span class="p">])))</span>
<span class="n">item_inverse_mapper</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">M</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">ratings</span><span class="p">[</span><span class="n">item_key</span><span class="p">])))</span>


<span class="k">def</span> <span class="nf">create_Y_from_ratings</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">M</span><span class="p">):</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="n">M</span><span class="p">))</span>
    <span class="n">Y</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">user_mapper</span><span class="p">[</span><span class="n">val</span><span class="p">[</span><span class="n">user_key</span><span class="p">]]</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">item_mapper</span><span class="p">[</span><span class="n">val</span><span class="p">[</span><span class="n">item_key</span><span class="p">]]</span>
        <span class="n">Y</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="s2">&quot;rating&quot;</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">Y</span>


<span class="n">Y_mat</span> <span class="o">=</span> <span class="n">create_Y_from_ratings</span><span class="p">(</span><span class="n">ratings</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">M</span><span class="p">)</span>
<span class="n">Y_mat</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(3635, 140)
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="utility-matrix-for-the-example-problem">
<h3>Utility matrix for the example problem<a class="headerlink" href="#utility-matrix-for-the-example-problem" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Rows represent users.</p></li>
<li><p>Columns represent items (jokes in our case).</p></li>
<li><p>Each cell gives the rating given by the user to the corresponding joke.</p></li>
<li><p>Users are features for jokes and jokes are features for users.</p></li>
<li><p>We want to predict the missing entries.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">Y_mat</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>0</th>
      <th>1</th>
      <th>2</th>
      <th>3</th>
      <th>4</th>
      <th>5</th>
      <th>6</th>
      <th>7</th>
      <th>8</th>
      <th>9</th>
      <th>...</th>
      <th>130</th>
      <th>131</th>
      <th>132</th>
      <th>133</th>
      <th>134</th>
      <th>135</th>
      <th>136</th>
      <th>137</th>
      <th>138</th>
      <th>139</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.219</td>
      <td>-9.281</td>
      <td>-9.281</td>
      <td>-6.781</td>
      <td>0.875</td>
      <td>-9.656</td>
      <td>-9.031</td>
      <td>-7.469</td>
      <td>-8.719</td>
      <td>-9.156</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1</th>
      <td>-9.688</td>
      <td>9.938</td>
      <td>9.531</td>
      <td>9.938</td>
      <td>0.406</td>
      <td>3.719</td>
      <td>9.656</td>
      <td>-2.688</td>
      <td>-9.562</td>
      <td>-9.125</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2</th>
      <td>-9.844</td>
      <td>-9.844</td>
      <td>-7.219</td>
      <td>-2.031</td>
      <td>-9.938</td>
      <td>-9.969</td>
      <td>-9.875</td>
      <td>-9.812</td>
      <td>-9.781</td>
      <td>-6.844</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3</th>
      <td>-5.812</td>
      <td>-4.500</td>
      <td>-4.906</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>4</th>
      <td>6.906</td>
      <td>4.750</td>
      <td>-5.906</td>
      <td>-0.406</td>
      <td>-4.031</td>
      <td>3.875</td>
      <td>6.219</td>
      <td>5.656</td>
      <td>6.094</td>
      <td>5.406</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>3630</th>
      <td>NaN</td>
      <td>-9.812</td>
      <td>-0.062</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3631</th>
      <td>NaN</td>
      <td>-9.844</td>
      <td>7.531</td>
      <td>-9.719</td>
      <td>-9.344</td>
      <td>3.875</td>
      <td>9.812</td>
      <td>8.938</td>
      <td>8.375</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3632</th>
      <td>NaN</td>
      <td>-1.906</td>
      <td>3.969</td>
      <td>-2.312</td>
      <td>-0.344</td>
      <td>-8.844</td>
      <td>4.188</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3633</th>
      <td>NaN</td>
      <td>-8.875</td>
      <td>-9.156</td>
      <td>-9.156</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3634</th>
      <td>NaN</td>
      <td>-6.312</td>
      <td>1.281</td>
      <td>-3.531</td>
      <td>2.125</td>
      <td>-5.812</td>
      <td>5.562</td>
      <td>-6.062</td>
      <td>0.125</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>4.188</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
<p>3635 rows × 140 columns</p>
</div></div></div>
</div>
<p><br><br><br><br></p>
</div>
</div>
<div class="section" id="baseline-approaches">
<h2>Baseline Approaches<a class="headerlink" href="#baseline-approaches" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Recall that our goal is to predict missing entries in the utility matrix.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">Y_mat</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>0</th>
      <th>1</th>
      <th>2</th>
      <th>3</th>
      <th>4</th>
      <th>5</th>
      <th>6</th>
      <th>7</th>
      <th>8</th>
      <th>9</th>
      <th>...</th>
      <th>130</th>
      <th>131</th>
      <th>132</th>
      <th>133</th>
      <th>134</th>
      <th>135</th>
      <th>136</th>
      <th>137</th>
      <th>138</th>
      <th>139</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.219</td>
      <td>-9.281</td>
      <td>-9.281</td>
      <td>-6.781</td>
      <td>0.875</td>
      <td>-9.656</td>
      <td>-9.031</td>
      <td>-7.469</td>
      <td>-8.719</td>
      <td>-9.156</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1</th>
      <td>-9.688</td>
      <td>9.938</td>
      <td>9.531</td>
      <td>9.938</td>
      <td>0.406</td>
      <td>3.719</td>
      <td>9.656</td>
      <td>-2.688</td>
      <td>-9.562</td>
      <td>-9.125</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2</th>
      <td>-9.844</td>
      <td>-9.844</td>
      <td>-7.219</td>
      <td>-2.031</td>
      <td>-9.938</td>
      <td>-9.969</td>
      <td>-9.875</td>
      <td>-9.812</td>
      <td>-9.781</td>
      <td>-6.844</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3</th>
      <td>-5.812</td>
      <td>-4.500</td>
      <td>-4.906</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>4</th>
      <td>6.906</td>
      <td>4.750</td>
      <td>-5.906</td>
      <td>-0.406</td>
      <td>-4.031</td>
      <td>3.875</td>
      <td>6.219</td>
      <td>5.656</td>
      <td>6.094</td>
      <td>5.406</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>3630</th>
      <td>NaN</td>
      <td>-9.812</td>
      <td>-0.062</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3631</th>
      <td>NaN</td>
      <td>-9.844</td>
      <td>7.531</td>
      <td>-9.719</td>
      <td>-9.344</td>
      <td>3.875</td>
      <td>9.812</td>
      <td>8.938</td>
      <td>8.375</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3632</th>
      <td>NaN</td>
      <td>-1.906</td>
      <td>3.969</td>
      <td>-2.312</td>
      <td>-0.344</td>
      <td>-8.844</td>
      <td>4.188</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3633</th>
      <td>NaN</td>
      <td>-8.875</td>
      <td>-9.156</td>
      <td>-9.156</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3634</th>
      <td>NaN</td>
      <td>-6.312</td>
      <td>1.281</td>
      <td>-3.531</td>
      <td>2.125</td>
      <td>-5.812</td>
      <td>5.562</td>
      <td>-6.062</td>
      <td>0.125</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>4.188</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
<p>3635 rows × 140 columns</p>
</div></div></div>
</div>
<div class="section" id="evaluation">
<h3>Evaluation<a class="headerlink" href="#evaluation" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>We’ll try a number of methods to do this.</p></li>
<li><p>Although there is no notion of “accurate” recommendations, we need a way to evaluate our predictions so that we’ll be able to compare different methods.</p></li>
<li><p>Although we are doing unsupervised learning, we’ll split the data and evaluate our predictions as follows.</p></li>
</ul>
</div>
<div class="section" id="data-splitting">
<h3>Data splitting<a class="headerlink" href="#data-splitting" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>We split the ratings into train and validation sets.</p></li>
<li><p>It’s easier to split the ratings data instead of splitting the utility matrix.</p></li>
<li><p>Don’t worry about <code class="docutils literal notranslate"><span class="pre">y</span></code>; we’re not really going to use it.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X</span> <span class="o">=</span> <span class="n">ratings</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">ratings</span><span class="p">[</span><span class="n">user_key</span><span class="p">]</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_valid</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_valid</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
<span class="p">)</span>

<span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">X_valid</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>((113089, 3), (28273, 3))
</pre></div>
</div>
</div>
</div>
<p>Now we will create utility matrices for train and validation splits.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_mat</span> <span class="o">=</span> <span class="n">create_Y_from_ratings</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">M</span><span class="p">)</span>
<span class="n">valid_mat</span> <span class="o">=</span> <span class="n">create_Y_from_ratings</span><span class="p">(</span><span class="n">X_valid</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">M</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">valid_mat</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>((3635, 140), (3635, 140))
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">train_mat</span></code> has only ratings from the train set and <code class="docutils literal notranslate"><span class="pre">valid_mat</span></code> has only ratings from the valid set.</p></li>
<li><p>During training we assume that we do not have access to some of the available ratings. We predict these ratings and evaluate them against ratings in the validation set.</p></li>
</ul>
</div>
<div class="section" id="questions-for-you">
<h3>Questions for you<a class="headerlink" href="#questions-for-you" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>How do train and validation utility matrices differ?</p></li>
<li><p>Why are utility matrices for train and validation sets are of the same shape?
<br><br></p></li>
</ul>
<p><strong>Answer:</strong></p>
<ul class="simple">
<li><p>The training matrix <code class="docutils literal notranslate"><span class="pre">train_mat</span></code> is of shape N by M but only has ratings from <code class="docutils literal notranslate"><span class="pre">X_train</span></code> and all other ratings missing.</p></li>
<li><p>The validation matrix <code class="docutils literal notranslate"><span class="pre">valid_mat</span></code> is also of shape N by M but it only has ratings <code class="docutils literal notranslate"><span class="pre">X_valid</span></code> and all other ratings missing.</p></li>
<li><p>They have the same shape because both have the same number of users and items; that’s how we have constructed them.</p></li>
</ul>
</div>
<div class="section" id="id3">
<h3>Evaluation<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Now that we have train and validation sets, how do we evaluate our predictions?</p></li>
<li><p>You can calculate the error between actual ratings and predicted ratings with metrics of your choice.</p>
<ul>
<li><p>Most common ones are MSE or RMSE.</p></li>
</ul>
</li>
</ul>
<ul class="simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">error</span></code> function below calculates RMSE and <code class="docutils literal notranslate"><span class="pre">evaluate</span></code> function prints train and validation RMSE.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">error</span><span class="p">(</span><span class="n">X1</span><span class="p">,</span> <span class="n">X2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the root mean squared error.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">((</span><span class="n">X1</span> <span class="o">-</span> <span class="n">X2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="n">pred_X</span><span class="p">,</span> <span class="n">train_X</span><span class="p">,</span> <span class="n">valid_X</span><span class="p">,</span> <span class="n">model_name</span><span class="o">=</span><span class="s2">&quot;Global average&quot;</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> train RMSE: </span><span class="si">%0.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">error</span><span class="p">(</span><span class="n">pred_X</span><span class="p">,</span> <span class="n">train_X</span><span class="p">)))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> valid RMSE: </span><span class="si">%0.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">error</span><span class="p">(</span><span class="n">pred_X</span><span class="p">,</span> <span class="n">valid_X</span><span class="p">)))</span>
</pre></div>
</div>
</div>
</div>
<p><br><br></p>
</div>
<div class="section" id="baselines">
<h3>Baselines<a class="headerlink" href="#baselines" title="Permalink to this headline">¶</a></h3>
<p>Let’s first try some simple approaches to predict missing entries.</p>
<ol class="simple">
<li><p>Global average baseline</p></li>
<li><p><a class="reference external" href="https://scikit-learn.org/stable/modules/generated/sklearn.impute.KNNImputer.html"><span class="math notranslate nohighlight">\(k\)</span>-Nearest Neighbours imputation</a></p></li>
</ol>
</div>
<div class="section" id="global-average-baseline">
<h3>Global average baseline<a class="headerlink" href="#global-average-baseline" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Let’s examine RMSE of the global average baseline.</p></li>
<li><p>In this baseline we predict everything as the global average rating</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">avg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">train_mat</span><span class="p">)</span>
<span class="n">pred_g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">train_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">+</span> <span class="n">avg</span>
<span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">pred_g</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>0</th>
      <th>1</th>
      <th>2</th>
      <th>3</th>
      <th>4</th>
      <th>5</th>
      <th>6</th>
      <th>7</th>
      <th>8</th>
      <th>9</th>
      <th>...</th>
      <th>130</th>
      <th>131</th>
      <th>132</th>
      <th>133</th>
      <th>134</th>
      <th>135</th>
      <th>136</th>
      <th>137</th>
      <th>138</th>
      <th>139</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1.20741</td>
      <td>1.20741</td>
      <td>1.20741</td>
      <td>1.20741</td>
      <td>1.20741</td>
      <td>1.20741</td>
      <td>1.20741</td>
      <td>1.20741</td>
      <td>1.20741</td>
      <td>1.20741</td>
      <td>...</td>
      <td>1.20741</td>
      <td>1.20741</td>
      <td>1.20741</td>
      <td>1.20741</td>
      <td>1.20741</td>
      <td>1.20741</td>
      <td>1.20741</td>
      <td>1.20741</td>
      <td>1.20741</td>
      <td>1.20741</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1.20741</td>
      <td>1.20741</td>
      <td>1.20741</td>
      <td>1.20741</td>
      <td>1.20741</td>
      <td>1.20741</td>
      <td>1.20741</td>
      <td>1.20741</td>
      <td>1.20741</td>
      <td>1.20741</td>
      <td>...</td>
      <td>1.20741</td>
      <td>1.20741</td>
      <td>1.20741</td>
      <td>1.20741</td>
      <td>1.20741</td>
      <td>1.20741</td>
      <td>1.20741</td>
      <td>1.20741</td>
      <td>1.20741</td>
      <td>1.20741</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1.20741</td>
      <td>1.20741</td>
      <td>1.20741</td>
      <td>1.20741</td>
      <td>1.20741</td>
      <td>1.20741</td>
      <td>1.20741</td>
      <td>1.20741</td>
      <td>1.20741</td>
      <td>1.20741</td>
      <td>...</td>
      <td>1.20741</td>
      <td>1.20741</td>
      <td>1.20741</td>
      <td>1.20741</td>
      <td>1.20741</td>
      <td>1.20741</td>
      <td>1.20741</td>
      <td>1.20741</td>
      <td>1.20741</td>
      <td>1.20741</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1.20741</td>
      <td>1.20741</td>
      <td>1.20741</td>
      <td>1.20741</td>
      <td>1.20741</td>
      <td>1.20741</td>
      <td>1.20741</td>
      <td>1.20741</td>
      <td>1.20741</td>
      <td>1.20741</td>
      <td>...</td>
      <td>1.20741</td>
      <td>1.20741</td>
      <td>1.20741</td>
      <td>1.20741</td>
      <td>1.20741</td>
      <td>1.20741</td>
      <td>1.20741</td>
      <td>1.20741</td>
      <td>1.20741</td>
      <td>1.20741</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1.20741</td>
      <td>1.20741</td>
      <td>1.20741</td>
      <td>1.20741</td>
      <td>1.20741</td>
      <td>1.20741</td>
      <td>1.20741</td>
      <td>1.20741</td>
      <td>1.20741</td>
      <td>1.20741</td>
      <td>...</td>
      <td>1.20741</td>
      <td>1.20741</td>
      <td>1.20741</td>
      <td>1.20741</td>
      <td>1.20741</td>
      <td>1.20741</td>
      <td>1.20741</td>
      <td>1.20741</td>
      <td>1.20741</td>
      <td>1.20741</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 140 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">evaluate</span><span class="p">(</span><span class="n">pred_g</span><span class="p">,</span> <span class="n">train_mat</span><span class="p">,</span> <span class="n">valid_mat</span><span class="p">,</span> <span class="n">model_name</span><span class="o">=</span><span class="s2">&quot;Global average&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Global average train RMSE: 5.75
Global average valid RMSE: 5.77
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="k-nearest-neighbours-imputation">
<h3><a class="reference external" href="https://scikit-learn.org/stable/modules/generated/sklearn.impute.KNNImputer.html"><span class="math notranslate nohighlight">\(k\)</span>-nearest neighbours imputation</a><a class="headerlink" href="#k-nearest-neighbours-imputation" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Can we try <span class="math notranslate nohighlight">\(k\)</span>-nearest neighbours type imputation?</p></li>
<li><p>Impute missing values using the mean value from <span class="math notranslate nohighlight">\(k\)</span> nearest neighbours found in the training set.</p></li>
<li><p>Calculate distances between examples using features where neither value is missing.</p></li>
</ul>
<a class="reference internal image-reference" href="../_images/utility_matrix.png"><img alt="" src="../_images/utility_matrix.png" style="width: 900px; height: 900px;" /></a>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.impute</span> <span class="kn">import</span> <span class="n">KNNImputer</span>

<span class="n">imputer</span> <span class="o">=</span> <span class="n">KNNImputer</span><span class="p">(</span><span class="n">n_neighbors</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">train_mat_imp</span> <span class="o">=</span> <span class="n">imputer</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">train_mat</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">train_mat_imp</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>0</th>
      <th>1</th>
      <th>2</th>
      <th>3</th>
      <th>4</th>
      <th>5</th>
      <th>6</th>
      <th>7</th>
      <th>8</th>
      <th>9</th>
      <th>...</th>
      <th>130</th>
      <th>131</th>
      <th>132</th>
      <th>133</th>
      <th>134</th>
      <th>135</th>
      <th>136</th>
      <th>137</th>
      <th>138</th>
      <th>139</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>-5.9406</td>
      <td>-9.2810</td>
      <td>-9.2810</td>
      <td>-6.7810</td>
      <td>0.8750</td>
      <td>-9.6560</td>
      <td>-9.0310</td>
      <td>-7.4690</td>
      <td>-8.7190</td>
      <td>-9.1560</td>
      <td>...</td>
      <td>-4.5311</td>
      <td>1.8968</td>
      <td>0.6905</td>
      <td>-3.1218</td>
      <td>1.2843</td>
      <td>-2.6063</td>
      <td>-0.1812</td>
      <td>-1.3937</td>
      <td>1.7625</td>
      <td>-0.4092</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2.3405</td>
      <td>9.9380</td>
      <td>9.5310</td>
      <td>9.9380</td>
      <td>0.4060</td>
      <td>3.7190</td>
      <td>9.6560</td>
      <td>-2.6880</td>
      <td>4.3438</td>
      <td>-9.1250</td>
      <td>...</td>
      <td>2.2437</td>
      <td>3.1719</td>
      <td>5.0251</td>
      <td>5.1812</td>
      <td>8.2407</td>
      <td>5.9311</td>
      <td>5.8375</td>
      <td>6.3812</td>
      <td>1.1687</td>
      <td>6.2532</td>
    </tr>
    <tr>
      <th>2</th>
      <td>-9.8440</td>
      <td>-3.5750</td>
      <td>-7.2190</td>
      <td>-2.0310</td>
      <td>-9.9380</td>
      <td>-9.9690</td>
      <td>-9.8750</td>
      <td>-9.8120</td>
      <td>-9.7810</td>
      <td>-6.8440</td>
      <td>...</td>
      <td>-4.4186</td>
      <td>-3.1156</td>
      <td>-1.5655</td>
      <td>-5.6250</td>
      <td>0.3720</td>
      <td>-4.0439</td>
      <td>-6.0500</td>
      <td>-5.5563</td>
      <td>-5.4125</td>
      <td>-5.5874</td>
    </tr>
    <tr>
      <th>3</th>
      <td>-5.8120</td>
      <td>-1.6499</td>
      <td>-4.9060</td>
      <td>-2.7781</td>
      <td>0.5530</td>
      <td>-3.8594</td>
      <td>1.7031</td>
      <td>-0.3687</td>
      <td>1.8469</td>
      <td>0.0593</td>
      <td>...</td>
      <td>-2.0344</td>
      <td>2.1469</td>
      <td>2.8875</td>
      <td>1.6845</td>
      <td>1.2437</td>
      <td>-0.0156</td>
      <td>1.2595</td>
      <td>3.8219</td>
      <td>3.1971</td>
      <td>5.0249</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1.3157</td>
      <td>4.7500</td>
      <td>1.8658</td>
      <td>-0.4060</td>
      <td>1.7937</td>
      <td>3.8750</td>
      <td>6.2190</td>
      <td>1.9220</td>
      <td>6.0940</td>
      <td>5.4060</td>
      <td>...</td>
      <td>-0.2844</td>
      <td>1.1313</td>
      <td>4.0157</td>
      <td>3.0344</td>
      <td>4.0406</td>
      <td>0.5218</td>
      <td>4.3594</td>
      <td>4.0968</td>
      <td>3.9250</td>
      <td>3.9657</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>3630</th>
      <td>-0.7750</td>
      <td>-9.8120</td>
      <td>-0.0620</td>
      <td>-2.8218</td>
      <td>-4.1470</td>
      <td>-4.8281</td>
      <td>2.2718</td>
      <td>-2.8782</td>
      <td>-1.0125</td>
      <td>0.0688</td>
      <td>...</td>
      <td>-6.6844</td>
      <td>3.0531</td>
      <td>2.8687</td>
      <td>1.5281</td>
      <td>4.5002</td>
      <td>-0.1878</td>
      <td>2.0031</td>
      <td>4.0908</td>
      <td>2.3563</td>
      <td>5.0406</td>
    </tr>
    <tr>
      <th>3631</th>
      <td>2.5188</td>
      <td>-5.0625</td>
      <td>-0.4001</td>
      <td>-9.7190</td>
      <td>-9.3440</td>
      <td>-1.6408</td>
      <td>-4.1187</td>
      <td>8.9380</td>
      <td>8.3750</td>
      <td>-0.9314</td>
      <td>...</td>
      <td>-4.0344</td>
      <td>7.9155</td>
      <td>3.4282</td>
      <td>4.2968</td>
      <td>6.7968</td>
      <td>7.3999</td>
      <td>1.8500</td>
      <td>5.8219</td>
      <td>5.1812</td>
      <td>2.8437</td>
    </tr>
    <tr>
      <th>3632</th>
      <td>0.1749</td>
      <td>-1.9060</td>
      <td>3.9690</td>
      <td>-1.3844</td>
      <td>-0.3440</td>
      <td>-8.8440</td>
      <td>4.1880</td>
      <td>-1.5564</td>
      <td>5.0593</td>
      <td>0.3343</td>
      <td>...</td>
      <td>-4.0126</td>
      <td>2.8344</td>
      <td>2.4499</td>
      <td>2.9312</td>
      <td>2.3750</td>
      <td>-0.4062</td>
      <td>1.4375</td>
      <td>3.9750</td>
      <td>-1.2220</td>
      <td>2.8375</td>
    </tr>
    <tr>
      <th>3633</th>
      <td>-2.7749</td>
      <td>-6.4907</td>
      <td>-6.1594</td>
      <td>-9.1560</td>
      <td>-7.1437</td>
      <td>-6.5406</td>
      <td>2.2531</td>
      <td>-1.5563</td>
      <td>-3.7406</td>
      <td>-0.6406</td>
      <td>...</td>
      <td>-4.6938</td>
      <td>4.8061</td>
      <td>4.9968</td>
      <td>-0.1626</td>
      <td>2.4187</td>
      <td>-0.7750</td>
      <td>4.6781</td>
      <td>1.7658</td>
      <td>0.4595</td>
      <td>0.1843</td>
    </tr>
    <tr>
      <th>3634</th>
      <td>-0.0812</td>
      <td>-6.3120</td>
      <td>1.2810</td>
      <td>-3.5310</td>
      <td>2.1250</td>
      <td>-5.8120</td>
      <td>5.5620</td>
      <td>0.2218</td>
      <td>0.1250</td>
      <td>-1.1874</td>
      <td>...</td>
      <td>-3.8156</td>
      <td>4.1812</td>
      <td>4.1880</td>
      <td>3.7280</td>
      <td>3.0750</td>
      <td>2.1033</td>
      <td>2.8156</td>
      <td>5.5312</td>
      <td>3.8283</td>
      <td>4.1219</td>
    </tr>
  </tbody>
</table>
<p>3635 rows × 140 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">evaluate</span><span class="p">(</span><span class="n">train_mat_imp</span><span class="p">,</span> <span class="n">train_mat</span><span class="p">,</span> <span class="n">valid_mat</span><span class="p">,</span> <span class="n">model_name</span><span class="o">=</span><span class="s2">&quot;KNN imputer&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>KNN imputer train RMSE: 0.00
KNN imputer valid RMSE: 4.79
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="finding-nearest-neighbors">
<h3>Finding <a class="reference external" href="https://scikit-learn.org/stable/modules/generated/sklearn.neighbors.NearestNeighbors.html">nearest neighbors</a><a class="headerlink" href="#finding-nearest-neighbors" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>We can look at nearest neighbours of a query item.</p></li>
<li><p>Here our columns are jokes, and users are features for jokes, and we’ll have to find nearest neighbours of columns vectors.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">train_mat_imp</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>0</th>
      <th>1</th>
      <th>2</th>
      <th>3</th>
      <th>4</th>
      <th>5</th>
      <th>6</th>
      <th>7</th>
      <th>8</th>
      <th>9</th>
      <th>...</th>
      <th>130</th>
      <th>131</th>
      <th>132</th>
      <th>133</th>
      <th>134</th>
      <th>135</th>
      <th>136</th>
      <th>137</th>
      <th>138</th>
      <th>139</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>-5.9406</td>
      <td>-9.2810</td>
      <td>-9.2810</td>
      <td>-6.7810</td>
      <td>0.8750</td>
      <td>-9.6560</td>
      <td>-9.0310</td>
      <td>-7.4690</td>
      <td>-8.7190</td>
      <td>-9.1560</td>
      <td>...</td>
      <td>-4.5311</td>
      <td>1.8968</td>
      <td>0.6905</td>
      <td>-3.1218</td>
      <td>1.2843</td>
      <td>-2.6063</td>
      <td>-0.1812</td>
      <td>-1.3937</td>
      <td>1.7625</td>
      <td>-0.4092</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2.3405</td>
      <td>9.9380</td>
      <td>9.5310</td>
      <td>9.9380</td>
      <td>0.4060</td>
      <td>3.7190</td>
      <td>9.6560</td>
      <td>-2.6880</td>
      <td>4.3438</td>
      <td>-9.1250</td>
      <td>...</td>
      <td>2.2437</td>
      <td>3.1719</td>
      <td>5.0251</td>
      <td>5.1812</td>
      <td>8.2407</td>
      <td>5.9311</td>
      <td>5.8375</td>
      <td>6.3812</td>
      <td>1.1687</td>
      <td>6.2532</td>
    </tr>
    <tr>
      <th>2</th>
      <td>-9.8440</td>
      <td>-3.5750</td>
      <td>-7.2190</td>
      <td>-2.0310</td>
      <td>-9.9380</td>
      <td>-9.9690</td>
      <td>-9.8750</td>
      <td>-9.8120</td>
      <td>-9.7810</td>
      <td>-6.8440</td>
      <td>...</td>
      <td>-4.4186</td>
      <td>-3.1156</td>
      <td>-1.5655</td>
      <td>-5.6250</td>
      <td>0.3720</td>
      <td>-4.0439</td>
      <td>-6.0500</td>
      <td>-5.5563</td>
      <td>-5.4125</td>
      <td>-5.5874</td>
    </tr>
    <tr>
      <th>3</th>
      <td>-5.8120</td>
      <td>-1.6499</td>
      <td>-4.9060</td>
      <td>-2.7781</td>
      <td>0.5530</td>
      <td>-3.8594</td>
      <td>1.7031</td>
      <td>-0.3687</td>
      <td>1.8469</td>
      <td>0.0593</td>
      <td>...</td>
      <td>-2.0344</td>
      <td>2.1469</td>
      <td>2.8875</td>
      <td>1.6845</td>
      <td>1.2437</td>
      <td>-0.0156</td>
      <td>1.2595</td>
      <td>3.8219</td>
      <td>3.1971</td>
      <td>5.0249</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1.3157</td>
      <td>4.7500</td>
      <td>1.8658</td>
      <td>-0.4060</td>
      <td>1.7937</td>
      <td>3.8750</td>
      <td>6.2190</td>
      <td>1.9220</td>
      <td>6.0940</td>
      <td>5.4060</td>
      <td>...</td>
      <td>-0.2844</td>
      <td>1.1313</td>
      <td>4.0157</td>
      <td>3.0344</td>
      <td>4.0406</td>
      <td>0.5218</td>
      <td>4.3594</td>
      <td>4.0968</td>
      <td>3.9250</td>
      <td>3.9657</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>3630</th>
      <td>-0.7750</td>
      <td>-9.8120</td>
      <td>-0.0620</td>
      <td>-2.8218</td>
      <td>-4.1470</td>
      <td>-4.8281</td>
      <td>2.2718</td>
      <td>-2.8782</td>
      <td>-1.0125</td>
      <td>0.0688</td>
      <td>...</td>
      <td>-6.6844</td>
      <td>3.0531</td>
      <td>2.8687</td>
      <td>1.5281</td>
      <td>4.5002</td>
      <td>-0.1878</td>
      <td>2.0031</td>
      <td>4.0908</td>
      <td>2.3563</td>
      <td>5.0406</td>
    </tr>
    <tr>
      <th>3631</th>
      <td>2.5188</td>
      <td>-5.0625</td>
      <td>-0.4001</td>
      <td>-9.7190</td>
      <td>-9.3440</td>
      <td>-1.6408</td>
      <td>-4.1187</td>
      <td>8.9380</td>
      <td>8.3750</td>
      <td>-0.9314</td>
      <td>...</td>
      <td>-4.0344</td>
      <td>7.9155</td>
      <td>3.4282</td>
      <td>4.2968</td>
      <td>6.7968</td>
      <td>7.3999</td>
      <td>1.8500</td>
      <td>5.8219</td>
      <td>5.1812</td>
      <td>2.8437</td>
    </tr>
    <tr>
      <th>3632</th>
      <td>0.1749</td>
      <td>-1.9060</td>
      <td>3.9690</td>
      <td>-1.3844</td>
      <td>-0.3440</td>
      <td>-8.8440</td>
      <td>4.1880</td>
      <td>-1.5564</td>
      <td>5.0593</td>
      <td>0.3343</td>
      <td>...</td>
      <td>-4.0126</td>
      <td>2.8344</td>
      <td>2.4499</td>
      <td>2.9312</td>
      <td>2.3750</td>
      <td>-0.4062</td>
      <td>1.4375</td>
      <td>3.9750</td>
      <td>-1.2220</td>
      <td>2.8375</td>
    </tr>
    <tr>
      <th>3633</th>
      <td>-2.7749</td>
      <td>-6.4907</td>
      <td>-6.1594</td>
      <td>-9.1560</td>
      <td>-7.1437</td>
      <td>-6.5406</td>
      <td>2.2531</td>
      <td>-1.5563</td>
      <td>-3.7406</td>
      <td>-0.6406</td>
      <td>...</td>
      <td>-4.6938</td>
      <td>4.8061</td>
      <td>4.9968</td>
      <td>-0.1626</td>
      <td>2.4187</td>
      <td>-0.7750</td>
      <td>4.6781</td>
      <td>1.7658</td>
      <td>0.4595</td>
      <td>0.1843</td>
    </tr>
    <tr>
      <th>3634</th>
      <td>-0.0812</td>
      <td>-6.3120</td>
      <td>1.2810</td>
      <td>-3.5310</td>
      <td>2.1250</td>
      <td>-5.8120</td>
      <td>5.5620</td>
      <td>0.2218</td>
      <td>0.1250</td>
      <td>-1.1874</td>
      <td>...</td>
      <td>-3.8156</td>
      <td>4.1812</td>
      <td>4.1880</td>
      <td>3.7280</td>
      <td>3.0750</td>
      <td>2.1033</td>
      <td>2.8156</td>
      <td>5.5312</td>
      <td>3.8283</td>
      <td>4.1219</td>
    </tr>
  </tbody>
</table>
<p>3635 rows × 140 columns</p>
</div></div></div>
</div>
</div>
<div class="section" id="k-nearest-neighbours-on-a-query-joke">
<h3><span class="math notranslate nohighlight">\(k\)</span>-nearest neighbours on a query joke<a class="headerlink" href="#k-nearest-neighbours-on-a-query-joke" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Let’s transpose the matrix.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">item_user_mat</span> <span class="o">=</span> <span class="n">train_mat_imp</span><span class="o">.</span><span class="n">T</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">jokes_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;data/jester_items.csv&quot;</span><span class="p">)</span>
<span class="n">jokes_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>jokeId</th>
      <th>jokeText</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>A man visits the doctor. The doctor says "I have bad news for you.You have\ncancer and Alzheimer's disease". \nThe man replies "Well,thank God I don't have cancer!"\n</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>This couple had an excellent relationship going until one day he came home\nfrom work to find his girlfriend packing. He asked her why she was leaving him\nand she told him that she had heard awful things about him. \n\n"What could they possibly have said to make you move out?" \n\n"They told me that you were a pedophile." \n\nHe replied, "That's an awfully big word for a ten year old." \n</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>Q. What's 200 feet long and has 4 teeth? \n\nA. The front row at a Willie Nelson Concert.\n</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>Q. What's the difference between a man and a toilet? \n\nA. A toilet doesn't follow you around after you use it.\n</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5</td>
      <td>Q.\tWhat's O. J. Simpson's Internet address? \nA.\tSlash, slash, backslash, slash, slash, escape.\n</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">id_joke_map</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">jokes_df</span><span class="o">.</span><span class="n">jokeId</span><span class="p">,</span> <span class="n">jokes_df</span><span class="o">.</span><span class="n">jokeText</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.neighbors</span> <span class="kn">import</span> <span class="n">NearestNeighbors</span>


<span class="k">def</span> <span class="nf">get_topk_recommendations</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">query_ind</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s2">&quot;cosine&quot;</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">query_idx</span> <span class="o">=</span> <span class="n">item_inverse_mapper</span><span class="p">[</span><span class="n">query_ind</span><span class="p">]</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">NearestNeighbors</span><span class="p">(</span><span class="n">n_neighbors</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s2">&quot;cosine&quot;</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    <span class="n">neigh_ind</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">kneighbors</span><span class="p">([</span><span class="n">X</span><span class="p">[</span><span class="n">query_ind</span><span class="p">]],</span> <span class="n">k</span><span class="p">,</span> <span class="n">return_distance</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">neigh_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">neigh_ind</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">query_ind</span> <span class="o">==</span> <span class="n">query_ind</span><span class="p">))</span>
    <span class="n">recs</span> <span class="o">=</span> <span class="p">[</span><span class="n">id_joke_map</span><span class="p">[</span><span class="n">item_inverse_mapper</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">neigh_ind</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Query joke: &quot;</span><span class="p">,</span> <span class="n">id_joke_map</span><span class="p">[</span><span class="n">query_idx</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">recs</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;top recommendations&quot;</span><span class="p">])</span>


<span class="n">get_topk_recommendations</span><span class="p">(</span><span class="n">item_user_mat</span><span class="p">,</span> <span class="n">query_ind</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s2">&quot;cosine&quot;</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Query joke:  Q: If a person who speaks three languages is called &quot;tri-lingual,&quot; and
a person who speaks two languages is called &quot;bi-lingual,&quot; what do call
a person who only speaks one language?

A: American! 
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>top recommendations</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Q: What is the difference between George  Washington, Richard Nixon,\nand Bill Clinton?\n\nA: Washington couldn't tell a lie, Nixon couldn't   tell the truth, and\nClinton doesn't know the difference.\n</td>
    </tr>
    <tr>
      <th>1</th>
      <td>A man in a hot air balloon realized he was lost. He reduced altitude and spotted a woman below. He descended a bit more and shouted, "Excuse me, can you help me? I promised a friend I would meet him an hour ago, but I don't know where I am." The woman below replied, "You are in a hot air balloon hovering approximately 30 feet above the ground. You are between 40 and 41 degrees north latitude and between 59 and 60 degrees west longitude." "You must be an engineer," said the balloonist. "I am," replied the woman. "How did you know?" "Well," answered the balloonist, "everything you told me is technically correct, but I have no idea what to make of your information, and the fact is, I am still lost. Frankly, you've not been much help so far." The woman below responded, "You must be in management." "I am," replied the balloonist, "but how did you know?" "Well," said the woman, "you don't know where you are or where you are going. You have risen to where you are due to a large quantity of hot air. You made a promise that you have no idea how to keep, and you expect people beneath you to solve your problems. The fact is, you are in exactly the same position you were in before we met, but now, somehow, it's my fault!"</td>
    </tr>
    <tr>
      <th>2</th>
      <td>If pro- is the opposite of con- then congress must be the opposite\nof progress.\n</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Arnold Swartzeneger and Sylvester Stallone are making a movie about\nthe lives of the great composers.  \nStallone says "I want to be Mozart." \nSwartzeneger says: "In that case...  I'll be Bach."\n</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p><strong>Question</strong></p>
<ul class="simple">
<li><p>Instead of imputation, what would be the consequences if we replace <code class="docutils literal notranslate"><span class="pre">nan</span></code> with zeros so that we can calculate distances between vectors?</p></li>
</ul>
<p><br><br>
<strong>Answer</strong></p>
<p>It’s not a good idea replace ratings with 0, because 0 can be an actual rating value in our case.</p>
</div>
<div class="section" id="what-to-do-with-predictions">
<h3>What to do with predictions?<a class="headerlink" href="#what-to-do-with-predictions" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Once you have predictions, you can sort them based on ratings and recommend items with highest ratings.</p></li>
</ul>
<p><br><br><br><br></p>
</div>
</div>
<div class="section" id="collaborative-filtering">
<h2>Collaborative filtering<a class="headerlink" href="#collaborative-filtering" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id4">
<h3>Collaborative filtering<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>One of the most popular approach for recommendation systems.</p></li>
<li><p>Approach used by the winning entry (and most of the entries) in the Netflix competition.</p></li>
<li><p>An unsupervised approach</p>
<ul>
<li><p>Only uses the user-item interactions given in the ratings matrix.</p></li>
</ul>
</li>
<li><p><strong>Intuition</strong></p>
<ul>
<li><p>We may have similar users and similar items which can help us predict missing entries.</p></li>
<li><p>Leverage social information to provide recommendations.</p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="problem">
<h3>Problem<a class="headerlink" href="#problem" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Given a utility matrix with many missing entries, how can we predict missing ratings?</p></li>
</ul>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{bmatrix} 
? &amp; ? &amp; \checkmark  &amp; ? &amp; \checkmark\\
\checkmark &amp; ? &amp; ?  &amp; ? &amp; ?\\
? &amp; \checkmark &amp; \checkmark  &amp; ? &amp; \checkmark\\
? &amp; ? &amp; ?  &amp; ? &amp; ?\\
? &amp; ? &amp; ? &amp; \checkmark &amp; ?\\
? &amp; \checkmark &amp; \checkmark  &amp; ? &amp; \checkmark
\end{bmatrix}
\end{split}\]</div>
<blockquote>
<div><p>Note: rating prediction <span class="math notranslate nohighlight">\(\neq\)</span> Classification or regression</p>
</div></blockquote>
</div>
<div class="section" id="classification-or-regression">
<h3>Classification or regression<a class="headerlink" href="#classification-or-regression" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>We have <span class="math notranslate nohighlight">\(X\)</span> and targets for some rows in <span class="math notranslate nohighlight">\(X\)</span>.</p></li>
<li><p>We want to predict the last column (target column).</p></li>
</ul>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{bmatrix} 
\checkmark &amp; \checkmark &amp; \checkmark  &amp; \checkmark &amp; \checkmark\\
\checkmark &amp; \checkmark &amp; \checkmark  &amp; \checkmark &amp; \checkmark\\
\checkmark &amp; \checkmark &amp; \checkmark  &amp; \checkmark &amp; \checkmark\\
\checkmark &amp; \checkmark &amp; \checkmark  &amp; \checkmark &amp; ?\\
\checkmark &amp; \checkmark &amp; \checkmark  &amp; \checkmark &amp; ?\\
\checkmark &amp; \checkmark &amp; \checkmark  &amp; \checkmark &amp; ?\\
\end{bmatrix}
\end{split}\]</div>
</div>
<div class="section" id="rating-prediction">
<h3>Rating prediction<a class="headerlink" href="#rating-prediction" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Ratings data has many missing values in the utility matrix. There is no special target column. We want to predict the missing entries in the matrix.</p></li>
<li><p>Since our goal is to <strong>predict</strong> ratings, usually the utility matrix is referred to as <span class="math notranslate nohighlight">\(Y\)</span> matrix.</p></li>
</ul>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{bmatrix} 
? &amp; ? &amp; \checkmark  &amp; ? &amp; \checkmark\\
\checkmark &amp; ? &amp; ?  &amp; ? &amp; ?\\
? &amp; \checkmark &amp; \checkmark  &amp; ? &amp; \checkmark\\
? &amp; ? &amp; ?  &amp; ? &amp; ?\\
? &amp; ? &amp; ? &amp; \checkmark &amp; ?\\
? &amp; \checkmark &amp; \checkmark  &amp; ? &amp; \checkmark
\end{bmatrix}
\end{split}\]</div>
<p><br><br></p>
<ul class="simple">
<li><p>I’ll show you how to use a package which implements collaborative filtering.</p></li>
<li><p>We don’t have sufficient background to understand how it works under the hood.</p></li>
</ul>
</div>
<div class="section" id="rating-prediction-using-the-surprise-package">
<h3>Rating prediction using the surprise package<a class="headerlink" href="#rating-prediction-using-the-surprise-package" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>We’ll be using a package called <a class="reference external" href="https://surprise.readthedocs.io/en/stable/index.html">Surprise</a>.</p></li>
<li><p>The collaborative filtering algorithm we use in this package is called <code class="docutils literal notranslate"><span class="pre">SVD</span></code>.</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">conda</span> <span class="n">install</span> <span class="o">-</span><span class="n">c</span> <span class="n">conda</span><span class="o">-</span><span class="n">forge</span> <span class="n">scikit</span><span class="o">-</span><span class="n">surprise</span>
</pre></div>
</div>
<p>Let’s try it out on our Jester dataset utility matrix.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">surprise</span>
<span class="kn">from</span> <span class="nn">surprise</span> <span class="kn">import</span> <span class="n">SVD</span><span class="p">,</span> <span class="n">Dataset</span><span class="p">,</span> <span class="n">Reader</span><span class="p">,</span> <span class="n">accuracy</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">reader</span> <span class="o">=</span> <span class="n">Reader</span><span class="p">()</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">load_from_df</span><span class="p">(</span><span class="n">ratings</span><span class="p">,</span> <span class="n">reader</span><span class="p">)</span>  <span class="c1"># Load the data</span>

<span class="c1"># I&#39;m being sloppy here. Probably there is a way to create validset from our already split data.</span>
<span class="n">trainset</span><span class="p">,</span> <span class="n">validset</span> <span class="o">=</span> <span class="n">surprise</span><span class="o">.</span><span class="n">model_selection</span><span class="o">.</span><span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">data</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
<span class="p">)</span>  <span class="c1"># Split the data</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">k</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">algo</span> <span class="o">=</span> <span class="n">SVD</span><span class="p">(</span><span class="n">n_factors</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="n">algo</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">trainset</span><span class="p">)</span>
<span class="n">svd_preds</span> <span class="o">=</span> <span class="n">algo</span><span class="o">.</span><span class="n">test</span><span class="p">(</span><span class="n">validset</span><span class="p">)</span>
<span class="n">accuracy</span><span class="o">.</span><span class="n">rmse</span><span class="p">(</span><span class="n">svd_preds</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>RMSE: 5.2893
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>5.28926338380112
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>No big improvement over the global baseline (RMSE=5.77).</p></li>
<li><p>Probably because we are only considering a sample.</p></li>
</ul>
</div>
<div class="section" id="cross-validation-for-recommender-systems">
<h3>Cross-validation for recommender systems<a class="headerlink" href="#cross-validation-for-recommender-systems" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>We can also carry out cross-validation and grid search with this package.</p></li>
<li><p>Let’s look at an example of cross-validation.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">surprise.model_selection</span> <span class="kn">import</span> <span class="n">cross_validate</span>

<span class="n">results</span> <span class="o">=</span> <span class="n">cross_validate</span><span class="p">(</span><span class="n">algo</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">measures</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;RMSE&quot;</span><span class="p">,</span> <span class="s2">&quot;MAE&quot;</span><span class="p">],</span> <span class="n">cv</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evaluating RMSE, MAE of algorithm SVD on 5 split(s).

                  Fold 1  Fold 2  Fold 3  Fold 4  Fold 5  Mean    Std     
RMSE (testset)    5.2887  5.2738  5.2776  5.2866  5.2801  5.2813  0.0055  
MAE (testset)     4.2128  4.1921  4.1942  4.1982  4.1984  4.1991  0.0072  
Fit time          1.42    1.44    1.44    1.43    1.44    1.43    0.01    
Test time         0.22    0.12    0.19    0.12    0.20    0.17    0.04    
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>test_rmse    5.281340
test_mae     4.199135
fit_time     1.432820
test_time    0.168270
dtype: float64
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Jester dataset is available as one of the built-in datasets in this package and you can load it as follows and run cross-validation as follows.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">load_builtin</span><span class="p">(</span><span class="s2">&quot;jester&quot;</span><span class="p">)</span>

<span class="n">results</span> <span class="o">=</span> <span class="n">cross_validate</span><span class="p">(</span><span class="n">algo</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">measures</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;RMSE&quot;</span><span class="p">,</span> <span class="s2">&quot;MAE&quot;</span><span class="p">],</span> <span class="n">cv</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">KeyboardInterrupt</span><span class="g g-Whitespace">                         </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">80</span><span class="o">/</span><span class="n">kr9rkqfj4w78h49djkz8yy9r0000gp</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_38354</span><span class="o">/</span><span class="mf">2323080709.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="n">data</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">load_builtin</span><span class="p">(</span><span class="s2">&quot;jester&quot;</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> 
<span class="ne">----&gt; </span><span class="mi">3</span> <span class="n">results</span> <span class="o">=</span> <span class="n">cross_validate</span><span class="p">(</span><span class="n">algo</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">measures</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;RMSE&quot;</span><span class="p">,</span> <span class="s2">&quot;MAE&quot;</span><span class="p">],</span> <span class="n">cv</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="nn">~/opt/miniconda3/envs/cpsc330/lib/python3.9/site-packages/surprise/model_selection/validation.py</span> in <span class="ni">cross_validate</span><span class="nt">(algo, data, measures, cv, return_train_measures, n_jobs, pre_dispatch, verbose)</span>
<span class="g g-Whitespace">    </span><span class="mi">101</span>                                            <span class="n">return_train_measures</span><span class="p">)</span>
<span class="nn">    102                     for (trainset, testset)</span> in <span class="ni">cv.split</span><span class="nt">(data))</span>
<span class="ne">--&gt; </span><span class="mi">103</span>     <span class="n">out</span> <span class="o">=</span> <span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">,</span> <span class="n">pre_dispatch</span><span class="o">=</span><span class="n">pre_dispatch</span><span class="p">)(</span><span class="n">delayed_list</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">104</span> 
<span class="g g-Whitespace">    </span><span class="mi">105</span>     <span class="p">(</span><span class="n">test_measures_dicts</span><span class="p">,</span>

<span class="nn">~/opt/miniconda3/envs/cpsc330/lib/python3.9/site-packages/joblib/parallel.py</span> in <span class="ni">__call__</span><span class="nt">(self, iterable)</span>
<span class="g g-Whitespace">   </span><span class="mi">1044</span>                 <span class="bp">self</span><span class="o">.</span><span class="n">_iterating</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_original_iterator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<span class="g g-Whitespace">   </span><span class="mi">1045</span> 
<span class="ne">-&gt; </span><span class="mi">1046</span>             <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispatch_one_batch</span><span class="p">(</span><span class="n">iterator</span><span class="p">):</span>
<span class="g g-Whitespace">   </span><span class="mi">1047</span>                 <span class="k">pass</span>
<span class="g g-Whitespace">   </span><span class="mi">1048</span> 

<span class="nn">~/opt/miniconda3/envs/cpsc330/lib/python3.9/site-packages/joblib/parallel.py</span> in <span class="ni">dispatch_one_batch</span><span class="nt">(self, iterator)</span>
<span class="g g-Whitespace">    </span><span class="mi">859</span>                 <span class="k">return</span> <span class="kc">False</span>
<span class="g g-Whitespace">    </span><span class="mi">860</span>             <span class="k">else</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">861</span>                 <span class="bp">self</span><span class="o">.</span><span class="n">_dispatch</span><span class="p">(</span><span class="n">tasks</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">862</span>                 <span class="k">return</span> <span class="kc">True</span>
<span class="g g-Whitespace">    </span><span class="mi">863</span> 

<span class="nn">~/opt/miniconda3/envs/cpsc330/lib/python3.9/site-packages/joblib/parallel.py</span> in <span class="ni">_dispatch</span><span class="nt">(self, batch)</span>
<span class="g g-Whitespace">    </span><span class="mi">777</span>         <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">778</span>             <span class="n">job_idx</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_jobs</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">779</span>             <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_backend</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">cb</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">780</span>             <span class="c1"># A job can complete so quickly than its callback is</span>
<span class="g g-Whitespace">    </span><span class="mi">781</span>             <span class="c1"># called before we get here, causing self._jobs to</span>

<span class="nn">~/opt/miniconda3/envs/cpsc330/lib/python3.9/site-packages/joblib/_parallel_backends.py</span> in <span class="ni">apply_async</span><span class="nt">(self, func, callback)</span>
<span class="g g-Whitespace">    </span><span class="mi">206</span>     <span class="k">def</span> <span class="nf">apply_async</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">207</span>         <span class="sd">&quot;&quot;&quot;Schedule a func to be run&quot;&quot;&quot;</span>
<span class="ne">--&gt; </span><span class="mi">208</span>         <span class="n">result</span> <span class="o">=</span> <span class="n">ImmediateResult</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">209</span>         <span class="k">if</span> <span class="n">callback</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">210</span>             <span class="n">callback</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

<span class="nn">~/opt/miniconda3/envs/cpsc330/lib/python3.9/site-packages/joblib/_parallel_backends.py</span> in <span class="ni">__init__</span><span class="nt">(self, batch)</span>
<span class="g g-Whitespace">    </span><span class="mi">570</span>         <span class="c1"># Don&#39;t delay the application, to avoid keeping the input</span>
<span class="g g-Whitespace">    </span><span class="mi">571</span>         <span class="c1"># arguments in memory</span>
<span class="ne">--&gt; </span><span class="mi">572</span>         <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="n">batch</span><span class="p">()</span>
<span class="g g-Whitespace">    </span><span class="mi">573</span> 
<span class="g g-Whitespace">    </span><span class="mi">574</span>     <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

<span class="nn">~/opt/miniconda3/envs/cpsc330/lib/python3.9/site-packages/joblib/parallel.py</span> in <span class="ni">__call__</span><span class="nt">(self)</span>
<span class="g g-Whitespace">    </span><span class="mi">260</span>         <span class="c1"># change the default number of processes to -1</span>
<span class="g g-Whitespace">    </span><span class="mi">261</span>         <span class="k">with</span> <span class="n">parallel_backend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_backend</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_jobs</span><span class="p">):</span>
<span class="ne">--&gt; </span><span class="mi">262</span>             <span class="k">return</span> <span class="p">[</span><span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">263</span>                     <span class="k">for</span> <span class="n">func</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">]</span>
<span class="g g-Whitespace">    </span><span class="mi">264</span> 

<span class="nn">~/opt/miniconda3/envs/cpsc330/lib/python3.9/site-packages/joblib/parallel.py</span> in <span class="ni">&lt;listcomp&gt;</span><span class="nt">(.0)</span>
<span class="g g-Whitespace">    </span><span class="mi">260</span>         <span class="c1"># change the default number of processes to -1</span>
<span class="g g-Whitespace">    </span><span class="mi">261</span>         <span class="k">with</span> <span class="n">parallel_backend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_backend</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_jobs</span><span class="p">):</span>
<span class="ne">--&gt; </span><span class="mi">262</span>             <span class="k">return</span> <span class="p">[</span><span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">263</span>                     <span class="k">for</span> <span class="n">func</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">]</span>
<span class="g g-Whitespace">    </span><span class="mi">264</span> 

<span class="nn">~/opt/miniconda3/envs/cpsc330/lib/python3.9/site-packages/surprise/model_selection/validation.py</span> in <span class="ni">fit_and_score</span><span class="nt">(algo, trainset, testset, measures, return_train_measures)</span>
<span class="g g-Whitespace">    </span><span class="mi">164</span> 
<span class="g g-Whitespace">    </span><span class="mi">165</span>     <span class="n">start_fit</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="ne">--&gt; </span><span class="mi">166</span>     <span class="n">algo</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">trainset</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">167</span>     <span class="n">fit_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_fit</span>
<span class="g g-Whitespace">    </span><span class="mi">168</span>     <span class="n">start_test</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="nn">~/opt/miniconda3/envs/cpsc330/lib/python3.9/site-packages/surprise/prediction_algorithms/matrix_factorization.pyx</span> in <span class="ni">surprise.prediction_algorithms.matrix_factorization.SVD.fit</span><span class="nt">()</span>

<span class="nn">~/opt/miniconda3/envs/cpsc330/lib/python3.9/site-packages/surprise/prediction_algorithms/matrix_factorization.pyx</span> in <span class="ni">surprise.prediction_algorithms.matrix_factorization.SVD.sgd</span><span class="nt">()</span>

<span class="nn">~/opt/miniconda3/envs/cpsc330/lib/python3.9/site-packages/surprise/trainset.py</span> in <span class="ni">all_ratings</span><span class="nt">(self)</span>
<span class="g g-Whitespace">    </span><span class="mi">187</span>         <span class="k">for</span> <span class="n">u</span><span class="p">,</span> <span class="n">u_ratings</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ur</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">188</span>             <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">u_ratings</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">189</span>                 <span class="k">yield</span> <span class="n">u</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span>
<span class="g g-Whitespace">    </span><span class="mi">190</span> 
<span class="g g-Whitespace">    </span><span class="mi">191</span>     <span class="k">def</span> <span class="nf">build_testset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

<span class="ne">KeyboardInterrupt</span>: 
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="what-is-content-based-filtering">
<h3>What is content-based filtering?<a class="headerlink" href="#what-is-content-based-filtering" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Supervised machine learning approach</p></li>
<li><p>In collaborative filtering we assumed that we only have ratings data.</p></li>
<li><p>Usually there is some information on items and users available.</p></li>
<li><p>Examples</p>
<ul>
<li><p>Netflix can describe movies as action, romance, comedy, documentaries.</p></li>
<li><p>Amazon could describe books according to topics: math, languages, history.</p></li>
<li><p>Tinder could describe people according to age, location, employment.</p></li>
</ul>
</li>
<li><p>Can we use this information to predict ratings in the utility matrix?</p>
<ul>
<li><p>Yes!</p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="hybrid-filtering">
<h3>Hybrid filtering<a class="headerlink" href="#hybrid-filtering" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Combining advantages of collaborative filtering and content-based filtering</p></li>
</ul>
<p><br><br><br><br></p>
</div>
</div>
<div class="section" id="final-comments-and-summary-a-name-1-a">
<h2>Final comments and summary <a name="1"></a><a class="headerlink" href="#final-comments-and-summary-a-name-1-a" title="Permalink to this headline">¶</a></h2>
<div class="section" id="formulating-the-problem-of-recommender-systems">
<h3>Formulating the problem of recommender systems<a class="headerlink" href="#formulating-the-problem-of-recommender-systems" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>We are given ratings data.</p></li>
<li><p>We use this data to create <strong>utility matrix</strong> which encodes interactions between users and items.</p></li>
<li><p>The utility matrix has many missing entries.</p></li>
<li><p>We defined recommendation systems problem as <strong>matrix completion problem</strong>.</p></li>
</ul>
</div>
<div class="section" id="id5">
<h3>Collaborative filtering<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Collaborative filtering is an unsupervised approach to recommendation systems.</p></li>
</ul>
</div>
<div class="section" id="id6">
<h3>Evaluation<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>We split the data similar to supervised systems.</p></li>
<li><p>We evaluate recommendation systems using traditional regression metrics such as MSE or RMSE.</p></li>
<li><p>But real evaluation of recommender system can be very tricky because there is no ground truth.</p></li>
<li><p>We have been using RMSE due to the lack of a better measure.</p></li>
<li><p>What we actually want to measure is the interest that our user has in the recommended items.</p></li>
</ul>
</div>
<div class="section" id="precision-at-n">
<h3>Precision at N<a class="headerlink" href="#precision-at-n" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Another popular evaluation metric from information retrieval is precision at N.</p></li>
<li><p>Suppose you recommend top-N items, then we look at the proportion of the items that are relevant.
$<span class="math notranslate nohighlight">\(\text{Precision at } N = \frac{r}{N}\)</span>$</p></li>
<li><p>For example, <span class="math notranslate nohighlight">\(r\)</span> could be the number of elements in your list that the user rated.</p></li>
<li><p>In this way, you would know that your system is recommending items that the user had interest in!</p></li>
</ul>
</div>
<div class="section" id="some-thoughts-on-recommendation-systems">
<h3>Some thoughts on recommendation systems<a class="headerlink" href="#some-thoughts-on-recommendation-systems" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Be mindful of the consequences recommendation systems.</p></li>
<li><p>Companies such as Amazon,  Netflix, Facebook, Google (YouTube), which extensively use recommendation systems, are profit-driven and so they design these systems to maximize user attention; their focus is not necessarily human well-being.</p></li>
<li><p>There are tons of news and research articles on serious consequences of recommendation systems.</p></li>
</ul>
</div>
<div class="section" id="id7">
<h3>Some thoughts on recommendation systems<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Some weird stories which got media attention.<br />
<a class="reference external" href="https://www.forbes.com/sites/kashmirhill/2012/02/16/how-target-figured-out-a-teen-girl-was-pregnant-before-her-father-did/?sh=3171af136668">How Target Figured Out A Teen Girl Was Pregnant Before Her Father Did</a></p></li>
<li><p>More serious consequences are in political contexts.</p>
<ul>
<li><p><a class="reference external" href="https://www.nytimes.com/2018/11/06/technology/myanmar-facebook.html">Facebook Admits It Was Used to Incite Violence in Myanmar</a></p></li>
<li><p><a class="reference external" href="https://www.theatlantic.com/politics/archive/2018/03/youtube-extremism-and-the-long-tail/555350/">YouTube Extremism and the Long Tail</a></p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="my-advice">
<h3>My advice<a class="headerlink" href="#my-advice" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Ask hard and uncomfortable questions to yourself (and to your employer if possible) before implementing and deploying such systems.</p></li>
</ul>
<p><br><br><br><br></p>
</div>
<div class="section" id="resources">
<h3>Resources<a class="headerlink" href="#resources" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p><a class="reference external" href="https://www.youtube.com/watch?v=z0dx-YckFko">Collaborative filtering for recommendation systems in Python, by N. Hug</a></p></li>
<li><p><a class="reference external" href="https://www.ted.com/talks/barry_schwartz_the_paradox_of_choice">An interesting talk: The paradox of choice</a></p></li>
<li><p><a class="reference external" href="https://help.netflix.com/en/node/100639">How Netflix’s Recommendations System Works</a></p></li>
<li><p><a class="reference external" href="https://learning.oreilly.com/library/view/hands-on-recommendation-systems/9781788993753/">Hands on Recommendation Systems with Python</a></p></li>
</ul>
<p><br><br><br><br></p>
</div>
<div class="section" id="questions-for-class-discussion-a-name-questions-a">
<h3>Questions for class discussion <a name="questions"></a><a class="headerlink" href="#questions-for-class-discussion-a-name-questions-a" title="Permalink to this headline">¶</a></h3>
</div>
<div class="section" id="true-false-questions">
<h3>True/False questions<a class="headerlink" href="#true-false-questions" title="Permalink to this headline">¶</a></h3>
<ol class="simple">
<li><p>To evaluate rating predictions we split the data. The shapes of validation utility matrix and train utility matrix are the same.</p></li>
<li><p>It would be reasonable to impute missing values in the utility matrix by taking the average of the ratings given to an item by similar users.</p></li>
<li><p>You might be able to predict missing ratings in the utility matrix using supervised machine learning methods.
<br><br><br><br></p></li>
</ol>
<ul class="simple">
<li><p>Discuss a strange/scary experience you had with recommendation systems.</p></li>
</ul>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "conda-env-cpsc330-py"
        },
        kernelOptions: {
            kernelName: "conda-env-cpsc330-py",
            path: "./lectures"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'conda-env-cpsc330-py'</script>

              </div>
              
        
        <div class='prev-next-bottom'>
            
    <a class='left-prev' id="prev-link" href="14_k-means-clustering.html" title="previous page">Lecture 14: Clustering</a>
    <a class='right-next' id="next-link" href="../attribution.html" title="next page">Attributions</a>

        </div>
        
        </div>
    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By Varada Kolhatkar<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="../_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  
  </body>
</html>