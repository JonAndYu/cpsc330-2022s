
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lecture 18: Time series &#8212; CPSC 330 Applied Machine Learning</title>
    
  <link href="../_static/css/theme.css" rel="stylesheet" />
  <link href="../_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/sphinx-book-theme.e8e5499552300ddf5d7adccae7cc3b70.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.1c5a1a01449ed65a7b51.js">

    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["\\(", "\\)"]], "displayMath": [["\\[", "\\]"]], "processRefs": false, "processEnvironments": false}})</script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
      <img src="../_static/UBC-CS-logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">CPSC 330 Applied Machine Learning</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
    <div class="bd-toc-item active">
        <p class="caption">
 <span class="caption-text">
  Things you should know
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../docs/README.html">
   CPSC 330 Documents
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Lectures
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="01_intro.html">
   Lecture 1: Course Introduction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="02_decision-trees.html">
   Lecture 2: Terminology, Baselines, Decision Trees
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="03_ml-fundamentals.html">
   Lecture 3: Machine Learning Fundamentals
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="04_kNNs-SVM-RBF.html">
   Lecture 4:
   <span class="math notranslate nohighlight">
    \(k\)
   </span>
   -Nearest Neighbours and SVM RBFs
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="05_preprocessing-pipelines.html">
   Lecture 5: Preprocessing and
   <code class="docutils literal notranslate">
    <span class="pre">
     sklearn
    </span>
   </code>
   pipelines
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="06_column-transformer-text-feats.html">
   Lecture 6:
   <code class="docutils literal notranslate">
    <span class="pre">
     sklearn
    </span>
   </code>
   <code class="docutils literal notranslate">
    <span class="pre">
     ColumnTransformer
    </span>
   </code>
   and Text Features
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="07_linear-models.html">
   Lecture 7: Linear Models
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="08_hyperparameter-optimization.html">
   Lecture 8: Hyperparameter Optimization and Optimization Bias
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="09_classification-metrics.html">
   Lecture 9: Classification Metrics
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="10_regression-metrics.html">
   Lecture 10: Regression Evaluation Metrics
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="11_ensembles.html">
   Lecture 11: Ensembles
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="13_feature-engineering-selection.html">
   Lecture 13: Feature engineering and feature selection
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="14_k-means-clustering.html">
   Lecture 14: Clustering
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="15_recommender-systems.html">
   Lecture 15: DBSCAN and Recommender Systems
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="16_natural-language-processing.html">
   Lecture 16: Introduction to natural language processing
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="17_intro_to_computer-vision.html">
   Lecture 17: Multi-class classification and introduction to computer vision
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Attribution
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../attribution.html">
   Attributions
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../LICENSE.html">
   LICENSE
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Varada Kolhatkar, CPSC 330 2021-22<br>Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/lectures/18_time-series.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/UBC-CS/cpsc330/master?urlpath=tree/lectures/18_time-series.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#">
   Lecture 18: Time series
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#imports">
     Imports
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#lecture-plan">
       Lecture plan
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#learning-objectives">
     Learning objectives
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#motivation">
     Motivation
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#train-test-split-for-temporal-data">
       Train/test split for temporal data
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#training-models">
       Training models
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#feature-engineering-for-date-time-columns">
       Feature engineering for date/time columns
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#cross-validation-with">
       Cross validation with
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#today-s-dataset-5-min">
     Today’s dataset (5 min)
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#goals">
       Goals
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#parsing-datetimes">
       Parsing datetimes
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#train-test-splits-with-temporal-data-15-min">
     Train/test splits with temporal data (15 min)
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#cross-validation">
       Cross-validation
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#encoding-date-time-as-feature-s-20-min">
     Encoding date/time as feature(s) (20 min)
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#encoding-time-as-an-number">
       Encoding time as an number
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#one-hot-encoding-of-the-month">
       One-hot encoding of the month
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#todo">
   TODO
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#one-hot-encoding-seasons">
     One-hot encoding seasons
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#periodic-encoding">
     Periodic encoding
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#encoding-average-monthly-rainfall">
     Encoding average monthly rainfall
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#average-monthly-rainfall-by-location">
     Average monthly rainfall by location
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#break-5-min">
     Break (5 min)
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#lag-based-features-15-min">
     Lag-based features (15 min)
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#forecasting-further-into-the-future-10-min">
     Forecasting further into the future (10 min)
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#trends-5-min">
     Trends (5 min)
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#what-did-we-not-cover-5-min">
     What did we not cover? (5 min)
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#traditional-time-series-approaches">
       Traditional time series approaches
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#deep-learning">
       Deep learning
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#types-of-problems-involving-time-series">
       Types of problems involving time series
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#unequally-spaced-time-points">
       Unequally spaced time points
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#other-software-package">
       Other software package
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#feature-engineering">
       Feature engineering
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#t-f-questions-piazza">
     T/F questions (Piazza)
    </a>
   </li>
  </ul>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <p><img alt="" src="../_images/330-banner.png" /></p>
<div class="section" id="lecture-18-time-series">
<h1>Lecture 18: Time series<a class="headerlink" href="#lecture-18-time-series" title="Permalink to this headline">¶</a></h1>
<p>UBC 2020-21</p>
<p>Instructor: Varada Kolhatkar</p>
<div class="section" id="imports">
<h2>Imports<a class="headerlink" href="#imports" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="kn">from</span> <span class="nn">sklearn.dummy</span> <span class="kn">import</span> <span class="n">DummyClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span><span class="p">,</span> <span class="n">cross_val_score</span><span class="p">,</span> <span class="n">cross_validate</span><span class="p">,</span> <span class="n">TimeSeriesSplit</span>

<span class="kn">from</span> <span class="nn">sklearn.impute</span> <span class="kn">import</span> <span class="n">SimpleImputer</span>
<span class="kn">from</span> <span class="nn">sklearn.compose</span> <span class="kn">import</span> <span class="n">ColumnTransformer</span>
<span class="kn">from</span> <span class="nn">sklearn.pipeline</span> <span class="kn">import</span> <span class="n">Pipeline</span><span class="p">,</span> <span class="n">make_pipeline</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span><span class="p">,</span> <span class="n">OrdinalEncoder</span><span class="p">,</span> <span class="n">OneHotEncoder</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="lecture-plan">
<h3>Lecture plan<a class="headerlink" href="#lecture-plan" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>👋</p></li>
<li><p><strong>Turn on recording</strong></p></li>
<li><p>Announcements</p></li>
<li><p>Today’s dataset (5 min)</p></li>
<li><p>Train/test splits with temporal data (15 min)</p></li>
<li><p>Encoding date/time as feature(s) (20 min) &lt;- we didn’t cover all of this due to time</p></li>
<li><p>Break (5 min)</p></li>
<li><p>Lag-based features (15 min)</p></li>
<li><p>Forecasting further into the future (10 min)</p></li>
<li><p>Trends (5 min)</p></li>
<li><p>What did we not cover? (5 min)</p></li>
</ul>
</div>
</div>
<div class="section" id="learning-objectives">
<h2>Learning objectives<a class="headerlink" href="#learning-objectives" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Explain the pitfalls of train/test splitting with time series data.</p></li>
<li><p>Appropriately split time series data, both train/test split and cross-validation.</p></li>
<li><p>Perform time series feature engineering:</p>
<ul>
<li><p>Encode time as various features in a tabular dataset</p></li>
<li><p>Create lag-based features</p></li>
</ul>
</li>
<li><p>Explain different approaches for forecasting multiple time steps into the future.</p></li>
<li><p>Apply “method 1”  for forecasting multiple time steps into the future, namely building a model that directly predicts <span class="math notranslate nohighlight">\(k\)</span> steps into the future.</p></li>
<li><p>Explain the challenges of time series data with unequally spaced time points.</p></li>
<li><p>At a high level, explain the concepts of seasonality and trends.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;font.size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">16</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="motivation">
<h2>Motivation<a class="headerlink" href="#motivation" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p><strong>Time series</strong> is a collection of data points indexed in time order.</p></li>
<li><p>Time series is everywhere:</p>
<ul>
<li><p>Physical sciences (e.g., weather forecasting)</p></li>
<li><p>Economics, finance (e.g., stocks, market trends)</p></li>
<li><p>Engineering (e.g., energy consumption)</p></li>
<li><p>Social sciences</p></li>
<li><p>Sports analytics</p></li>
</ul>
</li>
</ul>
<p>Let’s start with a simple example from <a class="reference external" href="https://learning.oreilly.com/library/view/introduction-to-machine/9781449369880/">Introduction to Machine Learning with Python  book</a>.</p>
<p>In New York city there is a network of bike rental stations with a subscription system. The stations are all around the city. The anonymized data is available <a class="reference external" href="https://ride.citibikenyc.com/system-data">here</a>.</p>
<p>We will focus on the task is predicting how many people will rent a bicycle from a particular station for a given time and day. We might be interested in knowing this so that we know whether there will be any bikes left at the station for a particular day and time.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mglearn</span>
<span class="n">citibike</span> <span class="o">=</span> <span class="n">mglearn</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">load_citibike</span><span class="p">()</span>
<span class="n">citibike</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>starttime
2015-08-01 00:00:00     3
2015-08-01 03:00:00     0
2015-08-01 06:00:00     9
2015-08-01 09:00:00    41
2015-08-01 12:00:00    39
Freq: 3H, Name: one, dtype: int64
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>The only feature we have is the date time feature.</p>
<ul>
<li><p>Example: 2015-08-01 00:00:00</p></li>
</ul>
</li>
<li><p>The target is the number of rentals in the next 3 hours.</p>
<ul>
<li><p>Example: 3 rentals between 2015-08-01 00:00:00 and 2015-08-01 03:00:00</p></li>
</ul>
</li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">citibike</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Timestamp(&#39;2015-08-01 00:00:00&#39;, freq=&#39;3H&#39;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">citibike</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Timestamp(&#39;2015-08-31 21:00:00&#39;, freq=&#39;3H&#39;)
</pre></div>
</div>
</div>
</div>
<p>We have data for August 2015.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">xticks</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">citibike</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">end</span><span class="o">=</span><span class="n">citibike</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
                       <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">xticks</span><span class="p">,</span> <span class="n">xticks</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%a</span><span class="s2"> %m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">),</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">citibike</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Date&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Rentals&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0, 0.5, &#39;Rentals&#39;)
</pre></div>
</div>
<img alt="../_images/18_time-series_15_1.png" src="../_images/18_time-series_15_1.png" />
</div>
</div>
<ul class="simple">
<li><p>We see the day and night pattern</p></li>
<li><p>We see the weekend and weekday pattern</p></li>
</ul>
<ul class="simple">
<li><p>Questions you might want to answer: How many people are likely to rent a bike at this station tomorrow at 3pm given everything we know about rentals in the past?</p></li>
<li><p>We want to learn from the past and predict the future.</p></li>
</ul>
<div class="section" id="train-test-split-for-temporal-data">
<h3>Train/test split for temporal data<a class="headerlink" href="#train-test-split-for-temporal-data" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>What will happen if we split this data the usual way?</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df</span><span class="p">,</span> <span class="n">test_df</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">citibike</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">123</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">test_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>starttime
2015-08-26 12:00:00    30
2015-08-12 09:00:00    10
2015-08-19 03:00:00     2
2015-08-07 12:00:00    22
2015-08-03 09:00:00     9
Name: one, dtype: int64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Timestamp(&#39;2015-08-31 21:00:00&#39;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">test_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Timestamp(&#39;2015-08-01 12:00:00&#39;)
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>So, we are training on data that came after our test data!</p></li>
<li><p>If we want to forecast, <strong>we aren’t allowed to know what happened in the future</strong>!</p></li>
<li><p>There may be cases where this is OK, e.g. if you aren’t trying to forecast and just want to understand your data (maybe you’re not even splitting).</p></li>
<li><p>But, for our purposes, we want to avoid this.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">train_df_sort</span> <span class="o">=</span> <span class="n">train_df</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
<span class="n">test_df_sort</span> <span class="o">=</span> <span class="n">test_df</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">train_df_sort</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;train&#39;</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">test_df_sort</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="s1">&#39;vertical&#39;</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/18_time-series_24_0.png" src="../_images/18_time-series_24_0.png" />
</div>
</div>
<p>We’ll split the data as follows:</p>
<ul class="simple">
<li><p>We have total 248 data points.</p></li>
<li><p>We’ll use the fist 184 data points corresponding to the first 23 days as training data - And the remaining 64 data points corresponding to the remaining 8 days as test data.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">citibike</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(248,)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n_train</span> <span class="o">=</span> <span class="mi">184</span>
<span class="n">train_df</span> <span class="o">=</span> <span class="n">citibike</span><span class="p">[:</span><span class="mi">184</span><span class="p">]</span>
<span class="n">test_df</span> <span class="o">=</span> <span class="n">citibike</span><span class="p">[</span><span class="mi">184</span><span class="p">:]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">train_df_sort</span> <span class="o">=</span> <span class="n">train_df</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
<span class="n">test_df_sort</span> <span class="o">=</span> <span class="n">test_df</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">train_df_sort</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;train&#39;</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">test_df_sort</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="s1">&#39;vertical&#39;</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/18_time-series_28_0.png" src="../_images/18_time-series_28_0.png" />
</div>
</div>
<ul class="simple">
<li><p>This split is looking reasonable now.</p></li>
</ul>
<p><br><br></p>
</div>
<div class="section" id="training-models">
<h3>Training models<a class="headerlink" href="#training-models" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>In this toy data, we just have a single feature: the date time feature.</p></li>
<li><p>We need to encode this feature if we want to build machine learning models.</p></li>
<li><p>A common way that dates are stored on computers is using POSIX time, which is the number of seconds since January 1970 00:00:00 (this is beginning of Unix time).</p></li>
<li><p>Let’s start with encode this feature as a single integer representing this POSIX time.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y_train</span> <span class="o">=</span> <span class="n">train_df</span><span class="o">.</span><span class="n">values</span>
<span class="n">y_test</span> <span class="o">=</span> <span class="n">test_df</span><span class="o">.</span><span class="n">values</span>
<span class="c1"># convert to POSIX time by dividing by 10**9</span>
<span class="n">X_train</span> <span class="o">=</span> <span class="n">train_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;int64&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">10</span><span class="o">**</span><span class="mi">9</span>
<span class="n">X_test</span> <span class="o">=</span> <span class="n">test_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;int64&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">10</span><span class="o">**</span><span class="mi">9</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/80/kr9rkqfj4w78h49djkz8yy9r0000gp/T/ipykernel_17016/37470091.py:4: FutureWarning: casting datetime64[ns] values to int64 with .astype(...) is deprecated and will raise in a future version. Use .view(...) instead.
  X_train = train_df.index.astype(&quot;int64&quot;).values.reshape(-1, 1) // 10**9
/var/folders/80/kr9rkqfj4w78h49djkz8yy9r0000gp/T/ipykernel_17016/37470091.py:5: FutureWarning: casting datetime64[ns] values to int64 with .astype(...) is deprecated and will raise in a future version. Use .view(...) instead.
  X_test = test_df.index.astype(&quot;int64&quot;).values.reshape(-1, 1) // 10**9
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y_train</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([ 3,  0,  9, 41, 39, 27, 12,  4,  3,  4])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_train</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[1438387200],
       [1438398000],
       [1438408800],
       [1438419600],
       [1438430400],
       [1438441200],
       [1438452000],
       [1438462800],
       [1438473600],
       [1438484400]])
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Our prediction task is a regression task.</p></li>
</ul>
<p>Let’s try random forest regression.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestRegressor</span>
<span class="n">regressor</span> <span class="o">=</span> <span class="n">RandomForestRegressor</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">regressor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Train-set R^2: </span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">regressor</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Test-set R^2: </span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">regressor</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Train-set R^2: 0.85
Test-set R^2: -0.04
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">eval_on_features</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">regressor</span><span class="p">):</span>
    <span class="c1"># split the given features into a training and a test set</span>
    <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span> <span class="o">=</span> <span class="n">features</span><span class="p">[:</span><span class="n">n_train</span><span class="p">],</span> <span class="n">features</span><span class="p">[</span><span class="n">n_train</span><span class="p">:]</span>
    <span class="c1"># also split the target array</span>
    <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">target</span><span class="p">[:</span><span class="n">n_train</span><span class="p">],</span> <span class="n">target</span><span class="p">[</span><span class="n">n_train</span><span class="p">:]</span>
    <span class="n">regressor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Train-set R^2: </span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">regressor</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)))</span>    
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Test-set R^2: </span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">regressor</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)))</span>
    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">regressor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
    <span class="n">y_pred_train</span> <span class="o">=</span> <span class="n">regressor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="mi">8</span><span class="p">),</span> <span class="n">xticks</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%a</span><span class="s2"> %m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">),</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span>
               <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n_train</span><span class="p">),</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;train&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n_train</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_test</span><span class="p">)</span> <span class="o">+</span> <span class="n">n_train</span><span class="p">),</span> <span class="n">y_test</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;test&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n_train</span><span class="p">),</span> <span class="n">y_pred_train</span><span class="p">,</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;prediction train&quot;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n_train</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_test</span><span class="p">)</span> <span class="o">+</span> <span class="n">n_train</span><span class="p">),</span> <span class="n">y_pred</span><span class="p">,</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span>
             <span class="n">label</span><span class="o">=</span><span class="s2">&quot;prediction test&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="p">(</span><span class="mf">1.01</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Date&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Rentals&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestRegressor</span>
<span class="n">regressor</span> <span class="o">=</span> <span class="n">RandomForestRegressor</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">eval_on_features</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">regressor</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">80</span><span class="o">/</span><span class="n">kr9rkqfj4w78h49djkz8yy9r0000gp</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_17016</span><span class="o">/</span><span class="mf">1406661695.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestRegressor</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="n">regressor</span> <span class="o">=</span> <span class="n">RandomForestRegressor</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="ne">----&gt; </span><span class="mi">3</span> <span class="n">eval_on_features</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">regressor</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;X&#39; is not defined
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>The predictions on the training score is pretty good</p></li>
<li><p>But for the test data, a constant line is predicted …</p></li>
<li><p>What’s going on?</p></li>
</ul>
<ul class="simple">
<li><p>The model is based on only one feature: POSIX time feature.</p></li>
<li><p>And the value of the POSIX time feature is outside the range of the feature values in the training set.</p></li>
<li><p>Tree-based models cannot <em>extrapolate</em> to feature ranges outside the training data.</p></li>
<li><p>The model predicted the target value of the closest point in the training set.</p></li>
</ul>
<p>Can we come up with better features?</p>
</div>
<div class="section" id="feature-engineering-for-date-time-columns">
<h3>Feature engineering for date/time columns<a class="headerlink" href="#feature-engineering-for-date-time-columns" title="Permalink to this headline">¶</a></h3>
<p>We noted before that the time of the day and day of the week seem quite important.
Let’s add these two features.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_hour</span> <span class="o">=</span> <span class="n">citibike</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">hour</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">eval_on_features</span><span class="p">(</span><span class="n">X_hour</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">regressor</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Train-set R^2: 0.50
Test-set R^2: 0.60
</pre></div>
</div>
<img alt="../_images/18_time-series_45_1.png" src="../_images/18_time-series_45_1.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_hour_week</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">citibike</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">dayofweek</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                         <span class="n">citibike</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">hour</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)])</span>
<span class="n">eval_on_features</span><span class="p">(</span><span class="n">X_hour_week</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">regressor</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Train-set R^2: 0.89
Test-set R^2: 0.84
</pre></div>
</div>
<img alt="../_images/18_time-series_46_1.png" src="../_images/18_time-series_46_1.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">Ridge</span>

<span class="n">lr</span> <span class="o">=</span> <span class="n">Ridge</span><span class="p">()</span>
<span class="n">eval_on_features</span><span class="p">(</span><span class="n">X_hour_week</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">lr</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Train-set R^2: 0.16
Test-set R^2: 0.13
</pre></div>
</div>
<img alt="../_images/18_time-series_49_1.png" src="../_images/18_time-series_49_1.png" />
</div>
</div>
<ul class="simple">
<li><p>Ridge is performing poorly on the training as well as test data.</p></li>
<li><p>It’s not able to capture the periodic pattern.</p></li>
<li><p>The reason is that we have encoded time of day using integers.</p></li>
<li><p>A linear function can only learn a linear function of the time of day.</p></li>
<li><p>What if we encode this feature as a categorical variable?</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">enc</span> <span class="o">=</span> <span class="n">OneHotEncoder</span><span class="p">()</span>
<span class="n">X_hour_week_onehot</span> <span class="o">=</span> <span class="n">enc</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_hour_week</span><span class="p">)</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">eval_on_features</span><span class="p">(</span><span class="n">X_hour_week_onehot</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">Ridge</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Train-set R^2: 0.53
Test-set R^2: 0.62
</pre></div>
</div>
<img alt="../_images/18_time-series_52_1.png" src="../_images/18_time-series_52_1.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_hour_week_onehot</span>
<span class="n">X_hour_week_onehot</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(248, 15)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">PolynomialFeatures</span>
<span class="n">poly_transformer</span> <span class="o">=</span> <span class="n">PolynomialFeatures</span><span class="p">(</span><span class="n">degree</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">interaction_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                      <span class="n">include_bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">X_hour_week_onehot_poly</span> <span class="o">=</span> <span class="n">poly_transformer</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_hour_week_onehot</span><span class="p">)</span>
<span class="n">lr</span> <span class="o">=</span> <span class="n">Ridge</span><span class="p">()</span>
<span class="n">eval_on_features</span><span class="p">(</span><span class="n">X_hour_week_onehot_poly</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">lr</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Train-set R^2: 0.87
Test-set R^2: 0.85
</pre></div>
</div>
<img alt="../_images/18_time-series_54_1.png" src="../_images/18_time-series_54_1.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_hour_week_onehot_poly</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(248, 120)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hour</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">%02d</span><span class="s2">:00&quot;</span> <span class="o">%</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">3</span><span class="p">)]</span>
<span class="n">day</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Mon&quot;</span><span class="p">,</span> <span class="s2">&quot;Tue&quot;</span><span class="p">,</span> <span class="s2">&quot;Wed&quot;</span><span class="p">,</span> <span class="s2">&quot;Thu&quot;</span><span class="p">,</span> <span class="s2">&quot;Fri&quot;</span><span class="p">,</span> <span class="s2">&quot;Sat&quot;</span><span class="p">,</span> <span class="s2">&quot;Sun&quot;</span><span class="p">]</span>
<span class="n">features</span> <span class="o">=</span>  <span class="n">day</span> <span class="o">+</span> <span class="n">hour</span>
<span class="n">features</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;Mon&#39;,
 &#39;Tue&#39;,
 &#39;Wed&#39;,
 &#39;Thu&#39;,
 &#39;Fri&#39;,
 &#39;Sat&#39;,
 &#39;Sun&#39;,
 &#39;00:00&#39;,
 &#39;03:00&#39;,
 &#39;06:00&#39;,
 &#39;09:00&#39;,
 &#39;12:00&#39;,
 &#39;15:00&#39;,
 &#39;18:00&#39;,
 &#39;21:00&#39;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">features_poly</span> <span class="o">=</span> <span class="n">poly_transformer</span><span class="o">.</span><span class="n">get_feature_names</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
<span class="n">features_nonzero</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">features_poly</span><span class="p">)[</span><span class="n">lr</span><span class="o">.</span><span class="n">coef_</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">coef_nonzero</span> <span class="o">=</span> <span class="n">lr</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="n">lr</span><span class="o">.</span><span class="n">coef_</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">coef_nonzero</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">features_nonzero</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Coefficient&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;Coefficient&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Coefficient</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Sat 09:00</th>
      <td>15.196739</td>
    </tr>
    <tr>
      <th>Wed 06:00</th>
      <td>15.005809</td>
    </tr>
    <tr>
      <th>Sat 12:00</th>
      <td>13.437684</td>
    </tr>
    <tr>
      <th>Sun 12:00</th>
      <td>13.362009</td>
    </tr>
    <tr>
      <th>Thu 06:00</th>
      <td>10.907595</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
    </tr>
    <tr>
      <th>Sat 21:00</th>
      <td>-6.085150</td>
    </tr>
    <tr>
      <th>00:00</th>
      <td>-11.693898</td>
    </tr>
    <tr>
      <th>03:00</th>
      <td>-12.111220</td>
    </tr>
    <tr>
      <th>Sat 06:00</th>
      <td>-13.757591</td>
    </tr>
    <tr>
      <th>Sun 06:00</th>
      <td>-18.033267</td>
    </tr>
  </tbody>
</table>
<p>71 rows × 1 columns</p>
</div></div></div>
</div>
<p>The coefficients make sense!</p>
</div>
<div class="section" id="cross-validation-with">
<h3>Cross validation with<a class="headerlink" href="#cross-validation-with" title="Permalink to this headline">¶</a></h3>
</div>
</div>
<div class="section" id="today-s-dataset-5-min">
<h2>Today’s dataset (5 min)<a class="headerlink" href="#today-s-dataset-5-min" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://www.kaggle.com/jsphyg/weather-dataset-rattle-package">Rain in Australia</a> dataset. Predicting whether or not it will rain tomorrow based on today’s measurements.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_rain</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;data/weatherAUS.csv&quot;</span><span class="p">)</span>
<span class="n">df_rain</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Date</th>
      <th>Location</th>
      <th>MinTemp</th>
      <th>MaxTemp</th>
      <th>Rainfall</th>
      <th>Evaporation</th>
      <th>Sunshine</th>
      <th>WindGustDir</th>
      <th>WindGustSpeed</th>
      <th>WindDir9am</th>
      <th>...</th>
      <th>Humidity3pm</th>
      <th>Pressure9am</th>
      <th>Pressure3pm</th>
      <th>Cloud9am</th>
      <th>Cloud3pm</th>
      <th>Temp9am</th>
      <th>Temp3pm</th>
      <th>RainToday</th>
      <th>RISK_MM</th>
      <th>RainTomorrow</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2008-12-01</td>
      <td>Albury</td>
      <td>13.4</td>
      <td>22.9</td>
      <td>0.6</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>W</td>
      <td>44.0</td>
      <td>W</td>
      <td>...</td>
      <td>22.0</td>
      <td>1007.7</td>
      <td>1007.1</td>
      <td>8.0</td>
      <td>NaN</td>
      <td>16.9</td>
      <td>21.8</td>
      <td>No</td>
      <td>0.0</td>
      <td>No</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2008-12-02</td>
      <td>Albury</td>
      <td>7.4</td>
      <td>25.1</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>WNW</td>
      <td>44.0</td>
      <td>NNW</td>
      <td>...</td>
      <td>25.0</td>
      <td>1010.6</td>
      <td>1007.8</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>17.2</td>
      <td>24.3</td>
      <td>No</td>
      <td>0.0</td>
      <td>No</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2008-12-03</td>
      <td>Albury</td>
      <td>12.9</td>
      <td>25.7</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>WSW</td>
      <td>46.0</td>
      <td>W</td>
      <td>...</td>
      <td>30.0</td>
      <td>1007.6</td>
      <td>1008.7</td>
      <td>NaN</td>
      <td>2.0</td>
      <td>21.0</td>
      <td>23.2</td>
      <td>No</td>
      <td>0.0</td>
      <td>No</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2008-12-04</td>
      <td>Albury</td>
      <td>9.2</td>
      <td>28.0</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NE</td>
      <td>24.0</td>
      <td>SE</td>
      <td>...</td>
      <td>16.0</td>
      <td>1017.6</td>
      <td>1012.8</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>18.1</td>
      <td>26.5</td>
      <td>No</td>
      <td>1.0</td>
      <td>No</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2008-12-05</td>
      <td>Albury</td>
      <td>17.5</td>
      <td>32.3</td>
      <td>1.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>W</td>
      <td>41.0</td>
      <td>ENE</td>
      <td>...</td>
      <td>33.0</td>
      <td>1010.8</td>
      <td>1006.0</td>
      <td>7.0</td>
      <td>8.0</td>
      <td>17.8</td>
      <td>29.7</td>
      <td>No</td>
      <td>0.2</td>
      <td>No</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 24 columns</p>
</div></div></div>
</div>
<div class="section" id="goals">
<h3>Goals<a class="headerlink" href="#goals" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Can the date/time features help us predict the target value?</p></li>
<li><p>Can we <strong>forecast</strong> into the future?</p></li>
</ul>
<p>Fun fact:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_rain</span><span class="p">[</span><span class="s2">&quot;Rainfall&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>371.0
</pre></div>
</div>
</div>
</div>
<p>3.7 mm of rain in one day?!?</p>
</div>
<div class="section" id="parsing-datetimes">
<h3>Parsing datetimes<a class="headerlink" href="#parsing-datetimes" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>In general, datetimes are a huge pain! Think of all the formats: MM-DD-YY, DD-MM-YY, YY-MM-DD, MM/DD/YY, DD/MM/YY, DD/MM/YYYY, 20:45, 8:45am, 8:45 PM, 8:45a, 08:00, 8:10:20, …….</p></li>
<li><p>No, seriously, dealing with datetimes is THE WORST.</p>
<ul>
<li><p>Time zones.</p></li>
<li><p>Daylight savings…</p></li>
</ul>
</li>
<li><p>Thankfully, pandas does a pretty good job here.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dates_rain</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df_rain</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">])</span>
<span class="n">dates_rain</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0        2008-12-01
1        2008-12-02
2        2008-12-03
3        2008-12-04
4        2008-12-05
            ...    
142188   2017-06-20
142189   2017-06-21
142190   2017-06-22
142191   2017-06-23
142192   2017-06-24
Name: Date, Length: 142193, dtype: datetime64[ns]
</pre></div>
</div>
</div>
</div>
<p>They are all the same format, so we can also compare dates:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dates_rain</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">dates_rain</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Timedelta(&#39;1 days 00:00:00&#39;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dates_rain</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">dates_rain</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">dates_rain</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">dates_rain</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>86400.0
</pre></div>
</div>
</div>
</div>
<p>You can tell pandas to parse the dates when reading in the CSV:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_rain</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;data/weatherAUS.csv&quot;</span><span class="p">,</span> <span class="n">parse_dates</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">])</span>
<span class="n">df_rain</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Date</th>
      <th>Location</th>
      <th>MinTemp</th>
      <th>MaxTemp</th>
      <th>Rainfall</th>
      <th>Evaporation</th>
      <th>Sunshine</th>
      <th>WindGustDir</th>
      <th>WindGustSpeed</th>
      <th>WindDir9am</th>
      <th>...</th>
      <th>Humidity3pm</th>
      <th>Pressure9am</th>
      <th>Pressure3pm</th>
      <th>Cloud9am</th>
      <th>Cloud3pm</th>
      <th>Temp9am</th>
      <th>Temp3pm</th>
      <th>RainToday</th>
      <th>RISK_MM</th>
      <th>RainTomorrow</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2008-12-01</td>
      <td>Albury</td>
      <td>13.4</td>
      <td>22.9</td>
      <td>0.6</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>W</td>
      <td>44.0</td>
      <td>W</td>
      <td>...</td>
      <td>22.0</td>
      <td>1007.7</td>
      <td>1007.1</td>
      <td>8.0</td>
      <td>NaN</td>
      <td>16.9</td>
      <td>21.8</td>
      <td>No</td>
      <td>0.0</td>
      <td>No</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2008-12-02</td>
      <td>Albury</td>
      <td>7.4</td>
      <td>25.1</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>WNW</td>
      <td>44.0</td>
      <td>NNW</td>
      <td>...</td>
      <td>25.0</td>
      <td>1010.6</td>
      <td>1007.8</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>17.2</td>
      <td>24.3</td>
      <td>No</td>
      <td>0.0</td>
      <td>No</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2008-12-03</td>
      <td>Albury</td>
      <td>12.9</td>
      <td>25.7</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>WSW</td>
      <td>46.0</td>
      <td>W</td>
      <td>...</td>
      <td>30.0</td>
      <td>1007.6</td>
      <td>1008.7</td>
      <td>NaN</td>
      <td>2.0</td>
      <td>21.0</td>
      <td>23.2</td>
      <td>No</td>
      <td>0.0</td>
      <td>No</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2008-12-04</td>
      <td>Albury</td>
      <td>9.2</td>
      <td>28.0</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NE</td>
      <td>24.0</td>
      <td>SE</td>
      <td>...</td>
      <td>16.0</td>
      <td>1017.6</td>
      <td>1012.8</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>18.1</td>
      <td>26.5</td>
      <td>No</td>
      <td>1.0</td>
      <td>No</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2008-12-05</td>
      <td>Albury</td>
      <td>17.5</td>
      <td>32.3</td>
      <td>1.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>W</td>
      <td>41.0</td>
      <td>ENE</td>
      <td>...</td>
      <td>33.0</td>
      <td>1010.8</td>
      <td>1006.0</td>
      <td>7.0</td>
      <td>8.0</td>
      <td>17.8</td>
      <td>29.7</td>
      <td>No</td>
      <td>0.2</td>
      <td>No</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 24 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_rain</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0   2008-12-01
1   2008-12-02
2   2008-12-03
3   2008-12-04
4   2008-12-05
Name: Date, dtype: datetime64[ns]
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="train-test-splits-with-temporal-data-15-min">
<h2>Train/test splits with temporal data (15 min)<a class="headerlink" href="#train-test-splits-with-temporal-data-15-min" title="Permalink to this headline">¶</a></h2>
<p>Let’s do the usual thing we do…</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_train</span><span class="p">,</span> <span class="n">df_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">df_rain</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">123</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">preprocess_features</span><span class="p">(</span><span class="n">df_train</span><span class="p">,</span> <span class="n">df_test</span><span class="p">,</span> <span class="n">numeric_features</span><span class="p">,</span> <span class="n">categorical_features</span><span class="p">,</span> <span class="n">drop_features</span><span class="p">):</span>

    <span class="n">all_features</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">numeric_features</span> <span class="o">+</span> <span class="n">categorical_features</span> <span class="o">+</span> <span class="n">drop_features</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">df_train</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">!=</span> <span class="n">all_features</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Missing columns&quot;</span><span class="p">,</span> <span class="nb">set</span><span class="p">(</span><span class="n">df_train</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">-</span> <span class="n">all_features</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Extra columns&quot;</span><span class="p">,</span> <span class="n">all_features</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">df_train</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Columns do not match&quot;</span><span class="p">)</span>
    
    <span class="n">numeric_transformer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span>
        <span class="p">(</span><span class="s1">&#39;imputer&#39;</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">)),</span>
        <span class="p">(</span><span class="s1">&#39;scaler&#39;</span><span class="p">,</span> <span class="n">StandardScaler</span><span class="p">())</span>
    <span class="p">])</span>  
    <span class="n">categorical_transformer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span>
        <span class="p">(</span><span class="s1">&#39;imputer&#39;</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;constant&#39;</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="s1">&#39;?&#39;</span><span class="p">)),</span>
        <span class="p">(</span><span class="s1">&#39;onehot&#39;</span><span class="p">,</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">handle_unknown</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">))</span>
    <span class="p">])</span>
    <span class="n">preprocessor</span> <span class="o">=</span> <span class="n">ColumnTransformer</span><span class="p">([</span>
        <span class="p">(</span><span class="s1">&#39;numeric&#39;</span><span class="p">,</span> <span class="n">numeric_transformer</span><span class="p">,</span> <span class="n">numeric_features</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;categorical&#39;</span><span class="p">,</span> <span class="n">categorical_transformer</span><span class="p">,</span> <span class="n">categorical_features</span><span class="p">)</span>
    <span class="p">])</span>
    <span class="n">preprocessor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df_train</span><span class="p">);</span>

    <span class="n">ohe</span> <span class="o">=</span> <span class="n">preprocessor</span><span class="o">.</span><span class="n">named_transformers_</span><span class="p">[</span><span class="s1">&#39;categorical&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;onehot&#39;</span><span class="p">]</span>
    <span class="n">ohe_feature_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ohe</span><span class="o">.</span><span class="n">get_feature_names</span><span class="p">(</span><span class="n">categorical_features</span><span class="p">))</span>
    <span class="n">new_columns</span> <span class="o">=</span> <span class="n">numeric_features</span> <span class="o">+</span> <span class="n">ohe_feature_names</span>

    <span class="n">X_train_enc</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">preprocessor</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">df_train</span><span class="p">)</span><span class="o">.</span><span class="n">toarray</span><span class="p">(),</span> <span class="n">index</span><span class="o">=</span><span class="n">df_train</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">new_columns</span><span class="p">)</span>
    <span class="n">X_test_enc</span>  <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">preprocessor</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">df_test</span><span class="p">)</span><span class="o">.</span><span class="n">toarray</span><span class="p">(),</span>  <span class="n">index</span><span class="o">=</span><span class="n">df_test</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>  <span class="n">columns</span><span class="o">=</span><span class="n">new_columns</span><span class="p">)</span>
    
    <span class="n">y_train</span> <span class="o">=</span> <span class="n">df_train</span><span class="p">[</span><span class="s2">&quot;RainTomorrow&quot;</span><span class="p">]</span>
    <span class="n">y_test</span>  <span class="o">=</span> <span class="n">df_test</span><span class="p">[</span><span class="s2">&quot;RainTomorrow&quot;</span><span class="p">]</span>
    
    <span class="k">return</span> <span class="n">X_train_enc</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">X_test_enc</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">preprocessor</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">numeric_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;MinTemp&#39;</span><span class="p">,</span> <span class="s1">&#39;MaxTemp&#39;</span><span class="p">,</span> <span class="s1">&#39;Rainfall&#39;</span><span class="p">,</span> <span class="s1">&#39;Evaporation&#39;</span><span class="p">,</span> <span class="s1">&#39;Sunshine&#39;</span><span class="p">,</span> <span class="s1">&#39;WindGustSpeed&#39;</span><span class="p">,</span> 
                    <span class="s1">&#39;WindSpeed9am&#39;</span><span class="p">,</span> <span class="s1">&#39;WindSpeed3pm&#39;</span><span class="p">,</span> <span class="s1">&#39;Humidity9am&#39;</span><span class="p">,</span> <span class="s1">&#39;Humidity3pm&#39;</span><span class="p">,</span> <span class="s1">&#39;Pressure9am&#39;</span><span class="p">,</span> 
                    <span class="s1">&#39;Pressure3pm&#39;</span><span class="p">,</span> <span class="s1">&#39;Cloud9am&#39;</span><span class="p">,</span> <span class="s1">&#39;Cloud3pm&#39;</span><span class="p">,</span> <span class="s1">&#39;Temp9am&#39;</span><span class="p">,</span> <span class="s1">&#39;Temp3pm&#39;</span><span class="p">]</span>
<span class="n">categorical_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Location&#39;</span><span class="p">,</span> <span class="s1">&#39;WindGustDir&#39;</span><span class="p">,</span> <span class="s1">&#39;WindDir9am&#39;</span><span class="p">,</span> <span class="s1">&#39;WindDir3pm&#39;</span><span class="p">,</span> <span class="s1">&#39;RainToday&#39;</span><span class="p">]</span>
<span class="n">drop_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;RISK_MM&#39;</span><span class="p">,</span> <span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="s1">&#39;RainTomorrow&#39;</span><span class="p">]</span>  <span class="c1"># See the documentation, should not keep the column</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_train_enc</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">X_test_enc</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">preprocessor</span> <span class="o">=</span> <span class="n">preprocess_features</span><span class="p">(</span><span class="n">df_train</span><span class="p">,</span> <span class="n">df_test</span><span class="p">,</span> 
        <span class="n">numeric_features</span><span class="p">,</span> <span class="n">categorical_features</span><span class="p">,</span> <span class="n">drop_features</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_train_enc</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>MinTemp</th>
      <th>MaxTemp</th>
      <th>Rainfall</th>
      <th>Evaporation</th>
      <th>Sunshine</th>
      <th>WindGustSpeed</th>
      <th>WindSpeed9am</th>
      <th>WindSpeed3pm</th>
      <th>Humidity9am</th>
      <th>Humidity3pm</th>
      <th>...</th>
      <th>WindDir3pm_SE</th>
      <th>WindDir3pm_SSE</th>
      <th>WindDir3pm_SSW</th>
      <th>WindDir3pm_SW</th>
      <th>WindDir3pm_W</th>
      <th>WindDir3pm_WNW</th>
      <th>WindDir3pm_WSW</th>
      <th>RainToday_?</th>
      <th>RainToday_No</th>
      <th>RainToday_Yes</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>88012</th>
      <td>0.924831</td>
      <td>-0.480941</td>
      <td>3.135864</td>
      <td>-0.119919</td>
      <td>0.148454</td>
      <td>5.866872</td>
      <td>4.300843</td>
      <td>7.821727</td>
      <td>0.799900</td>
      <td>2.314880</td>
      <td>...</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>126827</th>
      <td>-0.387306</td>
      <td>-0.691473</td>
      <td>-0.179868</td>
      <td>-0.307113</td>
      <td>1.305477</td>
      <td>1.604277</td>
      <td>1.359141</td>
      <td>-0.417811</td>
      <td>-0.783708</td>
      <td>-0.558442</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>51624</th>
      <td>-1.777546</td>
      <td>-2.824857</td>
      <td>-0.250919</td>
      <td>-0.119919</td>
      <td>0.148454</td>
      <td>1.223688</td>
      <td>0.340859</td>
      <td>0.039941</td>
      <td>0.060883</td>
      <td>0.025962</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>138778</th>
      <td>1.502795</td>
      <td>1.484018</td>
      <td>-0.274603</td>
      <td>-0.182317</td>
      <td>0.871594</td>
      <td>-0.527021</td>
      <td>-0.111710</td>
      <td>0.383255</td>
      <td>0.219244</td>
      <td>0.074663</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>23423</th>
      <td>0.549935</td>
      <td>0.150653</td>
      <td>-0.274603</td>
      <td>0.316865</td>
      <td>0.148454</td>
      <td>-0.755374</td>
      <td>0.340859</td>
      <td>-0.417811</td>
      <td>-0.836495</td>
      <td>0.464266</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>129130</th>
      <td>-0.715340</td>
      <td>-0.902004</td>
      <td>-0.274603</td>
      <td>-1.305478</td>
      <td>-1.550923</td>
      <td>0.310275</td>
      <td>-0.337995</td>
      <td>-0.646687</td>
      <td>0.166457</td>
      <td>-0.071439</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>119906</th>
      <td>-0.215478</td>
      <td>-0.537083</td>
      <td>0.767484</td>
      <td>-0.244715</td>
      <td>1.124692</td>
      <td>-0.679256</td>
      <td>0.114575</td>
      <td>-0.417811</td>
      <td>-0.678134</td>
      <td>-0.168839</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>17730</th>
      <td>0.706141</td>
      <td>-0.242339</td>
      <td>1.359579</td>
      <td>-0.119919</td>
      <td>0.148454</td>
      <td>1.223688</td>
      <td>1.132856</td>
      <td>1.642074</td>
      <td>1.063835</td>
      <td>1.486973</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>28030</th>
      <td>0.221900</td>
      <td>-1.112535</td>
      <td>0.459595</td>
      <td>-0.119919</td>
      <td>0.148454</td>
      <td>1.299806</td>
      <td>-0.903707</td>
      <td>-0.188935</td>
      <td>1.591704</td>
      <td>0.805168</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>15725</th>
      <td>-0.371685</td>
      <td>-0.691473</td>
      <td>-0.203551</td>
      <td>-0.119919</td>
      <td>0.148454</td>
      <td>-0.070314</td>
      <td>-1.356276</td>
      <td>-1.447753</td>
      <td>0.377605</td>
      <td>0.561666</td>
      <td>...</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
<p>106644 rows × 119 columns</p>
</div></div></div>
</div>
<p>Now we do the modelling:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lr_pipe</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span><span class="n">preprocessor</span><span class="p">,</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lr_pipe</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lr_pipe</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">df_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.8488241251265894
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lr_pipe</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">df_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.8482095136290754
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>But, wait a minute, I did something wrong. Any ideas?</p></li>
</ul>
<p><br><br><br><br><br><br></p>
<ul class="simple">
<li><p>Let’s look at the dates in our train/test split:</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_train</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Timestamp(&#39;2017-06-25 00:00:00&#39;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_test</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Timestamp(&#39;2007-11-03 00:00:00&#39;)
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>So, we are training on data that came before our test data!</p></li>
<li><p>If we want to forecast, we aren’t allowed to know what happened in the future!</p></li>
<li><p>There may be cases where this is OK, e.g. if you aren’t trying to forecast and just want to understand your data (maybe you’re not even splitting).</p></li>
<li><p>But, for our purposes, we want to avoid this.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># test_pred = df_test.sort_values(by=[&quot;Location&quot;, &quot;Date&quot;])</span>
<span class="c1"># np.mean(test_pred[&quot;RainToday&quot;].iloc[1:].values == test_pred[&quot;RainTomorrow&quot;].iloc[-1:].values)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_train_sort</span> <span class="o">=</span> <span class="n">df_train</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Location == &#39;Sydney&#39;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;Date&quot;</span><span class="p">)</span>
<span class="n">df_test_sort</span> <span class="o">=</span> <span class="n">df_test</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Location == &#39;Sydney&#39;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;Date&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_train_sort</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">],</span> <span class="n">df_train_sort</span><span class="p">[</span><span class="s2">&quot;Rainfall&quot;</span><span class="p">],</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;train&#39;</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_test_sort</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">],</span> <span class="n">df_test_sort</span><span class="p">[</span><span class="s2">&quot;Rainfall&quot;</span><span class="p">],</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="s1">&#39;vertical&#39;</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Rainfall (mm)&quot;</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Train/test rainfall in Sydney&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/18_time-series_96_0.png" src="../_images/18_time-series_96_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_rain</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Timestamp(&#39;2007-11-01 00:00:00&#39;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_rain</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Timestamp(&#39;2017-06-25 00:00:00&#39;)
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>It looks like we have 10 years of data.</p></li>
<li><p>Let’s use the last 2 years for test.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_train</span> <span class="o">=</span> <span class="n">df_rain</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;Date &lt;= 20150630&#39;</span><span class="p">)</span>
<span class="n">df_test</span>  <span class="o">=</span> <span class="n">df_rain</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;Date &gt;  20150630&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">len</span><span class="p">(</span><span class="n">df_train</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>107502
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">len</span><span class="p">(</span><span class="n">df_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>34691
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">len</span><span class="p">(</span><span class="n">df_test</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df_train</span><span class="p">)</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">df_test</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.24397122221206388
</pre></div>
</div>
</div>
</div>
<p>As we can see, we’re still using about 25% of our data as test data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_train_sort</span> <span class="o">=</span> <span class="n">df_train</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Location == &#39;Sydney&#39;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;Date&quot;</span><span class="p">)</span>
<span class="n">df_test_sort</span> <span class="o">=</span> <span class="n">df_test</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Location == &#39;Sydney&#39;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;Date&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_train_sort</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">],</span> <span class="n">df_train_sort</span><span class="p">[</span><span class="s2">&quot;Rainfall&quot;</span><span class="p">],</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;train&#39;</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_test_sort</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">],</span> <span class="n">df_test_sort</span><span class="p">[</span><span class="s2">&quot;Rainfall&quot;</span><span class="p">],</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="s1">&#39;vertical&#39;</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Rainfall (mm)&quot;</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Train/test rainfall in Sydney&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/18_time-series_105_0.png" src="../_images/18_time-series_105_0.png" />
</div>
</div>
<p>We’re learning relationships from the blue part; predicting only using features in the red part from the day before.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_train_enc</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">X_test_enc</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">preprocessor</span> <span class="o">=</span> <span class="n">preprocess_features</span><span class="p">(</span><span class="n">df_train</span><span class="p">,</span> <span class="n">df_test</span><span class="p">,</span> 
        <span class="n">numeric_features</span><span class="p">,</span> <span class="n">categorical_features</span><span class="p">,</span> <span class="n">drop_features</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lr_pipe</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span><span class="n">preprocessor</span><span class="p">,</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lr_pipe</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lr_pipe</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">df_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.8501888336961173
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lr_pipe</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">df_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.844368856475743
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>In this case it didn’t seem to really matter - we get about the same scores.</p></li>
<li><p>However, in general we should split conservatively if we can.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lr_coef</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">lr_pipe</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">coef_</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">X_train_enc</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Coef&quot;</span><span class="p">])</span>
<span class="n">lr_coef</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;Coef&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Coef</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Humidity3pm</th>
      <td>1.243177</td>
    </tr>
    <tr>
      <th>RainToday_?</th>
      <td>0.918921</td>
    </tr>
    <tr>
      <th>Pressure9am</th>
      <td>0.865433</td>
    </tr>
    <tr>
      <th>Location_Witchcliffe</th>
      <td>0.728615</td>
    </tr>
    <tr>
      <th>WindGustSpeed</th>
      <td>0.720383</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
    </tr>
    <tr>
      <th>RainToday_No</th>
      <td>-0.722747</td>
    </tr>
    <tr>
      <th>Location_Katherine</th>
      <td>-0.726450</td>
    </tr>
    <tr>
      <th>Location_Wollongong</th>
      <td>-0.749180</td>
    </tr>
    <tr>
      <th>Location_MountGinini</th>
      <td>-0.965270</td>
    </tr>
    <tr>
      <th>Pressure3pm</th>
      <td>-1.221832</td>
    </tr>
  </tbody>
</table>
<p>119 rows × 1 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dc</span> <span class="o">=</span> <span class="n">DummyClassifier</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;prior&#39;</span><span class="p">)</span>
<span class="n">dc</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dc</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">df_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.7750553478074826
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y_train</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>No     83320
Yes    24182
Name: RainTomorrow, dtype: int64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dc</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">df_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.7781845435415525
</pre></div>
</div>
</div>
</div>
<div class="section" id="cross-validation">
<h3>Cross-validation<a class="headerlink" href="#cross-validation" title="Permalink to this headline">¶</a></h3>
<p>What about cross-validation?</p>
<ul class="simple">
<li><p>We can’t do regular cross-validation if we don’t want to be predicting the past.</p></li>
<li><p>Cross-validation randomly shuffles the rows, so you might get rows in your training set that occur after rows in your validation set. This isn’t 100% terrible in that you’re still predicting next week’s price regardless, but it’s not a good idea. Especially if there are trends in the dataset, and then you get to see what happened to the trend in the future.</p></li>
<li><p>Actually, our training split is a bit weird because we “have the answers” in the training set. But our testing procedure is conservative.</p></li>
<li><p>If we want, there is:</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">TimeSeriesSplit</span>
</pre></div>
</div>
</div>
</div>
<p>see https://scikit-learn.org/stable/modules/cross_validation.html#time-series-split</p>
<p>However, things are actually more complicated here because this dataset has <strong>multiple time series</strong>, one per location.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_train</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Date</th>
      <th>Location</th>
      <th>MinTemp</th>
      <th>MaxTemp</th>
      <th>Rainfall</th>
      <th>Evaporation</th>
      <th>Sunshine</th>
      <th>WindGustDir</th>
      <th>WindGustSpeed</th>
      <th>WindDir9am</th>
      <th>...</th>
      <th>Humidity3pm</th>
      <th>Pressure9am</th>
      <th>Pressure3pm</th>
      <th>Cloud9am</th>
      <th>Cloud3pm</th>
      <th>Temp9am</th>
      <th>Temp3pm</th>
      <th>RainToday</th>
      <th>RISK_MM</th>
      <th>RainTomorrow</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2008-12-01</td>
      <td>Albury</td>
      <td>13.4</td>
      <td>22.9</td>
      <td>0.6</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>W</td>
      <td>44.0</td>
      <td>W</td>
      <td>...</td>
      <td>22.0</td>
      <td>1007.7</td>
      <td>1007.1</td>
      <td>8.0</td>
      <td>NaN</td>
      <td>16.9</td>
      <td>21.8</td>
      <td>No</td>
      <td>0.0</td>
      <td>No</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2008-12-02</td>
      <td>Albury</td>
      <td>7.4</td>
      <td>25.1</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>WNW</td>
      <td>44.0</td>
      <td>NNW</td>
      <td>...</td>
      <td>25.0</td>
      <td>1010.6</td>
      <td>1007.8</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>17.2</td>
      <td>24.3</td>
      <td>No</td>
      <td>0.0</td>
      <td>No</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2008-12-03</td>
      <td>Albury</td>
      <td>12.9</td>
      <td>25.7</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>WSW</td>
      <td>46.0</td>
      <td>W</td>
      <td>...</td>
      <td>30.0</td>
      <td>1007.6</td>
      <td>1008.7</td>
      <td>NaN</td>
      <td>2.0</td>
      <td>21.0</td>
      <td>23.2</td>
      <td>No</td>
      <td>0.0</td>
      <td>No</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2008-12-04</td>
      <td>Albury</td>
      <td>9.2</td>
      <td>28.0</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NE</td>
      <td>24.0</td>
      <td>SE</td>
      <td>...</td>
      <td>16.0</td>
      <td>1017.6</td>
      <td>1012.8</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>18.1</td>
      <td>26.5</td>
      <td>No</td>
      <td>1.0</td>
      <td>No</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2008-12-05</td>
      <td>Albury</td>
      <td>17.5</td>
      <td>32.3</td>
      <td>1.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>W</td>
      <td>41.0</td>
      <td>ENE</td>
      <td>...</td>
      <td>33.0</td>
      <td>1010.8</td>
      <td>1006.0</td>
      <td>7.0</td>
      <td>8.0</td>
      <td>17.8</td>
      <td>29.7</td>
      <td>No</td>
      <td>0.2</td>
      <td>No</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>141474</th>
      <td>2015-06-26</td>
      <td>Uluru</td>
      <td>3.8</td>
      <td>18.3</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>E</td>
      <td>39.0</td>
      <td>ESE</td>
      <td>...</td>
      <td>37.0</td>
      <td>1031.5</td>
      <td>1027.6</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>8.8</td>
      <td>17.2</td>
      <td>No</td>
      <td>0.0</td>
      <td>No</td>
    </tr>
    <tr>
      <th>141475</th>
      <td>2015-06-27</td>
      <td>Uluru</td>
      <td>2.5</td>
      <td>17.1</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>E</td>
      <td>41.0</td>
      <td>ESE</td>
      <td>...</td>
      <td>40.0</td>
      <td>1029.9</td>
      <td>1026.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>7.0</td>
      <td>15.7</td>
      <td>No</td>
      <td>0.0</td>
      <td>No</td>
    </tr>
    <tr>
      <th>141476</th>
      <td>2015-06-28</td>
      <td>Uluru</td>
      <td>4.5</td>
      <td>19.6</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>ENE</td>
      <td>35.0</td>
      <td>ESE</td>
      <td>...</td>
      <td>39.0</td>
      <td>1028.7</td>
      <td>1025.0</td>
      <td>NaN</td>
      <td>3.0</td>
      <td>8.9</td>
      <td>18.0</td>
      <td>No</td>
      <td>0.0</td>
      <td>No</td>
    </tr>
    <tr>
      <th>141477</th>
      <td>2015-06-29</td>
      <td>Uluru</td>
      <td>7.6</td>
      <td>22.0</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>ESE</td>
      <td>33.0</td>
      <td>SE</td>
      <td>...</td>
      <td>37.0</td>
      <td>1027.2</td>
      <td>1023.8</td>
      <td>6.0</td>
      <td>7.0</td>
      <td>11.7</td>
      <td>21.5</td>
      <td>No</td>
      <td>0.0</td>
      <td>No</td>
    </tr>
    <tr>
      <th>141478</th>
      <td>2015-06-30</td>
      <td>Uluru</td>
      <td>6.8</td>
      <td>21.1</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>ESE</td>
      <td>35.0</td>
      <td>ESE</td>
      <td>...</td>
      <td>35.0</td>
      <td>1028.6</td>
      <td>1025.2</td>
      <td>3.0</td>
      <td>NaN</td>
      <td>10.6</td>
      <td>20.2</td>
      <td>No</td>
      <td>0.0</td>
      <td>No</td>
    </tr>
  </tbody>
</table>
<p>107502 rows × 24 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_train</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Date</th>
      <th>Location</th>
      <th>MinTemp</th>
      <th>MaxTemp</th>
      <th>Rainfall</th>
      <th>Evaporation</th>
      <th>Sunshine</th>
      <th>WindGustDir</th>
      <th>WindGustSpeed</th>
      <th>WindDir9am</th>
      <th>...</th>
      <th>Humidity3pm</th>
      <th>Pressure9am</th>
      <th>Pressure3pm</th>
      <th>Cloud9am</th>
      <th>Cloud3pm</th>
      <th>Temp9am</th>
      <th>Temp3pm</th>
      <th>RainToday</th>
      <th>RISK_MM</th>
      <th>RainTomorrow</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>55977</th>
      <td>2015-06-30</td>
      <td>Ballarat</td>
      <td>-0.3</td>
      <td>10.5</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>S</td>
      <td>26.0</td>
      <td>NaN</td>
      <td>...</td>
      <td>63.0</td>
      <td>1029.5</td>
      <td>1027.7</td>
      <td>NaN</td>
      <td>8.0</td>
      <td>4.7</td>
      <td>9.3</td>
      <td>No</td>
      <td>0.4</td>
      <td>No</td>
    </tr>
    <tr>
      <th>116980</th>
      <td>2015-06-30</td>
      <td>PerthAirport</td>
      <td>10.1</td>
      <td>23.5</td>
      <td>0.0</td>
      <td>3.2</td>
      <td>5.8</td>
      <td>NNE</td>
      <td>31.0</td>
      <td>NE</td>
      <td>...</td>
      <td>33.0</td>
      <td>1023.6</td>
      <td>1021.7</td>
      <td>7.0</td>
      <td>6.0</td>
      <td>13.3</td>
      <td>22.2</td>
      <td>No</td>
      <td>0.0</td>
      <td>No</td>
    </tr>
    <tr>
      <th>59015</th>
      <td>2015-06-30</td>
      <td>Bendigo</td>
      <td>0.3</td>
      <td>11.4</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>W</td>
      <td>19.0</td>
      <td>NaN</td>
      <td>...</td>
      <td>56.0</td>
      <td>1029.3</td>
      <td>1027.4</td>
      <td>8.0</td>
      <td>7.0</td>
      <td>6.4</td>
      <td>10.5</td>
      <td>No</td>
      <td>0.0</td>
      <td>No</td>
    </tr>
    <tr>
      <th>65018</th>
      <td>2015-06-30</td>
      <td>MelbourneAirport</td>
      <td>3.2</td>
      <td>13.2</td>
      <td>0.0</td>
      <td>0.8</td>
      <td>3.9</td>
      <td>N</td>
      <td>20.0</td>
      <td>N</td>
      <td>...</td>
      <td>50.0</td>
      <td>1029.6</td>
      <td>1027.3</td>
      <td>2.0</td>
      <td>7.0</td>
      <td>5.3</td>
      <td>11.9</td>
      <td>No</td>
      <td>0.0</td>
      <td>No</td>
    </tr>
    <tr>
      <th>141478</th>
      <td>2015-06-30</td>
      <td>Uluru</td>
      <td>6.8</td>
      <td>21.1</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>ESE</td>
      <td>35.0</td>
      <td>ESE</td>
      <td>...</td>
      <td>35.0</td>
      <td>1028.6</td>
      <td>1025.2</td>
      <td>3.0</td>
      <td>NaN</td>
      <td>10.6</td>
      <td>20.2</td>
      <td>No</td>
      <td>0.0</td>
      <td>No</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 24 columns</p>
</div></div></div>
</div>
<ul class="simple">
<li><p>It seems the dataframe is sorted by location, and then time.</p></li>
<li><p>Our approach today will be to ignore the fact that we have multiple time series and just OHE the location</p></li>
<li><p>We’ll have multiple measurements for a given timestamp, and that’s OK.</p></li>
<li><p>But, <code class="docutils literal notranslate"><span class="pre">TimeSeriesSplit</span></code> expects the dataframe to be sorted by date so…</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_train_ordered</span> <span class="o">=</span> <span class="n">df_train</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">])</span>
<span class="n">y_train_ordered</span> <span class="o">=</span> <span class="n">df_train_ordered</span><span class="p">[</span><span class="s2">&quot;RainTomorrow&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cross_val_score</span><span class="p">(</span><span class="n">lr_pipe</span><span class="p">,</span> <span class="n">df_train_ordered</span><span class="p">,</span> <span class="n">y_train_ordered</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="n">TimeSeriesSplit</span><span class="p">())</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.8478763185801196
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>This gives us a slightly more conservative (lower) score than a regular “shuffle split” CV.</p>
<ul>
<li><p>Not sure if that is meaningful or just randomness</p></li>
</ul>
</li>
<li><p>Note that I have to explicitly tell it to shuffle because we didn’t do a <code class="docutils literal notranslate"><span class="pre">train_test_split</span></code> which is where our shuffling usually comes from.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">ShuffleSplit</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cross_val_score</span><span class="p">(</span><span class="n">lr_pipe</span><span class="p">,</span> <span class="n">df_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="n">ShuffleSplit</span><span class="p">())</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.8498000186029208
</pre></div>
</div>
</div>
</div>
<p>If you do unshuffled CV the score is significantly lower:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cross_val_score</span><span class="p">(</span><span class="n">lr_pipe</span><span class="p">,</span> <span class="n">df_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.805407887788886
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>This was a head-scratcher</p></li>
<li><p>I believe it may be because of the locations, and the lack of shuffling</p></li>
<li><p>We want each split to have some of all locations, but this way we might have nothing from a given location in the train set</p></li>
</ul>
<p><img alt="" src="../_images/mike_whatever.png" /></p>
</div>
</div>
<div class="section" id="encoding-date-time-as-feature-s-20-min">
<h2>Encoding date/time as feature(s) (20 min)<a class="headerlink" href="#encoding-date-time-as-feature-s-20-min" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Can we use the <code class="docutils literal notranslate"><span class="pre">Date</span></code> to help us predict the target?</p></li>
<li><p>Probably! E.g. different amounts of rain in different seasons.</p></li>
<li><p>This is feature engineering!</p></li>
</ul>
<div class="section" id="encoding-time-as-an-number">
<h3>Encoding time as an number<a class="headerlink" href="#encoding-time-as-an-number" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Idea 1: create a column of “days since Nov 1, 2007”.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">first_day</span> <span class="o">=</span> <span class="n">df_train</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

<span class="n">df_train</span> <span class="o">=</span> <span class="n">df_train</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">Days_since</span><span class="o">=</span><span class="n">df_train</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">first_day</span><span class="p">)</span><span class="o">.</span><span class="n">days</span><span class="p">))</span>
<span class="n">df_test</span> <span class="o">=</span> <span class="n">df_test</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">Days_since</span><span class="o">=</span><span class="n">df_test</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">first_day</span><span class="p">)</span><span class="o">.</span><span class="n">days</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_train</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Date</th>
      <th>Location</th>
      <th>MinTemp</th>
      <th>MaxTemp</th>
      <th>Rainfall</th>
      <th>Evaporation</th>
      <th>Sunshine</th>
      <th>WindGustDir</th>
      <th>WindGustSpeed</th>
      <th>WindDir9am</th>
      <th>...</th>
      <th>Pressure9am</th>
      <th>Pressure3pm</th>
      <th>Cloud9am</th>
      <th>Cloud3pm</th>
      <th>Temp9am</th>
      <th>Temp3pm</th>
      <th>RainToday</th>
      <th>RISK_MM</th>
      <th>RainTomorrow</th>
      <th>Days_since</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>44351</th>
      <td>2007-11-01</td>
      <td>Canberra</td>
      <td>8.0</td>
      <td>24.3</td>
      <td>0.0</td>
      <td>3.4</td>
      <td>6.3</td>
      <td>NW</td>
      <td>30.0</td>
      <td>SW</td>
      <td>...</td>
      <td>1019.7</td>
      <td>1015.0</td>
      <td>7.0</td>
      <td>7.0</td>
      <td>14.4</td>
      <td>23.6</td>
      <td>No</td>
      <td>3.6</td>
      <td>Yes</td>
      <td>0</td>
    </tr>
    <tr>
      <th>44352</th>
      <td>2007-11-02</td>
      <td>Canberra</td>
      <td>14.0</td>
      <td>26.9</td>
      <td>3.6</td>
      <td>4.4</td>
      <td>9.7</td>
      <td>ENE</td>
      <td>39.0</td>
      <td>E</td>
      <td>...</td>
      <td>1012.4</td>
      <td>1008.4</td>
      <td>5.0</td>
      <td>3.0</td>
      <td>17.5</td>
      <td>25.7</td>
      <td>Yes</td>
      <td>3.6</td>
      <td>Yes</td>
      <td>1</td>
    </tr>
    <tr>
      <th>44353</th>
      <td>2007-11-03</td>
      <td>Canberra</td>
      <td>13.7</td>
      <td>23.4</td>
      <td>3.6</td>
      <td>5.8</td>
      <td>3.3</td>
      <td>NW</td>
      <td>85.0</td>
      <td>N</td>
      <td>...</td>
      <td>1009.5</td>
      <td>1007.2</td>
      <td>8.0</td>
      <td>7.0</td>
      <td>15.4</td>
      <td>20.2</td>
      <td>Yes</td>
      <td>39.8</td>
      <td>Yes</td>
      <td>2</td>
    </tr>
    <tr>
      <th>44354</th>
      <td>2007-11-04</td>
      <td>Canberra</td>
      <td>13.3</td>
      <td>15.5</td>
      <td>39.8</td>
      <td>7.2</td>
      <td>9.1</td>
      <td>NW</td>
      <td>54.0</td>
      <td>WNW</td>
      <td>...</td>
      <td>1005.5</td>
      <td>1007.0</td>
      <td>2.0</td>
      <td>7.0</td>
      <td>13.5</td>
      <td>14.1</td>
      <td>Yes</td>
      <td>2.8</td>
      <td>Yes</td>
      <td>3</td>
    </tr>
    <tr>
      <th>44355</th>
      <td>2007-11-05</td>
      <td>Canberra</td>
      <td>7.6</td>
      <td>16.1</td>
      <td>2.8</td>
      <td>5.6</td>
      <td>10.6</td>
      <td>SSE</td>
      <td>50.0</td>
      <td>SSE</td>
      <td>...</td>
      <td>1018.3</td>
      <td>1018.5</td>
      <td>7.0</td>
      <td>7.0</td>
      <td>11.1</td>
      <td>15.4</td>
      <td>Yes</td>
      <td>0.0</td>
      <td>No</td>
      <td>4</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 25 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_train_enc</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">X_test_enc</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">preprocessor</span> <span class="o">=</span> <span class="n">preprocess_features</span><span class="p">(</span><span class="n">df_train</span><span class="p">,</span> <span class="n">df_test</span><span class="p">,</span> 
        <span class="n">numeric_features</span>  <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;Days_since&quot;</span><span class="p">],</span> 
        <span class="n">categorical_features</span><span class="p">,</span> 
        <span class="n">drop_features</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lr_pipe</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span><span class="n">preprocessor</span><span class="p">,</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lr_pipe</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lr_pipe</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">df_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.850160927238563
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lr_pipe</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">df_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.8446282897581505
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Can you think of other ways to generate features from the <code class="docutils literal notranslate"><span class="pre">Date</span></code> column?</p></li>
<li><p>What about the month - that seems relevant. How should we encode the month?</p></li>
</ul>
<p><br><br><br><br><br><br></p>
<p>Another idea month: encode as integer, categorical variable?</p>
</div>
<div class="section" id="one-hot-encoding-of-the-month">
<h3>One-hot encoding of the month<a class="headerlink" href="#one-hot-encoding-of-the-month" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_train</span> <span class="o">=</span> <span class="n">df_rain</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;Date &lt;= 20150630&#39;</span><span class="p">)</span>
<span class="n">df_test</span>  <span class="o">=</span> <span class="n">df_rain</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;Date &gt;  20150630&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_train</span> <span class="o">=</span> <span class="n">df_train</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">Month</span><span class="o">=</span><span class="n">df_train</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">month</span><span class="p">))</span> <span class="c1"># x.month_name() to get the actual string</span>
<span class="n">df_test</span>  <span class="o">=</span> <span class="n">df_test</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span> <span class="n">Month</span><span class="o">=</span><span class="n">df_test</span><span class="p">[</span> <span class="s2">&quot;Date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">month</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="todo">
<h1>TODO<a class="headerlink" href="#todo" title="Permalink to this headline">¶</a></h1>
<p>change to month name for this part</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_train</span><span class="p">[[</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="s2">&quot;Month&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;Month&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Date</th>
      <th>Month</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>31930</th>
      <td>2015-01-04</td>
      <td>1</td>
    </tr>
    <tr>
      <th>37595</th>
      <td>2014-01-20</td>
      <td>1</td>
    </tr>
    <tr>
      <th>37594</th>
      <td>2014-01-19</td>
      <td>1</td>
    </tr>
    <tr>
      <th>37593</th>
      <td>2014-01-18</td>
      <td>1</td>
    </tr>
    <tr>
      <th>37592</th>
      <td>2014-01-17</td>
      <td>1</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>46478</th>
      <td>2013-12-05</td>
      <td>12</td>
    </tr>
    <tr>
      <th>46477</th>
      <td>2013-12-04</td>
      <td>12</td>
    </tr>
    <tr>
      <th>46476</th>
      <td>2013-12-03</td>
      <td>12</td>
    </tr>
    <tr>
      <th>46474</th>
      <td>2013-12-01</td>
      <td>12</td>
    </tr>
    <tr>
      <th>0</th>
      <td>2008-12-01</td>
      <td>12</td>
    </tr>
  </tbody>
</table>
<p>107502 rows × 2 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_train_enc</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">X_test_enc</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">preprocessor</span> <span class="o">=</span> <span class="n">preprocess_features</span><span class="p">(</span><span class="n">df_train</span><span class="p">,</span> <span class="n">df_test</span><span class="p">,</span> 
        <span class="n">numeric_features</span><span class="p">,</span> 
        <span class="n">categorical_features</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;Month&quot;</span><span class="p">],</span> 
        <span class="n">drop_features</span><span class="p">)</span>

<span class="n">lr_pipe</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span><span class="n">preprocessor</span><span class="p">,</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lr_pipe</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lr_pipe</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">df_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.8499190712730926
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lr_pipe</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">df_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.8437635121501253
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lr_coef</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">lr_pipe</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">coef_</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">X_train_enc</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Coef&quot;</span><span class="p">])</span>
<span class="n">lr_coef</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;Coef&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Coef</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Humidity3pm</th>
      <td>1.267032</td>
    </tr>
    <tr>
      <th>RainToday_?</th>
      <td>0.940020</td>
    </tr>
    <tr>
      <th>Pressure9am</th>
      <td>0.799124</td>
    </tr>
    <tr>
      <th>Location_Witchcliffe</th>
      <td>0.748486</td>
    </tr>
    <tr>
      <th>WindGustSpeed</th>
      <td>0.705698</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
    </tr>
    <tr>
      <th>Location_Darwin</th>
      <td>-0.735932</td>
    </tr>
    <tr>
      <th>Location_Wollongong</th>
      <td>-0.748720</td>
    </tr>
    <tr>
      <th>Location_Townsville</th>
      <td>-0.903383</td>
    </tr>
    <tr>
      <th>Location_Katherine</th>
      <td>-0.928399</td>
    </tr>
    <tr>
      <th>Pressure3pm</th>
      <td>-1.181971</td>
    </tr>
  </tbody>
</table>
<p>131 rows × 1 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lr_coef</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;Month_1&quot;</span><span class="p">:</span><span class="s2">&quot;Month_12&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Coef</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Month_1</th>
      <td>-0.417780</td>
    </tr>
    <tr>
      <th>Month_2</th>
      <td>-0.155865</td>
    </tr>
    <tr>
      <th>Month_3</th>
      <td>-0.116287</td>
    </tr>
    <tr>
      <th>Month_4</th>
      <td>0.092459</td>
    </tr>
    <tr>
      <th>Month_5</th>
      <td>0.156809</td>
    </tr>
    <tr>
      <th>Month_6</th>
      <td>0.064607</td>
    </tr>
    <tr>
      <th>Month_7</th>
      <td>0.178047</td>
    </tr>
    <tr>
      <th>Month_8</th>
      <td>0.232103</td>
    </tr>
    <tr>
      <th>Month_9</th>
      <td>0.034527</td>
    </tr>
    <tr>
      <th>Month_10</th>
      <td>0.125502</td>
    </tr>
    <tr>
      <th>Month_11</th>
      <td>0.043165</td>
    </tr>
    <tr>
      <th>Month_12</th>
      <td>-0.218401</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="section" id="one-hot-encoding-seasons">
<h2>One-hot encoding seasons<a class="headerlink" href="#one-hot-encoding-seasons" title="Permalink to this headline">¶</a></h2>
<p>How about just summer/winter as a feature?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">WINTER_MONTHS</span> <span class="o">=</span> <span class="p">{</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">}</span>
<span class="n">df_train</span> <span class="o">=</span> <span class="n">df_train</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">Winter</span><span class="o">=</span><span class="n">df_train</span><span class="p">[</span><span class="s2">&quot;Month&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">WINTER_MONTHS</span><span class="p">))</span>
<span class="n">df_test</span>  <span class="o">=</span> <span class="n">df_test</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span> <span class="n">Winter</span><span class="o">=</span><span class="n">df_test</span><span class="p">[</span> <span class="s2">&quot;Month&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">WINTER_MONTHS</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_train</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Date</th>
      <th>Location</th>
      <th>MinTemp</th>
      <th>MaxTemp</th>
      <th>Rainfall</th>
      <th>Evaporation</th>
      <th>Sunshine</th>
      <th>WindGustDir</th>
      <th>WindGustSpeed</th>
      <th>WindDir9am</th>
      <th>...</th>
      <th>Pressure3pm</th>
      <th>Cloud9am</th>
      <th>Cloud3pm</th>
      <th>Temp9am</th>
      <th>Temp3pm</th>
      <th>RainToday</th>
      <th>RISK_MM</th>
      <th>RainTomorrow</th>
      <th>Month</th>
      <th>Winter</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2008-12-01</td>
      <td>Albury</td>
      <td>13.4</td>
      <td>22.9</td>
      <td>0.6</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>W</td>
      <td>44.0</td>
      <td>W</td>
      <td>...</td>
      <td>1007.1</td>
      <td>8.0</td>
      <td>NaN</td>
      <td>16.9</td>
      <td>21.8</td>
      <td>No</td>
      <td>0.0</td>
      <td>No</td>
      <td>12</td>
      <td>False</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2008-12-02</td>
      <td>Albury</td>
      <td>7.4</td>
      <td>25.1</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>WNW</td>
      <td>44.0</td>
      <td>NNW</td>
      <td>...</td>
      <td>1007.8</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>17.2</td>
      <td>24.3</td>
      <td>No</td>
      <td>0.0</td>
      <td>No</td>
      <td>12</td>
      <td>False</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2008-12-03</td>
      <td>Albury</td>
      <td>12.9</td>
      <td>25.7</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>WSW</td>
      <td>46.0</td>
      <td>W</td>
      <td>...</td>
      <td>1008.7</td>
      <td>NaN</td>
      <td>2.0</td>
      <td>21.0</td>
      <td>23.2</td>
      <td>No</td>
      <td>0.0</td>
      <td>No</td>
      <td>12</td>
      <td>False</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2008-12-04</td>
      <td>Albury</td>
      <td>9.2</td>
      <td>28.0</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NE</td>
      <td>24.0</td>
      <td>SE</td>
      <td>...</td>
      <td>1012.8</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>18.1</td>
      <td>26.5</td>
      <td>No</td>
      <td>1.0</td>
      <td>No</td>
      <td>12</td>
      <td>False</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2008-12-05</td>
      <td>Albury</td>
      <td>17.5</td>
      <td>32.3</td>
      <td>1.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>W</td>
      <td>41.0</td>
      <td>ENE</td>
      <td>...</td>
      <td>1006.0</td>
      <td>7.0</td>
      <td>8.0</td>
      <td>17.8</td>
      <td>29.7</td>
      <td>No</td>
      <td>0.2</td>
      <td>No</td>
      <td>12</td>
      <td>False</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>141474</th>
      <td>2015-06-26</td>
      <td>Uluru</td>
      <td>3.8</td>
      <td>18.3</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>E</td>
      <td>39.0</td>
      <td>ESE</td>
      <td>...</td>
      <td>1027.6</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>8.8</td>
      <td>17.2</td>
      <td>No</td>
      <td>0.0</td>
      <td>No</td>
      <td>6</td>
      <td>True</td>
    </tr>
    <tr>
      <th>141475</th>
      <td>2015-06-27</td>
      <td>Uluru</td>
      <td>2.5</td>
      <td>17.1</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>E</td>
      <td>41.0</td>
      <td>ESE</td>
      <td>...</td>
      <td>1026.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>7.0</td>
      <td>15.7</td>
      <td>No</td>
      <td>0.0</td>
      <td>No</td>
      <td>6</td>
      <td>True</td>
    </tr>
    <tr>
      <th>141476</th>
      <td>2015-06-28</td>
      <td>Uluru</td>
      <td>4.5</td>
      <td>19.6</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>ENE</td>
      <td>35.0</td>
      <td>ESE</td>
      <td>...</td>
      <td>1025.0</td>
      <td>NaN</td>
      <td>3.0</td>
      <td>8.9</td>
      <td>18.0</td>
      <td>No</td>
      <td>0.0</td>
      <td>No</td>
      <td>6</td>
      <td>True</td>
    </tr>
    <tr>
      <th>141477</th>
      <td>2015-06-29</td>
      <td>Uluru</td>
      <td>7.6</td>
      <td>22.0</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>ESE</td>
      <td>33.0</td>
      <td>SE</td>
      <td>...</td>
      <td>1023.8</td>
      <td>6.0</td>
      <td>7.0</td>
      <td>11.7</td>
      <td>21.5</td>
      <td>No</td>
      <td>0.0</td>
      <td>No</td>
      <td>6</td>
      <td>True</td>
    </tr>
    <tr>
      <th>141478</th>
      <td>2015-06-30</td>
      <td>Uluru</td>
      <td>6.8</td>
      <td>21.1</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>ESE</td>
      <td>35.0</td>
      <td>ESE</td>
      <td>...</td>
      <td>1025.2</td>
      <td>3.0</td>
      <td>NaN</td>
      <td>10.6</td>
      <td>20.2</td>
      <td>No</td>
      <td>0.0</td>
      <td>No</td>
      <td>6</td>
      <td>True</td>
    </tr>
  </tbody>
</table>
<p>107502 rows × 26 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_train_enc</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">X_test_enc</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">preprocessor</span> <span class="o">=</span> <span class="n">preprocess_features</span><span class="p">(</span><span class="n">df_train</span><span class="p">,</span> <span class="n">df_test</span><span class="p">,</span> 
        <span class="n">numeric_features</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;Winter&quot;</span><span class="p">],</span> 
        <span class="n">categorical_features</span><span class="p">,</span> 
        <span class="n">drop_features</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;Month&quot;</span><span class="p">])</span>

<span class="n">lr_pipe</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span><span class="n">preprocessor</span><span class="p">,</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lr_pipe</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lr_pipe</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">df_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.8501516250860449
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lr_pipe</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">df_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.8441382491136029
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lr_coef</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">lr_pipe</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">coef_</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">X_train_enc</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Coef&quot;</span><span class="p">])</span>
<span class="n">lr_coef</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;Coef&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Coef</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Humidity3pm</th>
      <td>1.245991</td>
    </tr>
    <tr>
      <th>RainToday_?</th>
      <td>0.930216</td>
    </tr>
    <tr>
      <th>Pressure9am</th>
      <td>0.854104</td>
    </tr>
    <tr>
      <th>Location_Witchcliffe</th>
      <td>0.732694</td>
    </tr>
    <tr>
      <th>WindGustSpeed</th>
      <td>0.716847</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
    </tr>
    <tr>
      <th>Location_Wollongong</th>
      <td>-0.748579</td>
    </tr>
    <tr>
      <th>Location_Townsville</th>
      <td>-0.760306</td>
    </tr>
    <tr>
      <th>Location_Katherine</th>
      <td>-0.768667</td>
    </tr>
    <tr>
      <th>Location_MountGinini</th>
      <td>-0.905676</td>
    </tr>
    <tr>
      <th>Pressure3pm</th>
      <td>-1.212546</td>
    </tr>
  </tbody>
</table>
<p>120 rows × 1 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lr_coef</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;Winter&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Coef    0.03719
Name: Winter, dtype: float64
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>It’s a bit surprising that these features don’t help much.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_train</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;Rainfall&quot;</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Rainfall (mm)&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/18_time-series_169_0.png" src="../_images/18_time-series_169_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">monthly_avg_rainfall</span> <span class="o">=</span> <span class="n">df_train</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;Month&quot;</span><span class="p">)[</span><span class="s2">&quot;Rainfall&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">monthly_avg_rainfall</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">13</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">));</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Avg rainfall (mm)&quot;</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Month&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/18_time-series_170_0.png" src="../_images/18_time-series_170_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_train</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Date</th>
      <th>Location</th>
      <th>MinTemp</th>
      <th>MaxTemp</th>
      <th>Rainfall</th>
      <th>Evaporation</th>
      <th>Sunshine</th>
      <th>WindGustDir</th>
      <th>WindGustSpeed</th>
      <th>WindDir9am</th>
      <th>...</th>
      <th>Pressure3pm</th>
      <th>Cloud9am</th>
      <th>Cloud3pm</th>
      <th>Temp9am</th>
      <th>Temp3pm</th>
      <th>RainToday</th>
      <th>RISK_MM</th>
      <th>RainTomorrow</th>
      <th>Month</th>
      <th>Winter</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>141478</th>
      <td>2015-06-30</td>
      <td>Uluru</td>
      <td>6.8</td>
      <td>21.1</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>ESE</td>
      <td>35.0</td>
      <td>ESE</td>
      <td>...</td>
      <td>1025.2</td>
      <td>3.0</td>
      <td>NaN</td>
      <td>10.6</td>
      <td>20.2</td>
      <td>No</td>
      <td>0.0</td>
      <td>No</td>
      <td>6</td>
      <td>True</td>
    </tr>
    <tr>
      <th>138387</th>
      <td>2015-06-30</td>
      <td>Darwin</td>
      <td>18.3</td>
      <td>32.6</td>
      <td>0.0</td>
      <td>6.0</td>
      <td>11.0</td>
      <td>ESE</td>
      <td>37.0</td>
      <td>E</td>
      <td>...</td>
      <td>1013.3</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>24.0</td>
      <td>31.6</td>
      <td>No</td>
      <td>0.0</td>
      <td>No</td>
      <td>6</td>
      <td>True</td>
    </tr>
    <tr>
      <th>96224</th>
      <td>2015-06-30</td>
      <td>Adelaide</td>
      <td>7.2</td>
      <td>13.8</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>SW</td>
      <td>17.0</td>
      <td>ENE</td>
      <td>...</td>
      <td>1029.5</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>10.1</td>
      <td>12.7</td>
      <td>No</td>
      <td>0.0</td>
      <td>No</td>
      <td>6</td>
      <td>True</td>
    </tr>
    <tr>
      <th>55977</th>
      <td>2015-06-30</td>
      <td>Ballarat</td>
      <td>-0.3</td>
      <td>10.5</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>S</td>
      <td>26.0</td>
      <td>NaN</td>
      <td>...</td>
      <td>1027.7</td>
      <td>NaN</td>
      <td>8.0</td>
      <td>4.7</td>
      <td>9.3</td>
      <td>No</td>
      <td>0.4</td>
      <td>No</td>
      <td>6</td>
      <td>True</td>
    </tr>
    <tr>
      <th>93135</th>
      <td>2015-06-30</td>
      <td>Townsville</td>
      <td>20.0</td>
      <td>27.4</td>
      <td>0.4</td>
      <td>6.6</td>
      <td>4.6</td>
      <td>SE</td>
      <td>46.0</td>
      <td>SE</td>
      <td>...</td>
      <td>1019.2</td>
      <td>7.0</td>
      <td>6.0</td>
      <td>23.5</td>
      <td>26.2</td>
      <td>No</td>
      <td>0.0</td>
      <td>No</td>
      <td>6</td>
      <td>True</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>44355</th>
      <td>2007-11-05</td>
      <td>Canberra</td>
      <td>7.6</td>
      <td>16.1</td>
      <td>2.8</td>
      <td>5.6</td>
      <td>10.6</td>
      <td>SSE</td>
      <td>50.0</td>
      <td>SSE</td>
      <td>...</td>
      <td>1018.5</td>
      <td>7.0</td>
      <td>7.0</td>
      <td>11.1</td>
      <td>15.4</td>
      <td>Yes</td>
      <td>0.0</td>
      <td>No</td>
      <td>11</td>
      <td>False</td>
    </tr>
    <tr>
      <th>44354</th>
      <td>2007-11-04</td>
      <td>Canberra</td>
      <td>13.3</td>
      <td>15.5</td>
      <td>39.8</td>
      <td>7.2</td>
      <td>9.1</td>
      <td>NW</td>
      <td>54.0</td>
      <td>WNW</td>
      <td>...</td>
      <td>1007.0</td>
      <td>2.0</td>
      <td>7.0</td>
      <td>13.5</td>
      <td>14.1</td>
      <td>Yes</td>
      <td>2.8</td>
      <td>Yes</td>
      <td>11</td>
      <td>False</td>
    </tr>
    <tr>
      <th>44353</th>
      <td>2007-11-03</td>
      <td>Canberra</td>
      <td>13.7</td>
      <td>23.4</td>
      <td>3.6</td>
      <td>5.8</td>
      <td>3.3</td>
      <td>NW</td>
      <td>85.0</td>
      <td>N</td>
      <td>...</td>
      <td>1007.2</td>
      <td>8.0</td>
      <td>7.0</td>
      <td>15.4</td>
      <td>20.2</td>
      <td>Yes</td>
      <td>39.8</td>
      <td>Yes</td>
      <td>11</td>
      <td>False</td>
    </tr>
    <tr>
      <th>44352</th>
      <td>2007-11-02</td>
      <td>Canberra</td>
      <td>14.0</td>
      <td>26.9</td>
      <td>3.6</td>
      <td>4.4</td>
      <td>9.7</td>
      <td>ENE</td>
      <td>39.0</td>
      <td>E</td>
      <td>...</td>
      <td>1008.4</td>
      <td>5.0</td>
      <td>3.0</td>
      <td>17.5</td>
      <td>25.7</td>
      <td>Yes</td>
      <td>3.6</td>
      <td>Yes</td>
      <td>11</td>
      <td>False</td>
    </tr>
    <tr>
      <th>44351</th>
      <td>2007-11-01</td>
      <td>Canberra</td>
      <td>8.0</td>
      <td>24.3</td>
      <td>0.0</td>
      <td>3.4</td>
      <td>6.3</td>
      <td>NW</td>
      <td>30.0</td>
      <td>SW</td>
      <td>...</td>
      <td>1015.0</td>
      <td>7.0</td>
      <td>7.0</td>
      <td>14.4</td>
      <td>23.6</td>
      <td>No</td>
      <td>3.6</td>
      <td>Yes</td>
      <td>11</td>
      <td>False</td>
    </tr>
  </tbody>
</table>
<p>107502 rows × 26 columns</p>
</div></div></div>
</div>
<ul class="simple">
<li><p>This pattern is pretty surprising to me - why is June rainy but May and August are less so?</p></li>
<li><p>But, Australia is a huge country. Perhaps we should drill down to particular locations:</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_train_canberra</span>  <span class="o">=</span> <span class="n">df_train</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;Location == &quot;Canberra&quot;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_train_canberra</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">],</span> <span class="n">df_train_canberra</span><span class="p">[</span><span class="s2">&quot;Rainfall&quot;</span><span class="p">]);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Rainfall (mm)&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/18_time-series_174_0.png" src="../_images/18_time-series_174_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_train_canberra</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;Month&quot;</span><span class="p">)[</span><span class="s2">&quot;Rainfall&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">());</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">13</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">));</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Avg rainfall (mm)&quot;</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Month&quot;</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Rainfall in Canberra&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/18_time-series_175_0.png" src="../_images/18_time-series_175_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_train_canberra</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(2696, 26)
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>This looks somewhat cleaner but also pretty surprising - why is December so much higher than January?</p></li>
<li><p>This is called <em>seasonality</em>.</p></li>
<li><p>Why was the month feature not that useful? Perhaps this was already captured in the other features.</p>
<ul>
<li><p>But also the encoding wasn’t ideal.</p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="periodic-encoding">
<h2>Periodic encoding<a class="headerlink" href="#periodic-encoding" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>We can also try a periodic encoding.</p></li>
<li><p>This works because we know the periodicity (annual).</p></li>
<li><p>We can use a sin and cos with period 1 year.</p></li>
<li><p>You can shift the period by adding together <span class="math notranslate nohighlight">\(\sin(x)\)</span> and <span class="math notranslate nohighlight">\(\cos(x)\)</span>:</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">WINTER_MONTHS</span> <span class="o">=</span> <span class="p">{</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">}</span>
<span class="n">df_train</span> <span class="o">=</span> <span class="n">df_train</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">Winter</span><span class="o">=</span><span class="n">df_train</span><span class="p">[</span><span class="s2">&quot;Month&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">WINTER_MONTHS</span><span class="p">))</span>
<span class="n">df_test</span>  <span class="o">=</span> <span class="n">df_test</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span> <span class="n">Winter</span><span class="o">=</span><span class="n">df_test</span><span class="p">[</span> <span class="s2">&quot;Month&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">WINTER_MONTHS</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_train</span> <span class="o">=</span> <span class="n">df_train</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">Month_sin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">df_train</span><span class="p">[</span><span class="s2">&quot;Month&quot;</span><span class="p">]</span><span class="o">/</span><span class="mi">12</span><span class="p">))</span>
<span class="n">df_train</span> <span class="o">=</span> <span class="n">df_train</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">Month_cos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">df_train</span><span class="p">[</span><span class="s2">&quot;Month&quot;</span><span class="p">]</span><span class="o">/</span><span class="mi">12</span><span class="p">))</span>

<span class="n">df_test</span> <span class="o">=</span> <span class="n">df_test</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">Month_sin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">df_test</span><span class="p">[</span><span class="s2">&quot;Month&quot;</span><span class="p">]</span><span class="o">/</span><span class="mi">12</span><span class="p">))</span>
<span class="n">df_test</span> <span class="o">=</span> <span class="n">df_test</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">Month_cos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">df_test</span><span class="p">[</span><span class="s2">&quot;Month&quot;</span><span class="p">]</span><span class="o">/</span><span class="mi">12</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">month</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">13</span><span class="p">)</span>
<span class="n">enc_sin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">month</span><span class="o">/</span><span class="mi">12</span><span class="p">)</span>
<span class="n">enc_cos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">month</span><span class="o">/</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">month</span><span class="p">,</span><span class="n">enc_sin</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">month</span><span class="p">,</span><span class="n">enc_cos</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/18_time-series_181_0.png" src="../_images/18_time-series_181_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_train_enc</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">X_test_enc</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">preprocessor</span> <span class="o">=</span> <span class="n">preprocess_features</span><span class="p">(</span><span class="n">df_train</span><span class="p">,</span> <span class="n">df_test</span><span class="p">,</span> 
        <span class="n">numeric_features</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;Month_sin&quot;</span><span class="p">,</span> <span class="s2">&quot;Month_cos&quot;</span><span class="p">],</span> 
        <span class="n">categorical_features</span><span class="p">,</span> 
        <span class="n">drop_features</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;Month&quot;</span><span class="p">,</span> <span class="s2">&quot;Winter&quot;</span><span class="p">])</span>

<span class="n">lr_pipe</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span><span class="n">preprocessor</span><span class="p">,</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lr_pipe</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lr_pipe</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">df_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.8499097691205745
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lr_pipe</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">df_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.8436770343893228
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lr_coef</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">lr_pipe</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">coef_</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">X_train_enc</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Coef&quot;</span><span class="p">])</span>
<span class="n">lr_coef</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="s2">&quot;Month_sin&quot;</span><span class="p">,</span> <span class="s2">&quot;Month_cos&quot;</span><span class="p">]]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Coef</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Month_sin</th>
      <td>-0.090787</td>
    </tr>
    <tr>
      <th>Month_cos</th>
      <td>-0.127540</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p><strong>From Piazza last year</strong></p>
<p>Q: How to interpret coefficients for periodic encoded features?</p>
<p>A: They are both negative, so it means the price is higher when sin(2 pi month / 12) is lower and when cos(2 pi month / 12) is lower. In fact, since this is a linear model, we can just combine them: it means the price is higher when -0.016 sin(2 pi month / 12) - 0.013 cos(2 pi month / 12) is high. You can plot this function. I plotted it - see attached image. It shows that the predicted price is higher roughly from months 5-11, meaning May-November, with the lowest price falling around Jan-Feb and the highest price around August.</p>
<p>Optional note: by following trigonometric identities, we can see that learning  <span class="math notranslate nohighlight">\(A\sin(x)+B\cos(x)\)</span>  is the same as learning  <span class="math notranslate nohighlight">\(C\sin(x-\phi)\)</span>, or in other words a phase-shifted sine wave.</p>
<p>However, all this only applies because it’s a linear model. For something like a random forest, these coefficients would be harder to interpret.</p>
</div>
<div class="section" id="encoding-average-monthly-rainfall">
<h2>Encoding average monthly rainfall<a class="headerlink" href="#encoding-average-monthly-rainfall" title="Permalink to this headline">¶</a></h2>
<p>We can also try encoding the average rainfall for that month a a feature:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">monthly_avg_rainfall</span> <span class="o">=</span> <span class="n">df_train</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;Month&quot;</span><span class="p">)[</span><span class="s2">&quot;Rainfall&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">monthly_avg_rainfall</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Month
1     2.641089
2     3.550847
3     2.675817
4     2.530029
5     2.026871
6     2.617369
7     2.179104
8     2.022084
9     1.777074
10    1.740375
11    2.474031
12    2.554032
Name: Rainfall, dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_train</span> <span class="o">=</span> <span class="n">df_train</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">Monthly_rainfall</span> <span class="o">=</span> <span class="n">df_train</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">monthly_avg_rainfall</span><span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">month</span><span class="p">]))</span>
<span class="n">df_test</span> <span class="o">=</span> <span class="n">df_test</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">Monthly_rainfall</span> <span class="o">=</span> <span class="n">df_test</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">monthly_avg_rainfall</span><span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">month</span><span class="p">]))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_train_enc</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">X_test_enc</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">preprocessor</span> <span class="o">=</span> <span class="n">preprocess_features</span><span class="p">(</span><span class="n">df_train</span><span class="p">,</span> <span class="n">df_test</span><span class="p">,</span> 
        <span class="n">numeric_features</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;Monthly_rainfall&quot;</span><span class="p">],</span> 
        <span class="n">categorical_features</span><span class="p">,</span> 
        <span class="n">drop_features</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;Month&quot;</span><span class="p">,</span> <span class="s2">&quot;Winter&quot;</span><span class="p">,</span> <span class="s2">&quot;Month_sin&quot;</span><span class="p">,</span> <span class="s2">&quot;Month_cos&quot;</span><span class="p">])</span>

<span class="n">lr_pipe</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span><span class="n">preprocessor</span><span class="p">,</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lr_pipe</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lr_pipe</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">df_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.8500213949507917
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lr_pipe</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">df_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.844484160156813
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lr_coef</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">lr_pipe</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">coef_</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">X_train_enc</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Coef&quot;</span><span class="p">])</span>
<span class="n">lr_coef</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;Monthly_rainfall&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Coef   -0.057041
Name: Monthly_rainfall, dtype: float64
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Hmm, it’s a bit worrying that this coefficient is negative…</p></li>
<li><p>Unless I have a bug in my code, this is a prime example of the dangers of interpreting coefficients too literally.</p></li>
<li><p>If we trained a model with <em>only</em> this feature:</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">monthly_rain</span> <span class="o">=</span> <span class="n">df_train</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">monthly_avg_rainfall</span><span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">month</span><span class="p">])</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lr</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
<span class="n">lr</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">monthly_rain</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">lr</span><span class="o">.</span><span class="n">coef_</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[-0.01646627]])
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Even here we get a negative coefficient, very bizarre.</p></li>
<li><p>We’ll get a sensible result in a second:</p></li>
</ul>
</div>
<div class="section" id="average-monthly-rainfall-by-location">
<h2>Average monthly rainfall by location<a class="headerlink" href="#average-monthly-rainfall-by-location" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">avg_monthly_rainfall_by_loc</span> <span class="o">=</span> <span class="n">df_train</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;Month&quot;</span><span class="p">,</span> <span class="s2">&quot;Location&quot;</span><span class="p">])[</span><span class="s2">&quot;Rainfall&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_train</span> <span class="o">=</span> <span class="n">df_train</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">Monthly_rainfall_at_loc</span> <span class="o">=</span> <span class="n">df_train</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">avg_monthly_rainfall_by_loc</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;Location&quot;</span><span class="p">])],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<span class="n">df_test</span> <span class="o">=</span> <span class="n">df_test</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">Monthly_rainfall_at_loc</span> <span class="o">=</span> <span class="n">df_test</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">avg_monthly_rainfall_by_loc</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;Location&quot;</span><span class="p">])],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_train_enc</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">X_test_enc</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">preprocessor</span> <span class="o">=</span> <span class="n">preprocess_features</span><span class="p">(</span><span class="n">df_train</span><span class="p">,</span> <span class="n">df_test</span><span class="p">,</span> 
        <span class="n">numeric_features</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;Monthly_rainfall_at_loc&quot;</span><span class="p">],</span> 
        <span class="n">categorical_features</span><span class="p">,</span> 
        <span class="n">drop_features</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;Month&quot;</span><span class="p">,</span> <span class="s2">&quot;Winter&quot;</span><span class="p">,</span> <span class="s2">&quot;Month_sin&quot;</span><span class="p">,</span> <span class="s2">&quot;Month_cos&quot;</span><span class="p">,</span> <span class="s2">&quot;Monthly_rainfall&quot;</span><span class="p">])</span>

<span class="n">lr_pipe</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span><span class="n">preprocessor</span><span class="p">,</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lr_pipe</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lr_pipe</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">df_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.8508306822198657
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lr_pipe</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">df_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.8437058603095904
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lr_coef</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">lr_pipe</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">coef_</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">X_train_enc</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Coef&quot;</span><span class="p">])</span>
<span class="n">lr_coef</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;Monthly_rainfall_at_loc&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Coef    0.216485
Name: Monthly_rainfall_at_loc, dtype: float64
</pre></div>
</div>
</div>
</div>
<p>At least here we get a positive coefficient</p>
<p><img alt="" src="../_images/mike_phew.png" /></p>
</div>
<div class="section" id="break-5-min">
<h2>Break (5 min)<a class="headerlink" href="#break-5-min" title="Permalink to this headline">¶</a></h2>
<p>REMINDER TO RESUME RECORDING</p>
</div>
<div class="section" id="lag-based-features-15-min">
<h2>Lag-based features (15 min)<a class="headerlink" href="#lag-based-features-15-min" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Currently we’re using features about today to predict tomorrow’s rainfall.</p></li>
<li><p>But, what if tomorrow’s rainfall is also related to yesterday’s features, or the day before?</p>
<ul>
<li><p>This is called a <em>lagged</em> feature.</p></li>
</ul>
</li>
<li><p>In time series analysis, we’d look at something called an <a class="reference external" href="https://en.wikipedia.org/wiki/Autocorrelation">autocorrelation function</a> (ACF), but we won’t go into that here.</p></li>
<li><p>Instead, we can just add those features:</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_train</span> <span class="o">=</span> <span class="n">df_rain</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;Date &lt;= 20150630&#39;</span><span class="p">)</span>
<span class="n">df_test</span>  <span class="o">=</span> <span class="n">df_rain</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;Date &gt;  20150630&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_train</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Date</th>
      <th>Location</th>
      <th>MinTemp</th>
      <th>MaxTemp</th>
      <th>Rainfall</th>
      <th>Evaporation</th>
      <th>Sunshine</th>
      <th>WindGustDir</th>
      <th>WindGustSpeed</th>
      <th>WindDir9am</th>
      <th>...</th>
      <th>Humidity3pm</th>
      <th>Pressure9am</th>
      <th>Pressure3pm</th>
      <th>Cloud9am</th>
      <th>Cloud3pm</th>
      <th>Temp9am</th>
      <th>Temp3pm</th>
      <th>RainToday</th>
      <th>RISK_MM</th>
      <th>RainTomorrow</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2008-12-01</td>
      <td>Albury</td>
      <td>13.4</td>
      <td>22.9</td>
      <td>0.6</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>W</td>
      <td>44.0</td>
      <td>W</td>
      <td>...</td>
      <td>22.0</td>
      <td>1007.7</td>
      <td>1007.1</td>
      <td>8.0</td>
      <td>NaN</td>
      <td>16.9</td>
      <td>21.8</td>
      <td>No</td>
      <td>0.0</td>
      <td>No</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2008-12-02</td>
      <td>Albury</td>
      <td>7.4</td>
      <td>25.1</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>WNW</td>
      <td>44.0</td>
      <td>NNW</td>
      <td>...</td>
      <td>25.0</td>
      <td>1010.6</td>
      <td>1007.8</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>17.2</td>
      <td>24.3</td>
      <td>No</td>
      <td>0.0</td>
      <td>No</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2008-12-03</td>
      <td>Albury</td>
      <td>12.9</td>
      <td>25.7</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>WSW</td>
      <td>46.0</td>
      <td>W</td>
      <td>...</td>
      <td>30.0</td>
      <td>1007.6</td>
      <td>1008.7</td>
      <td>NaN</td>
      <td>2.0</td>
      <td>21.0</td>
      <td>23.2</td>
      <td>No</td>
      <td>0.0</td>
      <td>No</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2008-12-04</td>
      <td>Albury</td>
      <td>9.2</td>
      <td>28.0</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NE</td>
      <td>24.0</td>
      <td>SE</td>
      <td>...</td>
      <td>16.0</td>
      <td>1017.6</td>
      <td>1012.8</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>18.1</td>
      <td>26.5</td>
      <td>No</td>
      <td>1.0</td>
      <td>No</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2008-12-05</td>
      <td>Albury</td>
      <td>17.5</td>
      <td>32.3</td>
      <td>1.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>W</td>
      <td>41.0</td>
      <td>ENE</td>
      <td>...</td>
      <td>33.0</td>
      <td>1010.8</td>
      <td>1006.0</td>
      <td>7.0</td>
      <td>8.0</td>
      <td>17.8</td>
      <td>29.7</td>
      <td>No</td>
      <td>0.2</td>
      <td>No</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>141474</th>
      <td>2015-06-26</td>
      <td>Uluru</td>
      <td>3.8</td>
      <td>18.3</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>E</td>
      <td>39.0</td>
      <td>ESE</td>
      <td>...</td>
      <td>37.0</td>
      <td>1031.5</td>
      <td>1027.6</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>8.8</td>
      <td>17.2</td>
      <td>No</td>
      <td>0.0</td>
      <td>No</td>
    </tr>
    <tr>
      <th>141475</th>
      <td>2015-06-27</td>
      <td>Uluru</td>
      <td>2.5</td>
      <td>17.1</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>E</td>
      <td>41.0</td>
      <td>ESE</td>
      <td>...</td>
      <td>40.0</td>
      <td>1029.9</td>
      <td>1026.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>7.0</td>
      <td>15.7</td>
      <td>No</td>
      <td>0.0</td>
      <td>No</td>
    </tr>
    <tr>
      <th>141476</th>
      <td>2015-06-28</td>
      <td>Uluru</td>
      <td>4.5</td>
      <td>19.6</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>ENE</td>
      <td>35.0</td>
      <td>ESE</td>
      <td>...</td>
      <td>39.0</td>
      <td>1028.7</td>
      <td>1025.0</td>
      <td>NaN</td>
      <td>3.0</td>
      <td>8.9</td>
      <td>18.0</td>
      <td>No</td>
      <td>0.0</td>
      <td>No</td>
    </tr>
    <tr>
      <th>141477</th>
      <td>2015-06-29</td>
      <td>Uluru</td>
      <td>7.6</td>
      <td>22.0</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>ESE</td>
      <td>33.0</td>
      <td>SE</td>
      <td>...</td>
      <td>37.0</td>
      <td>1027.2</td>
      <td>1023.8</td>
      <td>6.0</td>
      <td>7.0</td>
      <td>11.7</td>
      <td>21.5</td>
      <td>No</td>
      <td>0.0</td>
      <td>No</td>
    </tr>
    <tr>
      <th>141478</th>
      <td>2015-06-30</td>
      <td>Uluru</td>
      <td>6.8</td>
      <td>21.1</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>ESE</td>
      <td>35.0</td>
      <td>ESE</td>
      <td>...</td>
      <td>35.0</td>
      <td>1028.6</td>
      <td>1025.2</td>
      <td>3.0</td>
      <td>NaN</td>
      <td>10.6</td>
      <td>20.2</td>
      <td>No</td>
      <td>0.0</td>
      <td>No</td>
    </tr>
  </tbody>
</table>
<p>107502 rows × 24 columns</p>
</div></div></div>
</div>
<ul class="simple">
<li><p>It looks like the dataframe is already sorted by Location and then by date for each Location.</p></li>
<li><p>We could have done this ourselves with</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># df_train.sort_values(by=[&quot;Location&quot;, &quot;Date&quot;])</span>
</pre></div>
</div>
</div>
</div>
<p>But make sure to also sort the targets (i.e. do this before preprocessing).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">create_lag_feature</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">orig_feature</span><span class="p">,</span> <span class="n">lag</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Creates a new df with a new feature that&#39;s a lagged version of the original, where lag is an int.&quot;&quot;&quot;</span>
    <span class="c1"># note: pandas .shift() kind of does this for you already, but oh well I already wrote this code</span>
    
    <span class="n">new_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">new_feature_name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_lag</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">orig_feature</span><span class="p">,</span> <span class="n">lag</span><span class="p">)</span>
    <span class="n">new_df</span><span class="p">[</span><span class="n">new_feature_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">for</span> <span class="n">location</span><span class="p">,</span> <span class="n">df_location</span> <span class="ow">in</span> <span class="n">new_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;Location&quot;</span><span class="p">):</span> <span class="c1"># Each location is its own time series</span>
        <span class="n">new_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_location</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">lag</span><span class="p">:],</span><span class="n">new_feature_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_location</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="o">-</span><span class="n">lag</span><span class="p">][</span><span class="n">orig_feature</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="k">return</span> <span class="n">new_df</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_train</span> <span class="o">=</span> <span class="n">create_lag_feature</span><span class="p">(</span><span class="n">df_train</span><span class="p">,</span> <span class="s2">&quot;Rainfall&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_train</span><span class="p">[[</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="s2">&quot;Location&quot;</span><span class="p">,</span> <span class="s2">&quot;Rainfall&quot;</span><span class="p">,</span> <span class="s2">&quot;Rainfall_lag1&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Date</th>
      <th>Location</th>
      <th>Rainfall</th>
      <th>Rainfall_lag1</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2008-12-01</td>
      <td>Albury</td>
      <td>0.6</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2008-12-02</td>
      <td>Albury</td>
      <td>0.0</td>
      <td>0.6</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2008-12-03</td>
      <td>Albury</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2008-12-04</td>
      <td>Albury</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2008-12-05</td>
      <td>Albury</td>
      <td>1.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>5</th>
      <td>2008-12-06</td>
      <td>Albury</td>
      <td>0.2</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>6</th>
      <td>2008-12-07</td>
      <td>Albury</td>
      <td>0.0</td>
      <td>0.2</td>
    </tr>
    <tr>
      <th>7</th>
      <td>2008-12-08</td>
      <td>Albury</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>8</th>
      <td>2008-12-09</td>
      <td>Albury</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>9</th>
      <td>2008-12-10</td>
      <td>Albury</td>
      <td>1.4</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>10</th>
      <td>2008-12-11</td>
      <td>Albury</td>
      <td>0.0</td>
      <td>1.4</td>
    </tr>
    <tr>
      <th>11</th>
      <td>2008-12-12</td>
      <td>Albury</td>
      <td>2.2</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>12</th>
      <td>2008-12-13</td>
      <td>Albury</td>
      <td>15.6</td>
      <td>2.2</td>
    </tr>
    <tr>
      <th>13</th>
      <td>2008-12-14</td>
      <td>Albury</td>
      <td>3.6</td>
      <td>15.6</td>
    </tr>
    <tr>
      <th>14</th>
      <td>2008-12-16</td>
      <td>Albury</td>
      <td>NaN</td>
      <td>3.6</td>
    </tr>
    <tr>
      <th>15</th>
      <td>2008-12-17</td>
      <td>Albury</td>
      <td>0.0</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>16</th>
      <td>2008-12-18</td>
      <td>Albury</td>
      <td>16.8</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>17</th>
      <td>2008-12-19</td>
      <td>Albury</td>
      <td>10.6</td>
      <td>16.8</td>
    </tr>
    <tr>
      <th>18</th>
      <td>2008-12-20</td>
      <td>Albury</td>
      <td>0.0</td>
      <td>10.6</td>
    </tr>
    <tr>
      <th>19</th>
      <td>2008-12-21</td>
      <td>Albury</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_train</span><span class="p">[[</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="s2">&quot;Location&quot;</span><span class="p">,</span> <span class="s2">&quot;Rainfall&quot;</span><span class="p">,</span> <span class="s2">&quot;Rainfall_lag1&quot;</span><span class="p">]][</span><span class="mi">2285</span><span class="p">:</span><span class="mi">2295</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Date</th>
      <th>Location</th>
      <th>Rainfall</th>
      <th>Rainfall_lag1</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2285</th>
      <td>2015-06-26</td>
      <td>Albury</td>
      <td>0.2</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>2286</th>
      <td>2015-06-27</td>
      <td>Albury</td>
      <td>0.0</td>
      <td>0.2</td>
    </tr>
    <tr>
      <th>2287</th>
      <td>2015-06-28</td>
      <td>Albury</td>
      <td>0.2</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2288</th>
      <td>2015-06-29</td>
      <td>Albury</td>
      <td>0.0</td>
      <td>0.2</td>
    </tr>
    <tr>
      <th>2289</th>
      <td>2015-06-30</td>
      <td>Albury</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>3011</th>
      <td>2009-01-01</td>
      <td>BadgerysCreek</td>
      <td>0.0</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3012</th>
      <td>2009-01-02</td>
      <td>BadgerysCreek</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>3013</th>
      <td>2009-01-03</td>
      <td>BadgerysCreek</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>3014</th>
      <td>2009-01-04</td>
      <td>BadgerysCreek</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>3015</th>
      <td>2009-01-05</td>
      <td>BadgerysCreek</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<ul class="simple">
<li><p>Looks good.</p></li>
</ul>
<ul class="simple">
<li><p>Question: is it OK to do this to the test set? Discuss.</p></li>
</ul>
<p><br><br><br><br><br><br></p>
<ul class="simple">
<li><p>It’s fine if you would have this information available in deployment.</p></li>
<li><p>If we’re just forecasting the next day, we should.</p></li>
<li><p>Let’s include it for now.</p></li>
</ul>
<p>Another question: is there a difference between doing this and then splitting, vs. splitting and then doing this?</p>
<p><br><br><br><br><br><br></p>
<ul class="simple">
<li><p>Answer: a tiny difference: the first day of the test set, for each location, will have a <code class="docutils literal notranslate"><span class="pre">NaN</span></code>.</p>
<ul>
<li><p>That might actually be too strict.</p></li>
<li><p>It should be fine to do this before splitting.</p></li>
</ul>
</li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_rain_modified</span> <span class="o">=</span> <span class="n">create_lag_feature</span><span class="p">(</span><span class="n">df_rain</span><span class="p">,</span> <span class="s2">&quot;Rainfall&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_train</span> <span class="o">=</span> <span class="n">df_rain_modified</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;Date &lt;= 20150630&#39;</span><span class="p">)</span>
<span class="n">df_test</span>  <span class="o">=</span> <span class="n">df_rain_modified</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;Date &gt;  20150630&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_train_enc</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">X_test_enc</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">preprocessor</span> <span class="o">=</span> <span class="n">preprocess_features</span><span class="p">(</span><span class="n">df_train</span><span class="p">,</span> <span class="n">df_test</span><span class="p">,</span> 
        <span class="n">numeric_features</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;Rainfall_lag1&quot;</span><span class="p">],</span> 
        <span class="n">categorical_features</span><span class="p">,</span> 
        <span class="n">drop_features</span><span class="p">)</span>

<span class="n">lr_pipe</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span><span class="n">preprocessor</span><span class="p">,</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lr_pipe</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lr_pipe</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">df_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.8502260423061897
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lr_pipe</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">df_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.844426508316278
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lr_coef</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">lr_pipe</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">coef_</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">X_train_enc</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Coef&quot;</span><span class="p">])</span>
<span class="n">lr_coef</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;Coef&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Coef</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Humidity3pm</th>
      <td>1.242542</td>
    </tr>
    <tr>
      <th>RainToday_?</th>
      <td>0.918470</td>
    </tr>
    <tr>
      <th>Pressure9am</th>
      <td>0.866227</td>
    </tr>
    <tr>
      <th>Location_Witchcliffe</th>
      <td>0.728622</td>
    </tr>
    <tr>
      <th>WindGustSpeed</th>
      <td>0.720533</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
    </tr>
    <tr>
      <th>RainToday_No</th>
      <td>-0.722207</td>
    </tr>
    <tr>
      <th>Location_Katherine</th>
      <td>-0.728617</td>
    </tr>
    <tr>
      <th>Location_Wollongong</th>
      <td>-0.749250</td>
    </tr>
    <tr>
      <th>Location_MountGinini</th>
      <td>-0.965463</td>
    </tr>
    <tr>
      <th>Pressure3pm</th>
      <td>-1.222190</td>
    </tr>
  </tbody>
</table>
<p>120 rows × 1 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lr_coef</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="s2">&quot;Rainfall&quot;</span><span class="p">,</span> <span class="s2">&quot;Rainfall_lag1&quot;</span><span class="p">]]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Coef</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Rainfall</th>
      <td>0.081072</td>
    </tr>
    <tr>
      <th>Rainfall_lag1</th>
      <td>0.008303</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<ul class="simple">
<li><p>We could also create a lagged version of the target.</p></li>
<li><p>In fact, this dataset already has that built in! <code class="docutils literal notranslate"><span class="pre">RainToday</span></code> is the lagged version of the target <code class="docutils literal notranslate"><span class="pre">RainTomorrow</span></code>.</p></li>
<li><p>We could also created lagged version of other features, or more lags</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_rain_modified</span> <span class="o">=</span> <span class="n">create_lag_feature</span><span class="p">(</span><span class="n">df_rain</span><span class="p">,</span> <span class="s2">&quot;Rainfall&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">df_rain_modified</span> <span class="o">=</span> <span class="n">create_lag_feature</span><span class="p">(</span><span class="n">df_rain_modified</span><span class="p">,</span> <span class="s2">&quot;Rainfall&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">df_rain_modified</span> <span class="o">=</span> <span class="n">create_lag_feature</span><span class="p">(</span><span class="n">df_rain_modified</span><span class="p">,</span> <span class="s2">&quot;Rainfall&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">df_rain_modified</span> <span class="o">=</span> <span class="n">create_lag_feature</span><span class="p">(</span><span class="n">df_rain_modified</span><span class="p">,</span> <span class="s2">&quot;Humidity3pm&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_rain_modified</span><span class="p">[[</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="s1">&#39;Location&#39;</span><span class="p">,</span> <span class="s1">&#39;Rainfall&#39;</span><span class="p">,</span> <span class="s1">&#39;Rainfall_lag1&#39;</span><span class="p">,</span> <span class="s1">&#39;Rainfall_lag2&#39;</span><span class="p">,</span> <span class="s1">&#39;Rainfall_lag3&#39;</span><span class="p">,</span> <span class="s1">&#39;Humidity3pm&#39;</span><span class="p">,</span> <span class="s1">&#39;Humidity3pm_lag1&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Date</th>
      <th>Location</th>
      <th>Rainfall</th>
      <th>Rainfall_lag1</th>
      <th>Rainfall_lag2</th>
      <th>Rainfall_lag3</th>
      <th>Humidity3pm</th>
      <th>Humidity3pm_lag1</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2008-12-01</td>
      <td>Albury</td>
      <td>0.6</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>22.0</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2008-12-02</td>
      <td>Albury</td>
      <td>0.0</td>
      <td>0.6</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>25.0</td>
      <td>22.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2008-12-03</td>
      <td>Albury</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.6</td>
      <td>NaN</td>
      <td>30.0</td>
      <td>25.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2008-12-04</td>
      <td>Albury</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.6</td>
      <td>16.0</td>
      <td>30.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2008-12-05</td>
      <td>Albury</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>33.0</td>
      <td>16.0</td>
    </tr>
    <tr>
      <th>5</th>
      <td>2008-12-06</td>
      <td>Albury</td>
      <td>0.2</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>23.0</td>
      <td>33.0</td>
    </tr>
    <tr>
      <th>6</th>
      <td>2008-12-07</td>
      <td>Albury</td>
      <td>0.0</td>
      <td>0.2</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>19.0</td>
      <td>23.0</td>
    </tr>
    <tr>
      <th>7</th>
      <td>2008-12-08</td>
      <td>Albury</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.2</td>
      <td>1.0</td>
      <td>19.0</td>
      <td>19.0</td>
    </tr>
    <tr>
      <th>8</th>
      <td>2008-12-09</td>
      <td>Albury</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.2</td>
      <td>9.0</td>
      <td>19.0</td>
    </tr>
    <tr>
      <th>9</th>
      <td>2008-12-10</td>
      <td>Albury</td>
      <td>1.4</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>27.0</td>
      <td>9.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Note the pattern of <code class="docutils literal notranslate"><span class="pre">NaN</span></code> values.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_train</span> <span class="o">=</span> <span class="n">df_rain_modified</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;Date &lt;= 20150630&#39;</span><span class="p">)</span>
<span class="n">df_test</span>  <span class="o">=</span> <span class="n">df_rain_modified</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;Date &gt;  20150630&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_train_enc</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">X_test_enc</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">preprocessor</span> <span class="o">=</span> <span class="n">preprocess_features</span><span class="p">(</span><span class="n">df_train</span><span class="p">,</span> <span class="n">df_test</span><span class="p">,</span> 
        <span class="n">numeric_features</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;Rainfall_lag1&#39;</span><span class="p">,</span> <span class="s1">&#39;Rainfall_lag2&#39;</span><span class="p">,</span> <span class="s1">&#39;Rainfall_lag3&#39;</span><span class="p">,</span> <span class="s1">&#39;Humidity3pm_lag1&#39;</span><span class="p">],</span> 
        <span class="n">categorical_features</span><span class="p">,</span> 
        <span class="n">drop_features</span><span class="p">)</span>

<span class="n">lr_pipe</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span><span class="n">preprocessor</span><span class="p">,</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lr_pipe</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lr_pipe</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">df_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.8514818328961322
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lr_pipe</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">df_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.8460119339309907
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lr_coef</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">lr_pipe</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">coef_</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">X_train_enc</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Coef&quot;</span><span class="p">])</span>
<span class="n">lr_coef</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;Coef&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Coef</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Humidity3pm</th>
      <td>1.278554</td>
    </tr>
    <tr>
      <th>RainToday_?</th>
      <td>0.903025</td>
    </tr>
    <tr>
      <th>Pressure9am</th>
      <td>0.895413</td>
    </tr>
    <tr>
      <th>Location_Witchcliffe</th>
      <td>0.745507</td>
    </tr>
    <tr>
      <th>WindGustSpeed</th>
      <td>0.706832</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
    </tr>
    <tr>
      <th>Location_Wollongong</th>
      <td>-0.641508</td>
    </tr>
    <tr>
      <th>Location_Katherine</th>
      <td>-0.747221</td>
    </tr>
    <tr>
      <th>RainToday_No</th>
      <td>-0.758927</td>
    </tr>
    <tr>
      <th>Location_MountGinini</th>
      <td>-0.869530</td>
    </tr>
    <tr>
      <th>Pressure3pm</th>
      <td>-1.253096</td>
    </tr>
  </tbody>
</table>
<p>123 rows × 1 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lr_coef</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="s1">&#39;Rainfall&#39;</span><span class="p">,</span> <span class="s1">&#39;Rainfall_lag1&#39;</span><span class="p">,</span> <span class="s1">&#39;Rainfall_lag2&#39;</span><span class="p">,</span> <span class="s1">&#39;Rainfall_lag3&#39;</span><span class="p">,</span> <span class="s1">&#39;Humidity3pm&#39;</span><span class="p">,</span> <span class="s1">&#39;Humidity3pm_lag1&#39;</span><span class="p">]]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Coef</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Rainfall</th>
      <td>0.108507</td>
    </tr>
    <tr>
      <th>Rainfall_lag1</th>
      <td>0.023072</td>
    </tr>
    <tr>
      <th>Rainfall_lag2</th>
      <td>0.018276</td>
    </tr>
    <tr>
      <th>Rainfall_lag3</th>
      <td>0.017810</td>
    </tr>
    <tr>
      <th>Humidity3pm</th>
      <td>1.278554</td>
    </tr>
    <tr>
      <th>Humidity3pm_lag1</th>
      <td>-0.267483</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_train</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Date</th>
      <th>Location</th>
      <th>MinTemp</th>
      <th>MaxTemp</th>
      <th>Rainfall</th>
      <th>Evaporation</th>
      <th>Sunshine</th>
      <th>WindGustDir</th>
      <th>WindGustSpeed</th>
      <th>WindDir9am</th>
      <th>...</th>
      <th>Cloud3pm</th>
      <th>Temp9am</th>
      <th>Temp3pm</th>
      <th>RainToday</th>
      <th>RISK_MM</th>
      <th>RainTomorrow</th>
      <th>Rainfall_lag1</th>
      <th>Rainfall_lag2</th>
      <th>Rainfall_lag3</th>
      <th>Humidity3pm_lag1</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2008-12-01</td>
      <td>Albury</td>
      <td>13.4</td>
      <td>22.9</td>
      <td>0.6</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>W</td>
      <td>44.0</td>
      <td>W</td>
      <td>...</td>
      <td>NaN</td>
      <td>16.9</td>
      <td>21.8</td>
      <td>No</td>
      <td>0.0</td>
      <td>No</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2008-12-02</td>
      <td>Albury</td>
      <td>7.4</td>
      <td>25.1</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>WNW</td>
      <td>44.0</td>
      <td>NNW</td>
      <td>...</td>
      <td>NaN</td>
      <td>17.2</td>
      <td>24.3</td>
      <td>No</td>
      <td>0.0</td>
      <td>No</td>
      <td>0.6</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>22.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2008-12-03</td>
      <td>Albury</td>
      <td>12.9</td>
      <td>25.7</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>WSW</td>
      <td>46.0</td>
      <td>W</td>
      <td>...</td>
      <td>2.0</td>
      <td>21.0</td>
      <td>23.2</td>
      <td>No</td>
      <td>0.0</td>
      <td>No</td>
      <td>0.0</td>
      <td>0.6</td>
      <td>NaN</td>
      <td>25.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2008-12-04</td>
      <td>Albury</td>
      <td>9.2</td>
      <td>28.0</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NE</td>
      <td>24.0</td>
      <td>SE</td>
      <td>...</td>
      <td>NaN</td>
      <td>18.1</td>
      <td>26.5</td>
      <td>No</td>
      <td>1.0</td>
      <td>No</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.6</td>
      <td>30.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2008-12-05</td>
      <td>Albury</td>
      <td>17.5</td>
      <td>32.3</td>
      <td>1.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>W</td>
      <td>41.0</td>
      <td>ENE</td>
      <td>...</td>
      <td>8.0</td>
      <td>17.8</td>
      <td>29.7</td>
      <td>No</td>
      <td>0.2</td>
      <td>No</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>16.0</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 28 columns</p>
</div></div></div>
</div>
</div>
<div class="section" id="forecasting-further-into-the-future-10-min">
<h2>Forecasting further into the future (10 min)<a class="headerlink" href="#forecasting-further-into-the-future-10-min" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Let’s say we want to predict 7 days into the future instead of one day.</p></li>
<li><p>There are a few main approaches here:</p></li>
</ul>
<ol class="simple">
<li><p>Train a separate model for each number of days. E.g. one model that predicts RainTomorrow, another model that predicts RainIn2Days, etc. We can build these datasets.</p></li>
<li><p>Use a multi-output model that jointly predicts RainTomorrow, RainIn2Days, etc. However, multi-output models are outside the scope of CPSC 330.</p></li>
<li><p>Use one model and sequentially predict using a <code class="docutils literal notranslate"><span class="pre">for</span></code> loop. However, this requires predicting <em>all</em> features into a model so may not be that useful here.</p></li>
</ol>
<p>So, I’ll recommend Approach 1 to you, even though it’s a bit unwieldy.</p>
<ul class="simple">
<li><p>To briefly dig into approach 3, this is easier to understand for a univariate (one feature) time series.</p></li>
<li><p>To dig into this we’ll look at the <a class="reference external" href="https://fred.stlouisfed.org/series/MRTSSM448USN">Retail Sales of Clothing and Clothing Accessory Stores dataset</a> made available by the Federal Reserve Bank of St. Louis.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">retail_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;data/retail_sales_timeseries.csv&#39;</span><span class="p">,</span> <span class="n">parse_dates</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">])</span>
<span class="n">retail_df</span><span class="o">.</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="s2">&quot;sales&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">retail_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>date</th>
      <th>sales</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1992-01-01</td>
      <td>6938</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1992-02-01</td>
      <td>7524</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1992-03-01</td>
      <td>8475</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1992-04-01</td>
      <td>9401</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1992-05-01</td>
      <td>9558</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">retail_df</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Timestamp(&#39;1992-01-01 00:00:00&#39;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">retail_df</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Timestamp(&#39;2020-08-01 00:00:00&#39;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">retail_df_train</span> <span class="o">=</span> <span class="n">retail_df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;date &lt;= 20170101&#39;</span><span class="p">)</span>
<span class="n">retail_df_test</span>  <span class="o">=</span> <span class="n">retail_df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;date &gt;  20170101&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">retail_df_train</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;sales&quot;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">5</span><span class="p">));</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/18_time-series_258_0.png" src="../_images/18_time-series_258_0.png" />
</div>
</div>
<p>We can create a dataset using purely lag features.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">lag_df</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">lag</span><span class="p">,</span> <span class="n">cols</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">lag</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">retail_lag_5</span> <span class="o">=</span> <span class="n">lag_df</span><span class="p">(</span><span class="n">retail_df</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;sales&quot;</span><span class="p">])</span>
<span class="n">retail_train_5</span> <span class="o">=</span> <span class="n">retail_lag_5</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;date &lt;= 20170101&#39;</span><span class="p">)</span>
<span class="n">retail_test_5</span>  <span class="o">=</span> <span class="n">retail_lag_5</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;date &gt;  20170101&#39;</span><span class="p">)</span>
<span class="n">retail_train_5</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>date</th>
      <th>sales</th>
      <th>sales-1</th>
      <th>sales-2</th>
      <th>sales-3</th>
      <th>sales-4</th>
      <th>sales-5</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1992-01-01</td>
      <td>6938</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1992-02-01</td>
      <td>7524</td>
      <td>6938.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1992-03-01</td>
      <td>8475</td>
      <td>7524.0</td>
      <td>6938.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1992-04-01</td>
      <td>9401</td>
      <td>8475.0</td>
      <td>7524.0</td>
      <td>6938.0</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1992-05-01</td>
      <td>9558</td>
      <td>9401.0</td>
      <td>8475.0</td>
      <td>7524.0</td>
      <td>6938.0</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>296</th>
      <td>2016-09-01</td>
      <td>19816</td>
      <td>22394.0</td>
      <td>20676.0</td>
      <td>20157.0</td>
      <td>21648.0</td>
      <td>20412.0</td>
    </tr>
    <tr>
      <th>297</th>
      <td>2016-10-01</td>
      <td>20544</td>
      <td>19816.0</td>
      <td>22394.0</td>
      <td>20676.0</td>
      <td>20157.0</td>
      <td>21648.0</td>
    </tr>
    <tr>
      <th>298</th>
      <td>2016-11-01</td>
      <td>23704</td>
      <td>20544.0</td>
      <td>19816.0</td>
      <td>22394.0</td>
      <td>20676.0</td>
      <td>20157.0</td>
    </tr>
    <tr>
      <th>299</th>
      <td>2016-12-01</td>
      <td>34611</td>
      <td>23704.0</td>
      <td>20544.0</td>
      <td>19816.0</td>
      <td>22394.0</td>
      <td>20676.0</td>
    </tr>
    <tr>
      <th>300</th>
      <td>2017-01-01</td>
      <td>15791</td>
      <td>34611.0</td>
      <td>23704.0</td>
      <td>20544.0</td>
      <td>19816.0</td>
      <td>22394.0</td>
    </tr>
  </tbody>
</table>
<p>301 rows × 7 columns</p>
</div></div></div>
</div>
<ul class="simple">
<li><p>Now, if we drop the “date” column we have a target (“sales”) and 5 features (the previous 5 days of sales).</p></li>
<li><p>We need to impute/drop the missing values and then we can fit a model to this. I will just drop for convenience:</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">retail_train_5</span> <span class="o">=</span> <span class="n">retail_train_5</span><span class="p">[</span><span class="mi">5</span><span class="p">:]</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">])</span>
<span class="n">retail_train_5</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>sales</th>
      <th>sales-1</th>
      <th>sales-2</th>
      <th>sales-3</th>
      <th>sales-4</th>
      <th>sales-5</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>5</th>
      <td>9182</td>
      <td>9558.0</td>
      <td>9401.0</td>
      <td>8475.0</td>
      <td>7524.0</td>
      <td>6938.0</td>
    </tr>
    <tr>
      <th>6</th>
      <td>9103</td>
      <td>9182.0</td>
      <td>9558.0</td>
      <td>9401.0</td>
      <td>8475.0</td>
      <td>7524.0</td>
    </tr>
    <tr>
      <th>7</th>
      <td>10513</td>
      <td>9103.0</td>
      <td>9182.0</td>
      <td>9558.0</td>
      <td>9401.0</td>
      <td>8475.0</td>
    </tr>
    <tr>
      <th>8</th>
      <td>9573</td>
      <td>10513.0</td>
      <td>9103.0</td>
      <td>9182.0</td>
      <td>9558.0</td>
      <td>9401.0</td>
    </tr>
    <tr>
      <th>9</th>
      <td>10254</td>
      <td>9573.0</td>
      <td>10513.0</td>
      <td>9103.0</td>
      <td>9182.0</td>
      <td>9558.0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>296</th>
      <td>19816</td>
      <td>22394.0</td>
      <td>20676.0</td>
      <td>20157.0</td>
      <td>21648.0</td>
      <td>20412.0</td>
    </tr>
    <tr>
      <th>297</th>
      <td>20544</td>
      <td>19816.0</td>
      <td>22394.0</td>
      <td>20676.0</td>
      <td>20157.0</td>
      <td>21648.0</td>
    </tr>
    <tr>
      <th>298</th>
      <td>23704</td>
      <td>20544.0</td>
      <td>19816.0</td>
      <td>22394.0</td>
      <td>20676.0</td>
      <td>20157.0</td>
    </tr>
    <tr>
      <th>299</th>
      <td>34611</td>
      <td>23704.0</td>
      <td>20544.0</td>
      <td>19816.0</td>
      <td>22394.0</td>
      <td>20676.0</td>
    </tr>
    <tr>
      <th>300</th>
      <td>15791</td>
      <td>34611.0</td>
      <td>23704.0</td>
      <td>20544.0</td>
      <td>19816.0</td>
      <td>22394.0</td>
    </tr>
  </tbody>
</table>
<p>296 rows × 6 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">retail_train_5_X</span> <span class="o">=</span> <span class="n">retail_train_5</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;sales&quot;</span><span class="p">])</span>
<span class="n">retail_train_5_y</span> <span class="o">=</span> <span class="n">retail_train_5</span><span class="p">[</span><span class="s2">&quot;sales&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestRegressor</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">retail_model</span> <span class="o">=</span> <span class="n">RandomForestRegressor</span><span class="p">()</span>
<span class="n">retail_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">retail_train_5_X</span><span class="p">,</span> <span class="n">retail_train_5_y</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<p>Given this, we can now predict the sales</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">preds</span> <span class="o">=</span> <span class="n">retail_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">retail_test_5</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="s2">&quot;sales&quot;</span><span class="p">]))</span>
<span class="n">preds</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([18467.6 , 20499.93, 20832.32, 21975.02, 20478.01, 21715.37,
       22137.9 , 27378.72, 21336.06, 22967.41, 29288.32, 16088.3 ,
       18441.65, 21964.19, 22129.24, 22035.51, 29124.66, 20128.5 ,
       22068.74, 31185.6 , 21982.77, 21840.5 , 18289.57, 16076.64,
       18672.95, 20503.22, 21384.15, 21916.12, 28232.72, 21622.19,
       21795.75, 31142.77, 21945.5 , 21989.4 , 27653.07, 16070.28,
       18978.71, 22361.74, 13334.49, 11690.89, 11271.88, 14551.29,
       13598.25])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">retail_test_5_preds</span> <span class="o">=</span> <span class="n">retail_test_5</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">predicted_sales</span> <span class="o">=</span> <span class="n">preds</span><span class="p">)</span>
<span class="n">retail_test_5_preds</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>date</th>
      <th>sales</th>
      <th>sales-1</th>
      <th>sales-2</th>
      <th>sales-3</th>
      <th>sales-4</th>
      <th>sales-5</th>
      <th>predicted_sales</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>301</th>
      <td>2017-02-01</td>
      <td>17900</td>
      <td>15791.0</td>
      <td>34611.0</td>
      <td>23704.0</td>
      <td>20544.0</td>
      <td>19816.0</td>
      <td>18467.60</td>
    </tr>
    <tr>
      <th>302</th>
      <td>2017-03-01</td>
      <td>21217</td>
      <td>17900.0</td>
      <td>15791.0</td>
      <td>34611.0</td>
      <td>23704.0</td>
      <td>20544.0</td>
      <td>20499.93</td>
    </tr>
    <tr>
      <th>303</th>
      <td>2017-04-01</td>
      <td>21052</td>
      <td>21217.0</td>
      <td>17900.0</td>
      <td>15791.0</td>
      <td>34611.0</td>
      <td>23704.0</td>
      <td>20832.32</td>
    </tr>
    <tr>
      <th>304</th>
      <td>2017-05-01</td>
      <td>21831</td>
      <td>21052.0</td>
      <td>21217.0</td>
      <td>17900.0</td>
      <td>15791.0</td>
      <td>34611.0</td>
      <td>21975.02</td>
    </tr>
    <tr>
      <th>305</th>
      <td>2017-06-01</td>
      <td>20527</td>
      <td>21831.0</td>
      <td>21052.0</td>
      <td>21217.0</td>
      <td>17900.0</td>
      <td>15791.0</td>
      <td>20478.01</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<ul class="simple">
<li><p>Ok, that is fine, but what if we want to predict 7 days in the future?</p></li>
<li><p>Well, we would not have access to our features!! We don’t yet know the previous day’s sales, or 2 days prior!</p></li>
<li><p>So we can use “Approach 3” mentioned earlier: predict these values and then pretend they are true!</p></li>
<li><p>For simplicity, say today is Monday</p></li>
</ul>
<ol class="simple">
<li><p>Predict Tuesday’s sales</p></li>
<li><p>Then, to predict for Wednesday, we need to know Tuesday’s sales. Use our <em>prediction</em> for Tuesday as the truth.</p></li>
<li><p>Then, to predict for Thursday, we need to know Tue and Wed sales. Use our predictions.</p></li>
<li><p>Etc etc.</p></li>
</ol>
<p>Let’s take a look at <a class="reference external" href="https://github.com/TomasBeuzen/machine-learning-tutorials/blob/master/ml-timeseries/notebooks/supervised_time_series_intro.ipynb">Tom’s timeseries tutorial</a> for what this looks like.</p>
</div>
<div class="section" id="trends-5-min">
<h2>Trends (5 min)<a class="headerlink" href="#trends-5-min" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>I kind of regret picking the Rain in Australia dataset because it has a binary target value.</p></li>
<li><p>There are some important concepts in time series that rely on having a continuous target (like we do in the retail sales example above).</p></li>
<li><p>Part of that is the idea of seasonality and trends.</p></li>
<li><p>These are mostly taken care of by our feature engineering of the data variable, but there’s something important left to discuss.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">retail_df_train</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;sales&quot;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">5</span><span class="p">));</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/18_time-series_275_0.png" src="../_images/18_time-series_275_0.png" />
</div>
</div>
<ul class="simple">
<li><p>It looks like there’s a <strong>trend</strong> here - the sales are going up over time.</p></li>
<li><p>This is somewhat captured by the fact that you can look at the last 5 time points, which will also be higher.</p></li>
<li><p>But if you want to forecast much farther into the future, nothing in our model accounts for the trend.</p></li>
<li><p>This is seen in the forecasts in Tom’s notebook.</p></li>
</ul>
<p>Let’s say we encoded the date as a feature in days like this:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">retail_train_5_date</span> <span class="o">=</span> <span class="n">retail_lag_5</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;date &lt;= 20170101&#39;</span><span class="p">)</span>
<span class="n">first_day_retail</span> <span class="o">=</span> <span class="n">retail_train_5_date</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

<span class="n">retail_train_5_date</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">Days_since</span><span class="o">=</span><span class="n">retail_train_5_date</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">first_day_retail</span><span class="p">)</span><span class="o">.</span><span class="n">days</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>date</th>
      <th>sales</th>
      <th>sales-1</th>
      <th>sales-2</th>
      <th>sales-3</th>
      <th>sales-4</th>
      <th>sales-5</th>
      <th>Days_since</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1992-01-01</td>
      <td>6938</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1992-02-01</td>
      <td>7524</td>
      <td>6938.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>31</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1992-03-01</td>
      <td>8475</td>
      <td>7524.0</td>
      <td>6938.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>60</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1992-04-01</td>
      <td>9401</td>
      <td>8475.0</td>
      <td>7524.0</td>
      <td>6938.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>91</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1992-05-01</td>
      <td>9558</td>
      <td>9401.0</td>
      <td>8475.0</td>
      <td>7524.0</td>
      <td>6938.0</td>
      <td>NaN</td>
      <td>121</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>296</th>
      <td>2016-09-01</td>
      <td>19816</td>
      <td>22394.0</td>
      <td>20676.0</td>
      <td>20157.0</td>
      <td>21648.0</td>
      <td>20412.0</td>
      <td>9010</td>
    </tr>
    <tr>
      <th>297</th>
      <td>2016-10-01</td>
      <td>20544</td>
      <td>19816.0</td>
      <td>22394.0</td>
      <td>20676.0</td>
      <td>20157.0</td>
      <td>21648.0</td>
      <td>9040</td>
    </tr>
    <tr>
      <th>298</th>
      <td>2016-11-01</td>
      <td>23704</td>
      <td>20544.0</td>
      <td>19816.0</td>
      <td>22394.0</td>
      <td>20676.0</td>
      <td>20157.0</td>
      <td>9071</td>
    </tr>
    <tr>
      <th>299</th>
      <td>2016-12-01</td>
      <td>34611</td>
      <td>23704.0</td>
      <td>20544.0</td>
      <td>19816.0</td>
      <td>22394.0</td>
      <td>20676.0</td>
      <td>9101</td>
    </tr>
    <tr>
      <th>300</th>
      <td>2017-01-01</td>
      <td>15791</td>
      <td>34611.0</td>
      <td>23704.0</td>
      <td>20544.0</td>
      <td>19816.0</td>
      <td>22394.0</td>
      <td>9132</td>
    </tr>
  </tbody>
</table>
<p>301 rows × 8 columns</p>
</div></div></div>
</div>
<ul class="simple">
<li><p>Now, let’s say we use all these features (the lagged version of the target and also <code class="docutils literal notranslate"><span class="pre">Days_since</span></code>.</p></li>
<li><p>If we use <strong>linear regression</strong> we’ll learn a coefficient for <code class="docutils literal notranslate"><span class="pre">Days_since</span></code>.</p>
<ul>
<li><p>If that coefficient is positive, it predicts unlimited growth forever. That may not be what you want? It depends.</p></li>
</ul>
</li>
<li><p>If we use a <strong>random forest</strong>, we’ll just be doing splits from the training set, e.g. “if <code class="docutils literal notranslate"><span class="pre">Days_since</span></code> &gt; 9100 then do this”.</p>
<ul>
<li><p>There will be no splits for later time points because there is no training data there.</p></li>
<li><p>Thus tree-based models cannot model trends.</p></li>
<li><p>This is really important to know!!</p></li>
</ul>
</li>
<li><p>Often, we model the trend separately and use the random forest to model a de-trended time series.</p></li>
</ul>
</div>
<div class="section" id="what-did-we-not-cover-5-min">
<h2>What did we not cover? (5 min)<a class="headerlink" href="#what-did-we-not-cover-5-min" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>A huge amount!</p></li>
</ul>
<div class="section" id="traditional-time-series-approaches">
<h3>Traditional time series approaches<a class="headerlink" href="#traditional-time-series-approaches" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Time series analysis is a huge field of its own (notice a pattern here?)</p></li>
<li><p>Traditional approaches include the <a class="reference external" href="https://en.wikipedia.org/wiki/Autoregressive_integrated_moving_average">ARIMA model</a> and its various components/extensions.</p></li>
<li><p>In Python, the <a class="reference external" href="https://www.statsmodels.org/">statsmodels</a> package is the place to go for this sort of thing.</p>
<ul>
<li><p>For example, <a class="reference external" href="https://www.statsmodels.org/stable/generated/statsmodels.tsa.arima_model.ARIMA.html">statsmodels.tsa.arima_model.ARIMA</a>.</p></li>
</ul>
</li>
<li><p>These approaches can forecast, but they are also very good for understanding the temporal relationships in your data.</p></li>
<li><p>We will take a different route in this course, and stick to our supervised learning tools.</p></li>
</ul>
</div>
<div class="section" id="deep-learning">
<h3>Deep learning<a class="headerlink" href="#deep-learning" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Recently, deep learning has been very successful too.</p></li>
<li><p>In particular, <a class="reference external" href="https://en.wikipedia.org/wiki/Recurrent_neural_network">recurrent neural networks</a> (RNNs).</p>
<ul>
<li><p>These are not covered in CPSC 340, but I believe they are in 540 (soon to be renamed 440).</p></li>
<li><p><a class="reference external" href="https://en.wikipedia.org/wiki/Long_short-term_memory">LSTMs</a> especially have shown a lot of promise in this type of task.</p></li>
<li><p><a class="reference external" href="https://colah.github.io/posts/2015-08-Understanding-LSTMs/">Here</a> is a blog post about LSTMs.</p></li>
<li><p><a class="reference external" href="https://www.tensorflow.org/api_docs/python/tf/keras/layers/LSTM">Here</a> is the documentation for the LSTM in tf.keras.</p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="types-of-problems-involving-time-series">
<h3>Types of problems involving time series<a class="headerlink" href="#types-of-problems-involving-time-series" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>A single label associated with an entire time series.</p>
<ul>
<li><p>We had that with images earlier on, you could have the same for a time series.</p></li>
<li><p>E.g., for fraud detection, labelling each transaction as fraud/normal vs. labelling a person as bad/good based on their entire history.</p></li>
<li><p>There are various approaches that can be used for this type of problem, including CNNs (Lecture 14), LSTMs, and non deep learning methods.</p></li>
</ul>
</li>
<li><p>Inference problems.</p>
<ul>
<li><p>What are the patterns in this time series?</p></li>
<li><p>How many lags are associated with the current value?</p></li>
</ul>
</li>
<li><p>Etc.</p></li>
</ul>
</div>
<div class="section" id="unequally-spaced-time-points">
<h3>Unequally spaced time points<a class="headerlink" href="#unequally-spaced-time-points" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>We assumed we have a measurement each day.</p></li>
<li><p>For example, when creating lag features we used consecutive rows in the DataFrame.</p></li>
<li><p>But, in fact some days were missing in this dataset.</p></li>
<li><p>More generally, what if the measurements are at arbitrary times, not equally spaced?</p>
<ul>
<li><p>Some of our approaches would still work, like encoding the month / looking at seasonality.</p></li>
<li><p>Some of our approaches would not make sense, like the lags.</p></li>
<li><p>Perhaps the measurements could be binned into equally spaced bins, or something.</p></li>
<li><p>This is more of a hassle.</p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="other-software-package">
<h3>Other software package<a class="headerlink" href="#other-software-package" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>One good one to know about is <a class="reference external" href="https://facebook.github.io/prophet/docs/quick_start.html">Prophet</a>.</p></li>
</ul>
</div>
<div class="section" id="feature-engineering">
<h3>Feature engineering<a class="headerlink" href="#feature-engineering" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Often, a useful approach is to just <em>engineer your own features</em>.</p>
<ul>
<li><p>E.g., max expenditure, min expenditure, max-min, avg time gap between transactions, variance of time gap between transactions, etc etc.</p></li>
<li><p>We could do that here as well, or in any problem.</p></li>
</ul>
</li>
</ul>
</div>
</div>
<div class="section" id="t-f-questions-piazza">
<h2>T/F questions (Piazza)<a class="headerlink" href="#t-f-questions-piazza" title="Permalink to this headline">¶</a></h2>
<ol class="simple">
<li><p>The rain in Australia dataset contains a single time series; that is, each date has a unique row associated with it.</p></li>
<li><p>A reasonable approach to encoding the date would be one-hot encoding the days of the year (from 1-365).</p></li>
<li><p>It is better to OHE the month than to encode it as an integer (i.e. ordinal).</p></li>
<li><p>It is important to train/test split before we create our lagged features.</p></li>
<li><p>If we have a feature with lag 3 in our dataset, that feature will be missing if we try to forecast 5 days into the future.</p></li>
</ol>
<p><br><br><br><br><br><br></p>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "conda-env-cpsc330-py"
        },
        kernelOptions: {
            kernelName: "conda-env-cpsc330-py",
            path: "./lectures"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'conda-env-cpsc330-py'</script>

              </div>
              
        
        <div class='prev-next-bottom'>
            

        </div>
        
        </div>
    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By Varada Kolhatkar<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="../_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  
  </body>
</html>