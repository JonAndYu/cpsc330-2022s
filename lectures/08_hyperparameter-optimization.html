
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lecture 7: Hyperparameter optimization and optimization bias &#8212; CPSC 330 Applied Machine Learning</title>
    
  <link href="../_static/css/theme.css" rel="stylesheet" />
  <link href="../_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/sphinx-book-theme.e8e5499552300ddf5d7adccae7cc3b70.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.1c5a1a01449ed65a7b51.js">

    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["\\(", "\\)"]], "displayMath": [["\\[", "\\]"]], "processRefs": false, "processEnvironments": false}})</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
      <img src="../_static/UBC-CS-logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">CPSC 330 Applied Machine Learning</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
    <div class="bd-toc-item active">
        <p class="caption">
 <span class="caption-text">
  Things you should know
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../docs/README.html">
   CPSC 330 Documents
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Lectures
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="01_intro.html">
   Lecture 1: Course Introduction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="02_decision-trees.html">
   Lecture 2: Terminology, Baselines, Decision Trees
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="03_ml-fundamentals.html">
   Lecture 3: Machine Learning Fundamentals
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="04_kNNs-SVM-RBF.html">
   Lecture 4:
   <span class="math notranslate nohighlight">
    \(k\)
   </span>
   -Nearest Neighbours and SVM RBFs
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="05_preprocessing-pipelines.html">
   Lecture 5: Preprocessing and
   <code class="docutils literal notranslate">
    <span class="pre">
     sklearn
    </span>
   </code>
   pipelines
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="06_column-transformer-text-feats.html">
   Lecture 6:
   <code class="docutils literal notranslate">
    <span class="pre">
     sklearn
    </span>
   </code>
   <code class="docutils literal notranslate">
    <span class="pre">
     ColumnTransformer
    </span>
   </code>
   and Text Features
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Attribution
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../attribution.html">
   Attributions
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../LICENSE.html">
   LICENSE
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Varada Kolhatkar, CPSC 330 2021-22<br>Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/lectures/08_hyperparameter-optimization.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/UBC-CS/cpsc330/master?urlpath=tree/lectures/08_hyperparameter-optimization.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#imports">
   Imports
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#lecture-plan-for-today">
   Lecture plan for today
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#announcements">
   Announcements
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#learning-outcomes">
     Learning outcomes
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#lecture-outline">
     Lecture outline
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#hyperparameter-optimization-introduction-and-motivation">
   Hyperparameter optimization introduction and motivation
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#motivation">
     Motivation
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#hyperparameters-the-problem">
     Hyperparameters: the problem
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#some-ways-to-pick-hyperparameters">
     Some ways to pick hyperparameters:
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#manual-hyperparameter-optimization">
       Manual hyperparameter optimization
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#automated-hyperparameter-optimization">
       Automated hyperparameter optimization
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#hyperparameter-optimization-with-scikit-learn">
   Hyperparameter optimization with
   <code class="docutils literal notranslate">
    <span class="pre">
     scikit-learn
    </span>
   </code>
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#dataset">
     Dataset
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#exhaustive-grid-search">
       Exhaustive grid search
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#problems-with-exhaustive-grid-search">
       Problems with exhaustive grid search
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#data">
   Data
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#reading-the-data-csv-and-splitting-it">
     Reading the data CSV and splitting it
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#identify-feature-types">
     Identify feature types
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#define-columntransformer-and-a-pipeline">
     Define
     <code class="docutils literal notranslate">
      <span class="pre">
       ColumnTransformer
      </span>
     </code>
     and a pipeline
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#let-s-carry-out-hyperparameter-optimization-with-c-and-gamma">
     Let’s carry out hyperparameter optimization with
     <code class="docutils literal notranslate">
      <span class="pre">
       C
      </span>
     </code>
     and
     <code class="docutils literal notranslate">
      <span class="pre">
       gamma
      </span>
     </code>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#questions-and-comments">
     Questions and comments
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#automated-hyperparameter-tuning-the-solution">
     Automated hyperparameter tuning: the solution?
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#scikit-learn-built-in-methods-for-hyperparameter-optimization">
     <code class="docutils literal notranslate">
      <span class="pre">
       scikit-learn
      </span>
     </code>
     built-in methods for hyperparameter optimization
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id1">
     Exhaustive grid search
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#the-syntax">
     The
     <code class="docutils literal notranslate">
      <span class="pre">
       __
      </span>
     </code>
     syntax
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#how-do-we-access-hyperparameters-of-transformers">
     How do we access hyperparameters of transformers
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id2">
     Problems with exhaustive grid search
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#randomized-hyperparameter-search">
     Randomized hyperparameter search
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#advantages-of-randomizedsearchcv">
     Advantages of
     <code class="docutils literal notranslate">
      <span class="pre">
       RandomizedSearchCV
      </span>
     </code>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id3">
     Advantages of
     <code class="docutils literal notranslate">
      <span class="pre">
       RandomizedSearchCV
      </span>
     </code>
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#fancier-methods-optional">
   Fancier methods (optional)
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#pros-and-cons-of-bayesopt">
     Pros and cons of BayesOpt
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#questions-for-class-discussion-hyperparameter-optimization">
     Questions for class discussion (hyperparameter optimization)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#optimization-bias-a-name-3-a">
   3. Optimization bias
   <a name="3">
   </a>
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#overfitting-of-the-validation-error">
     Overfitting of the validation error
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id4">
     Overfitting of the validation error
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#example-1-optimization-bias-optional">
     Example 1: Optimization bias (optional)
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#example-2-optimization-bias-optional">
     Example 2: Optimization bias (optional)
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#let-s-examine-effects-of-optimization-on-the-adult-income-dataset">
     Let’s examine effects of optimization on the adult income dataset
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id5">
     Identify feature types
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id6">
     Define
     <code class="docutils literal notranslate">
      <span class="pre">
       ColumnTransformer
      </span>
     </code>
     and a pipeline
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#overfitting-of-the-validation-data">
     Overfitting of the validation data
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#why-do-we-need-a-test-set">
     Why do we need a test set?
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#large-datasets-solves-many-of-these-problems">
     Large datasets solves many of these problems
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#questions-for-class-discussion-optimization-bias">
     Questions for class discussion (optimization bias)
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#would-you-trust-the-model">
     Would you trust the model?
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id7">
     Would you trust the model?
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id8">
     Would you trust the model?
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#optional-readings-and-resources">
   Optional readings and resources
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <p><img alt="" src="../_images/330-banner.png" /></p>
<div class="section" id="lecture-7-hyperparameter-optimization-and-optimization-bias">
<h1>Lecture 7: Hyperparameter optimization and optimization bias<a class="headerlink" href="#lecture-7-hyperparameter-optimization-and-optimization-bias" title="Permalink to this headline">¶</a></h1>
<p>UBC 2020-21</p>
<p>Instructor: Varada Kolhatkar</p>
<div class="section" id="imports">
<h2>Imports<a class="headerlink" href="#imports" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">mglearn</span>

<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">HTML</span>
<span class="kn">from</span> <span class="nn">sklearn.compose</span> <span class="kn">import</span> <span class="n">ColumnTransformer</span>
<span class="kn">from</span> <span class="nn">sklearn.dummy</span> <span class="kn">import</span> <span class="n">DummyClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.feature_extraction.text</span> <span class="kn">import</span> <span class="n">CountVectorizer</span><span class="p">,</span> <span class="n">TfidfVectorizer</span>

<span class="c1"># Preprocessing and pipeline</span>
<span class="kn">from</span> <span class="nn">sklearn.impute</span> <span class="kn">import</span> <span class="n">SimpleImputer</span>

<span class="c1"># train test split and cross validation</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">GridSearchCV</span><span class="p">,</span>
    <span class="n">RandomizedSearchCV</span><span class="p">,</span>
    <span class="n">cross_val_score</span><span class="p">,</span>
    <span class="n">cross_validate</span><span class="p">,</span>
    <span class="n">train_test_split</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">sklearn.neighbors</span> <span class="kn">import</span> <span class="n">KNeighborsClassifier</span><span class="p">,</span> <span class="n">KNeighborsRegressor</span>
<span class="kn">from</span> <span class="nn">sklearn.pipeline</span> <span class="kn">import</span> <span class="n">FeatureUnion</span><span class="p">,</span> <span class="n">Pipeline</span><span class="p">,</span> <span class="n">make_pipeline</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">OneHotEncoder</span><span class="p">,</span> <span class="n">OrdinalEncoder</span><span class="p">,</span> <span class="n">StandardScaler</span>
<span class="kn">from</span> <span class="nn">sklearn.svm</span> <span class="kn">import</span> <span class="n">SVC</span>
<span class="kn">from</span> <span class="nn">sklearn.tree</span> <span class="kn">import</span> <span class="n">DecisionTreeClassifier</span>

<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s2">&quot;display.max_colwidth&quot;</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="lecture-plan-for-today">
<h2>Lecture plan for today<a class="headerlink" href="#lecture-plan-for-today" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>TBD</p></li>
</ul>
<p><br><br></p>
</div>
<div class="section" id="announcements">
<h2>Announcements<a class="headerlink" href="#announcements" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>TBD</p></li>
</ul>
<div class="section" id="learning-outcomes">
<h3>Learning outcomes<a class="headerlink" href="#learning-outcomes" title="Permalink to this headline">¶</a></h3>
<p>From this lecture, you will be able to</p>
<ul class="simple">
<li><p>explain the need for hyperparameter optimization</p></li>
<li><p>carry out hyperparameter optimization using <code class="docutils literal notranslate"><span class="pre">sklearn</span></code>’s <code class="docutils literal notranslate"><span class="pre">GridSearchCV</span></code> and <code class="docutils literal notranslate"><span class="pre">RandomizedSearchCV</span></code></p></li>
<li><p>explain optimization bias</p></li>
<li><p>identify and reason when to trust and not trust reported accuracies</p></li>
</ul>
</div>
<div class="section" id="lecture-outline">
<h3>Lecture outline<a class="headerlink" href="#lecture-outline" title="Permalink to this headline">¶</a></h3>
<ol class="simple">
<li><p><a class="reference external" href="#1">Introduction and motivation</a></p></li>
<li><p><a class="reference external" href="#2">Hyperparameter optimization</a></p></li>
<li><p><a class="reference external" href="#3">Optimization bias</a></p></li>
<li><p><a class="reference external" href="#4">Summary</a></p></li>
</ol>
</div>
</div>
<div class="section" id="hyperparameter-optimization-introduction-and-motivation">
<h2>Hyperparameter optimization introduction and motivation<a class="headerlink" href="#hyperparameter-optimization-introduction-and-motivation" title="Permalink to this headline">¶</a></h2>
<div class="section" id="motivation">
<h3>Motivation<a class="headerlink" href="#motivation" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Remember that the fundamental goal of supervised machine is to generalize beyond what we see in the training examples.</p></li>
<li><p>We have been using data splitting and cross-validation to provide a framework to approximate generalization error.</p></li>
<li><p>With this framework, we can improve the model’s generalization performance by tuning model hyperparameters using cross-validation on the training set.</p></li>
</ul>
<p>In homework assignments, we have been carrying out hyperparameter search by exhaustively trying all possible combinations of the hyperparameters of interest.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mglearn</span><span class="o">.</span><span class="n">plots</span><span class="o">.</span><span class="n">plot_grid_search_overview</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/08_hyperparameter-optimization_12_0.png" src="../_images/08_hyperparameter-optimization_12_0.png" />
</div>
</div>
<p>Let’s look at an example of training SVM RBF classifier on the Spotify dataset.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">spotify_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;data/spotify.csv&quot;</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">X_spotify</span> <span class="o">=</span> <span class="n">spotify_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">,</span> <span class="s2">&quot;song_title&quot;</span><span class="p">,</span> <span class="s2">&quot;artist&quot;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The number of features in the Spotify dataset: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">X_spotify</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">X_spotify</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The number of features in the Spotify dataset: 13
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>acousticness</th>
      <th>danceability</th>
      <th>duration_ms</th>
      <th>energy</th>
      <th>instrumentalness</th>
      <th>key</th>
      <th>liveness</th>
      <th>loudness</th>
      <th>mode</th>
      <th>speechiness</th>
      <th>tempo</th>
      <th>time_signature</th>
      <th>valence</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.0102</td>
      <td>0.833</td>
      <td>204600</td>
      <td>0.434</td>
      <td>0.021900</td>
      <td>2</td>
      <td>0.1650</td>
      <td>-8.795</td>
      <td>1</td>
      <td>0.4310</td>
      <td>150.062</td>
      <td>4.0</td>
      <td>0.286</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.1990</td>
      <td>0.743</td>
      <td>326933</td>
      <td>0.359</td>
      <td>0.006110</td>
      <td>1</td>
      <td>0.1370</td>
      <td>-10.401</td>
      <td>1</td>
      <td>0.0794</td>
      <td>160.083</td>
      <td>4.0</td>
      <td>0.588</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0.0344</td>
      <td>0.838</td>
      <td>185707</td>
      <td>0.412</td>
      <td>0.000234</td>
      <td>2</td>
      <td>0.1590</td>
      <td>-7.148</td>
      <td>1</td>
      <td>0.2890</td>
      <td>75.044</td>
      <td>4.0</td>
      <td>0.173</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0.6040</td>
      <td>0.494</td>
      <td>199413</td>
      <td>0.338</td>
      <td>0.510000</td>
      <td>5</td>
      <td>0.0922</td>
      <td>-15.236</td>
      <td>1</td>
      <td>0.0261</td>
      <td>86.468</td>
      <td>4.0</td>
      <td>0.230</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.1800</td>
      <td>0.678</td>
      <td>392893</td>
      <td>0.561</td>
      <td>0.512000</td>
      <td>5</td>
      <td>0.4390</td>
      <td>-11.648</td>
      <td>0</td>
      <td>0.0694</td>
      <td>174.004</td>
      <td>4.0</td>
      <td>0.904</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y_spotify</span> <span class="o">=</span> <span class="n">spotify_df</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">X_spotify</span><span class="p">,</span> <span class="n">y_spotify</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">123</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pipe_svm</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span><span class="n">StandardScaler</span><span class="p">(),</span> <span class="n">SVC</span><span class="p">())</span>
<span class="n">pipe_svm</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Pipeline(steps=[(&#39;standardscaler&#39;, StandardScaler()), (&#39;svc&#39;, SVC())])
</pre></div>
</div>
</div>
</div>
<p>Let’s try cross-validation with default hyperparameters of SVC.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">scores</span> <span class="o">=</span> <span class="n">cross_validate</span><span class="p">(</span><span class="n">pipe_svm</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">return_train_score</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>fit_time       0.049648
score_time     0.024396
test_score     0.738998
train_score    0.814011
dtype: float64
</pre></div>
</div>
</div>
</div>
<p>Now let’s try exhaustive hyperparameter search using for loops.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">best_score</span> <span class="o">=</span> <span class="mi">0</span>

<span class="n">param_grid</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;C&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">],</span>
    <span class="s2">&quot;gamma&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">],</span>
<span class="p">}</span>

<span class="n">results_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;C&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;gamma&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;mean_cv_score&quot;</span><span class="p">:</span> <span class="p">[]}</span>

<span class="k">for</span> <span class="n">gamma</span> <span class="ow">in</span> <span class="n">param_grid</span><span class="p">[</span><span class="s2">&quot;gamma&quot;</span><span class="p">]:</span>
    <span class="k">for</span> <span class="n">C</span> <span class="ow">in</span> <span class="n">param_grid</span><span class="p">[</span><span class="s2">&quot;C&quot;</span><span class="p">]:</span>  <span class="c1"># for each combination of parameters, train an SVC</span>
        <span class="n">pipe_svm</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span><span class="n">StandardScaler</span><span class="p">(),</span> <span class="n">SVC</span><span class="p">(</span><span class="n">gamma</span><span class="o">=</span><span class="n">gamma</span><span class="p">,</span> <span class="n">C</span><span class="o">=</span><span class="n">C</span><span class="p">))</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="n">cross_val_score</span><span class="p">(</span><span class="n">pipe_svm</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>  <span class="c1"># perform cross-validation</span>
        <span class="n">mean_score</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>  <span class="c1"># compute mean cross-validation accuracy</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">mean_score</span> <span class="o">&gt;</span> <span class="n">best_score</span>
        <span class="p">):</span>  <span class="c1"># if we got a better score, store the score and parameters</span>
            <span class="n">best_score</span> <span class="o">=</span> <span class="n">mean_score</span>
            <span class="n">best_parameters</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;C&quot;</span><span class="p">:</span> <span class="n">C</span><span class="p">,</span> <span class="s2">&quot;gamma&quot;</span><span class="p">:</span> <span class="n">gamma</span><span class="p">}</span>
        <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;C&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">C</span><span class="p">)</span>
        <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;gamma&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gamma</span><span class="p">)</span>
        <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;mean_cv_score&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mean_score</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">best_parameters</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;C&#39;: 1, &#39;gamma&#39;: 0.1}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">best_score</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.7439609253312309
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">search_dict</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">80</span><span class="o">/</span><span class="n">kr9rkqfj4w78h49djkz8yy9r0000gp</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_49775</span><span class="o">/</span><span class="mf">1252741426.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">search_dict</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;search_dict&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;mean_cv_score&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>C</th>
      <th>gamma</th>
      <th>mean_cv_score</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>15</th>
      <td>1.000</td>
      <td>0.100</td>
      <td>0.743961</td>
    </tr>
    <tr>
      <th>11</th>
      <td>100.000</td>
      <td>0.010</td>
      <td>0.732792</td>
    </tr>
    <tr>
      <th>16</th>
      <td>10.000</td>
      <td>0.100</td>
      <td>0.729091</td>
    </tr>
    <tr>
      <th>10</th>
      <td>10.000</td>
      <td>0.010</td>
      <td>0.720391</td>
    </tr>
    <tr>
      <th>17</th>
      <td>100.000</td>
      <td>0.100</td>
      <td>0.711715</td>
    </tr>
    <tr>
      <th>5</th>
      <td>100.000</td>
      <td>0.001</td>
      <td>0.704284</td>
    </tr>
    <tr>
      <th>14</th>
      <td>0.100</td>
      <td>0.100</td>
      <td>0.703034</td>
    </tr>
    <tr>
      <th>9</th>
      <td>1.000</td>
      <td>0.010</td>
      <td>0.697473</td>
    </tr>
    <tr>
      <th>8</th>
      <td>0.100</td>
      <td>0.010</td>
      <td>0.678851</td>
    </tr>
    <tr>
      <th>4</th>
      <td>10.000</td>
      <td>0.001</td>
      <td>0.678244</td>
    </tr>
    <tr>
      <th>23</th>
      <td>100.000</td>
      <td>1.000</td>
      <td>0.671425</td>
    </tr>
    <tr>
      <th>22</th>
      <td>10.000</td>
      <td>1.000</td>
      <td>0.671425</td>
    </tr>
    <tr>
      <th>21</th>
      <td>1.000</td>
      <td>1.000</td>
      <td>0.668335</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1.000</td>
      <td>0.001</td>
      <td>0.652824</td>
    </tr>
    <tr>
      <th>29</th>
      <td>100.000</td>
      <td>10.000</td>
      <td>0.515190</td>
    </tr>
    <tr>
      <th>28</th>
      <td>10.000</td>
      <td>10.000</td>
      <td>0.515190</td>
    </tr>
    <tr>
      <th>27</th>
      <td>1.000</td>
      <td>10.000</td>
      <td>0.511469</td>
    </tr>
    <tr>
      <th>33</th>
      <td>1.000</td>
      <td>100.000</td>
      <td>0.508371</td>
    </tr>
    <tr>
      <th>34</th>
      <td>10.000</td>
      <td>100.000</td>
      <td>0.508371</td>
    </tr>
    <tr>
      <th>35</th>
      <td>100.000</td>
      <td>100.000</td>
      <td>0.508371</td>
    </tr>
    <tr>
      <th>31</th>
      <td>0.010</td>
      <td>100.000</td>
      <td>0.507750</td>
    </tr>
    <tr>
      <th>30</th>
      <td>0.001</td>
      <td>100.000</td>
      <td>0.507750</td>
    </tr>
    <tr>
      <th>25</th>
      <td>0.010</td>
      <td>10.000</td>
      <td>0.507750</td>
    </tr>
    <tr>
      <th>32</th>
      <td>0.100</td>
      <td>100.000</td>
      <td>0.507750</td>
    </tr>
    <tr>
      <th>26</th>
      <td>0.100</td>
      <td>10.000</td>
      <td>0.507750</td>
    </tr>
    <tr>
      <th>0</th>
      <td>0.001</td>
      <td>0.001</td>
      <td>0.507750</td>
    </tr>
    <tr>
      <th>24</th>
      <td>0.001</td>
      <td>10.000</td>
      <td>0.507750</td>
    </tr>
    <tr>
      <th>20</th>
      <td>0.100</td>
      <td>1.000</td>
      <td>0.507750</td>
    </tr>
    <tr>
      <th>19</th>
      <td>0.010</td>
      <td>1.000</td>
      <td>0.507750</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.010</td>
      <td>0.001</td>
      <td>0.507750</td>
    </tr>
    <tr>
      <th>13</th>
      <td>0.010</td>
      <td>0.100</td>
      <td>0.507750</td>
    </tr>
    <tr>
      <th>12</th>
      <td>0.001</td>
      <td>0.100</td>
      <td>0.507750</td>
    </tr>
    <tr>
      <th>7</th>
      <td>0.010</td>
      <td>0.010</td>
      <td>0.507750</td>
    </tr>
    <tr>
      <th>6</th>
      <td>0.001</td>
      <td>0.010</td>
      <td>0.507750</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0.100</td>
      <td>0.001</td>
      <td>0.507750</td>
    </tr>
    <tr>
      <th>18</th>
      <td>0.001</td>
      <td>1.000</td>
      <td>0.507750</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">mean_cv_score</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>

<span class="n">mglearn</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span>
    <span class="n">scores</span><span class="p">,</span>
    <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;gamma&quot;</span><span class="p">,</span>
    <span class="n">xticklabels</span><span class="o">=</span><span class="n">param_grid</span><span class="p">[</span><span class="s2">&quot;gamma&quot;</span><span class="p">],</span>
    <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;C&quot;</span><span class="p">,</span>
    <span class="n">yticklabels</span><span class="o">=</span><span class="n">param_grid</span><span class="p">[</span><span class="s2">&quot;C&quot;</span><span class="p">],</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="c1"># plot the mean cross-validation scores</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/08_hyperparameter-optimization_26_0.png" src="../_images/08_hyperparameter-optimization_26_0.png" />
</div>
</div>
<ul class="simple">
<li><p>We have 6 possible values for <code class="docutils literal notranslate"><span class="pre">C</span></code> and 6 possible values for <code class="docutils literal notranslate"><span class="pre">gamma</span></code>.</p></li>
<li><p>In 5-fold cross-validation, for each combination of parameter values, five accuracies are computed.</p></li>
<li><p>So to evaluate the accuracy of the SVM using 6 values of C and 6 values of gamma using five-fold cross-validation, we need to train 36 * 5 = 180 models!</p></li>
</ul>
<p>Once we have optimized hyperparameters, we retrain a model on the full training set with these optimized hyperparameters.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pipe_svm</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span><span class="n">StandardScaler</span><span class="p">(),</span> <span class="n">SVC</span><span class="p">(</span><span class="o">**</span><span class="n">best_parameters</span><span class="p">))</span>
<span class="n">pipe_svm</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span>
<span class="p">)</span>  <span class="c1"># Retrain a model with optimized hyperparameters on the combined training and validation set</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Pipeline(steps=[(&#39;standardscaler&#39;, StandardScaler()),
                (&#39;svc&#39;, SVC(C=1, gamma=0.1))])
</pre></div>
</div>
</div>
</div>
<p>And finally evaluate the performance of this model on the test set.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pipe_svm</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>  <span class="c1"># Final evaluation on the test data</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.7376237623762376
</pre></div>
</div>
</div>
</div>
<p>This is a common process in supervised machine learning pipelines and there are some standard method in <code class="docutils literal notranslate"><span class="pre">scikit-learn</span></code> to help with this.</p>
</div>
<div class="section" id="hyperparameters-the-problem">
<h3>Hyperparameters: the problem<a class="headerlink" href="#hyperparameters-the-problem" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>In order to get the best generalization performance, finding the best values for the important hyperparameters of a model is necessary for almost all models and datasets.</p></li>
<li><p>Picking reasonable hyperparameters is important because if we don’t do it, we might end up with an underfit or overfit model.</p></li>
<li><p>The problem of finding the best values for the important hyperparameters is tricky because</p>
<ul>
<li><p>You may have a lot of them (e.g. deep learning).</p></li>
<li><p>You may have multiple hyperparameters which may interact with each other in unexpected ways.</p></li>
</ul>
</li>
<li><p>The best settings depend on the specific data/problem.</p></li>
</ul>
</div>
<div class="section" id="some-ways-to-pick-hyperparameters">
<h3>Some ways to pick hyperparameters:<a class="headerlink" href="#some-ways-to-pick-hyperparameters" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Manual or expert knowledge or heuristics based optimization</p></li>
<li><p>Data-driven or automated optimization (this lecture)</p></li>
</ul>
<div class="section" id="manual-hyperparameter-optimization">
<h4>Manual hyperparameter optimization<a class="headerlink" href="#manual-hyperparameter-optimization" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><p>Advantage: we may have some intuition about what might work.</p>
<ul>
<li><p>E.g. if I’m massively overfitting, try decreasing <code class="docutils literal notranslate"><span class="pre">max_depth</span></code> or <code class="docutils literal notranslate"><span class="pre">C</span></code>.</p></li>
</ul>
</li>
<li><p>Disadvantage: it takes a lot of work.</p></li>
<li><p>Disadvantage: in very complicated cases, our intuition might be worse than a data-driven approach.</p></li>
</ul>
</div>
<div class="section" id="automated-hyperparameter-optimization">
<h4>Automated hyperparameter optimization<a class="headerlink" href="#automated-hyperparameter-optimization" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><p>Advantages</p>
<ul>
<li><p>reduce human effort</p></li>
<li><p>less prone to error and improve reproducibility</p></li>
<li><p>data-driven approaches may be effective</p></li>
</ul>
</li>
<li><p>Disadvantages</p>
<ul>
<li><p>may be hard to incorporate intuition</p></li>
<li><p>be careful about overfitting on the validation set.</p></li>
</ul>
</li>
</ul>
<p><br><br><br><br></p>
</div>
</div>
</div>
<div class="section" id="hyperparameter-optimization-with-scikit-learn">
<h2>Hyperparameter optimization with <code class="docutils literal notranslate"><span class="pre">scikit-learn</span></code><a class="headerlink" href="#hyperparameter-optimization-with-scikit-learn" title="Permalink to this headline">¶</a></h2>
<p>There are two automated hyperparameter search methods in <code class="docutils literal notranslate"><span class="pre">scikit-learn</span></code>:</p>
<ul class="simple">
<li><p>Exhaustive grid search: <a class="reference external" href="http://scikit-learn.org/stable/modules/generated/sklearn.model_selection.GridSearchCV.html"><code class="docutils literal notranslate"><span class="pre">sklearn.model_selection.GridSearchCV</span></code></a></p></li>
<li><p>Randomized hyperparameter optimization: <a class="reference external" href="https://scikit-learn.org/stable/modules/generated/sklearn.model_selection.RandomizedSearchCV.html"><code class="docutils literal notranslate"><span class="pre">sklearn.model_selection.RandomizedSearchCV</span></code></a></p></li>
</ul>
<p>The “CV” stands for cross-validation; these methods have cross-validation built right in.</p>
<div class="section" id="dataset">
<h3>Dataset<a class="headerlink" href="#dataset" title="Permalink to this headline">¶</a></h3>
<p>We’ll use the <a class="reference external" href="https://www.kaggle.com/lakshmi25npathi/imdb-dataset-of-50k-movie-reviews">IMDB movie review</a> dataset</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">imdb_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;data/imdb_master.csv&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;ISO-8859-1&quot;</span><span class="p">)</span>
<span class="n">imdb_df</span> <span class="o">=</span> <span class="n">imdb_df</span><span class="p">[</span><span class="n">imdb_df</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">startswith</span><span class="p">((</span><span class="s2">&quot;pos&quot;</span><span class="p">,</span> <span class="s2">&quot;neg&quot;</span><span class="p">))]</span>
<span class="n">imdb_df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s2">&quot;Unnamed: 0&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;file&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">imdb_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>review</th>
      <th>label</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Once again Mr. Costner has dragged out a movie for far longer than necessary. Aside from the terrific sea rescue sequences, of which there are very few I just did not care about any of the charact...</td>
      <td>neg</td>
    </tr>
    <tr>
      <th>1</th>
      <td>This is an example of why the majority of action films are the same. Generic and boring, there's really nothing worth watching here. A complete waste of the then barely-tapped talents of Ice-T and...</td>
      <td>neg</td>
    </tr>
    <tr>
      <th>2</th>
      <td>First of all I hate those moronic rappers, who could'nt act if they had a gun pressed against their foreheads. All they do is curse and shoot each other and acting like clichÃ©'e version of gangst...</td>
      <td>neg</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Not even the Beatles could write songs everyone liked, and although Walter Hill is no mop-top he's second to none when it comes to thought provoking action movies. The nineties came and social pla...</td>
      <td>neg</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Brass pictures (movies is not a fitting word for them) really are somewhat brassy. Their alluring visual qualities are reminiscent of expensive high class TV commercials. But unfortunately Brass p...</td>
      <td>neg</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">re</span>


<span class="k">def</span> <span class="nf">replace_tags</span><span class="p">(</span><span class="n">doc</span><span class="p">):</span>
    <span class="n">doc</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;br /&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>
    <span class="n">doc</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;https://\S*&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">doc</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">doc</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">imdb_df</span><span class="p">[</span><span class="s2">&quot;review_pp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">imdb_df</span><span class="p">[</span><span class="s2">&quot;review&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">replace_tags</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df</span><span class="p">,</span> <span class="n">test_df</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">imdb_df</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">123</span><span class="p">)</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span> <span class="o">=</span> <span class="n">train_df</span><span class="p">[</span><span class="s2">&quot;review_pp&quot;</span><span class="p">],</span> <span class="n">train_df</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span>
<span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">test_df</span><span class="p">[</span><span class="s2">&quot;review_pp&quot;</span><span class="p">],</span> <span class="n">test_df</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span>
<span class="n">train_df</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(5000, 3)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">vec</span> <span class="o">=</span> <span class="n">CountVectorizer</span><span class="p">(</span><span class="n">stop_words</span><span class="o">=</span><span class="s2">&quot;english&quot;</span><span class="p">,</span> <span class="n">max_features</span><span class="o">=</span><span class="mi">5000</span><span class="p">)</span>
<span class="n">X_train_imdb</span> <span class="o">=</span> <span class="n">vec</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
<span class="n">X_test_imdb</span> <span class="o">=</span> <span class="n">vec</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">GridSearchCV</span><span class="p">,</span> <span class="n">RandomizedSearchCV</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="exhaustive-grid-search">
<h4>Exhaustive grid search<a class="headerlink" href="#exhaustive-grid-search" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><p>A user specifies a set of values for each hyperparameter.</p></li>
<li><p>The method considers “product” of the sets and then evaluates each combination one by one.</p></li>
</ul>
<p>Let’s start the automated hyperparameter optimization.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">param_grid</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;C&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">]}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegression</span>

<span class="n">lr</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
<span class="n">grid_search</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span><span class="n">lr</span><span class="p">,</span> <span class="n">param_grid</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Note that we can fix some hyperparameters and make others variable.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">verbose=1</span></code> tells <code class="docutils literal notranslate"><span class="pre">GridSearchCV</span></code> to print some output while it’s working.</p>
<ul>
<li><p>This can be useful as this step sometimes takes a long time.</p></li>
</ul>
</li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">grid_search</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_imdb</span><span class="p">,</span> <span class="n">y_train</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Fitting 5 folds for each of 4 candidates, totalling 20 fits
</pre></div>
</div>
</div>
</div>
<p>Going back to Lecture 3, this is what it’s doing:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">C</span> <span class="ow">in</span> <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">]:</span>
    <span class="k">for</span> <span class="n">fold</span> <span class="ow">in</span> <span class="n">folds</span><span class="p">:</span>
        <span class="n">fit</span> <span class="ow">in</span> <span class="n">training</span> <span class="n">portion</span> <span class="k">with</span> <span class="n">the</span> <span class="n">given</span> <span class="n">C</span>
        <span class="n">score</span> <span class="n">on</span> <span class="n">validation</span> <span class="n">portion</span>
    <span class="n">compute</span> <span class="n">average</span> <span class="n">score</span>
<span class="n">pick</span> <span class="n">hypers</span> <span class="k">with</span> <span class="n">best</span> <span class="n">score</span>
</pre></div>
</div>
<p>From here, we can extract the best hyperparameter values:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;C&#39;: 0.01}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_score_</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.8474666666666668
</pre></div>
</div>
</div>
</div>
<p>We can extract the classifier inside like this:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_estimator_</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>LogisticRegression(C=0.01, max_iter=1000)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_estimator_</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test_imdb</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([&#39;pos&#39;, &#39;pos&#39;, &#39;pos&#39;, ..., &#39;pos&#39;, &#39;pos&#39;, &#39;pos&#39;], dtype=object)
</pre></div>
</div>
</div>
</div>
<p>They also provide some “syntactic sugar” and allow you to call <code class="docutils literal notranslate"><span class="pre">predict</span></code> or <code class="docutils literal notranslate"><span class="pre">score</span></code> directly on the <code class="docutils literal notranslate"><span class="pre">GridSearchCV</span></code> object:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">grid_search</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test_imdb</span><span class="p">)</span>  <span class="c1">## Does the same thing</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([&#39;pos&#39;, &#39;pos&#39;, &#39;pos&#39;, ..., &#39;pos&#39;, &#39;pos&#39;, &#39;pos&#39;], dtype=object)
</pre></div>
</div>
</div>
</div>
<p>By the way, by default it takes the best hyperparameters and refits on the entire training set - very nice!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ?GridSearchCV</span>
</pre></div>
</div>
</div>
</div>
<p>Note the <code class="docutils literal notranslate"><span class="pre">refit=True</span></code> to control this.</p>
<ul class="simple">
<li><p>Ok, so this is all the syntax, but now we know we’ve been violating the Golden Rule because of the cross-validation.</p></li>
<li><p>Furthermore, we may want to tune the hyperparameters of the <code class="docutils literal notranslate"><span class="pre">CountVectorizer</span></code> and the <code class="docutils literal notranslate"><span class="pre">LogisticRegression</span></code> together.</p></li>
<li><p>Pipelines are perfect for this!!</p></li>
<li><p>So let’s do it again properly this time.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">countvec</span> <span class="o">=</span> <span class="n">CountVectorizer</span><span class="p">(</span>
    <span class="n">binary</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>  <span class="c1"># we should not set min_df here, it will be optimized</span>
<span class="n">lr</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>  <span class="c1"># we should not set C here, it will be optimized</span>

<span class="n">pipe</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([(</span><span class="s2">&quot;countvec&quot;</span><span class="p">,</span> <span class="n">countvec</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;lr&quot;</span><span class="p">,</span> <span class="n">lr</span><span class="p">)])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">param_grid</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;countvec__min_df&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">],</span> <span class="s2">&quot;lr__C&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">]}</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Above: we have a nesting of transformers.</p></li>
<li><p>We can access the parameters of the “inner” objects by using <code class="docutils literal notranslate"><span class="pre">__</span></code> to go “deeper”:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">countvec__min_df</span></code>: “the <code class="docutils literal notranslate"><span class="pre">min_df</span></code> of the <code class="docutils literal notranslate"><span class="pre">CountVectorizer</span></code> (of the pipeline)”</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">lr__C</span></code>: “the <code class="docutils literal notranslate"><span class="pre">C</span></code> of the <code class="docutils literal notranslate"><span class="pre">LogisticRegression</span></code> (of the pipeline)”</p></li>
</ul>
</li>
<li><p>Later in the course we’ll see even deeper nesting, like <code class="docutils literal notranslate"><span class="pre">preprocessor__numeric__imputer__strategy</span></code>.</p></li>
</ul>
<p>So, now we pass int he <code class="docutils literal notranslate"><span class="pre">Pipeline</span></code> to <code class="docutils literal notranslate"><span class="pre">GridSearchCV</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">grid_search</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="n">param_grid</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>And we pass in the raw text because we’re using a <code class="docutils literal notranslate"><span class="pre">Pipeline</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">grid_search</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_imdb_raw</span><span class="p">,</span> <span class="n">y_train_imdb</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Fitting 5 folds for each of 12 candidates, totalling 60 fits
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[Parallel(n_jobs=-1)]: Using backend LokyBackend with 8 concurrent workers.
[Parallel(n_jobs=-1)]: Done  25 tasks      | elapsed:   23.7s
[Parallel(n_jobs=-1)]: Done  60 out of  60 | elapsed:   44.0s finished
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Note the <code class="docutils literal notranslate"><span class="pre">n_jobs=-1</span></code> above.</p></li>
<li><p>Hyperparameter optimization can be done <em>in parallel</em> for each of the configurations.</p></li>
<li><p>This is very useful when scaling up to large numbers of machines in the cloud.</p></li>
<li><p>But even on my laptop there are 8 cores it can use, so that makes it a lot faster.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;countvec__min_df&#39;: 0, &#39;lr__C&#39;: 1}
</pre></div>
</div>
</div>
</div>
<p>Heh, here we get back the defaults again. This happens surprisingly often - the defaults are well chosen!</p>
<ul class="simple">
<li><p>Note the number of candidates comes from the <strong>product</strong> of the number of options for each hyperparameter.</p></li>
<li><p>And then the whole thing multiplied by the number of folds (default is 5).</p></li>
<li><p>So, this number can get big really fast.</p></li>
</ul>
<p>But note that we’re searching more possibilities than if we just sweep one hyperparameter at a time:</p>
<p><img alt="" src="../_images/gridsearch.png" /></p>
<p>In that case we’d only get the ones in red, but here we get the entire grid.</p>
<p>(Img source: see credit below)</p>
</div>
<div class="section" id="problems-with-exhaustive-grid-search">
<h4>Problems with exhaustive grid search<a class="headerlink" href="#problems-with-exhaustive-grid-search" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><p>Required number of models to evaluate grows exponentially with the dimensionally of the configuration space.</p></li>
<li><p>Exhaustive search may become infeasible fairly quickly.</p></li>
</ul>
</div>
</div>
</div>
<div class="section" id="data">
<h2>Data<a class="headerlink" href="#data" title="Permalink to this headline">¶</a></h2>
<p>We’ll be using <a class="reference external" href="https://www.kaggle.com/uciml/adult-census-income">the adult census dataset</a> you used in lab 2.</p>
<p>This is a classification dataset and the classification task is to predict whether income exceeds 50K per year or not based on the census data. You can find more information on the dataset and features <a class="reference external" href="http://archive.ics.uci.edu/ml/datasets/Adult">here</a>.</p>
<p>The code below loads the data CSV (assuming that it is saved as <code class="docutils literal notranslate"><span class="pre">data/adult.csv</span></code> in this folder).</p>
<p><em>Note that many popular datasets have sex as a feature where the possible values are male and female. This representation reflects how the data were collected and is not meant to imply that, for example, gender is binary.</em></p>
<div class="section" id="reading-the-data-csv-and-splitting-it">
<h3>Reading the data CSV and splitting it<a class="headerlink" href="#reading-the-data-csv-and-splitting-it" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adult_df_large</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;data/adult.csv&quot;</span><span class="p">)</span>
<span class="n">adult_df_sample</span> <span class="o">=</span> <span class="n">adult_df_large</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">frac</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df</span><span class="p">,</span> <span class="n">test_df</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">adult_df_sample</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df_nan</span> <span class="o">=</span> <span class="n">train_df</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;?&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span><span class="p">)</span>
<span class="n">test_df_nan</span> <span class="o">=</span> <span class="n">test_df</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;?&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df_nan</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>age</th>
      <th>workclass</th>
      <th>fnlwgt</th>
      <th>education</th>
      <th>education.num</th>
      <th>marital.status</th>
      <th>occupation</th>
      <th>relationship</th>
      <th>race</th>
      <th>sex</th>
      <th>capital.gain</th>
      <th>capital.loss</th>
      <th>hours.per.week</th>
      <th>native.country</th>
      <th>income</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>19258</th>
      <td>23</td>
      <td>Private</td>
      <td>237044</td>
      <td>HS-grad</td>
      <td>9</td>
      <td>Never-married</td>
      <td>Other-service</td>
      <td>Own-child</td>
      <td>Black</td>
      <td>Male</td>
      <td>0</td>
      <td>0</td>
      <td>12</td>
      <td>United-States</td>
      <td>&lt;=50K</td>
    </tr>
    <tr>
      <th>9782</th>
      <td>35</td>
      <td>Private</td>
      <td>38948</td>
      <td>Some-college</td>
      <td>10</td>
      <td>Married-civ-spouse</td>
      <td>Prof-specialty</td>
      <td>Husband</td>
      <td>White</td>
      <td>Male</td>
      <td>0</td>
      <td>0</td>
      <td>40</td>
      <td>United-States</td>
      <td>&gt;50K</td>
    </tr>
    <tr>
      <th>1842</th>
      <td>46</td>
      <td>Private</td>
      <td>155659</td>
      <td>Some-college</td>
      <td>10</td>
      <td>Married-civ-spouse</td>
      <td>Craft-repair</td>
      <td>Husband</td>
      <td>White</td>
      <td>Male</td>
      <td>15024</td>
      <td>0</td>
      <td>45</td>
      <td>United-States</td>
      <td>&gt;50K</td>
    </tr>
    <tr>
      <th>29224</th>
      <td>42</td>
      <td>Private</td>
      <td>126003</td>
      <td>HS-grad</td>
      <td>9</td>
      <td>Married-civ-spouse</td>
      <td>Tech-support</td>
      <td>Husband</td>
      <td>White</td>
      <td>Male</td>
      <td>0</td>
      <td>0</td>
      <td>40</td>
      <td>United-States</td>
      <td>&gt;50K</td>
    </tr>
    <tr>
      <th>16985</th>
      <td>38</td>
      <td>Self-emp-not-inc</td>
      <td>114835</td>
      <td>Bachelors</td>
      <td>13</td>
      <td>Married-civ-spouse</td>
      <td>Sales</td>
      <td>Wife</td>
      <td>White</td>
      <td>Female</td>
      <td>0</td>
      <td>0</td>
      <td>60</td>
      <td>United-States</td>
      <td>&gt;50K</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df_nan</span><span class="p">[</span><span class="s2">&quot;income&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;=50K    5914
&gt;50K     1900
Name: income, dtype: int64
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="identify-feature-types">
<h3>Identify feature types<a class="headerlink" href="#identify-feature-types" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">numeric_features</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;age&quot;</span><span class="p">,</span> <span class="s2">&quot;fnlwgt&quot;</span><span class="p">,</span> <span class="s2">&quot;capital.gain&quot;</span><span class="p">,</span> <span class="s2">&quot;capital.loss&quot;</span><span class="p">,</span> <span class="s2">&quot;hours.per.week&quot;</span><span class="p">]</span>
<span class="c1"># I am removing eduction.num column</span>
<span class="n">categorical_features</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;workclass&quot;</span><span class="p">,</span>
    <span class="s2">&quot;marital.status&quot;</span><span class="p">,</span>
    <span class="s2">&quot;occupation&quot;</span><span class="p">,</span>
    <span class="s2">&quot;relationship&quot;</span><span class="p">,</span>
    <span class="s2">&quot;sex&quot;</span><span class="p">,</span>
    <span class="s2">&quot;native.country&quot;</span><span class="p">,</span>
<span class="p">]</span>
<span class="c1"># I am removing &#39;race&#39; column</span>
<span class="n">ordinal_features</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;education&quot;</span><span class="p">]</span>
<span class="n">target</span> <span class="o">=</span> <span class="s2">&quot;income&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">education_levels</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;Preschool&quot;</span><span class="p">,</span>
    <span class="s2">&quot;1st-4th&quot;</span><span class="p">,</span>
    <span class="s2">&quot;5th-6th&quot;</span><span class="p">,</span>
    <span class="s2">&quot;7th-8th&quot;</span><span class="p">,</span>
    <span class="s2">&quot;9th&quot;</span><span class="p">,</span>
    <span class="s2">&quot;10th&quot;</span><span class="p">,</span>
    <span class="s2">&quot;11th&quot;</span><span class="p">,</span>
    <span class="s2">&quot;12th&quot;</span><span class="p">,</span>
    <span class="s2">&quot;HS-grad&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Prof-school&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Assoc-voc&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Assoc-acdm&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Some-college&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Bachelors&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Masters&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Doctorate&quot;</span><span class="p">,</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="n">education_levels</span><span class="p">)</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span><span class="n">train_df</span><span class="p">[</span><span class="s2">&quot;education&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_train</span> <span class="o">=</span> <span class="n">train_df_nan</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">target</span><span class="p">])</span>
<span class="n">y_train</span> <span class="o">=</span> <span class="n">train_df_nan</span><span class="p">[</span><span class="n">target</span><span class="p">]</span>

<span class="n">X_test</span> <span class="o">=</span> <span class="n">test_df_nan</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">target</span><span class="p">])</span>
<span class="n">y_test</span> <span class="o">=</span> <span class="n">test_df_nan</span><span class="p">[</span><span class="n">target</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="define-columntransformer-and-a-pipeline">
<h3>Define <code class="docutils literal notranslate"><span class="pre">ColumnTransformer</span></code> and a pipeline<a class="headerlink" href="#define-columntransformer-and-a-pipeline" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">numeric_transformer</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span><span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s2">&quot;median&quot;</span><span class="p">),</span> <span class="n">StandardScaler</span><span class="p">())</span>

<span class="n">categorical_transformer</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span>
    <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s2">&quot;constant&quot;</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="s2">&quot;missing&quot;</span><span class="p">),</span>
    <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">handle_unknown</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">),</span>
<span class="p">)</span>

<span class="n">ordinal_transformer</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span>
    <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s2">&quot;constant&quot;</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="s2">&quot;missing&quot;</span><span class="p">),</span>
    <span class="n">OrdinalEncoder</span><span class="p">(</span>
        <span class="n">categories</span><span class="o">=</span><span class="p">[</span><span class="n">education_levels</span><span class="p">],</span>
        <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
    <span class="p">),</span>
<span class="p">)</span>

<span class="n">preprocessor</span> <span class="o">=</span> <span class="n">ColumnTransformer</span><span class="p">(</span>
    <span class="n">transformers</span><span class="o">=</span><span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;num&quot;</span><span class="p">,</span> <span class="n">numeric_transformer</span><span class="p">,</span> <span class="n">numeric_features</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;cat&quot;</span><span class="p">,</span> <span class="n">categorical_transformer</span><span class="p">,</span> <span class="n">categorical_features</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;ordinal&quot;</span><span class="p">,</span> <span class="n">ordinal_transformer</span><span class="p">,</span> <span class="n">ordinal_features</span><span class="p">),</span>
    <span class="p">]</span>
<span class="p">)</span>
<span class="n">pipe</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span><span class="n">preprocessor</span><span class="p">,</span> <span class="n">SVC</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">scores</span> <span class="o">=</span> <span class="n">cross_validate</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">return_train_score</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>fit_time       0.619898
score_time     0.113588
test_score     0.846430
train_score    0.848861
dtype: float64
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>We are using the default hyperparameters for SVC.</p></li>
<li><p>We have cherry picked hyperparameters for some of our transformers.</p></li>
<li><p>Probably we could do better with different hyperparameters.</p></li>
</ul>
</div>
<div class="section" id="let-s-carry-out-hyperparameter-optimization-with-c-and-gamma">
<h3>Let’s carry out hyperparameter optimization with <code class="docutils literal notranslate"><span class="pre">C</span></code> and <code class="docutils literal notranslate"><span class="pre">gamma</span></code><a class="headerlink" href="#let-s-carry-out-hyperparameter-optimization-with-c-and-gamma" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">### Writing a loop for hyperparameter optimization for gamma and C for SVC</span>
<span class="n">param_grid</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;gamma&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">],</span> <span class="s2">&quot;C&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">]}</span>

<span class="n">param_scores</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;gamma&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;C&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;train_accuracy&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;valid_accuracy&quot;</span><span class="p">:</span> <span class="p">[]}</span>
<span class="k">for</span> <span class="n">gamma_val</span> <span class="ow">in</span> <span class="n">param_grid</span><span class="p">[</span><span class="s2">&quot;gamma&quot;</span><span class="p">]:</span>
    <span class="k">for</span> <span class="n">c_val</span> <span class="ow">in</span> <span class="n">param_grid</span><span class="p">[</span><span class="s2">&quot;C&quot;</span><span class="p">]:</span>
        <span class="n">pipe</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span><span class="n">preprocessor</span><span class="p">,</span> <span class="n">SVC</span><span class="p">(</span><span class="n">gamma</span><span class="o">=</span><span class="n">gamma_val</span><span class="p">,</span> <span class="n">C</span><span class="o">=</span><span class="n">c_val</span><span class="p">))</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="n">cross_validate</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">return_train_score</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">param_scores</span><span class="p">[</span><span class="s2">&quot;gamma&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gamma_val</span><span class="p">)</span>
        <span class="n">param_scores</span><span class="p">[</span><span class="s2">&quot;C&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c_val</span><span class="p">)</span>
        <span class="n">param_scores</span><span class="p">[</span><span class="s2">&quot;train_accuracy&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">scores</span><span class="p">[</span><span class="s2">&quot;train_score&quot;</span><span class="p">]))</span>
        <span class="n">param_scores</span><span class="p">[</span><span class="s2">&quot;valid_accuracy&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">scores</span><span class="p">[</span><span class="s2">&quot;test_score&quot;</span><span class="p">]))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">param_scores</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;valid_accuracy&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>gamma</th>
      <th>C</th>
      <th>train_accuracy</th>
      <th>valid_accuracy</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>0.1</td>
      <td>1.0</td>
      <td>0.872728</td>
      <td>0.852444</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0.1</td>
      <td>10.0</td>
      <td>0.916048</td>
      <td>0.845406</td>
    </tr>
    <tr>
      <th>0</th>
      <td>0.1</td>
      <td>0.1</td>
      <td>0.839615</td>
      <td>0.832480</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0.1</td>
      <td>100.0</td>
      <td>0.949898</td>
      <td>0.810981</td>
    </tr>
    <tr>
      <th>5</th>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.957384</td>
      <td>0.791401</td>
    </tr>
    <tr>
      <th>6</th>
      <td>1.0</td>
      <td>10.0</td>
      <td>0.984419</td>
      <td>0.783593</td>
    </tr>
    <tr>
      <th>7</th>
      <td>1.0</td>
      <td>100.0</td>
      <td>0.994081</td>
      <td>0.778601</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1.0</td>
      <td>0.1</td>
      <td>0.765357</td>
      <td>0.763117</td>
    </tr>
    <tr>
      <th>9</th>
      <td>10.0</td>
      <td>1.0</td>
      <td>0.989890</td>
      <td>0.758766</td>
    </tr>
    <tr>
      <th>10</th>
      <td>10.0</td>
      <td>10.0</td>
      <td>0.998432</td>
      <td>0.757999</td>
    </tr>
    <tr>
      <th>11</th>
      <td>10.0</td>
      <td>100.0</td>
      <td>0.999616</td>
      <td>0.757743</td>
    </tr>
    <tr>
      <th>8</th>
      <td>10.0</td>
      <td>0.1</td>
      <td>0.756847</td>
      <td>0.756847</td>
    </tr>
    <tr>
      <th>12</th>
      <td>100.0</td>
      <td>0.1</td>
      <td>0.756847</td>
      <td>0.756847</td>
    </tr>
    <tr>
      <th>13</th>
      <td>100.0</td>
      <td>1.0</td>
      <td>0.998240</td>
      <td>0.756719</td>
    </tr>
    <tr>
      <th>14</th>
      <td>100.0</td>
      <td>10.0</td>
      <td>0.999680</td>
      <td>0.756591</td>
    </tr>
    <tr>
      <th>15</th>
      <td>100.0</td>
      <td>100.0</td>
      <td>1.000000</td>
      <td>0.756591</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="questions-and-comments">
<h3>Questions and comments<a class="headerlink" href="#questions-and-comments" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>How many 5-fold cross-validation experiments are carried out here?</p></li>
<li><p>How would it work with more hyperparameters?</p></li>
<li><p>Remember that we also have hyperparameters of our transformers. For example, you might want to try “mean” or “median” strategies for your scaler and pick the one that works best.</p></li>
<li><p>If you want to try multiple classifiers each with a different set of hyperparameters</p></li>
<li><p>Writing for loops for this and keeping track of all scores becomes unwieldy quite quickly!</p></li>
</ul>
</div>
<div class="section" id="automated-hyperparameter-tuning-the-solution">
<h3>Automated hyperparameter tuning: the solution?<a class="headerlink" href="#automated-hyperparameter-tuning-the-solution" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Advantage: reduce human effort</p></li>
<li><p>Advantage: less prone to error and improve reproducibility</p></li>
<li><p>Advantage: data-driven approaches may be effective</p></li>
<li><p>Disadvantage: may be hard to incorporate intuition</p></li>
<li><p>Disadvantage: be careful about overfitting on the validation set (We’ll talk about it in the second part.)</p></li>
</ul>
</div>
<div class="section" id="scikit-learn-built-in-methods-for-hyperparameter-optimization">
<h3><code class="docutils literal notranslate"><span class="pre">scikit-learn</span></code> built-in methods for hyperparameter optimization<a class="headerlink" href="#scikit-learn-built-in-methods-for-hyperparameter-optimization" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">scikit-learn</span></code> has the following <a class="reference external" href="https://scikit-learn.org/stable/modules/grid_search.html">built-in methods</a> which automate hyperparameter optimization for you.</p>
<ol class="simple">
<li><p>Exhaustive grid search</p>
<ul class="simple">
<li><p><a class="reference external" href="http://scikit-learn.org/stable/modules/generated/sklearn.model_selection.GridSearchCV.html"><code class="docutils literal notranslate"><span class="pre">sklearn.model_selection.GridSearchCV</span></code></a></p></li>
</ul>
</li>
<li><p>Randomized hyperparameter optimization</p>
<ul class="simple">
<li><p><a class="reference external" href="https://scikit-learn.org/stable/modules/generated/sklearn.model_selection.RandomizedSearchCV.html"><code class="docutils literal notranslate"><span class="pre">sklearn.model_selection.RandomizedSearchCV</span></code></a></p></li>
</ul>
</li>
</ol>
</div>
<div class="section" id="id1">
<h3>Exhaustive grid search<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p><a class="reference external" href="http://scikit-learn.org/stable/modules/generated/sklearn.model_selection.GridSearchCV.html"><code class="docutils literal notranslate"><span class="pre">sklearn.model_selection.GridSearchCV</span></code></a></p></li>
<li><p>How does it work?</p>
<ul>
<li><p>A user specifies a set of values for each hyperparameter.</p></li>
<li><p>The method considers product of the sets and then evaluates each combination one by one.</p></li>
</ul>
</li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">GridSearchCV</span>

<span class="n">param_grid</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;svc__gamma&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">],</span>
    <span class="s2">&quot;svc__C&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">],</span>
<span class="p">}</span>

<span class="n">grid_search</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="n">param_grid</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">return_train_score</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">grid_search</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>CPU times: user 1.59 s, sys: 229 ms, total: 1.82 s
Wall time: 31.9 s
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>GridSearchCV(cv=5,
             estimator=Pipeline(steps=[(&#39;columntransformer&#39;,
                                        ColumnTransformer(transformers=[(&#39;num&#39;,
                                                                         Pipeline(steps=[(&#39;simpleimputer&#39;,
                                                                                          SimpleImputer(strategy=&#39;median&#39;)),
                                                                                         (&#39;standardscaler&#39;,
                                                                                          StandardScaler())]),
                                                                         [&#39;age&#39;,
                                                                          &#39;fnlwgt&#39;,
                                                                          &#39;capital.gain&#39;,
                                                                          &#39;capital.loss&#39;,
                                                                          &#39;hours.per.week&#39;]),
                                                                        (&#39;cat&#39;,
                                                                         Pipeline(steps=[(&#39;simpleimputer&#39;,
                                                                                          SimpleImputer(fill_value=&#39;missing&#39;,
                                                                                                        s...
                                                                                          OrdinalEncoder(categories=[[&#39;Preschool&#39;,
                                                                                                                      &#39;1st-4th&#39;,
                                                                                                                      &#39;5th-6th&#39;,
                                                                                                                      &#39;7th-8th&#39;,
                                                                                                                      &#39;9th&#39;,
                                                                                                                      &#39;10th&#39;,
                                                                                                                      &#39;11th&#39;,
                                                                                                                      &#39;12th&#39;,
                                                                                                                      &#39;HS-grad&#39;,
                                                                                                                      &#39;Prof-school&#39;,
                                                                                                                      &#39;Assoc-voc&#39;,
                                                                                                                      &#39;Assoc-acdm&#39;,
                                                                                                                      &#39;Some-college&#39;,
                                                                                                                      &#39;Bachelors&#39;,
                                                                                                                      &#39;Masters&#39;,
                                                                                                                      &#39;Doctorate&#39;]],
                                                                                                         dtype=&lt;class &#39;int&#39;&gt;))]),
                                                                         [&#39;education&#39;])])),
                                       (&#39;svc&#39;, SVC(C=100, gamma=100))]),
             n_jobs=-1,
             param_grid={&#39;svc__C&#39;: [0.1, 1.0, 10, 100],
                         &#39;svc__gamma&#39;: [0.1, 1.0, 10, 100]},
             return_train_score=True)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Best cv score from grid search: </span><span class="si">%.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">grid_search</span><span class="o">.</span><span class="n">best_score_</span><span class="p">)</span>
<span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Best cv score from grid search: 0.852
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;svc__C&#39;: 1.0, &#39;svc__gamma&#39;: 0.1}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">grid_search</span><span class="o">.</span><span class="n">cv_results_</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;rank_test_score&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean_fit_time</th>
      <th>std_fit_time</th>
      <th>mean_score_time</th>
      <th>std_score_time</th>
      <th>param_svc__C</th>
      <th>param_svc__gamma</th>
      <th>params</th>
      <th>split0_test_score</th>
      <th>split1_test_score</th>
      <th>split2_test_score</th>
      <th>...</th>
      <th>split4_test_score</th>
      <th>mean_test_score</th>
      <th>std_test_score</th>
      <th>split0_train_score</th>
      <th>split1_train_score</th>
      <th>split2_train_score</th>
      <th>split3_train_score</th>
      <th>split4_train_score</th>
      <th>mean_train_score</th>
      <th>std_train_score</th>
    </tr>
    <tr>
      <th>rank_test_score</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>1.908747</td>
      <td>0.016357</td>
      <td>0.204031</td>
      <td>0.003334</td>
      <td>1</td>
      <td>0.1</td>
      <td>{'svc__C': 1.0, 'svc__gamma': 0.1}</td>
      <td>0.842610</td>
      <td>0.859245</td>
      <td>0.859885</td>
      <td>...</td>
      <td>0.851472</td>
      <td>0.852444</td>
      <td>0.006497</td>
      <td>0.874740</td>
      <td>0.872820</td>
      <td>0.870261</td>
      <td>0.874420</td>
      <td>0.871401</td>
      <td>0.872728</td>
      <td>0.001719</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2.748669</td>
      <td>0.037835</td>
      <td>0.195921</td>
      <td>0.002304</td>
      <td>10</td>
      <td>0.1</td>
      <td>{'svc__C': 10, 'svc__gamma': 0.1}</td>
      <td>0.840051</td>
      <td>0.854766</td>
      <td>0.849008</td>
      <td>...</td>
      <td>0.845711</td>
      <td>0.845406</td>
      <td>0.006197</td>
      <td>0.918733</td>
      <td>0.913614</td>
      <td>0.914894</td>
      <td>0.916493</td>
      <td>0.916507</td>
      <td>0.916048</td>
      <td>0.001725</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2.926996</td>
      <td>0.059028</td>
      <td>0.265295</td>
      <td>0.013773</td>
      <td>0.1</td>
      <td>0.1</td>
      <td>{'svc__C': 0.1, 'svc__gamma': 0.1}</td>
      <td>0.820857</td>
      <td>0.834933</td>
      <td>0.843890</td>
      <td>...</td>
      <td>0.834187</td>
      <td>0.832480</td>
      <td>0.007613</td>
      <td>0.844345</td>
      <td>0.837946</td>
      <td>0.836826</td>
      <td>0.838746</td>
      <td>0.840211</td>
      <td>0.839615</td>
      <td>0.002609</td>
    </tr>
    <tr>
      <th>4</th>
      <td>4.166481</td>
      <td>0.121645</td>
      <td>0.194305</td>
      <td>0.005071</td>
      <td>100</td>
      <td>0.1</td>
      <td>{'svc__C': 100, 'svc__gamma': 0.1}</td>
      <td>0.815099</td>
      <td>0.818938</td>
      <td>0.813820</td>
      <td>...</td>
      <td>0.816261</td>
      <td>0.810981</td>
      <td>0.010237</td>
      <td>0.950088</td>
      <td>0.948808</td>
      <td>0.948488</td>
      <td>0.952488</td>
      <td>0.949616</td>
      <td>0.949898</td>
      <td>0.001414</td>
    </tr>
    <tr>
      <th>5</th>
      <td>5.088506</td>
      <td>0.147284</td>
      <td>0.441413</td>
      <td>0.010283</td>
      <td>1</td>
      <td>1</td>
      <td>{'svc__C': 1.0, 'svc__gamma': 1.0}</td>
      <td>0.789507</td>
      <td>0.796545</td>
      <td>0.804862</td>
      <td>...</td>
      <td>0.797695</td>
      <td>0.791401</td>
      <td>0.012492</td>
      <td>0.957287</td>
      <td>0.957447</td>
      <td>0.956327</td>
      <td>0.958727</td>
      <td>0.957134</td>
      <td>0.957384</td>
      <td>0.000774</td>
    </tr>
    <tr>
      <th>6</th>
      <td>5.591746</td>
      <td>0.553660</td>
      <td>0.551825</td>
      <td>0.058971</td>
      <td>10</td>
      <td>1</td>
      <td>{'svc__C': 10, 'svc__gamma': 1.0}</td>
      <td>0.777351</td>
      <td>0.795905</td>
      <td>0.792706</td>
      <td>...</td>
      <td>0.775928</td>
      <td>0.783593</td>
      <td>0.008820</td>
      <td>0.984163</td>
      <td>0.983843</td>
      <td>0.984642</td>
      <td>0.984482</td>
      <td>0.984965</td>
      <td>0.984419</td>
      <td>0.000387</td>
    </tr>
    <tr>
      <th>7</th>
      <td>5.143064</td>
      <td>0.519868</td>
      <td>0.353574</td>
      <td>0.008612</td>
      <td>100</td>
      <td>1</td>
      <td>{'svc__C': 100, 'svc__gamma': 1.0}</td>
      <td>0.773512</td>
      <td>0.798464</td>
      <td>0.780550</td>
      <td>...</td>
      <td>0.765045</td>
      <td>0.778601</td>
      <td>0.011118</td>
      <td>0.993921</td>
      <td>0.993121</td>
      <td>0.994561</td>
      <td>0.994561</td>
      <td>0.994242</td>
      <td>0.994081</td>
      <td>0.000535</td>
    </tr>
    <tr>
      <th>8</th>
      <td>5.105062</td>
      <td>0.200283</td>
      <td>0.591333</td>
      <td>0.052098</td>
      <td>0.1</td>
      <td>1</td>
      <td>{'svc__C': 0.1, 'svc__gamma': 1.0}</td>
      <td>0.763916</td>
      <td>0.762636</td>
      <td>0.764555</td>
      <td>...</td>
      <td>0.762484</td>
      <td>0.763117</td>
      <td>0.000959</td>
      <td>0.766597</td>
      <td>0.765318</td>
      <td>0.763718</td>
      <td>0.765797</td>
      <td>0.765355</td>
      <td>0.765357</td>
      <td>0.000940</td>
    </tr>
    <tr>
      <th>9</th>
      <td>5.050587</td>
      <td>0.091293</td>
      <td>0.584451</td>
      <td>0.032579</td>
      <td>1</td>
      <td>10</td>
      <td>{'svc__C': 1.0, 'svc__gamma': 10}</td>
      <td>0.760717</td>
      <td>0.756878</td>
      <td>0.760077</td>
      <td>...</td>
      <td>0.758003</td>
      <td>0.758766</td>
      <td>0.001417</td>
      <td>0.989922</td>
      <td>0.989122</td>
      <td>0.990082</td>
      <td>0.989282</td>
      <td>0.991043</td>
      <td>0.989890</td>
      <td>0.000682</td>
    </tr>
    <tr>
      <th>10</th>
      <td>5.305142</td>
      <td>0.059122</td>
      <td>0.554369</td>
      <td>0.016215</td>
      <td>10</td>
      <td>10</td>
      <td>{'svc__C': 10, 'svc__gamma': 10}</td>
      <td>0.760077</td>
      <td>0.752399</td>
      <td>0.758157</td>
      <td>...</td>
      <td>0.761204</td>
      <td>0.757999</td>
      <td>0.003033</td>
      <td>0.998400</td>
      <td>0.998240</td>
      <td>0.998880</td>
      <td>0.998080</td>
      <td>0.998560</td>
      <td>0.998432</td>
      <td>0.000275</td>
    </tr>
    <tr>
      <th>11</th>
      <td>4.073205</td>
      <td>0.028526</td>
      <td>0.447852</td>
      <td>0.009148</td>
      <td>100</td>
      <td>10</td>
      <td>{'svc__C': 100, 'svc__gamma': 10}</td>
      <td>0.760717</td>
      <td>0.752399</td>
      <td>0.758157</td>
      <td>...</td>
      <td>0.759923</td>
      <td>0.757743</td>
      <td>0.002911</td>
      <td>0.999680</td>
      <td>0.999360</td>
      <td>0.999680</td>
      <td>0.999680</td>
      <td>0.999680</td>
      <td>0.999616</td>
      <td>0.000128</td>
    </tr>
    <tr>
      <th>12</th>
      <td>5.462002</td>
      <td>0.073579</td>
      <td>0.840595</td>
      <td>0.015886</td>
      <td>0.1</td>
      <td>10</td>
      <td>{'svc__C': 0.1, 'svc__gamma': 10}</td>
      <td>0.756878</td>
      <td>0.756878</td>
      <td>0.756878</td>
      <td>...</td>
      <td>0.756722</td>
      <td>0.756847</td>
      <td>0.000062</td>
      <td>0.756839</td>
      <td>0.756839</td>
      <td>0.756839</td>
      <td>0.756839</td>
      <td>0.756878</td>
      <td>0.756847</td>
      <td>0.000016</td>
    </tr>
    <tr>
      <th>12</th>
      <td>4.836406</td>
      <td>0.118449</td>
      <td>0.742922</td>
      <td>0.064156</td>
      <td>0.1</td>
      <td>100</td>
      <td>{'svc__C': 0.1, 'svc__gamma': 100}</td>
      <td>0.756878</td>
      <td>0.756878</td>
      <td>0.756878</td>
      <td>...</td>
      <td>0.756722</td>
      <td>0.756847</td>
      <td>0.000062</td>
      <td>0.756839</td>
      <td>0.756839</td>
      <td>0.756839</td>
      <td>0.756839</td>
      <td>0.756878</td>
      <td>0.756847</td>
      <td>0.000016</td>
    </tr>
    <tr>
      <th>14</th>
      <td>4.710889</td>
      <td>0.059277</td>
      <td>0.500462</td>
      <td>0.022772</td>
      <td>1</td>
      <td>100</td>
      <td>{'svc__C': 1.0, 'svc__gamma': 100}</td>
      <td>0.755598</td>
      <td>0.757518</td>
      <td>0.756878</td>
      <td>...</td>
      <td>0.756722</td>
      <td>0.756719</td>
      <td>0.000624</td>
      <td>0.998080</td>
      <td>0.998240</td>
      <td>0.998720</td>
      <td>0.997920</td>
      <td>0.998241</td>
      <td>0.998240</td>
      <td>0.000268</td>
    </tr>
    <tr>
      <th>15</th>
      <td>4.558117</td>
      <td>0.098283</td>
      <td>0.516642</td>
      <td>0.014235</td>
      <td>10</td>
      <td>100</td>
      <td>{'svc__C': 10, 'svc__gamma': 100}</td>
      <td>0.756878</td>
      <td>0.756878</td>
      <td>0.756878</td>
      <td>...</td>
      <td>0.756082</td>
      <td>0.756591</td>
      <td>0.000355</td>
      <td>0.999840</td>
      <td>0.999520</td>
      <td>0.999680</td>
      <td>0.999680</td>
      <td>0.999680</td>
      <td>0.999680</td>
      <td>0.000101</td>
    </tr>
    <tr>
      <th>15</th>
      <td>3.081595</td>
      <td>0.115879</td>
      <td>0.411206</td>
      <td>0.010108</td>
      <td>100</td>
      <td>100</td>
      <td>{'svc__C': 100, 'svc__gamma': 100}</td>
      <td>0.756878</td>
      <td>0.756878</td>
      <td>0.756878</td>
      <td>...</td>
      <td>0.756082</td>
      <td>0.756591</td>
      <td>0.000355</td>
      <td>1.000000</td>
      <td>1.000000</td>
      <td>1.000000</td>
      <td>1.000000</td>
      <td>1.000000</td>
      <td>1.000000</td>
      <td>0.000000</td>
    </tr>
  </tbody>
</table>
<p>16 rows × 21 columns</p>
</div></div></div>
</div>
</div>
<div class="section" id="the-syntax">
<h3>The <code class="docutils literal notranslate"><span class="pre">__</span></code> syntax<a class="headerlink" href="#the-syntax" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Above: we have a nesting of transformers.</p></li>
<li><p>We can access the parameters of the “inner” objects by using __ to go “deeper”:</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">svc__gamma</span></code>: the <code class="docutils literal notranslate"><span class="pre">gamma</span></code> of the <code class="docutils literal notranslate"><span class="pre">svc</span></code> of the pipeline</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">svc__C</span></code>: the <code class="docutils literal notranslate"><span class="pre">C</span></code> of the <code class="docutils literal notranslate"><span class="pre">svc</span></code> of the pipeline</p></li>
</ul>
</div>
<div class="section" id="how-do-we-access-hyperparameters-of-transformers">
<h3>How do we access hyperparameters of transformers<a class="headerlink" href="#how-do-we-access-hyperparameters-of-transformers" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">columntransformer__num__simpleimputer__strategy</span></code>: the strategy used with <code class="docutils literal notranslate"><span class="pre">SimpleImputer</span></code> of the preprocessor in the pipeline.
Later in the course we’ll see even deeper nesting, like preprocessor__numeric__imputer__strategy.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pipe</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Pipeline(steps=[(&#39;columntransformer&#39;,
                 ColumnTransformer(transformers=[(&#39;num&#39;,
                                                  Pipeline(steps=[(&#39;simpleimputer&#39;,
                                                                   SimpleImputer(strategy=&#39;median&#39;)),
                                                                  (&#39;standardscaler&#39;,
                                                                   StandardScaler())]),
                                                  [&#39;age&#39;, &#39;fnlwgt&#39;,
                                                   &#39;capital.gain&#39;,
                                                   &#39;capital.loss&#39;,
                                                   &#39;hours.per.week&#39;]),
                                                 (&#39;cat&#39;,
                                                  Pipeline(steps=[(&#39;simpleimputer&#39;,
                                                                   SimpleImputer(fill_value=&#39;missing&#39;,
                                                                                 strategy=&#39;constant&#39;)),
                                                                  (&#39;oneho...
                                                  Pipeline(steps=[(&#39;simpleimputer&#39;,
                                                                   SimpleImputer(fill_value=&#39;missing&#39;,
                                                                                 strategy=&#39;constant&#39;)),
                                                                  (&#39;ordinalencoder&#39;,
                                                                   OrdinalEncoder(categories=[[&#39;Preschool&#39;,
                                                                                               &#39;1st-4th&#39;,
                                                                                               &#39;5th-6th&#39;,
                                                                                               &#39;7th-8th&#39;,
                                                                                               &#39;9th&#39;,
                                                                                               &#39;10th&#39;,
                                                                                               &#39;11th&#39;,
                                                                                               &#39;12th&#39;,
                                                                                               &#39;HS-grad&#39;,
                                                                                               &#39;Prof-school&#39;,
                                                                                               &#39;Assoc-voc&#39;,
                                                                                               &#39;Assoc-acdm&#39;,
                                                                                               &#39;Some-college&#39;,
                                                                                               &#39;Bachelors&#39;,
                                                                                               &#39;Masters&#39;,
                                                                                               &#39;Doctorate&#39;]],
                                                                                  dtype=&lt;class &#39;int&#39;&gt;))]),
                                                  [&#39;education&#39;])])),
                (&#39;svc&#39;, SVC(C=100, gamma=100))])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">param_grid</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;svc__gamma&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span>
    <span class="s2">&quot;columntransformer__num__simpleimputer__strategy&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="s2">&quot;median&quot;</span><span class="p">],</span>
<span class="p">}</span>

<span class="n">grid_search</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="n">param_grid</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">return_train_score</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">grid_search</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">((</span><span class="s2">&quot;Best SVC from grid search: </span><span class="si">%.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">grid_search</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)))</span>
<span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span>
<span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">grid_search</span><span class="o">.</span><span class="n">cv_results_</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;rank_test_score&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Best SVC from grid search: 0.814
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean_fit_time</th>
      <th>std_fit_time</th>
      <th>mean_score_time</th>
      <th>std_score_time</th>
      <th>param_columntransformer__num__simpleimputer__strategy</th>
      <th>param_svc__gamma</th>
      <th>params</th>
      <th>split0_test_score</th>
      <th>split1_test_score</th>
      <th>split2_test_score</th>
      <th>...</th>
      <th>mean_test_score</th>
      <th>std_test_score</th>
      <th>rank_test_score</th>
      <th>split0_train_score</th>
      <th>split1_train_score</th>
      <th>split2_train_score</th>
      <th>split3_train_score</th>
      <th>split4_train_score</th>
      <th>mean_train_score</th>
      <th>std_train_score</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>4.369722</td>
      <td>0.073645</td>
      <td>0.187483</td>
      <td>0.002374</td>
      <td>mean</td>
      <td>0.1</td>
      <td>{'columntransformer__num__simpleimputer__strategy': 'mean', 'svc__gamma': 0.1}</td>
      <td>0.815099</td>
      <td>0.818938</td>
      <td>0.81382</td>
      <td>...</td>
      <td>0.810981</td>
      <td>0.010237</td>
      <td>1</td>
      <td>0.950088</td>
      <td>0.948808</td>
      <td>0.948488</td>
      <td>0.952488</td>
      <td>0.949616</td>
      <td>0.949898</td>
      <td>0.001414</td>
    </tr>
    <tr>
      <th>2</th>
      <td>4.416549</td>
      <td>0.066688</td>
      <td>0.186616</td>
      <td>0.001750</td>
      <td>median</td>
      <td>0.1</td>
      <td>{'columntransformer__num__simpleimputer__strategy': 'median', 'svc__gamma': 0.1}</td>
      <td>0.815099</td>
      <td>0.818938</td>
      <td>0.81382</td>
      <td>...</td>
      <td>0.810981</td>
      <td>0.010237</td>
      <td>1</td>
      <td>0.950088</td>
      <td>0.948808</td>
      <td>0.948488</td>
      <td>0.952488</td>
      <td>0.949616</td>
      <td>0.949898</td>
      <td>0.001414</td>
    </tr>
    <tr>
      <th>1</th>
      <td>5.850827</td>
      <td>0.385002</td>
      <td>0.276416</td>
      <td>0.006900</td>
      <td>mean</td>
      <td>1</td>
      <td>{'columntransformer__num__simpleimputer__strategy': 'mean', 'svc__gamma': 1.0}</td>
      <td>0.773512</td>
      <td>0.798464</td>
      <td>0.78055</td>
      <td>...</td>
      <td>0.778601</td>
      <td>0.011118</td>
      <td>3</td>
      <td>0.993921</td>
      <td>0.993121</td>
      <td>0.994561</td>
      <td>0.994561</td>
      <td>0.994242</td>
      <td>0.994081</td>
      <td>0.000535</td>
    </tr>
    <tr>
      <th>3</th>
      <td>5.791268</td>
      <td>0.403897</td>
      <td>0.277448</td>
      <td>0.007326</td>
      <td>median</td>
      <td>1</td>
      <td>{'columntransformer__num__simpleimputer__strategy': 'median', 'svc__gamma': 1.0}</td>
      <td>0.773512</td>
      <td>0.798464</td>
      <td>0.78055</td>
      <td>...</td>
      <td>0.778601</td>
      <td>0.011118</td>
      <td>3</td>
      <td>0.993921</td>
      <td>0.993121</td>
      <td>0.994561</td>
      <td>0.994561</td>
      <td>0.994242</td>
      <td>0.994081</td>
      <td>0.000535</td>
    </tr>
  </tbody>
</table>
<p>4 rows × 22 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">grid_search</span><span class="o">.</span><span class="n">cv_results_</span><span class="p">)[</span>
    <span class="p">[</span>
        <span class="s2">&quot;mean_test_score&quot;</span><span class="p">,</span>
        <span class="s2">&quot;param_columntransformer__num__simpleimputer__strategy&quot;</span><span class="p">,</span>
        <span class="s2">&quot;param_svc__gamma&quot;</span><span class="p">,</span>
        <span class="s2">&quot;mean_fit_time&quot;</span><span class="p">,</span>
        <span class="s2">&quot;rank_test_score&quot;</span><span class="p">,</span>
    <span class="p">]</span>
<span class="p">]</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;rank_test_score&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean_test_score</th>
      <th>param_columntransformer__num__simpleimputer__strategy</th>
      <th>param_svc__gamma</th>
      <th>mean_fit_time</th>
    </tr>
    <tr>
      <th>rank_test_score</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>0.810981</td>
      <td>mean</td>
      <td>0.1</td>
      <td>4.369722</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.810981</td>
      <td>median</td>
      <td>0.1</td>
      <td>4.416549</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0.778601</td>
      <td>mean</td>
      <td>1</td>
      <td>5.850827</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0.778601</td>
      <td>median</td>
      <td>1</td>
      <td>5.791268</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># How many combinations in total?</span>
<span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="n">param_grid</span><span class="o">.</span><span class="n">values</span><span class="p">())))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>4
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="id2">
<h3>Problems with exhaustive grid search<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Required number of models to evaluate grows exponentially with the dimensionally of the configuration space.</p></li>
<li><p>Example: Suppose you have</p>
<ul>
<li><p>5 hyperparameters</p></li>
<li><p>10 different values for each hyperparameter</p></li>
<li><p>You’ll be evaluating <span class="math notranslate nohighlight">\(10^5=100,000\)</span> models! That is you’ll be calling <code class="docutils literal notranslate"><span class="pre">cross_validate</span></code> 100,000 times!</p></li>
</ul>
</li>
<li><p>Exhaustive search may become infeasible fairly quickly.</p></li>
<li><p>Other options?</p></li>
</ul>
</div>
<div class="section" id="randomized-hyperparameter-search">
<h3>Randomized hyperparameter search<a class="headerlink" href="#randomized-hyperparameter-search" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Randomized hyperparameter optimization</p>
<ul>
<li><p><a class="reference external" href="https://scikit-learn.org/stable/modules/generated/sklearn.model_selection.RandomizedSearchCV.html"><code class="docutils literal notranslate"><span class="pre">sklearn.model_selection.RandomizedSearchCV</span></code></a></p></li>
</ul>
</li>
<li><p>Samples configurations at random until certain budget (e.g., time) is exhausted</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">RandomizedSearchCV</span>

<span class="n">param_grid</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;svc__gamma&quot;</span><span class="p">:</span> <span class="mf">10.0</span> <span class="o">**</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
    <span class="s2">&quot;svc__C&quot;</span><span class="p">:</span> <span class="mf">10.0</span> <span class="o">**</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
<span class="p">}</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Grid size: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="n">param_grid</span><span class="o">.</span><span class="n">values</span><span class="p">())))))</span>
<span class="n">param_grid</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Grid size: 144
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;svc__gamma&#39;: array([1.e-06, 1.e-05, 1.e-04, 1.e-03, 1.e-02, 1.e-01, 1.e+00, 1.e+01,
        1.e+02, 1.e+03, 1.e+04, 1.e+05]),
 &#39;svc__C&#39;: array([1.e-06, 1.e-05, 1.e-04, 1.e-03, 1.e-02, 1.e-01, 1.e+00, 1.e+01,
        1.e+02, 1.e+03, 1.e+04, 1.e+05])}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">random_search</span> <span class="o">=</span> <span class="n">RandomizedSearchCV</span><span class="p">(</span>
    <span class="n">pipe</span><span class="p">,</span> <span class="n">param_distributions</span><span class="o">=</span><span class="n">param_grid</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_iter</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="mi">5</span>
<span class="p">)</span>
<span class="n">random_search</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">random_search</span><span class="o">.</span><span class="n">cv_results_</span><span class="p">)[</span>
    <span class="p">[</span>
        <span class="s2">&quot;mean_test_score&quot;</span><span class="p">,</span>
        <span class="s2">&quot;param_svc__gamma&quot;</span><span class="p">,</span>
        <span class="s2">&quot;param_svc__C&quot;</span><span class="p">,</span>
        <span class="s2">&quot;mean_fit_time&quot;</span><span class="p">,</span>
        <span class="s2">&quot;rank_test_score&quot;</span><span class="p">,</span>
    <span class="p">]</span>
<span class="p">]</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;rank_test_score&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean_test_score</th>
      <th>param_svc__gamma</th>
      <th>param_svc__C</th>
      <th>mean_fit_time</th>
    </tr>
    <tr>
      <th>rank_test_score</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>0.853852</td>
      <td>0.01</td>
      <td>10</td>
      <td>0.612439</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0.849118</td>
      <td>0.0001</td>
      <td>10000</td>
      <td>1.088907</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0.845406</td>
      <td>0.1</td>
      <td>10</td>
      <td>0.887579</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.783593</td>
      <td>1</td>
      <td>10</td>
      <td>2.034650</td>
    </tr>
    <tr>
      <th>5</th>
      <td>0.778473</td>
      <td>1</td>
      <td>100000</td>
      <td>7.923222</td>
    </tr>
    <tr>
      <th>6</th>
      <td>0.757743</td>
      <td>10</td>
      <td>10000</td>
      <td>1.819518</td>
    </tr>
    <tr>
      <th>7</th>
      <td>0.756847</td>
      <td>10000</td>
      <td>1e-06</td>
      <td>0.651702</td>
    </tr>
    <tr>
      <th>7</th>
      <td>0.756847</td>
      <td>1e-05</td>
      <td>0.01</td>
      <td>0.710953</td>
    </tr>
    <tr>
      <th>7</th>
      <td>0.756847</td>
      <td>100000</td>
      <td>0.01</td>
      <td>1.337574</td>
    </tr>
    <tr>
      <th>7</th>
      <td>0.756847</td>
      <td>1e-06</td>
      <td>0.1</td>
      <td>0.709211</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="advantages-of-randomizedsearchcv">
<h3>Advantages of <code class="docutils literal notranslate"><span class="pre">RandomizedSearchCV</span></code><a class="headerlink" href="#advantages-of-randomizedsearchcv" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Faster compared to <code class="docutils literal notranslate"><span class="pre">GridSearchCV</span></code>.</p></li>
<li><p>Adding parameters that do not influence the performance does not affect efficiency.</p></li>
<li><p>In general, I recommend using <code class="docutils literal notranslate"><span class="pre">RandomizedSearchCV</span></code> rather than <code class="docutils literal notranslate"><span class="pre">GridSearchCV</span></code>.</p></li>
</ul>
</div>
<div class="section" id="id3">
<h3>Advantages of <code class="docutils literal notranslate"><span class="pre">RandomizedSearchCV</span></code><a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Works better when some parameters are more important than others.</p></li>
</ul>
<p><img alt="" src="lectures/images/randomsearch_bergstra.png" /></p>
<p>Source: <a class="reference external" href="http://www.jmlr.org/papers/volume13/bergstra12a/bergstra12a.pdf">Bergstra and Bengio, Random Search for Hyper-Parameter Optimization, JMLR 2012</a>.</p>
<ul class="simple">
<li><p>The yellow on the left shows how your scores are going to change when you vary the unimportant hyperparameter.</p></li>
<li><p>The green on the top shows how your scores are  going to change when you vary the important hyperparameter.</p></li>
<li><p>You don’t know in advance which hyperparameters are important for your problem.</p></li>
<li><p>In the left figure, 6 of the 9 searches are useless because they are only varying the unimportant parameter.</p></li>
<li><p>In the right figure, all 9 searches are useful.</p></li>
</ul>
</div>
</div>
<div class="section" id="fancier-methods-optional">
<h2>Fancier methods (optional)<a class="headerlink" href="#fancier-methods-optional" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Both <code class="docutils literal notranslate"><span class="pre">GridSearchCV</span></code> and <code class="docutils literal notranslate"><span class="pre">RandomizedSearchCV</span></code> do each trial independently.</p></li>
<li><p>What if you could learn from your experience, e.g. learn that <code class="docutils literal notranslate"><span class="pre">max_depth=3</span></code> is bad?</p>
<ul>
<li><p>That could save time because you wouldn’t try combinations involving <code class="docutils literal notranslate"><span class="pre">max_depth=3</span></code> in the future.</p></li>
</ul>
</li>
<li><p>We can do this with <code class="docutils literal notranslate"><span class="pre">scikit-optimize</span></code>, which is a completely different package from <code class="docutils literal notranslate"><span class="pre">scikit-learn</span></code></p></li>
<li><p>It uses a technique called “model-based optimization” and we’ll specifically use “Bayesian optimization”.</p>
<ul>
<li><p>In short, it uses machine learning to predict what hyperparameters will be good.</p></li>
<li><p>Machine learning on machine learning!</p></li>
</ul>
</li>
<li><p>This is an active research area and there are sophisticated packages for this.</p></li>
<li><p>It was Mike’s <a class="reference external" href="https://dash.harvard.edu/bitstream/handle/1/17467236/GELBART-DISSERTATION-2015.pdf?sequence=4">PhD thesis</a> topic. So you can bother him if want to know more about it :).</p></li>
</ul>
<ul class="simple">
<li><p>If you want to run the following optional code, you’ll have to install <code class="docutils literal notranslate"><span class="pre">scikit-optimize</span></code></p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">conda</span> <span class="pre">install</span> <span class="pre">-c</span> <span class="pre">conda-forge</span> <span class="pre">scikit-optimize</span></code></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">BayesSearchCV</span></code> uses the same interface as <code class="docutils literal notranslate"><span class="pre">GridSearchCV</span></code> and <code class="docutils literal notranslate"><span class="pre">RandomSearchCV</span></code>.</p></li>
<li><p>However, the way we specify the parameter distributions is slightly different.</p></li>
<li><p>Here, we can just give the bounds as tuples.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">skopt</span> <span class="kn">import</span> <span class="n">BayesSearchCV</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pipe</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span><span class="n">preprocessor</span><span class="p">,</span> <span class="n">SVC</span><span class="p">())</span>

<span class="n">bayes_opt</span> <span class="o">=</span> <span class="n">BayesSearchCV</span><span class="p">(</span>
    <span class="n">pipe</span><span class="p">,</span>
    <span class="p">{</span>
        <span class="s2">&quot;svc__C&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
        <span class="s2">&quot;columntransformer__num__simpleimputer__strategy&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="s2">&quot;median&quot;</span><span class="p">),</span>
    <span class="p">},</span>
    <span class="n">n_iter</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">cv</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
    <span class="n">random_state</span><span class="o">=</span><span class="mi">123</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">refit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bayes_opt</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>It took a similar amount of time to the other methods.</p></li>
<li><p>In reality there is some extra computation to do the “meta-ML”.</p></li>
<li><p>However, the overall time is dominated by the time of calling <code class="docutils literal notranslate"><span class="pre">fit</span></code> on the <code class="docutils literal notranslate"><span class="pre">SVC</span></code>.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bayes_opt</span><span class="o">.</span><span class="n">best_params_</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>OrderedDict([(&#39;columntransformer__num__simpleimputer__strategy&#39;, &#39;mean&#39;),
             (&#39;svc__C&#39;, 9.901973022704464)])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bayes_opt</span><span class="o">.</span><span class="n">best_score_</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.8523163552597901
</pre></div>
</div>
</div>
</div>
<div class="section" id="pros-and-cons-of-bayesopt">
<h3>Pros and cons of BayesOpt<a class="headerlink" href="#pros-and-cons-of-bayesopt" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Advantage: can find better hyperparameter values with fewer trials.</p></li>
<li><p>Disadvantage: requires installation.</p></li>
<li><p>Disadvantage: when number of trials is large (e.g. hundreds), the meta-ML can actually get too slow.</p></li>
<li><p>Disadvantage: harder to parallelize the search because each trial depends on the previous ones.</p>
<ul>
<li><p>Note <code class="docutils literal notranslate"><span class="pre">n_jobs</span></code> parameter for <code class="docutils literal notranslate"><span class="pre">GridSearchCV</span></code> and <code class="docutils literal notranslate"><span class="pre">RandomizedSearchCV</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">BayesSearchCV</span></code> also has this parameter.</p></li>
<li><p>It can definitely parallelize the folds.</p></li>
<li><p>The search will be less effective if it parallelizes further.</p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="questions-for-class-discussion-hyperparameter-optimization">
<h3>Questions for class discussion (hyperparameter optimization)<a class="headerlink" href="#questions-for-class-discussion-hyperparameter-optimization" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Suppose you have 10 hyperparameters, each with 4 possible values. If you run <code class="docutils literal notranslate"><span class="pre">GridSearchCV</span></code> with this parameter grid, how many cross-validation experiments it would carry out?</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">GridSearchCV</span></code> exhaustively searches the grid and so it’s guaranteed to give you the optimal hyperparameters for the given problem.</p></li>
<li><p>It is possible to get different hyperparameters in different runs of <code class="docutils literal notranslate"><span class="pre">RandomizedSearchCV</span></code>.</p></li>
<li><p>Suppose you have 10 hyperparameters and each takes 4 values. If you run <code class="docutils literal notranslate"><span class="pre">RandomizedSearchCV</span></code> with this parameter grid, how many cross-validation experiments it would carry out?</p></li>
</ul>
</div>
</div>
<div class="section" id="optimization-bias-a-name-3-a">
<h2>3. Optimization bias <a name="3"></a><a class="headerlink" href="#optimization-bias-a-name-3-a" title="Permalink to this headline">¶</a></h2>
<div class="section" id="overfitting-of-the-validation-error">
<h3>Overfitting of the validation error<a class="headerlink" href="#overfitting-of-the-validation-error" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Why do we need to evaluate the model on the test set in the end?</p></li>
<li><p>Why not just use cross-validation on the whole dataset?</p></li>
<li><p>While carrying out hyperparameter optimization, we end up trying over many possibilities.</p></li>
<li><p>If our dataset is small and if your validation set is hit too many times, we suffer from <strong>optimization bias</strong> or <strong>overfitting the validation set</strong>.</p></li>
</ul>
</div>
<div class="section" id="id4">
<h3>Overfitting of the validation error<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<p>Optimization bias of parameter learning:</p>
<ul class="simple">
<li><p>During learning, we could search over tons of different decision trees.</p></li>
<li><p>So we can get “lucky” and find one with low training error by chance.</p>
<ul>
<li><p>“Overfitting of the training error”.</p></li>
</ul>
</li>
</ul>
<p>Optimization bias of hyper-parameter learning:</p>
<ul class="simple">
<li><p>Here, we might optimize the validation error over 100 values of <code class="docutils literal notranslate"><span class="pre">max_depth</span></code>.</p></li>
<li><p>One of the 100 trees might have low validation error by chance.</p></li>
</ul>
</div>
<div class="section" id="example-1-optimization-bias-optional">
<h3>Example 1: Optimization bias (optional)<a class="headerlink" href="#example-1-optimization-bias-optional" title="Permalink to this headline">¶</a></h3>
<p>Consider a multiple-choice (a,b,c,d) “test” with 10 questions:</p>
<ul class="simple">
<li><p>If you choose answers randomly, expected grade is 25% (no bias).</p></li>
<li><p>If you fill out two tests randomly and pick the best, expected grade is 33%.</p>
<ul>
<li><p>Optimization bias of ~8%.</p></li>
</ul>
</li>
<li><p>If you take the best among 10 random tests, expected grade is ~47%.</p></li>
<li><p>If you take the best among 100, expected grade is ~62%.</p></li>
<li><p>If you take the best among 1000, expected grade is ~73%.</p></li>
<li><p>If you take the best among 10000, expected grade is ~82%.</p>
<ul>
<li><p>You have so many “chances” that you expect to do well.</p></li>
</ul>
</li>
</ul>
<p><strong>But on new questions the “random choice” accuracy is still 25%.</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Code attribution: Thanks to Rodolfo! (optional)</span>
<span class="n">number_tests</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">10000</span><span class="p">]</span>
<span class="k">for</span> <span class="n">ntests</span> <span class="ow">in</span> <span class="n">number_tests</span><span class="p">:</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">10000</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10000</span><span class="p">):</span>
        <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">binomial</span><span class="p">(</span><span class="mf">10.0</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="n">ntests</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="s2">&quot;The expected grade among the best of </span><span class="si">%d</span><span class="s2"> tests is : </span><span class="si">%0.2f</span><span class="s2">&quot;</span>
        <span class="o">%</span> <span class="p">(</span><span class="n">ntests</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">/</span> <span class="mf">10.0</span><span class="p">)</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="example-2-optimization-bias-optional">
<h3>Example 2: Optimization bias (optional)<a class="headerlink" href="#example-2-optimization-bias-optional" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>If we instead used a 100-question test then:</p>
<ul>
<li><p>Expected grade from best over 1 randomly-filled test is 25%.</p></li>
<li><p>Expected grade from best over 2 randomly-filled test is ~27%.</p></li>
<li><p>Expected grade from best over 10 randomly-filled test is ~32%.</p></li>
<li><p>Expected grade from best over 100 randomly-filled test is ~36%.</p></li>
<li><p>Expected grade from best over 1000 randomly-filled test is ~40%.</p></li>
<li><p>Expected grade from best over 10000 randomly-filled test is ~43%.</p></li>
</ul>
</li>
<li><p>The optimization bias <strong>grows with the number of things we try</strong>.</p>
<ul>
<li><p>“Complexity” of the set of models we search over.</p></li>
</ul>
</li>
<li><p>But, optimization bias <strong>shrinks quickly with the number of examples</strong>.</p>
<ul>
<li><p>But it’s still non-zero and growing if you over-use your validation set!</p></li>
</ul>
</li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Code attribution: Thanks to Rodolfo! (optional)</span>
<span class="n">number_tests</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">10000</span><span class="p">]</span>
<span class="k">for</span> <span class="n">ntests</span> <span class="ow">in</span> <span class="n">number_tests</span><span class="p">:</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">10000</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10000</span><span class="p">):</span>
        <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">binomial</span><span class="p">(</span><span class="mf">100.0</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="n">ntests</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="s2">&quot;The expected grade among the best of </span><span class="si">%d</span><span class="s2"> tests is : </span><span class="si">%0.2f</span><span class="s2">&quot;</span>
        <span class="o">%</span> <span class="p">(</span><span class="n">ntests</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">/</span> <span class="mf">100.0</span><span class="p">)</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="let-s-examine-effects-of-optimization-on-the-adult-income-dataset">
<h3>Let’s examine effects of optimization on the adult income dataset<a class="headerlink" href="#let-s-examine-effects-of-optimization-on-the-adult-income-dataset" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df</span><span class="p">,</span> <span class="n">test_df</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">adult_df_large</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.99</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(325, 15)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df_nan</span> <span class="o">=</span> <span class="n">train_df</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;?&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span><span class="p">)</span>
<span class="n">test_df_nan</span> <span class="o">=</span> <span class="n">test_df</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;?&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df_nan</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>age</th>
      <th>workclass</th>
      <th>fnlwgt</th>
      <th>education</th>
      <th>education.num</th>
      <th>marital.status</th>
      <th>occupation</th>
      <th>relationship</th>
      <th>race</th>
      <th>sex</th>
      <th>capital.gain</th>
      <th>capital.loss</th>
      <th>hours.per.week</th>
      <th>native.country</th>
      <th>income</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>15087</th>
      <td>34</td>
      <td>Private</td>
      <td>119153</td>
      <td>11th</td>
      <td>7</td>
      <td>Married-civ-spouse</td>
      <td>Transport-moving</td>
      <td>Husband</td>
      <td>White</td>
      <td>Male</td>
      <td>0</td>
      <td>0</td>
      <td>50</td>
      <td>United-States</td>
      <td>&lt;=50K</td>
    </tr>
    <tr>
      <th>11774</th>
      <td>22</td>
      <td>Private</td>
      <td>215477</td>
      <td>Some-college</td>
      <td>10</td>
      <td>Never-married</td>
      <td>Transport-moving</td>
      <td>Own-child</td>
      <td>White</td>
      <td>Male</td>
      <td>0</td>
      <td>0</td>
      <td>40</td>
      <td>United-States</td>
      <td>&lt;=50K</td>
    </tr>
    <tr>
      <th>1930</th>
      <td>30</td>
      <td>Local-gov</td>
      <td>182926</td>
      <td>Some-college</td>
      <td>10</td>
      <td>Married-civ-spouse</td>
      <td>Protective-serv</td>
      <td>Husband</td>
      <td>White</td>
      <td>Male</td>
      <td>15024</td>
      <td>0</td>
      <td>40</td>
      <td>United-States</td>
      <td>&gt;50K</td>
    </tr>
    <tr>
      <th>23509</th>
      <td>33</td>
      <td>Private</td>
      <td>124052</td>
      <td>HS-grad</td>
      <td>9</td>
      <td>Married-civ-spouse</td>
      <td>Craft-repair</td>
      <td>Husband</td>
      <td>White</td>
      <td>Male</td>
      <td>0</td>
      <td>0</td>
      <td>40</td>
      <td>United-States</td>
      <td>&lt;=50K</td>
    </tr>
    <tr>
      <th>197</th>
      <td>49</td>
      <td>Local-gov</td>
      <td>102359</td>
      <td>9th</td>
      <td>5</td>
      <td>Widowed</td>
      <td>Handlers-cleaners</td>
      <td>Unmarried</td>
      <td>White</td>
      <td>Male</td>
      <td>0</td>
      <td>2231</td>
      <td>40</td>
      <td>United-States</td>
      <td>&gt;50K</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df_nan</span><span class="p">[</span><span class="s2">&quot;income&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;=50K    246
&gt;50K      79
Name: income, dtype: int64
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="id5">
<h3>Identify feature types<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">numeric_features</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;age&quot;</span><span class="p">,</span> <span class="s2">&quot;fnlwgt&quot;</span><span class="p">,</span> <span class="s2">&quot;capital.gain&quot;</span><span class="p">,</span> <span class="s2">&quot;capital.loss&quot;</span><span class="p">,</span> <span class="s2">&quot;hours.per.week&quot;</span><span class="p">]</span>
<span class="c1"># I am removing eduction.num column</span>
<span class="n">categorical_features</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;workclass&quot;</span><span class="p">,</span>
    <span class="s2">&quot;marital.status&quot;</span><span class="p">,</span>
    <span class="s2">&quot;occupation&quot;</span><span class="p">,</span>
    <span class="s2">&quot;relationship&quot;</span><span class="p">,</span>
    <span class="s2">&quot;sex&quot;</span><span class="p">,</span>
    <span class="s2">&quot;native.country&quot;</span><span class="p">,</span>
<span class="p">]</span>
<span class="c1"># I am removing &#39;race&#39; column</span>
<span class="n">ordinal_features</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;education&quot;</span><span class="p">]</span>
<span class="n">target</span> <span class="o">=</span> <span class="s2">&quot;income&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">education_levels</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;Preschool&quot;</span><span class="p">,</span>
    <span class="s2">&quot;1st-4th&quot;</span><span class="p">,</span>
    <span class="s2">&quot;5th-6th&quot;</span><span class="p">,</span>
    <span class="s2">&quot;7th-8th&quot;</span><span class="p">,</span>
    <span class="s2">&quot;9th&quot;</span><span class="p">,</span>
    <span class="s2">&quot;10th&quot;</span><span class="p">,</span>
    <span class="s2">&quot;11th&quot;</span><span class="p">,</span>
    <span class="s2">&quot;12th&quot;</span><span class="p">,</span>
    <span class="s2">&quot;HS-grad&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Prof-school&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Assoc-voc&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Assoc-acdm&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Some-college&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Bachelors&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Masters&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Doctorate&quot;</span><span class="p">,</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_train</span> <span class="o">=</span> <span class="n">train_df_nan</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">target</span><span class="p">])</span>
<span class="n">y_train</span> <span class="o">=</span> <span class="n">train_df_nan</span><span class="p">[</span><span class="n">target</span><span class="p">]</span>

<span class="n">X_test</span> <span class="o">=</span> <span class="n">test_df_nan</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">target</span><span class="p">])</span>
<span class="n">y_test</span> <span class="o">=</span> <span class="n">test_df_nan</span><span class="p">[</span><span class="n">target</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="id6">
<h3>Define <code class="docutils literal notranslate"><span class="pre">ColumnTransformer</span></code> and a pipeline<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">numeric_transformer</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span><span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s2">&quot;median&quot;</span><span class="p">),</span> <span class="n">StandardScaler</span><span class="p">())</span>

<span class="n">categorical_transformer</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span>
    <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s2">&quot;constant&quot;</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="s2">&quot;missing&quot;</span><span class="p">),</span>
    <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">handle_unknown</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">),</span>
<span class="p">)</span>

<span class="n">ordinal_transformer</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span>
    <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s2">&quot;constant&quot;</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="s2">&quot;missing&quot;</span><span class="p">),</span>
    <span class="n">OrdinalEncoder</span><span class="p">(</span>
        <span class="n">categories</span><span class="o">=</span><span class="p">[</span><span class="n">education_levels</span><span class="p">],</span>
        <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
    <span class="p">),</span>
<span class="p">)</span>

<span class="n">preprocessor</span> <span class="o">=</span> <span class="n">ColumnTransformer</span><span class="p">(</span>
    <span class="n">transformers</span><span class="o">=</span><span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;num&quot;</span><span class="p">,</span> <span class="n">numeric_transformer</span><span class="p">,</span> <span class="n">numeric_features</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;cat&quot;</span><span class="p">,</span> <span class="n">categorical_transformer</span><span class="p">,</span> <span class="n">categorical_features</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;ordinal&quot;</span><span class="p">,</span> <span class="n">ordinal_transformer</span><span class="p">,</span> <span class="n">ordinal_features</span><span class="p">),</span>
    <span class="p">]</span>
<span class="p">)</span>
<span class="n">pipe</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span><span class="n">preprocessor</span><span class="p">,</span> <span class="n">SVC</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">RandomizedSearchCV</span>

<span class="n">param_grid</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;svc__gamma&quot;</span><span class="p">:</span> <span class="mf">10.0</span> <span class="o">**</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
    <span class="s2">&quot;svc__C&quot;</span><span class="p">:</span> <span class="mf">10.0</span> <span class="o">**</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
<span class="p">}</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Grid size: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="n">param_grid</span><span class="o">.</span><span class="n">values</span><span class="p">())))))</span>
<span class="n">param_grid</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Grid size: 900
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;svc__gamma&#39;: array([1.e-20, 1.e-19, 1.e-18, 1.e-17, 1.e-16, 1.e-15, 1.e-14, 1.e-13,
        1.e-12, 1.e-11, 1.e-10, 1.e-09, 1.e-08, 1.e-07, 1.e-06, 1.e-05,
        1.e-04, 1.e-03, 1.e-02, 1.e-01, 1.e+00, 1.e+01, 1.e+02, 1.e+03,
        1.e+04, 1.e+05, 1.e+06, 1.e+07, 1.e+08, 1.e+09]),
 &#39;svc__C&#39;: array([1.e-20, 1.e-19, 1.e-18, 1.e-17, 1.e-16, 1.e-15, 1.e-14, 1.e-13,
        1.e-12, 1.e-11, 1.e-10, 1.e-09, 1.e-08, 1.e-07, 1.e-06, 1.e-05,
        1.e-04, 1.e-03, 1.e-02, 1.e-01, 1.e+00, 1.e+01, 1.e+02, 1.e+03,
        1.e+04, 1.e+05, 1.e+06, 1.e+07, 1.e+08, 1.e+09])}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">random_search</span> <span class="o">=</span> <span class="n">RandomizedSearchCV</span><span class="p">(</span>
    <span class="n">pipe</span><span class="p">,</span> <span class="n">param_distributions</span><span class="o">=</span><span class="n">param_grid</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_iter</span><span class="o">=</span><span class="mi">900</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="mi">5</span>
<span class="p">)</span>
<span class="n">random_search</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">random_search</span><span class="o">.</span><span class="n">cv_results_</span><span class="p">)[</span>
    <span class="p">[</span>
        <span class="s2">&quot;mean_test_score&quot;</span><span class="p">,</span>
        <span class="s2">&quot;param_svc__gamma&quot;</span><span class="p">,</span>
        <span class="s2">&quot;param_svc__C&quot;</span><span class="p">,</span>
        <span class="s2">&quot;mean_fit_time&quot;</span><span class="p">,</span>
        <span class="s2">&quot;rank_test_score&quot;</span><span class="p">,</span>
    <span class="p">]</span>
<span class="p">]</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;rank_test_score&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean_test_score</th>
      <th>param_svc__gamma</th>
      <th>param_svc__C</th>
      <th>mean_fit_time</th>
    </tr>
    <tr>
      <th>rank_test_score</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>0.852308</td>
      <td>0.001</td>
      <td>1000</td>
      <td>0.025669</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.852308</td>
      <td>0.1</td>
      <td>1</td>
      <td>0.024438</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0.846154</td>
      <td>0.01</td>
      <td>10</td>
      <td>0.027776</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0.846154</td>
      <td>1e-05</td>
      <td>1e+07</td>
      <td>0.204596</td>
    </tr>
    <tr>
      <th>5</th>
      <td>0.843077</td>
      <td>1e-08</td>
      <td>1e+08</td>
      <td>0.021219</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<ul class="simple">
<li><p>Do we really believe that 0.85 is a good estimate of our test data?</p></li>
<li><p>Do we really believe that <code class="docutils literal notranslate"><span class="pre">gamma</span></code>=0.001 and C=1000 are the best hyperparameters?</p></li>
</ul>
<ul class="simple">
<li><p>No, because our training data is quite small and so our validation splits in cross validation would be small.</p></li>
<li><p>No, because of the small dataset and the fact that we hit the small validation set 900 times and it’s possible that we got lucky on the validation set!</p></li>
<li><p>Let’s find out the test score with this best model.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">random_search</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.8083198908053109
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>We can trust this test score because it’s a huge test set.</p></li>
</ul>
</div>
<div class="section" id="overfitting-of-the-validation-data">
<h3>Overfitting of the validation data<a class="headerlink" href="#overfitting-of-the-validation-data" title="Permalink to this headline">¶</a></h3>
<center>
<img src='./images/optimization-bias.png' width="800">
</center>
<p><a class="reference external" href="https://amueller.github.io/COMS4995-s20/slides/aml-03-supervised-learning/#20">Source</a></p>
<ul class="simple">
<li><p>Thus, not only can we not trust the cv scores, we also cannot trust cv’s ability to choose of the best hyperparameters.</p></li>
</ul>
</div>
<div class="section" id="why-do-we-need-a-test-set">
<h3>Why do we need a test set?<a class="headerlink" href="#why-do-we-need-a-test-set" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>We have a VERY optimistic cross-validation score.</p></li>
<li><p>This is why we need a test set.</p></li>
<li><p>The frustrating part is that if our dataset is small then our test set is also small :(.</p></li>
<li><p>But we don’t have a lot of better alternatives, unfortunately, if we have a small dataset.</p></li>
</ul>
</div>
<div class="section" id="large-datasets-solves-many-of-these-problems">
<h3>Large datasets solves many of these problems<a class="headerlink" href="#large-datasets-solves-many-of-these-problems" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>With infinite amounts of training data, overfitting would not be a problem and you could have your test score = your train score.</p>
<ul>
<li><p>Overfitting happens because you only see a bit of data and you learn patterns that are overly specific to your sample.</p></li>
<li><p>If you saw “all” the data, then the notion of “overly specific” would not apply.</p></li>
</ul>
</li>
<li><p>So, more data will make your test score better and robust.</p></li>
<li><p>What to do if your test score is much lower than your cross-validation score:</p>
<ul>
<li><p>Try simpler models and use the test set a couple of times - it’s not the end of the world.</p></li>
<li><p>Communicate this clearly when you report the results.</p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="questions-for-class-discussion-optimization-bias">
<h3>Questions for class discussion (optimization bias)<a class="headerlink" href="#questions-for-class-discussion-optimization-bias" title="Permalink to this headline">¶</a></h3>
</div>
<div class="section" id="would-you-trust-the-model">
<h3>Would you trust the model?<a class="headerlink" href="#would-you-trust-the-model" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>You have a dataset and you give me half of it. I build a model using all the data you have given me and I tell you that the model accuracy is 0.99. Would it classify the rest of the data with similar accuracy?</p></li>
</ul>
<ol class="simple">
<li><p>Probably</p></li>
<li><p>Probably not</p></li>
</ol>
</div>
<div class="section" id="id7">
<h3>Would you trust the model?<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>You have a dataset and you give me half of it. I build a model using 80% of the data given to me and report the accuracy of 0.95 on the remaining 20% of the data. Would it classify the rest of the data with similar accuracy?</p></li>
</ul>
<ol class="simple">
<li><p>Probably</p></li>
<li><p>Probably not</p></li>
</ol>
</div>
<div class="section" id="id8">
<h3>Would you trust the model?<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>You have a dataset and you give me 1/10th of it. The dataset given to me is rather small and so I split it into 96% train and 4% validation split. I carry out hyperparameter optimization using a single 4% validation split and report validation accuracy of 0.97. Would it classify the rest of the data with similar accuracy?</p></li>
</ul>
<ol class="simple">
<li><p>Probably</p></li>
<li><p>Probably not</p></li>
</ol>
</div>
</div>
<div class="section" id="optional-readings-and-resources">
<h2>Optional readings and resources<a class="headerlink" href="#optional-readings-and-resources" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="http://www.robotics.stanford.edu/~ang/papers/cv-final.pdf">Preventing “overfitting” of cross-validation data</a> by Andrew Ng</p></li>
</ul>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "conda-env-571-py"
        },
        kernelOptions: {
            kernelName: "conda-env-571-py",
            path: "./lectures"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'conda-env-571-py'</script>

              </div>
              
        
        <div class='prev-next-bottom'>
            

        </div>
        
        </div>
    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By Varada Kolhatkar<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="../_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  
  </body>
</html>